// Carregamento de vari√°veis de ambiente para o Sistema Disciplinar Jupiara
// Este arquivo gerencia as configura√ß√µes de ambiente tanto localmente quanto na produ√ß√£o

(function() {
  'use strict';

  // Fun√ß√£o para carregar vari√°veis do Netlify
  function loadNetlifyEnv() {
    // M√©todo 1: Vari√°veis injetadas pelo build do Netlify
    if (window.NETLIFY_ENV && window.NETLIFY_ENV.SUPABASE_URL) {
      console.log('üì¶ Carregando vari√°veis do build do Netlify');
      return window.NETLIFY_ENV;
    }
    
    // M√©todo 2: Vari√°veis definidas diretamente (fallback)
    if (window.env) {
      return window.env;
    }
    
    // M√©todo 3: Tentar carregar do arquivo netlify-env.js
    try {
      if (window.NETLIFY_ENV) {
        console.log('üì¶ Tentando usar window.NETLIFY_ENV:', window.NETLIFY_ENV);
        return window.NETLIFY_ENV;
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Erro ao carregar window.NETLIFY_ENV:', e);
    }
    
    // M√©todo 4: Valores hardcoded para produ√ß√£o (TEMPOR√ÅRIO para debug)
    if (window.location.hostname === 'eecmjupiara.com.br') {
      console.log('üîß Usando configura√ß√£o hardcoded para produ√ß√£o');
      return {
        SUPABASE_URL: 'https://rvppxdhrahcwiwrrwwaz.supabase.co',
        SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2cHB4ZGhyYWhjd2l3cnJ3d2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNjYyOTMsImV4cCI6MjA1MTg0MjI5M30.8EsOmyF0UMKfqXl6Q-_TfYJYKOMjZKejrGzb1pxqWPI',
        NODE_ENV: 'production'
      };
    }
    
    // M√©todo 5: Fallback para desenvolvimento local
    return {
      SUPABASE_URL: '',
      SUPABASE_ANON_KEY: '',
      NODE_ENV: window.location.hostname.includes('localhost') ? 'development' : 'production',
      APP_BASE_URL: window.location.origin,
      DEBUG_ENABLED: window.location.hostname.includes('localhost'),
      LOG_LEVEL: 'info'
    };
  }

  // Fun√ß√£o para detectar ambiente
  function detectEnvironment() {
    const hostname = window.location.hostname;
    
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      return 'development';
    }
    
    if (hostname.includes('netlify.app') || hostname.includes('netlify.com')) {
      if (window.CONTEXT === 'deploy-preview' || hostname.includes('deploy-preview')) {
        return 'staging';
      }
      return 'production';
    }
    
    // Dom√≠nio personalizado
    return 'production';
  }

  // Carregar configura√ß√µes
  const env = loadNetlifyEnv();
  const environment = detectEnvironment();
  
  // Atribuir vari√°veis globalmente
  window.SUPABASE_URL = env.SUPABASE_URL || '';
  window.SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || '';
  window.NODE_ENV = env.NODE_ENV || environment;
  window.APP_BASE_URL = env.APP_BASE_URL || window.location.origin;
  window.DEBUG_ENABLED = env.DEBUG_ENABLED || (environment === 'development');
  window.LOG_LEVEL = env.LOG_LEVEL || 'info';

  // Configura√ß√µes espec√≠ficas do ambiente
  const environmentConfig = {
    development: {
      apiUrl: 'local',
      enableDebug: true,
      logLevel: 'debug',
      mockData: true,
      hotReload: true
    },
    staging: {
      apiUrl: window.SUPABASE_URL || 'local',
      enableDebug: true,
      logLevel: 'info',
      mockData: false,
      hotReload: false
    },
    production: {
      apiUrl: window.SUPABASE_URL || 'local',
      enableDebug: false,
      logLevel: 'warn',
      mockData: false,
      hotReload: false
    }
  };

  // Aplicar configura√ß√µes do ambiente atual
  const currentConfig = environmentConfig[environment] || environmentConfig.development;
  
  // Atualizar APP_CONFIG global
  if (window.APP_CONFIG) {
    Object.assign(window.APP_CONFIG, {
      environment: environment,
      database: {
        ...window.APP_CONFIG.database,
        useSupabase: !!(window.SUPABASE_URL && window.SUPABASE_ANON_KEY),
        apiUrl: currentConfig.apiUrl
      },
      debug: {
        ...window.APP_CONFIG.debug,
        enabled: window.DEBUG_ENABLED === 'true' || currentConfig.enableDebug,
        logLevel: window.LOG_LEVEL || currentConfig.logLevel
      }
    });
  }

  // Log das configura√ß√µes carregadas (apenas em desenvolvimento)
  if (environment === 'development' || window.DEBUG_ENABLED === 'true') {
    console.group('üåç Configura√ß√µes de Ambiente');
    console.log('Ambiente detectado:', environment);
    console.log('Supabase URL:', window.SUPABASE_URL ? '‚úÖ Configurada' : '‚ùå N√£o configurada');
    console.log('Supabase Key:', window.SUPABASE_ANON_KEY ? '‚úÖ Configurada' : '‚ùå N√£o configurada');
    console.log('Debug habilitado:', window.DEBUG_ENABLED || currentConfig.enableDebug);
    console.log('N√≠vel de log:', window.LOG_LEVEL || currentConfig.logLevel);
    console.log('URL base:', window.APP_BASE_URL);
    
    if (window.NETLIFY) {
      console.log('üåê Informa√ß√µes do Netlify:');
      console.log('- Contexto:', window.CONTEXT || 'N/A');
      console.log('- Branch:', window.BRANCH || 'N/A');
      console.log('- Deploy URL:', window.DEPLOY_URL || 'N/A');
    }
    
    console.groupEnd();
  }

  // Valida√ß√£o das configura√ß√µes cr√≠ticas
  function validateConfig() {
    const issues = [];
    
    if (environment === 'production') {
      if (!window.SUPABASE_URL) {
        issues.push('SUPABASE_URL n√£o est√° configurada para produ√ß√£o');
      }
      
      if (!window.SUPABASE_ANON_KEY) {
        issues.push('SUPABASE_ANON_KEY n√£o est√° configurada para produ√ß√£o');
      }
    }
    
    return issues;
  }

  // Executar valida√ß√£o
  const configIssues = validateConfig();
  
  if (configIssues.length > 0 && (window.DEBUG_ENABLED || environment === 'development')) {
    console.group('‚ö†Ô∏è Problemas de Configura√ß√£o');
    configIssues.forEach(issue => console.warn(issue));
    console.groupEnd();
  }

  // Disparar evento quando as configura√ß√µes estiverem prontas
  window.dispatchEvent(new CustomEvent('envConfigReady', {
    detail: {
      environment,
      supabaseConfigured: !!(window.SUPABASE_URL && window.SUPABASE_ANON_KEY),
      config: currentConfig
    }
  }));

})();