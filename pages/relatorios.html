<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Disciplinares e de Frequência - E.E.C.M. Jupiara</title>
    
    <!-- CSS do seu projeto -->
    <link rel="stylesheet" href="/assets/css/style.css?v=20250911">
    <link rel="stylesheet" href="/assets/css/components.css?v=20250911">
    <link rel="stylesheet" href="/assets/css/dashboard.css?v=20250911">
    <link rel="stylesheet" href="/assets/css/modern-layout.css?v=20250911">
    
    <!-- Script para corrigir cor dos emojis nos títulos -->
    <script src="/assets/js/fix-emoji-titles.js?v=20250911"></script>
    
    <!-- Script para barra superior moderna -->
    <script src="/assets/js/modern-topbar.js?v=20250911"></script>

    <!-- Supabase e configurações -->
    <script src="/netlify-env.js" onerror="console.log('Variáveis do Netlify não encontradas')"></script>
    <script src="/assets/js/env-config.js?v=20250911"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="/assets/js/supabase-only.js?v=20250911"></script>

    <!-- SISTEMA DE SELEÇÃO DE UNIDADE (Sede/Anexa) -->
    <script src="/assets/js/unidade-selector.js"></script>

    <!-- Chart.js para gráficos avançados -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="app-launcher">
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
            </div>
            <span class="app-name">Dashboard Disciplinar</span>
            <span class="school-name">Escola Estadual Cívico-Militar Jupiara</span>
        </div>
        <div class="top-bar-right">
            <div class="user-profile">A</div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="main-layout">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Módulos Principais</div>
                
                <a href="/index.html" class="sidebar-item">
                    <span class="sidebar-icon">🏠</span>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                <a href="/pages/gestao-alunos.html" class="sidebar-item">
                    <span class="sidebar-icon">👥</span>
                    <span class="sidebar-text">Gestão de Alunos</span>
                </a>
                
                <a href="/pages/medidas-disciplinares.html" class="sidebar-item">
                    <span class="sidebar-icon">📋</span>
                    <span class="sidebar-text">Medidas Disciplinares</span>
                </a>
                
                <a href="/pages/consulta-ficha.html" class="sidebar-item">
                    <span class="sidebar-icon">👤</span>
                    <span class="sidebar-text">Ficha Disciplinar</span>
                </a>
                
                <a href="/pages/frequencia.html" class="sidebar-item">
                    <span class="sidebar-icon">📅</span>
                    <span class="sidebar-text">Controle de Frequência</span>
                </a>

                <a href="/pages/boletim.html" class="sidebar-item"><span class="sidebar-icon">📚</span><span class="sidebar-text">Boletim Escolar</span></a>

                <a href="/pages/relatorios.html" class="sidebar-item active">
                    <span class="sidebar-icon">📊</span>
                    <span class="sidebar-text">Relatórios</span>
                </a>
                
                <a href="/pages/analises.html" class="sidebar-item">
                    <span class="sidebar-icon">📈</span>
                    <span class="sidebar-text">Análises</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ferramentas</div>
                
                <a href="/pages/configuracoes.html" class="sidebar-item">
                    <span class="sidebar-icon">⚙️</span>
                    <span class="sidebar-text">Configurações</span>
                </a>
                
                <a href="/pages/comunicacao.html" class="sidebar-item">
                    <span class="sidebar-icon">📱</span>
                    <span class="sidebar-text">Comunicação</span>
                </a>
                
                <a href="/pages/login.html" class="sidebar-item">
                    <span class="sidebar-icon">🔐</span>
                    <span class="sidebar-text">Login/Logout</span>
                </a>
            </div>
        </div>

        <!-- ÁREA DE CONTEÚDO -->
        <div class="content-area">
            <div class="main-content">
                
                <!-- TÍTULO -->
                <div class="module-title">
                    📊 Relatórios Disciplinares e de Frequência
                </div>
                
                <!-- SUBTÍTULO -->
                <div class="info-text" style="text-align: center; margin: 20px 0; color: #666; font-style: italic;">
                    Sistema integrado de análise baseado em views do Postgres
                </div>

                <!-- NAVEGAÇÃO POR ABAS -->
                <div class="management-section">
                    <div class="management-title">
                        📊 Navegação por Categorias
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <button class="btn btn-primary active" onclick="switchTab('disciplinar')">
                                ⚖️ Disciplinar
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="switchTab('frequencia')">
                                📅 Frequência
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="switchTab('comparativo')">
                                📈 Comparativo
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="switchTab('mensal')">
                                📋 Mensal
                            </button>
                        </div>
                    </div>

                    <!-- Controles Globais -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Filtrar por Turma</label>
                            <select id="filtroTurma" class="form-select">
                                <option value="">Todas as turmas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mês de Referência</label>
                            <input type="month" id="filtroMes" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ações</label>
                            <div class="form-actions">
                                <button class="btn btn-info" onclick="atualizarRelatorio()">
                                    🔄 Atualizar
                                </button>
                                <button class="btn btn-success" onclick="exportarCSV()">
                                    📊 Exportar CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONTEÚDO DAS ABAS -->
                <div class="tab-content">
                    
                    <!-- TAB DISCIPLINAR -->
                    <div id="disciplinar" class="tab-pane active">
                        
                        <!-- ESTATÍSTICAS RÁPIDAS -->
                        <div class="quick-stats">
                            <div class="stat-card stat-primary">
                                <div class="stat-icon">👥</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="totalAlunos">0</div>
                                    <div class="stat-label">Total de Alunos</div>
                                </div>
                            </div>
                            <div class="stat-card stat-success">
                                <div class="stat-icon">⭐</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="mediaGeral">8.0</div>
                                    <div class="stat-label">Nota Média Geral</div>
                                </div>
                            </div>
                            <div class="stat-card stat-warning">
                                <div class="stat-icon">⚠️</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="alunosRisco">0</div>
                                    <div class="stat-label">Alunos em Risco</div>
                                </div>
                            </div>
                            <div class="stat-card stat-danger">
                                <div class="stat-icon">🚨</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="alunosCriticos">0</div>
                                    <div class="stat-label">Casos Críticos</div>
                                </div>
                            </div>
                        </div>

                        <!-- GRÁFICO DE DISTRIBUIÇÃO DE NOTAS -->
                        <div class="management-section">
                            <div class="management-title">
                                📊 Distribuição de Notas Disciplinares
                            </div>
                            <div style="height: 400px; background: white; border-radius: 8px; padding: 20px;">
                                <canvas id="chartDistribuicaoNotas"></canvas>
                            </div>
                        </div>

                        <!-- TABELA DE ALUNOS -->
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-title">
                                    📋 Lista de Alunos por Nota Disciplinar
                                </div>
                            </div>
                            <div class="table-content">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Turma</th>
                                            <th>Nota Atual</th>
                                            <th>Classificação</th>
                                            <th>Última Medida</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaNotasDisciplinares">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 20px;">
                                                Carregando dados...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

            <!-- Tab Frequência -->
            <div id="frequencia" class="tab-pane">
                <!-- Estatísticas de Frequência -->
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">📊</div>
                        <div class="stat-value" id="mediaPresenca">0%</div>
                        <div class="stat-label">Presença Média</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon">✅</div>
                        <div class="stat-value" id="totalPresencas">0</div>
                        <div class="stat-label">Total de Presenças</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-icon">❌</div>
                        <div class="stat-value" id="totalFaltas">0</div>
                        <div class="stat-label">Total de Faltas</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">⚠️</div>
                        <div class="stat-value" id="alunosBaixaFreq">0</div>
                        <div class="stat-label">Baixa Frequência</div>
                    </div>
                </div>

                <!-- Gráfico de Frequência por Turma -->
                <div class="charts-section">
                    <h3 class="chart-title">Frequência por Turma</h3>
                    <div class="chart-container">
                        <canvas id="chartFrequenciaTurma"></canvas>
                    </div>
                </div>

                <!-- Tabela de Frequência -->
                <div class="table-section">
                    <h3 class="table-title">
                        📅 Resumo de Frequência por Aluno
                    </h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Turma</th>
                                <th>% Presença</th>
                                <th>Presenças</th>
                                <th>Atestados</th>
                                <th>Faltas</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaFrequencia">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Comparativo -->
            <div id="comparativo" class="tab-pane">
                <!-- Gráfico Comparativo -->
                <div class="charts-section">
                    <h3 class="chart-title">Comparativo: Disciplina vs Frequência por Turma</h3>
                    <div class="chart-container">
                        <canvas id="chartComparativo"></canvas>
                    </div>
                </div>

                <!-- Tabela Comparativa -->
                <div class="table-section">
                    <h3 class="table-title">
                        📊 Análise Comparativa por Turma
                    </h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Turma</th>
                                <th>Total Alunos</th>
                                <th>Nota Disciplinar Média</th>
                                <th>% Frequência Média</th>
                                <th>Casos Críticos</th>
                                <th>Desempenho</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaComparativo">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Mensal -->
            <div id="mensal" class="tab-pane">
                <div class="charts-section">
                    <h3 class="chart-title">Evolução Mensal</h3>
                    <div class="chart-container">
                        <canvas id="chartEvolucaoMensal"></canvas>
                    </div>
                </div>

                <div class="table-section">
                    <h3 class="table-title">
                        📋 Resumo Mensal por Turma
                    </h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Turma</th>
                                <th>Mês</th>
                                <th>Alunos</th>
                                <th>Média Disciplinar</th>
                                <th>% Frequência</th>
                                <th>Tendência</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaMensal">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>

            </div>
        </div>
    </div>

    <!-- JavaScript dos Relatórios -->
    <script type="module">
        // Importar camadas de dados
        import { 
            listNotasDisciplinares, 
            getEstatisticasNotas, 
            getTurmasDisponiveis,
            NotasUtils 
        } from '../data/notas.js';
        
        import { 
            getEstatisticasFrequencia, 
            listFrequenciaAcumulada,
            listMensalDaTurma,
            listComparativoTurmas,
            FrequenciaUtils 
        } from '../data/frequencia.js';
        
        // Importar adaptadores globais para compatibilidade
        import '../adapters/globals.js';
        
        // Tornar funções disponíveis globalmente (caso não sejam pelos adapters)
        window.listNotasDisciplinares = listNotasDisciplinares;
        window.getEstatisticasNotas = getEstatisticasNotas;
        window.getTurmasDisponiveis = getTurmasDisponiveis;
        window.NotasUtils = NotasUtils;
        
        window.getEstatisticasFrequencia = getEstatisticasFrequencia;
        window.listFrequenciaAcumulada = listFrequenciaAcumulada;
        window.listMensalDaTurma = listMensalDaTurma;
        window.listComparativoTurmas = listComparativoTurmas;
        window.FrequenciaUtils = FrequenciaUtils;
    </script>

    <script>
        // Variáveis globais para gerenciamento de charts
        let charts = {
            distribuicao: null,
            frequenciaTurma: null,
            comparativo: null,
            evolucaoMensal: null
        };
        let currentData = null;
        
        // Sistema de Tabs
        function switchTab(tabName) {
            // Atualizar botões
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Atualizar conteúdo
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Carregar dados da tab
            carregarDadosTab(tabName);
        }
        
        // Carregar dados por tab
        async function carregarDadosTab(tabName) {
            switch(tabName) {
                case 'disciplinar':
                    await carregarDadosDisciplinares();
                    break;
                case 'frequencia':
                    await carregarDadosFrequencia();
                    break;
                case 'comparativo':
                    await carregarDadosComparativos();
                    break;
                case 'mensal':
                    await carregarDadosMensais();
                    break;
            }
        }
        
        // Carregar dados disciplinares
        async function carregarDadosDisciplinares() {
            try {
                const turmaFiltro = document.getElementById('filtroTurma').value;
                
                // Obter estatísticas e lista de alunos
                const [estatisticasResult, alunosResult] = await Promise.all([
                    window.getEstatisticasNotas(),
                    window.listNotasDisciplinares({ 
                        turma: turmaFiltro || null,
                        limit: 100,
                        orderBy: 'nota_atual',
                        asc: false 
                    })
                ]);
                
                const estatisticas = estatisticasResult.data;
                const alunos = alunosResult.data || [];
                
                // Atualizar cards de estatísticas
                document.getElementById('totalAlunos').textContent = estatisticas?.totalAlunos || 0;
                document.getElementById('mediaGeral').textContent = estatisticas?.mediaNota?.toFixed(2) || '8.00';
                document.getElementById('alunosRisco').textContent = estatisticas?.distribuicao?.regulares || 0;
                document.getElementById('alunosCriticos').textContent = estatisticas?.distribuicao?.criticos || 0;
                
                // Criar gráfico de distribuição
                criarGraficoDistribuicao(estatisticas);
                
                // Preencher tabela
                preencherTabelaDisciplinar(alunos);
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados disciplinares:', error);
            }
        }
        
        // Carregar dados de frequência  
        async function carregarDadosFrequencia() {
            try {
                console.log('📊 Carregando dados de frequência...');
                const turmaFiltro = document.getElementById('filtroTurma').value;
                
                // Aguardar funções estarem disponíveis
                if (!window.getEstatisticasFrequencia || !window.listFrequenciaAcumulada) {
                    console.warn('⏳ Aguardando carregamento dos adaptadores...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                const estatisticas = await window.getEstatisticasFrequencia(turmaFiltro || null);
                const dados = estatisticas.data;
                
                console.log('📊 Dados de frequência recebidos:', dados);
                
                if (!dados) {
                    console.warn('⚠️ Sem dados de frequência disponíveis');
                    document.getElementById('tabelaFrequencia').innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Nenhum dado de frequência disponível no momento
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Atualizar cards com valores seguros
                document.getElementById('mediaPresenca').textContent = 
                    dados.mediaGeral ? dados.mediaGeral.toFixed(2) + '%' : '0%';
                document.getElementById('totalPresencas').textContent = dados.totaisGerais?.totalPresencas || 0;
                document.getElementById('totalFaltas').textContent = dados.totaisGerais?.totalFaltas || 0;
                document.getElementById('alunosBaixaFreq').textContent = dados.distribuicao?.critica || 0;
                
                // Criar gráfico de frequência por turma
                await criarGraficoFrequenciaTurma(dados);
                
                // Preencher tabela de frequência
                await preencherTabelaFrequencia(dados);
                
                console.log('✅ Dados de frequência carregados com sucesso');
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados de frequência:', error);
                document.getElementById('tabelaFrequencia').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            Erro ao carregar dados de frequência: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Carregar dados comparativos
        async function carregarDadosComparativos() {
            try {
                // Obter dados comparativos
                const [notasResult, frequenciaResult] = await Promise.all([
                    window.getEstatisticasNotas(),
                    window.getEstatisticasFrequencia()
                ]);
                
                const estatisticasNotas = notasResult.data;
                const estatisticasFreq = frequenciaResult.data;
                
                // Criar gráfico comparativo
                criarGraficoComparativo(estatisticasNotas, estatisticasFreq);
                
                // Preencher tabela comparativa
                preencherTabelaComparativa(estatisticasNotas, estatisticasFreq);
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados comparativos:', error);
                document.getElementById('tabelaComparativo').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Erro ao carregar dados comparativos
                        </td>
                    </tr>
                `;
            }
        }
        
        // Carregar dados mensais
        async function carregarDadosMensais() {
            try {
                console.log('📅 Carregando dados mensais...');
                
                // Obter mês selecionado
                const mesInput = document.getElementById('filtroMes').value;
                if (!mesInput) {
                    console.warn('⚠️ Mês não selecionado');
                    return;
                }
                
                // Garantir formato 'YYYY-MM-01' 
                const mesSelecionado = mesInput.includes('-01') ? mesInput : mesInput + '-01';
                console.log('📅 Buscando dados para o mês:', mesSelecionado);
                
                // Aguardar Supabase estar disponível
                if (!window.supabaseClient) {
                    console.warn('⏳ Aguardando Supabase...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // Buscar dados mensais
                const resultado = await window.supabaseClient
                    .from('mv_frequencia_mensal_aluno')
                    .select('*')
                    .eq('mes', mesSelecionado)
                    .order('turma', { ascending: true });
                
                if (resultado.error) {
                    throw resultado.error;
                }
                
                const dados = resultado.data || [];
                
                // Criar gráfico de evolução
                const ctx = document.getElementById('chartEvolucaoMensal').getContext('2d');
                if (charts.evolucaoMensal) {
                    charts.evolucaoMensal.destroy();
                    charts.evolucaoMensal = null;
                }
                
                // Agrupar por turma
                const turmas = [...new Set(dados.map(d => d.turma))];
                const mediasPorTurma = turmas.map(turma => {
                    const alunosTurma = dados.filter(d => d.turma === turma);
                    const soma = alunosTurma.reduce((acc, a) => acc + (a.pct_presenca || 0), 0);
                    return alunosTurma.length > 0 ? soma / alunosTurma.length : 0;
                });
                
                charts.evolucaoMensal = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: turmas,
                        datasets: [{
                            label: 'Média de Presença no Mês (%)',
                            data: mediasPorTurma,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                
                // Preencher tabela mensal
                const tbody = document.getElementById('tabelaMensal');
                if (dados.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                Nenhum dado encontrado para o mês selecionado
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    turmas.forEach((turma, index) => {
                        const alunosTurma = dados.filter(d => d.turma === turma);
                        const totalPresencas = alunosTurma.reduce((acc, a) => acc + (a.total_presencas || 0), 0);
                        const totalFaltas = alunosTurma.reduce((acc, a) => acc + (a.total_faltas || 0), 0);
                        const totalAtestados = alunosTurma.reduce((acc, a) => acc + (a.total_atestados || 0), 0);
                        
                        html += `
                            <tr>
                                <td><strong>${turma}</strong></td>
                                <td>${mesSelecionado.slice(0, 7)}</td>
                                <td>${alunosTurma.length}</td>
                                <td><strong>${mediasPorTurma[index].toFixed(2)}%</strong></td>
                                <td>${totalPresencas + totalAtestados + totalFaltas}</td>
                                <td>
                                    <span class="badge badge-${
                                        mediasPorTurma[index] >= 85 ? 'success' : 
                                        mediasPorTurma[index] >= 75 ? 'warning' : 'danger'
                                    }">
                                        ${mediasPorTurma[index] >= 85 ? 'Boa' : 
                                          mediasPorTurma[index] >= 75 ? 'Regular' : 'Crítica'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados mensais:', error);
                document.getElementById('tabelaMensal').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Erro ao carregar dados: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Função para criar gráfico de distribuição de notas
        function criarGraficoDistribuicao(estatisticas) {
            const ctx = document.getElementById('chartDistribuicaoNotas').getContext('2d');
            
            if (charts.distribuicao) {
                charts.distribuicao.destroy();
                charts.distribuicao = null;
            }
            
            if (!estatisticas?.distribuicao) return;
            
            charts.distribuicao = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Excelentes (9+)', 'Bons (7-9)', 'Regulares (5-7)', 'Críticos (<5)'],
                    datasets: [{
                        data: [
                            estatisticas.distribuicao.excelentes,
                            estatisticas.distribuicao.bons,
                            estatisticas.distribuicao.regulares,
                            estatisticas.distribuicao.criticos
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#17a2b8', 
                            '#ffc107',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Função para preencher tabela disciplinar
        function preencherTabelaDisciplinar(alunos) {
            const tbody = document.getElementById('tabelaNotasDisciplinares');
            
            if (!alunos || alunos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Nenhum dado encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            alunos.forEach(aluno => {
                const nota = aluno.nota_atual || 8.0;
                const classificacao = window.NotasUtils.getDescricaoNota(nota);
                const corBadge = window.NotasUtils.getCorNota(nota);
                const ultimaMedida = aluno.data_ultima_medida ? 
                    new Date(aluno.data_ultima_medida).toLocaleDateString('pt-BR') : 'N/A';
                
                let statusBadge = 'badge-success';
                let statusTexto = 'Normal';
                
                if (nota < 5) {
                    statusBadge = 'badge-danger';
                    statusTexto = 'Crítico';
                } else if (nota < 7) {
                    statusBadge = 'badge-warning';
                    statusTexto = 'Atenção';
                }
                
                html += `
                    <tr>
                        <td><strong>${aluno.nome_completo || 'N/A'}</strong></td>
                        <td>${aluno.turma || 'N/A'}</td>
                        <td><strong>${nota.toFixed(2)}</strong></td>
                        <td><span class="badge ${corBadge}">${classificacao}</span></td>
                        <td>${ultimaMedida}</td>
                        <td><span class="badge ${statusBadge}">${statusTexto}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Criar gráfico de frequência por turma
        async function criarGraficoFrequenciaTurma(dados) {
            const ctx = document.getElementById('chartFrequenciaTurma').getContext('2d');
            
            if (charts.frequenciaTurma) {
                charts.frequenciaTurma.destroy();
                charts.frequenciaTurma = null;
            }
            
            if (!dados?.porTurma || dados.porTurma.length === 0) return;
            
            const turmas = dados.porTurma.map(t => t.turma);
            const medias = dados.porTurma.map(t => t.mediaPresenca || 0);
            
            charts.frequenciaTurma = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: turmas,
                    datasets: [{
                        label: 'Média de Presença (%)',
                        data: medias,
                        backgroundColor: medias.map(m => 
                            m >= 95 ? '#28a745' :
                            m >= 85 ? '#17a2b8' :
                            m >= 75 ? '#ffc107' : '#dc3545'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Preencher tabela de frequência
        async function preencherTabelaFrequencia(dados) {
            const tbody = document.getElementById('tabelaFrequencia');
            
            if (!dados?.alunos || dados.alunos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            Nenhum dado de frequência encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            dados.alunos.forEach(aluno => {
                const pctPresenca = aluno.pct_presenca_operacional || 0;
                const statusCor = window.FrequenciaUtils.getCorPresenca(pctPresenca);
                const statusTexto = window.FrequenciaUtils.getDescricaoPresenca(pctPresenca);
                
                html += `
                    <tr>
                        <td>${aluno.nome_completo || 'N/A'}</td>
                        <td>${aluno.turma || 'N/A'}</td>
                        <td><strong>${pctPresenca.toFixed(2)}%</strong></td>
                        <td>${aluno.total_presencas || 0}</td>
                        <td>${aluno.total_atestados || 0}</td>
                        <td>${aluno.total_faltas || 0}</td>
                        <td><span class="badge badge-${statusCor}">${statusTexto}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Criar gráfico comparativo
        function criarGraficoComparativo(notas, frequencia) {
            const ctx = document.getElementById('chartComparativo').getContext('2d');
            
            if (charts.comparativo) {
                charts.comparativo.destroy();
                charts.comparativo = null;
            }
            
            if (!notas?.porTurma) return;
            
            const turmas = notas.porTurma.map(t => t.turma);
            const mediasNotas = notas.porTurma.map(t => t.mediaNota || 0);
            
            // Mapear frequências por turma
            const mediasFreq = turmas.map(turma => {
                const turmaFreq = frequencia?.porTurma?.find(f => f.turma === turma);
                return turmaFreq?.mediaPresenca || 85;
            });
            
            charts.comparativo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: turmas,
                    datasets: [
                        {
                            label: 'Nota Disciplinar Média',
                            data: mediasNotas,
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Frequência Média (%)',
                            data: mediasFreq,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            max: 10,
                            title: {
                                display: true,
                                text: 'Nota Disciplinar'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            max: 100,
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Frequência (%)'
                            }
                        }
                    }
                }
            });
        }
        
        // Preencher tabela comparativa
        function preencherTabelaComparativa(notas, frequencia) {
            const tbody = document.getElementById('tabelaComparativo');
            
            if (!notas?.porTurma) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Nenhum dado comparativo disponível
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            notas.porTurma.forEach(turma => {
                // Encontrar dados de frequência da turma
                const freqTurma = frequencia?.porTurma?.find(f => f.turma === turma.turma) || {};
                const mediaFreq = freqTurma.mediaPresenca || 85;
                
                const desempenho = turma.mediaNota >= 7 && mediaFreq >= 85 ? 
                    '<span class="badge badge-success">Excelente</span>' :
                    turma.mediaNota >= 5 && mediaFreq >= 75 ?
                    '<span class="badge badge-warning">Regular</span>' :
                    '<span class="badge badge-danger">Crítico</span>';
                
                const casosCriticos = (turma.alunosCriticos || 0) + (freqTurma.alunosCriticos || 0);
                
                html += `
                    <tr>
                        <td><strong>${turma.turma}</strong></td>
                        <td>${turma.totalAlunos}</td>
                        <td>${turma.mediaNota.toFixed(2)}</td>
                        <td>${mediaFreq.toFixed(2)}%</td>
                        <td>${casosCriticos}</td>
                        <td>${desempenho}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Função para atualizar relatório
        async function atualizarRelatorio() {
            const tabAtiva = document.querySelector('.tab.active').onclick.toString().match(/'([^']+)'/)[1];
            await carregarDadosTab(tabAtiva);
        }
        
        // Função para exportar CSV
        function exportarCSV() {
            console.log('📊 Exportando CSV...');
            alert('Funcionalidade de exportação em desenvolvimento');
        }
        
        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', async function() {
            // Aguardar Supabase
            if (!window.supabaseClient) {
                await new Promise(resolve => {
                    const check = setInterval(() => {
                        if (window.supabaseClient) {
                            clearInterval(check);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            // Configurar mês atual
            const hoje = new Date();
            document.getElementById('filtroMes').value = hoje.toISOString().slice(0, 7);
            
            // Carregar turmas para filtro
            try {
                const { data: turmas } = await window.getTurmasDisponiveis();
                const select = document.getElementById('filtroTurma');
                
                turmas?.forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma;
                    option.textContent = turma;
                    select.appendChild(option);
                });
            } catch (error) {
                console.warn('Erro ao carregar turmas:', error);
            }
            
            // Carregar dados iniciais
            await carregarDadosDisciplinares();
            
            console.log('✅ Página de relatórios inicializada');
        });
        
        // Função para toggle da sidebar em mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
        
        // Tornar função global
        window.switchTab = switchTab;
        window.atualizarRelatorio = atualizarRelatorio;
        window.exportarCSV = exportarCSV;
        window.toggleSidebar = toggleSidebar;
    </script>
</body>
</html>