<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Frequência - Dashboard Disciplinar (OBSOLETO)</title>
    
    <!-- CSS Externos -->
    <link rel="stylesheet" href="/assets/css/style.css?v=20250911">
    <link rel="stylesheet" href="/assets/css/components.css?v=20250911">
    <link rel="stylesheet" href="/assets/css/dashboard.css?v=20250911">
    <link rel="stylesheet" href="/assets/css/frequencia.css">
    <link rel="stylesheet" href="/assets/css/modern-layout.css?v=20250911">
    
    <!-- Scripts modernos -->
    <script src="/assets/js/fix-emoji-titles.js?v=20250911"></script>
    <script src="/assets/js/modern-topbar.js?v=20250911"></script>
    
    <!-- APENAS SUPABASE -->
    <script src="../netlify-env.js" onerror="console.log('Variáveis do Netlify não encontradas')"></script>
    <script src="../assets/js/env-config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-only.js"></script>

    <!-- SISTEMA DE SELEÇÃO DE UNIDADE (Sede/Anexa) -->
    <script src="../assets/js/unidade-selector.js"></script>

    <!-- SISTEMA DE TURMAS DINÂMICAS -->
    <script src="../assets/js/turmas-dinamicas.js"></script>

    <!-- Chart.js removido (não utilizado na frequência) -->
    
    <!-- UI Components -->
    <script src="../assets/js/ui/toast.js"></script>
    <script src="../assets/js/main.js"></script>
    
    <!-- WhatsApp Sender Integration -->
    <script defer src="../assets/js/whatsapp-sender.js"></script>

    <!-- AVISO: Sistema legado - use pages/relatorios.html para frequência -->
    <!-- Sistema de Frequência OBSOLETO -->
    <script src="../assets/js/frequencia-supabase.js?v=20250924"></script>
</head>

<body>
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="app-launcher">
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
            </div>
            <span class="app-name">Dashboard Disciplinar</span>
            <span class="school-name">Escola Estadual Cívico-Militar Jupiara</span>
        </div>
        <div class="top-bar-right">
            <div class="user-profile">A</div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="main-layout">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Módulos Principais</div>
                
                <a href="/index.html" class="sidebar-item">
                    <span class="sidebar-icon">🏠</span>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                <a href="/pages/gestao-alunos.html" class="sidebar-item">
                    <span class="sidebar-icon">👥</span>
                    <span class="sidebar-text">Gestão de Alunos</span>
                </a>
                
                <a href="/pages/medidas-disciplinares.html" class="sidebar-item">
                    <span class="sidebar-icon">📋</span>
                    <span class="sidebar-text">Medidas Disciplinares</span>
                </a>
                
                <a href="/pages/consulta-ficha.html" class="sidebar-item">
                    <span class="sidebar-icon">👤</span>
                    <span class="sidebar-text">Ficha Disciplinar</span>
                </a>
                
                <a href="/pages/frequencia.html" class="sidebar-item active">
                    <span class="sidebar-icon">📅</span>
                    <span class="sidebar-text">Controle de Frequência</span>
                </a>

                <a href="/pages/boletim.html" class="sidebar-item"><span class="sidebar-icon">📚</span><span class="sidebar-text">Boletim Escolar</span></a>

                <a href="/pages/relatorios.html" class="sidebar-item">
                    <span class="sidebar-icon">📊</span>
                    <span class="sidebar-text">Relatórios</span>
                </a>
                
                <a href="/pages/analises.html" class="sidebar-item">
                    <span class="sidebar-icon">📈</span>
                    <span class="sidebar-text">Análises</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ferramentas</div>
                
                <a href="/pages/configuracoes.html" class="sidebar-item">
                    <span class="sidebar-icon">⚙️</span>
                    <span class="sidebar-text">Configurações</span>
                </a>
                
                <a href="/pages/comunicacao.html" class="sidebar-item">
                    <span class="sidebar-icon">📱</span>
                    <span class="sidebar-text">Comunicação</span>
                </a>
                
                <a href="/pages/login.html" class="sidebar-item">
                    <span class="sidebar-icon">🔐</span>
                    <span class="sidebar-text">Login/Logout</span>
                </a>
            </div>
        </div>

        <!-- ÁREA DE CONTEÚDO -->
        <div class="content-area">
            <div class="main-content">
                
                <!-- TÍTULO -->
                <div class="module-title">
                    📅 Controle de Frequência
                </div>

                <!-- SEÇÃO: ESTATÍSTICAS RÁPIDAS -->
                <div class="quick-stats">
                    <div class="stat-card stat-success">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="presencasHoje">0</div>
                            <div class="stat-label">Presenças Hoje</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-danger">
                        <div class="stat-icon">❌</div>
                        <div class="stat-content">
                            <div class="stat-number" id="faltasHoje">0</div>
                            <div class="stat-label">Faltas Hoje</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">⚠️</div>
                        <div class="stat-content">
                            <div class="stat-number" id="faltasControladasHoje">0</div>
                            <div class="stat-label">Faltas Controladas</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-info">
                        <div class="stat-icon">🏥</div>
                        <div class="stat-content">
                            <div class="stat-number" id="atestadosHoje">0</div>
                            <div class="stat-label">Atestados Hoje</div>
                        </div>
                    </div>
                </div>

                <!-- PAINEL DE ALERTAS DE FREQUÊNCIA -->
                <div class="management-section" id="painelAlertasFrequencia">
                    <div class="management-title">
                        🚨 Alertas de Frequência (<50%)
                        <button id="toggleAlertas" class="btn btn-small btn-secondary" onclick="toggleListaAlertas()" style="margin-left: 10px;">
                            👁️ Mostrar Lista
                        </button>
                    </div>
                    <div id="alertasFrequenciaContainer">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Carregando alertas de frequência...</p>
                        </div>
                    </div>
                    <div id="listaAlertasDetalhada" style="display: none; margin-top: 15px;">
                        <!-- Lista detalhada será carregada aqui -->
                    </div>
                </div>

                <!-- SEÇÃO: LANÇAMENTO DIÁRIO DE FREQUÊNCIA -->
                <div class="management-section">
                    <div class="management-title">
                        ✏️ Lançar Frequência Diária
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">📅 Data da Frequência *</label>
                            <input type="date" id="dataLancamento" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">🎯 Selecionar Turma *</label>
                            <select id="turmaLancamento" class="form-select" onchange="carregarAlunosLancamento()">
                                <option value="">Selecione uma turma...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">📊 Ações Rápidas:</label>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="marcarTodosPresentes()">
                                    ✅ Todos Presentes
                                </button>
                                <button type="button" class="btn btn-info" onclick="limparMarcacoes()">
                                    🔄 Limpar Marcações
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Alunos -->
                    <div id="containerListaAlunos" style="display: none;">
                        <div class="management-title" style="margin-top: 20px;">
                            👥 Lista de Alunos - <span id="tituloTurmaData"></span>
                        </div>
                        
                        <!-- Legenda -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0;">📋 Legenda das Marcações:</h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <span style="padding: 6px 12px; background: #d4edda; color: #155724; border-radius: 4px; font-weight: bold;">P = Presença</span>
                                <span style="padding: 6px 12px; background: #f8d7da; color: #721c24; border-radius: 4px; font-weight: bold;">F = Falta</span>
                                <span style="padding: 6px 12px; background: #fff3cd; color: #856404; border-radius: 4px; font-weight: bold;">FC = Falta Controlada</span>
                                <span style="padding: 6px 12px; background: #d1ecf1; color: #0c5460; border-radius: 4px; font-weight: bold;">A = Atestado</span>
                            </div>
                        </div>
                        
                        <!-- Lista de Alunos -->
                        <div id="listaAlunosFrequencia" class="alunos-frequencia-lista">
                            <!-- Alunos serão carregados aqui dinamicamente -->
                        </div>
                        
                        <!-- Checkbox WhatsApp -->
                        <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500;">
                                <input type="checkbox" id="enviarWhatsAppFrequencia" style="transform: scale(1.2);">
                                📱 Notificar responsáveis dos alunos faltosos via WhatsApp
                            </label>
                            <small style="color: #666; margin-left: 28px; display: block; margin-top: 4px;">
                                Mensagem será enviada apenas para alunos com Falta (F) ou Falta Controlada (FC)
                            </small>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="form-actions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1dfdd;">
                            <button type="button" class="btn btn-success btn-large" onclick="salvarFrequenciaDiaria()" id="btnSalvarFrequencia" disabled>
                                💾 Salvar Frequência do Dia
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="voltarSelecaoTurma()">
                                ⬅️ Voltar
                            </button>
                        </div>
                        
                        <!-- Status do Salvamento -->
                        <div id="statusSalvamento" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- SEÇÃO: RESUMO POR TURMA -->
                <div class="management-section">
                    <div class="management-title">
                        📊 Resumo por Turma
                    </div>
                    <div id="resumoTurmas" class="quick-stats">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Carregando resumo por turma...</p>
                        </div>
                    </div>
                </div>


                <!-- SEÇÃO: TABELA DE FREQUÊNCIA DETALHADA -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">
                            📋 Frequência Detalhada
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-info btn-small" onclick="aplicarFiltrosFrequencia()">
                                🔄 Atualizar
                            </button>
                            <button class="btn btn-success btn-small" onclick="mostrarTabelaDiaria()">
                                📅 Ver por Dias
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportarRelatorioFrequencia()">
                                📊 Exportar
                            </button>
                        </div>
                    </div>
                    
                    <div id="frequenciaContainer" class="table-content">
                        <div class="info-text">
                            📊 Clique em uma turma acima para visualizar a frequência detalhada dos alunos
                        </div>
                        
                        <!-- Tabela detalhada (será exibida pelo JavaScript) -->
                        <div id="tabela-container" style="display: none;">
                            <table class="data-table">
                                <thead id="tabela-head">
                                    <!-- Cabeçalho será inserido dinamicamente -->
                                </thead>
                                <tbody id="tabela-body">
                                    <!-- Dados serão inseridos dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO: TABELA POR DIAS -->
                <div class="table-container" id="tabelaDiariaContainer" style="display: none;">
                    <div class="table-header">
                        <div class="table-title">
                            📅 Frequência por Dias
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-info btn-small" onclick="atualizarTabelaDiaria()">
                                🔄 Atualizar
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="ocultarTabelaDiaria()">
                                ❌ Fechar
                            </button>
                        </div>
                    </div>
                    
                    <div id="tabelaDiariaContent" class="table-content">
                        <!-- Tabela diária será carregada aqui -->
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- Script para WhatsApp na Frequência -->
    <script>
        // Modificar texto do botão baseado no checkbox
        function atualizarTextoBotaoFrequencia() {
            const checkbox = document.getElementById('enviarWhatsAppFrequencia');
            const btnSalvar = document.getElementById('btnSalvarFrequencia');

            if (checkbox && btnSalvar) {
                if (checkbox.checked) {
                    btnSalvar.innerHTML = '📱💾 Salvar e Enviar WhatsApp';
                } else {
                    btnSalvar.innerHTML = '💾 Salvar Frequência do Dia';
                }
            }
        }

        // Adicionar event listener quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('enviarWhatsAppFrequencia');
            if (checkbox) {
                checkbox.addEventListener('change', atualizarTextoBotaoFrequencia);
            }
        });

        // Função para enviar WhatsApp para alunos faltosos
        async function enviarWhatsAppFaltosos() {
            console.log('📱 Iniciando WhatsApp para faltosos');

            try {
                // Verificar se WhatsApp Sender está disponível
                if (!window.whatsappSender) {
                    throw new Error('Sistema WhatsApp não carregado');
                }

                // Obter dados da turma e data atual
                const turmaSelect = document.getElementById('turmaLancamento');
                const dataInput = document.getElementById('dataLancamento');

                if (!turmaSelect.value || !dataInput.value) {
                    throw new Error('Selecione uma turma e data primeiro');
                }

                const turma = turmaSelect.options[turmaSelect.selectedIndex].text;
                const data = dataInput.value;

                // Coletar alunos faltosos (F ou FC)
                const alunosFaltosos = [];

                // Buscar lista de alunos com frequência (DIVs, não TABLE)
                const listaAlunosFreq = document.getElementById('listaAlunosFrequencia');
                if (!listaAlunosFreq) {
                    throw new Error('Lista de alunos de frequência não encontrada');
                }

                // Buscar todos os itens de aluno na lista
                const alunosItems = listaAlunosFreq.querySelectorAll('.aluno-frequencia-item');
                alunosItems.forEach(item => {
                    const codigo = item.dataset.codigo;
                    const nomeElement = item.querySelector('.aluno-nome');
                    const nome = nomeElement ? nomeElement.textContent.trim() : '';
                    const radioSelecionado = item.querySelector('input[type="radio"]:checked');

                    if (radioSelecionado && (radioSelecionado.value === 'F' || radioSelecionado.value === 'FC')) {
                        alunosFaltosos.push({
                            id: codigo,
                            nome: nome,
                            turma: turma,
                            status: radioSelecionado.value === 'F' ? 'Falta' : 'Falta Controlada'
                        });
                    }
                });

                console.log(`📱 Encontrados: ${alunosFaltosos.length} faltosos na data ${data}`);

                if (alunosFaltosos.length === 0) {
                    showMessage('ℹ️ Nenhum aluno faltoso encontrado para envio de WhatsApp', 'info');
                    return;
                }

                console.log(`📱 ${alunosFaltosos.length} alunos faltosos encontrados`);

                // Mostrar popup de progresso
                const popup = mostrarPopupProgresso(alunosFaltosos.length);

                let sucessos = 0;
                let falhas = 0;

                // Enviar mensagens sequencialmente
                for (let i = 0; i < alunosFaltosos.length; i++) {
                    const aluno = alunosFaltosos[i];

                    // Atualizar popup
                    atualizarPopupProgresso(popup, i + 1, aluno.nome);

                    try {
                        // Criar dados do aluno para compatibilidade
                        const dadosAluno = {
                            id: aluno.id,
                            codigo: aluno.id,
                            nome: aluno.nome,
                            turma: aluno.turma
                        };

                        // Criar dados da "medida" (no caso, falta)
                        const dadosFalta = {
                            tipo: 'Falta Escolar',
                            data: data,
                            especificacao: `${aluno.status} - ${data}`,
                            motivo: 'O aluno não compareceu na escola na data especificada',
                            providencias: ''
                        };

                        // Enviar via WhatsApp Sender usando função de frequência
                        const resultado = await window.whatsappSender.notificarFrequencia(dadosAluno, dadosFalta);

                        if (resultado.success) {
                            sucessos++;
                            console.log(`✅ Enviado: ${aluno.nome}`);
                        } else {
                            falhas++;
                            console.error(`❌ Falha: ${aluno.nome} - ${resultado.error}`);
                        }

                    } catch (error) {
                        falhas++;
                        console.error(`❌ Erro ao enviar para ${aluno.nome}:`, error);
                    }

                    // Pequeno delay para não sobrecarregar
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Fechar popup e mostrar resultado
                fecharPopupProgresso(popup);

                const mensagem = `✅ Envio concluído!\n\n📱 Sucessos: ${sucessos}\n❌ Falhas: ${falhas}`;
                showMessage(mensagem, sucessos > falhas ? 'success' : 'warning');

            } catch (error) {
                console.error('❌ Erro no envio de WhatsApp:', error);
                showMessage('❌ Erro ao enviar WhatsApp: ' + error.message, 'error');
            }
        }

        // Função para mostrar popup de progresso
        function mostrarPopupProgresso(total) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                min-width: 300px;
            `;

            popup.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">📱</div>
                    <h3 style="margin: 0; color: #333;">Enviando WhatsApp</h3>
                    <p style="margin: 10px 0; color: #666;">Aguarde enquanto as mensagens são enviadas...</p>
                </div>
                <div style="background: #f0f0f0; border-radius: 10px; padding: 10px; margin-bottom: 20px;">
                    <div id="progressoTexto" style="font-weight: bold; margin-bottom: 8px;">0 / ${total}</div>
                    <div style="background: #ddd; border-radius: 5px; height: 8px; overflow: hidden;">
                        <div id="progressoBarra" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div id="alunoAtual" style="color: #666; font-size: 14px;">Preparando...</div>
            `;

            // Adicionar overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(popup);

            return { popup, overlay };
        }

        // Função para atualizar popup de progresso
        function atualizarPopupProgresso(popupData, atual, nomeAluno) {
            const progressoTexto = popupData.popup.querySelector('#progressoTexto');
            const progressoBarra = popupData.popup.querySelector('#progressoBarra');
            const alunoAtual = popupData.popup.querySelector('#alunoAtual');

            const total = progressoTexto.textContent.split(' / ')[1];
            const porcentagem = (atual / total) * 100;

            progressoTexto.textContent = `${atual} / ${total}`;
            progressoBarra.style.width = `${porcentagem}%`;
            alunoAtual.textContent = `Enviando para: ${nomeAluno}`;
        }

        // Função para fechar popup de progresso
        function fecharPopupProgresso(popupData) {
            setTimeout(() => {
                if (popupData.overlay.parentNode) {
                    document.body.removeChild(popupData.overlay);
                }
                if (popupData.popup.parentNode) {
                    document.body.removeChild(popupData.popup);
                }
            }, 1500);
        }

        // Interceptar função de salvar frequência
        document.addEventListener('DOMContentLoaded', function() {
            // Aguardar um pouco para garantir que a função original foi carregada
            setTimeout(() => {
                const salvarOriginal = window.salvarFrequenciaDiaria;

                window.salvarFrequenciaDiaria = async function() {
                    // Salvando frequência...

                    const checkboxWhatsApp = document.getElementById('enviarWhatsAppFrequencia');
                    const enviarWhatsApp = checkboxWhatsApp && checkboxWhatsApp.checked;

                    try {
                        // Chamar função original
                        if (salvarOriginal) {
                            const resultado = await salvarOriginal();
                        }

                        // Se checkbox marcado, enviar WhatsApp
                        if (enviarWhatsApp) {
                            setTimeout(enviarWhatsAppFaltosos, 1500);
                        }

                        return true;

                    } catch (error) {
                        console.error('❌ Erro:', error);
                        throw error;
                    }
                };
            }, 2000);
        });
    </script>

</body>
</html>
