<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- META TAGS DE CACHE CONTROL -->
  <meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
  <meta name="deploy-version" content="v2.2.0-20250902-1553">
  
  <title>Login ‚Äî Sistema Disciplinar</title>

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/components.css">
  <link rel="stylesheet" href="../assets/css/dashboard.css">

  <!-- SISTEMA DE AUTENTICA√á√ÉO UNIFICADO -->
  <script src="../netlify-env.js" onerror="console.log('Vari√°veis do Netlify n√£o encontradas')"></script>
  <script src="../assets/js/env-config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="../assets/js/unified-auth.js"></script>
  <script src="../assets/js/supabase-only.js"></script>
  
  <!-- SISTEMA DE CACHE BUSTING (carrega ap√≥s depend√™ncias) -->
  <script src="../assets/js/cache-buster.js"></script>

  <style>
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0078d4,#106ebe);padding:20px}
    .login-card{background:#fff;border-radius:12px;padding:40px;width:100%;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:slideIn .5s ease}
    .login-header{text-align:center;margin-bottom:30px}
    .login-logo{width:64px;height:64px;background:linear-gradient(135deg,#0078d4,#106ebe);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:32px}
    .login-title{font-size:24px;font-weight:700;color:#323130;margin-bottom:8px}
    .login-subtitle{color:#605e5c;font-size:14px}
    .login-form{display:flex;flex-direction:column;gap:20px}
    .login-input{padding:16px;border:2px solid #e1dfdd;border-radius:8px;font-size:16px;transition:all .3s ease;background:#fff}
    .login-input:focus{outline:none;border-color:#0078d4;box-shadow:0 0 0 3px rgba(0,120,212,.1)}
    .login-button{padding:16px;background:linear-gradient(135deg,#0078d4,#106ebe);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;margin-top:10px}
    .login-button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,120,212,.4)}
    .login-button:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
    .message{padding:12px;border-radius:8px;margin:16px 0;text-align:center;font-size:14px}
    .message.error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .message.success{background:#f0fdf4;color:#059669;border:1px solid #bbf7d0}
    @keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">üè´</div>
        <h1 class="login-title">Dashboard Disciplinar</h1>
        <p class="login-subtitle">Sistema Jupiara - Acesso Direto</p>
      </div>

      <form class="login-form" id="loginForm">
        <input type="text" id="loginInput" class="login-input" placeholder="Email ou Nome de Usu√°rio" required>
        <input type="password" id="password" class="login-input" placeholder="Senha" required>
        <button type="submit" class="login-button" id="loginButton">
          üîê Entrar no Sistema
        </button>
      </form>

      <div id="message"></div>
    </div>
  </div>

  <script>
    // Mostrar mensagem
    function showMessage(text, type = 'success') {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
    }

    // Fun√ß√£o para login com username
    async function loginWithUsername(username, password) {
      try {
        // Aguardar inicializa√ß√£o do Supabase se necess√°rio
        if (!window.supabaseClient) {
          console.log('‚è≥ Aguardando inicializa√ß√£o do Supabase...');
          // Aguardar at√© 5 segundos pela inicializa√ß√£o
          for (let i = 0; i < 50; i++) {
            await new Promise(resolve => setTimeout(resolve, 100));
            if (window.supabaseClient) break;
          }
          
          if (!window.supabaseClient) {
            throw new Error('Sistema de autentica√ß√£o n√£o inicializado. Recarregue a p√°gina.');
          }
        }
        
        // Buscar usu√°rio pelo username na tabela personalizada
        const { data: usuarios, error } = await window.supabaseClient
          .from('usuarios_sistema')
          .select('email')
          .ilike('username', username)
          .limit(1);
        
        if (error) {
          // Se a tabela n√£o existir, tentar buscar nos metadados do auth (fallback)
          if (error.code === '42P01') {
            console.log('‚ö†Ô∏è Tabela personalizada n√£o encontrada, usando fallback');
            // Por enquanto, retornar erro j√° que n√£o podemos usar auth.admin
            throw new Error('Sistema de username requer configura√ß√£o adicional');
          }
          throw error;
        }
        
        if (!usuarios || usuarios.length === 0) {
          throw new Error('Usu√°rio n√£o encontrado');
        }
        
        const email = usuarios[0].email;
        
        // Fazer login com o email encontrado
        return await window.unifiedAuth.signIn(email, password);
        
      } catch (error) {
        console.error('Erro no login com username:', error);
        return { success: false, error: error.message };
      }
    }

    // Verificar se j√° est√° logado
    async function checkAuth() {
      await window.unifiedAuth.waitForReady();
      
      if (window.unifiedAuth.isAuthenticated()) {
        const user = window.unifiedAuth.getCurrentUser();
        console.log('‚úÖ Usu√°rio j√° logado:', user.email);
        window.location.href = '../index.html';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Sistema de login unificado inicializando...');
      await checkAuth();
    });

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const loginInput = document.getElementById('loginInput').value.trim();
      const password = document.getElementById('password').value;
      const button = document.getElementById('loginButton');

      if (!loginInput || !password) {
        showMessage('‚ùå Preencha usu√°rio/email e senha', 'error');
        return;
      }

      button.disabled = true;
      button.textContent = '‚è≥ Entrando...';
      
      try {
        let result;
        
        // Verificar se √© email ou username
        if (loginInput.includes('@')) {
          // Login com email
          result = await window.unifiedAuth.signIn(loginInput, password);
        } else {
          // Login com username - buscar email correspondente
          result = await loginWithUsername(loginInput, password);
        }
        
        if (result.success) {
          showMessage('‚úÖ Login realizado com sucesso!', 'success');
          console.log('üéâ Login bem-sucedido para:', result.user.email);
          
          setTimeout(() => {
            window.location.href = '../index.html';
          }, 1000);
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('‚ùå Erro de login:', error);
        showMessage('‚ùå ' + error.message, 'error');
      } finally {
        button.disabled = false;
        button.textContent = 'üîê Entrar no Sistema';
      }
    });

    // Disponibilizar logout globalmente
    window.logoutSystem = () => window.unifiedAuth.signOut();
  </script>
</body>
</html>