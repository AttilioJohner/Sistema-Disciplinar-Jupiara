<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidas Disciplinares - Dashboard Disciplinar</title>
    <link rel="icon" type="image/jpeg" href="../assets/images/logo-escola.jpeg">
    <!-- Deploy test -->
    
    <!-- CSS Externos -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    
    <!-- APENAS SUPABASE -->
    <script src="../netlify-env.js" onerror="console.log('Variáveis do Netlify não encontradas')"></script>
    <script src="../assets/js/env-config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-only.js"></script>
    
    <!-- jsPDF para exportação em PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    
    <!-- Estilos específicos para ficha disciplinar -->
    <style>
        /* Dados pessoais */
        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dado-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .dado-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .dado-valor {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }
        
        /* Sistema de Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .loading-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            color: #666;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading-steps {
            text-align: left;
            margin-top: 20px;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 5px 0;
            font-size: 0.85em;
            color: #666;
        }
        
        .loading-step.active {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .loading-step.completed {
            color: #28a745;
        }
        
        .loading-step-icon {
            margin-right: 8px;
            width: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Top Loading Bar */
        .top-loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            z-index: 9998;
            overflow: hidden;
        }
        
        .top-loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Componentes de Frequência */
        .frequencia-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .frequencia-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .frequencia-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .frequencia-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #17a2b8;
        }
        
        .frequencia-card.presenca-excelente {
            border-left-color: #28a745;
        }
        
        .frequencia-card.presenca-boa {
            border-left-color: #17a2b8;
        }
        
        .frequencia-card.presenca-regular {
            border-left-color: #ffc107;
        }
        
        .frequencia-card.presenca-baixa {
            border-left-color: #dc3545;
        }
        
        .frequencia-card-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .frequencia-card-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .frequencia-card-subtitle {
            font-size: 0.8em;
            color: #888;
        }
        
        .faltas-recentes {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .faltas-recentes-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .falta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #fff5f5;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #dc3545;
        }
        
        .falta-data {
            font-weight: 500;
            color: #dc3545;
        }
        
        .falta-info {
            font-size: 0.85em;
            color: #666;
        }
        
        .sem-faltas {
            text-align: center;
            padding: 20px;
            color: #28a745;
            font-weight: 500;
        }
        
        .ver-todas-faltas {
            display: block;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            color: #007bff;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .ver-todas-faltas:hover {
            background: #e9ecef;
        }
        
        .resumo-mensal {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .resumo-mensal-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resumo-mensal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .resumo-mensal-stat {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .resumo-mensal-stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        
        .resumo-mensal-stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }

        /* Resumos */
        .faltas-resumo, .medidas-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .resumo-item {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .resumo-danger { background: linear-gradient(135deg, #dc3545, #e55565); color: white; }
        .resumo-warning { background: linear-gradient(135deg, #ffc107, #ffcd3c); color: #333; }
        .resumo-info { background: linear-gradient(135deg, #17a2b8, #3bc4db); color: white; }
        .resumo-secondary { background: linear-gradient(135deg, #6c757d, #868e96); color: white; }
        .resumo-success { background: linear-gradient(135deg, #28a745, #34ce57); color: white; }
        
        .resumo-numero {
            display: block;
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .resumo-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
            display: block;
        }
        
        /* Timeline de faltas */
        .faltas-timeline {
            margin-top: 20px;
        }
        
        .mes-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .mes-titulo {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            padding: 12px 20px;
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .faltas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .falta-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .falta-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .falta-simples {
            background: linear-gradient(135deg, #dc3545, #e55565);
            color: white;
        }
        
        .falta-controlada {
            background: linear-gradient(135deg, #ffc107, #ffcd3c);
            color: #333;
        }
        
        .atestado {
            background: linear-gradient(135deg, #17a2b8, #3bc4db);
            color: white;
        }
        
        .falta-icon {
            font-size: 1.8em;
            margin-right: 12px;
        }
        
        .falta-info {
            flex-grow: 1;
        }
        
        .falta-data {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 2px;
        }
        
        .falta-dia {
            font-size: 0.85em;
            opacity: 0.8;
            text-transform: capitalize;
        }
        
        .falta-tipo {
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .stat-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .stat-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .stat-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .stat-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
        
        .stat-icon {
            font-size: 2.5em;
            margin-right: 15px;
            opacity: 0.8;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        /* Breakdown */
        .breakdown-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .breakdown-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #495057;
        }
        
        .breakdown-value {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }
        
        /* Info boxes */
        .info-box {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .info-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .info-box h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        /* Medidas timeline */
        .medidas-timeline {
            margin-top: 20px;
        }
        
        .medida-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .medida-data {
            font-weight: bold;
            color: #495057;
            margin-right: 20px;
            min-width: 100px;
            font-size: 0.9em;
        }
        
        .medida-content {
            flex-grow: 1;
        }
        
        .medida-actions {
            margin-left: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .btn-excluir-medida {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .btn-excluir-medida:hover {
            background: #c82333;
            opacity: 1;
            transform: scale(1.1);
        }
        
        .medida-tipo {
            font-weight: bold;
            color: #dc3545;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        /* Medidas positivas - verde */
        .medida-item.positiva {
            border-left: 4px solid #28a745;
        }
        
        .medida-item.positiva .medida-tipo {
            color: #28a745;
        }
        
        /* Pontuação da medida */
        .medida-pontos {
            display: inline-block;
            margin-left: 10px;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .medida-pontos.positivos {
            background: #d4edda;
            color: #155724;
        }
        
        .medida-pontos.negativos {
            background: #f8d7da;
            color: #721c24;
        }
        
        .medida-descricao {
            color: #495057;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .medida-providencias {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Registros recentes */
        .records-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .record-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .record-student {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }
        
        .record-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-details {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
        }
        
        .record-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .record-turma {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-description {
            color: #495057;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        /* Comparações */
        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .comparison-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .comparison-good {
            border-left-color: #28a745;
        }
        
        .comparison-alert {
            border-left-color: #dc3545;
        }
        
        .comparison-label {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }
        
        .comparison-value {
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 15px;
        }
        
        /* Nota Disciplinar */
        .disciplinary-score-card {
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .score-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .score-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-emoji {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .score-info .score-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .score-info .score-subtitle {
            font-size: 1.1em;
            font-weight: 600;
            opacity: 0.8;
        }
        
        .score-number {
            font-size: 3.5em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 20px;
        }
        
        .score-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.95em;
            color: #495057;
            background: rgba(255,255,255,0.7);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid currentColor;
        }
        
        .score-details span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dados-grid, .faltas-grid, .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .disciplinary-score-card {
                padding: 20px;
            }
            
            .score-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .score-number {
                font-size: 2.5em;
                margin-left: 0;
            }
            
            .score-emoji {
                font-size: 2em;
            }
            
            .score-info .score-title {
                font-size: 1.2em;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .faltas-resumo, .medidas-resumo {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .breakdown-grid {
                grid-template-columns: 1fr;
            }
            
            .medida-item {
                flex-direction: column;
            }
            
            .medida-data {
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>

<body>
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <img src="../assets/images/logo-escola.jpeg" alt="Logo da Escola" class="top-bar-logo" style="height: 40px; margin-right: 15px; border-radius: 4px;">
            <div class="app-launcher">
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
            </div>
            <span class="app-name">Dashboard Disciplinar</span>
        </div>
        <div class="top-bar-center">
            <input type="text" class="search-box" placeholder="Pesquisar registros...">
        </div>
        <div class="top-bar-right">
            <div class="user-profile">A</div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="main-layout">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Módulos Principais</div>
                
                <a href="../index.html" class="sidebar-item">
                    <span class="sidebar-icon">🏠</span>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                
                <a href="gestao-alunos.html" class="sidebar-item">
                    <span class="sidebar-icon">👥</span>
                    <span class="sidebar-text">Gestão de Alunos</span>
                </a>
                
                <a href="medidas-disciplinares.html" class="sidebar-item active">
                    <span class="sidebar-icon">📋</span>
                    <span class="sidebar-text">Medidas Disciplinares</span>
                </a>
                
                <a href="frequencia.html" class="sidebar-item">
                    <span class="sidebar-icon">📅</span>
                    <span class="sidebar-text">Controle de Frequência</span>
                </a>
                
                <a href="relatorios.html" class="sidebar-item">
                    <span class="sidebar-icon">📊</span>
                    <span class="sidebar-text">Relatórios</span>
                </a>
                
                <a href="analises.html" class="sidebar-item">
                    <span class="sidebar-icon">📈</span>
                    <span class="sidebar-text">Análises</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ferramentas</div>
                
                <a href="configuracoes.html" class="sidebar-item">
                    <span class="sidebar-icon">⚙️</span>
                    <span class="sidebar-text">Configurações</span>
                </a>
                
                <a href="comunicacao.html" class="sidebar-item">
                    <span class="sidebar-icon">📱</span>
                    <span class="sidebar-text">Comunicação</span>
                </a>
                
                <a href="login.html" class="sidebar-item">
                    <span class="sidebar-icon">🔐</span>
                    <span class="sidebar-text">Login/Logout</span>
                </a>
            </div>
        </div>

        <!-- ÁREA DE CONTEÚDO -->
        <div class="content-area">
            <div class="main-content">
                
                <!-- TÍTULO -->
                <div class="module-title">
                    📋 Medidas Disciplinares
                </div>

                <!-- SEÇÃO: ESTATÍSTICAS RÁPIDAS -->
                <div class="quick-stats">
                    <div class="stat-card stat-highlight" style="background: linear-gradient(135deg, #28a74520, #17a2b820); border: 2px solid #28a745;">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-content">
                            <div class="stat-number" id="mediaNotaEscola" style="color: #28a745;">0.0</div>
                            <div class="stat-label">Média Disciplinar da Escola</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">⚖️</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalMedidas">0</div>
                            <div class="stat-label">Total de Medidas</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-info">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasMes">0</div>
                            <div class="stat-label">Medidas este Mês</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-success">
                        <div class="stat-icon">📅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasSemana">0</div>
                            <div class="stat-label">Medidas esta Semana</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">👥</div>
                        <div class="stat-content">
                            <div class="stat-number" id="alunosAfetados">0</div>
                            <div class="stat-label">Alunos com Medidas</div>
                        </div>
                    </div>
                </div>

                <!-- PAINEL DE ALERTAS -->
                <div class="management-section" id="painelAlertas">
                    <div class="management-title">
                        🚨 Alertas e Prioridades
                    </div>
                    <div id="alertasContainer">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Carregando alertas...</p>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO: MEDIDAS DISCIPLINARES -->
                <div class="management-section">
                    <div class="management-title">
                        ⚖️ Registrar Medida Disciplinar
                    </div>
                    
                    <form id="formMedida" onsubmit="salvarMedida(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Turma *</label>
                                <select id="turmaMedida" class="form-select" onchange="carregarAlunosPorTurmaMedida()" required>
                                    <option value="">Selecione a turma...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aluno *</label>
                                <select id="alunoMedida" class="form-select" required disabled>
                                    <option value="">Primeiro selecione uma turma...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Data da Ocorrência *</label>
                                <input 
                                    type="date" 
                                    id="dataMedida" 
                                    class="form-input" 
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Medida *</label>
                                <select id="tipoMedida" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    <optgroup label="📈 Medidas Positivas">
                                        <option value="Elogio Individual">Elogio Individual (+0,5)</option>
                                        <option value="Elogio Coletivo">Elogio Coletivo (+0,3)</option>
                                        <option value="Fato Observado Positivo">Fato Observado Positivo (+0,1)</option>
                                    </optgroup>
                                    <optgroup label="📉 Medidas Disciplinares">
                                        <option value="Fato Observado Negativo">Fato Observado Negativo (-0,1)</option>
                                        <option value="Advertência Verbal">Advertência Verbal (-0,3)</option>
                                        <option value="Advertência Escrita">Advertência Escrita (-0,3)</option>
                                        <option value="Suspensão">Suspensão (-0,5 por dia)</option>
                                        <option value="Ação Educativa">Ação Educativa (-1,0)</option>
                                    </optgroup>
                                    <optgroup label="🔄 Medidas Educativas">
                                        <option value="Reunião com Responsáveis">Reunião com Responsáveis</option>
                                        <option value="Encaminhamento Coordenação">Encaminhamento à Coordenação</option>
                                        <option value="Trabalho Educativo">Trabalho Educativo</option>
                                        <option value="Acompanhamento Psicopedagógico">Acompanhamento Psicopedagógico</option>
                                        <option value="Outro">Outro</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Gravidade</label>
                                <select id="gravidadeMedida" class="form-select">
                                    <option value="">Selecione...</option>
                                    <option value="Leve">Leve</option>
                                    <option value="Moderada">Moderada</option>
                                    <option value="Grave">Grave</option>
                                    <option value="Gravíssima">Gravíssima</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="campoSuspensao" style="display: none;">
                                <label class="form-label">Dias de Suspensão *</label>
                                <input 
                                    type="number" 
                                    id="diasSuspensao" 
                                    class="form-input" 
                                    min="1" 
                                    max="30"
                                    placeholder="Número de dias"
                                >
                            </div>
                            
                            <div class="form-group form-group-full">
                                <label class="form-label">Motivo/Descrição *</label>
                                <textarea 
                                    id="motivoMedida" 
                                    class="form-textarea" 
                                    required 
                                    placeholder="Descreva detalhadamente o motivo da medida disciplinar..." 
                                    rows="4"
                                ></textarea>
                            </div>
                            
                            <div class="form-group form-group-full">
                                <label class="form-label">Ações Tomadas</label>
                                <textarea 
                                    id="acoesMedida" 
                                    class="form-textarea" 
                                    placeholder="Descreva as ações tomadas ou que serão tomadas..." 
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="limparFormMedida()">
                                🔄 Limpar
                            </button>
                            <button type="submit" class="btn btn-warning">
                                ⚠️ Salvar Medida
                            </button>
                        </div>
                    </form>
                </div>

                <!-- SEÇÃO: FICHA DISCIPLINAR DO ALUNO -->
                <div class="management-section">
                    <div class="management-title">
                        🔍 Consultar Ficha Disciplinar do Aluno
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Selecionar Turma *</label>
                            <select id="turmaConsulta" class="form-select" onchange="carregarAlunosPorTurma()" required>
                                <option value="">Selecione uma turma...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Selecionar Aluno *</label>
                            <select id="alunoConsulta" class="form-select" onchange="console.log('Aluno selecionado:', this.value); console.log('Funcao disponivel?', typeof carregarFichaDisciplinar); try { carregarFichaDisciplinar(); } catch(e) { console.error('ERRO ao chamar carregarFichaDisciplinar:', e); }" required>
                                <option value="">Primeiro selecione uma turma...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-success" onclick="exportarFichaPDF()" id="btnExportarPDF" disabled>
                                📄 Exportar Ficha em PDF
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-info" onclick="window.debugNotas()">
                                🔍 Debug Notas (Views)
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-secondary" onclick="analisarTiposMedidas()">
                                🔍 Analisar Tipos de Medidas
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-warning" onclick="verFrequenciaAluno()">
                                📅 Ver Frequência do Aluno
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÁREA DE FREQUÊNCIA SEPARADA -->
                    <div id="areaFrequenciaAluno" style="display: none; margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; border: 2px solid #2196f3;">
                        <h4>📅 Frequência do Aluno Selecionado</h4>
                        <div id="resultadoFrequenciaAluno"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="fecharFrequencia()" style="margin-top: 10px;">
                            ✖️ Fechar
                        </button>
                    </div>
                    
                    <!-- ÁREA DE EXIBIÇÃO DA FICHA -->
                    <div id="fichaAluno" class="ficha-container" style="display: none;">
                        <!-- Dados pessoais do aluno -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">👤 Dados Pessoais</h3>
                            <div id="dadosPessoais" class="dados-pessoais"></div>
                        </div>
                        
                        
                        <!-- Histórico de medidas disciplinares -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">⚖️ Histórico de Medidas Disciplinares</h3>
                            <div id="historicoMedidas" class="historico-container"></div>
                        </div>
                        
                        <!-- Frequência Escolar -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">📅 Frequência Escolar</h3>
                            <div id="frequenciaEscolar" class="frequencia-container">
                                <div class="loading-state">
                                    <p>Carregando dados de frequência...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Resumo estatístico -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">📊 Resumo Estatístico</h3>
                            <div id="resumoEstatistico" class="resumo-stats"></div>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO: REGISTROS RECENTES -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">
                            📋 Registros Recentes
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-info btn-small" onclick="carregarRegistrosRecentes()">
                                🔄 Atualizar
                            </button>
                            <select class="filter-select" onchange="filtrarRegistrosRecentes(this.value)">
                                <option value="todos">Todos os tipos</option>
                                <option value="faltas">Apenas Faltas</option>
                                <option value="medidas">Apenas Medidas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="exportarRegistros()">
                                📊 Exportar
                            </button>
                        </div>
                    </div>
                    
                    <div id="registrosRecentes" class="table-content">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Carregando registros recentes...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Sistema de Loading -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-title">Carregando Sistema</div>
            <div class="loading-subtitle">Preparando dados disciplinares...</div>
            
            <div class="progress-container">
                <div id="loadingProgressBar" class="progress-bar"></div>
            </div>
            <div id="loadingProgressText" class="progress-text">0%</div>
            
            <div class="loading-steps">
                <div id="loadingStep1" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Conectando ao banco de dados...</span>
                </div>
                <div id="loadingStep2" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Carregando lista de alunos...</span>
                </div>
                <div id="loadingStep3" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Calculando estatísticas...</span>
                </div>
                <div id="loadingStep4" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Carregando registros recentes...</span>
                </div>
                <div id="loadingStep5" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Finalizando interface...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Loading Bar -->
    <div id="topLoadingBar" class="top-loading-bar" style="display: none;">
        <div id="topLoadingProgress" class="top-loading-progress"></div>
    </div>

    <!-- JAVASCRIPT -->
    
    <script src="../assets/js/main.js" defer></script>
    <script src="../assets/js/gestao.js" defer></script>
    
    <!-- Serviços de notas disciplinares e frequência -->
    <script type="module">
        import { getNotaDisciplinar, NotasUtils } from '../assets/js/notas-disciplinares.js';
        import { 
            getResumoAcumuladoAluno, 
            getFaltasAluno, 
            getResumoMensalAtualAluno,
            FrequenciaUtils 
        } from '../data/frequencia.js';
        
        // Tornar funções disponíveis globalmente
        window.getNotaDisciplinar = getNotaDisciplinar;
        window.NotasUtils = NotasUtils;
        window.getResumoAcumuladoAluno = getResumoAcumuladoAluno;
        window.getFaltasAluno = getFaltasAluno;
        window.getResumoMensalAtualAluno = getResumoMensalAtualAluno;
        window.FrequenciaUtils = FrequenciaUtils;
    </script>
    
    <script>
        // Sistema de Loading Inteligente
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loadingOverlay');
                this.topBar = document.getElementById('topLoadingBar');
                this.progressBar = document.getElementById('loadingProgressBar');
                this.progressText = document.getElementById('loadingProgressText');
                this.topProgress = document.getElementById('topLoadingProgress');
                this.currentStep = 0;
                this.totalSteps = 5;
                this.isVisible = false;
            }
            
            show(title = 'Carregando Sistema', subtitle = 'Preparando dados disciplinares...') {
                if (this.isVisible) return;
                
                document.querySelector('.loading-title').textContent = title;
                document.querySelector('.loading-subtitle').textContent = subtitle;
                
                this.overlay.style.display = 'flex';
                this.topBar.style.display = 'block';
                this.isVisible = true;
                this.currentStep = 0;
                this.updateProgress(0);
            }
            
            hide() {
                setTimeout(() => {
                    this.overlay.style.display = 'none';
                    this.topBar.style.display = 'none';
                    this.isVisible = false;
                }, 500);
            }
            
            updateProgress(percentage, stepText = null) {
                this.progressBar.style.width = percentage + '%';
                this.progressText.textContent = Math.round(percentage) + '%';
                this.topProgress.style.width = percentage + '%';
                
                if (stepText) {
                    const stepNumber = Math.ceil((percentage / 100) * this.totalSteps);
                    this.setStepActive(stepNumber, stepText);
                }
            }
            
            setStepActive(stepNumber, text = null) {
                // Limpar estados anteriores
                for (let i = 1; i <= this.totalSteps; i++) {
                    const step = document.getElementById(`loadingStep${i}`);
                    if (step) {
                        step.classList.remove('active', 'completed');
                        const icon = step.querySelector('.loading-step-icon');
                        if (i < stepNumber) {
                            step.classList.add('completed');
                            icon.textContent = '✅';
                        } else if (i === stepNumber) {
                            step.classList.add('active');
                            icon.textContent = '🔄';
                            if (text) {
                                step.querySelector('span:last-child').textContent = text;
                            }
                        } else {
                            icon.textContent = '⏳';
                        }
                    }
                }
            }
            
            async simulateProgress(duration = 2000) {
                const steps = [
                    { progress: 20, text: 'Conectando ao banco de dados...' },
                    { progress: 40, text: 'Carregando lista de alunos...' },
                    { progress: 60, text: 'Calculando estatísticas...' },
                    { progress: 80, text: 'Carregando registros recentes...' },
                    { progress: 100, text: 'Finalizando interface...' }
                ];
                
                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => {
                        setTimeout(() => {
                            this.updateProgress(steps[i].progress, steps[i].text);
                            resolve();
                        }, duration / steps.length);
                    });
                }
            }
        }
        
        // Instância global do loading
        window.loadingManager = new LoadingManager();
        
        // Inicialização da página com loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 Página de Medidas Disciplinares carregada');
            
            // Mostrar loading imediatamente
            window.loadingManager.show();
            
            // Inicializar sistema com progresso
            inicializarMedidasDisciplinaresComLoading();
        });

        // Carregar alunos para os selects dos formulários
        async function carregarSelectsAlunos() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                console.log('🔄 Carregando alunos do Supabase...');
                const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma')
                    .order('"Nome completo"');

                if (error) throw error;

                const alunos = alunosData.map(item => ({
                    id: item.codigo,
                    codigo: item.codigo,
                    nome: item['Nome completo'],
                    turma: item.turma
                }));

                // Guardar dados para uso posterior
                window.alunosMedidasGlobal = alunos;

                // Preencher select de turmas
                const selectTurmaMedida = document.getElementById('turmaMedida');
                if (selectTurmaMedida) {
                    const turmasUnicas = [...new Set(alunos.map(aluno => aluno.turma))].sort();
                    selectTurmaMedida.innerHTML = '<option value="">Selecione a turma...</option>';
                    turmasUnicas.forEach(turma => {
                        selectTurmaMedida.innerHTML += `<option value="${turma}">${turma}</option>`;
                    });
                }

                // Select de alunos começa desabilitado
                const selectMedida = document.getElementById('alunoMedida');
                if (selectMedida) {
                    selectMedida.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                    selectMedida.disabled = true;
                }

                console.log(`✅ ${alunos.length} alunos carregados nos selects`);
            } catch (error) {
                console.error('❌ Erro ao carregar alunos para os selects:', error);
            }
        }

        // Função para carregar alunos por turma no formulário de medidas
        function carregarAlunosPorTurmaMedida() {
            const selectTurma = document.getElementById('turmaMedida');
            const selectAluno = document.getElementById('alunoMedida');
            
            if (!selectTurma || !selectAluno || !window.alunosMedidasGlobal) return;
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar seleção atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = window.alunosMedidasGlobal.filter(aluno => aluno.turma === turmaSelecionada);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                selectAluno.innerHTML += `<option value="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
            console.log(`✅ Carregados ${alunosDaTurma.length} alunos da turma ${turmaSelecionada} para o formulário de medidas`);
        }

        // Controlar exibição do campo de suspensão
        document.getElementById('tipoMedida').addEventListener('change', function() {
            const campoSuspensao = document.getElementById('campoSuspensao');
            const diasSuspensao = document.getElementById('diasSuspensao');
            
            if (this.value === 'Suspensão') {
                campoSuspensao.style.display = 'block';
                diasSuspensao.required = true;
            } else {
                campoSuspensao.style.display = 'none';
                diasSuspensao.required = false;
                diasSuspensao.value = '';
            }
        });

        // Função para salvar medida disciplinar
        async function salvarMedida(event) {
            event.preventDefault();
            
            const form = event.target;
            const btn = form.querySelector('button[type="submit"]');
            const alunoId = document.getElementById('alunoMedida').value;
            const tipoMedida = document.getElementById('tipoMedida').value;
            const data = document.getElementById('dataMedida').value;
            const gravidade = document.getElementById('gravidadeMedida').value;
            const motivo = document.getElementById('motivoMedida').value;
            const acoes = document.getElementById('acoesMedida').value;
            const diasSuspensao = document.getElementById('diasSuspensao').value;
            
            if (!alunoId) {
                alert('Selecione um aluno');
                return;
            }
            
            if (!tipoMedida) {
                alert('Selecione o tipo de medida');
                return;
            }
            
            if (tipoMedida === 'Suspensão' && !diasSuspensao) {
                alert('Informe o número de dias de suspensão');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Buscar dados do aluno do Supabase
                const { data: dadosAluno, error: alunoError } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma')
                    .eq('codigo', parseInt(alunoId))
                    .single();
                    
                if (alunoError || !dadosAluno) {
                    throw new Error('Aluno não encontrado');
                }
                
                // Salvar medida diretamente no Supabase
                const { data: result, error: saveError } = await window.supabaseClient
                    .from('medidas')
                    .insert([{
                        codigo_matricula: dadosAluno.codigo.toString(),
                        nome_completo: dadosAluno['Nome completo'],
                        turma: dadosAluno.turma,
                        data: data,
                        especificacao: motivo,
                        observacao: acoes,
                        tipo_medida: tipoMedida,
                        criado_em: new Date().toISOString()
                    }]);
                
                if (saveError) throw saveError;
                
                // Atualizar nota disciplinar do aluno
                if (typeof window.atualizarNotaDisciplinar === 'function') {
                    await window.atualizarNotaDisciplinar(alunoId, dadosAluno);
                }
                
                // Limpar formulário
                form.reset();
                document.getElementById('campoSuspensao').style.display = 'none';
                document.getElementById('diasSuspensao').required = false;
                
                // Mostrar mensagem de sucesso
                showMessage('✅ Medida disciplinar salva com sucesso!', 'success');
                
                // Recarregar registros recentes
                await carregarRegistrosRecentes();
                
                // Recarregar estatísticas
                await carregarEstatisticasMedidas();
                
                // Se a ficha do aluno estiver aberta, recarregar
                if (window.dadosAlunoAtual && window.dadosAlunoAtual.id === alunoId) {
                    await carregarFichaDisciplinar();
                }
                
                // Mostrar nota disciplinar atualizada
                showMessage(`🎯 Medida registrada! Nota disciplinar atualizada.`, 'info');
                
            } catch (error) {
                console.error('Erro ao salvar medida:', error);
                alert('Erro ao salvar medida: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '⚠️ Salvar Medida';
            }
        }

        // Nova função de inicialização com sistema de loading
        async function inicializarMedidasDisciplinaresComLoading() {
            try {
                // ETAPA 1: Conectar ao banco (20%)
                window.loadingManager.updateProgress(10, 'Conectando ao banco de dados...');
                
                // Verificar se sistema Supabase está pronto
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                window.loadingManager.updateProgress(20, 'Conectado ao banco de dados');
                
                // ETAPA 2: Carregar lista de alunos (40%)
                window.loadingManager.updateProgress(25, 'Carregando lista de alunos...');
                
                // Definir data atual no formulário
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) dataMedida.value = hoje;
                
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                window.loadingManager.updateProgress(40, 'Alunos carregados com sucesso');
                
                // ETAPA 3: Calcular estatísticas (60%)
                window.loadingManager.updateProgress(45, 'Calculando estatísticas...');
                await carregarEstatisticasMedidas();
                window.loadingManager.updateProgress(60, 'Estatísticas calculadas');
                
                // ETAPA 4: Carregar registros recentes (80%)
                window.loadingManager.updateProgress(65, 'Carregando registros recentes...');
                await carregarRegistrosRecentes();
                window.loadingManager.updateProgress(80, 'Registros carregados');
                
                // ETAPA 5: Finalizar interface (100%)
                window.loadingManager.updateProgress(85, 'Configurando alertas...');
                
                // Carregar alertas em background
                if (typeof carregarAlertas === 'function') {
                    await carregarAlertas();
                }
                
                window.loadingManager.updateProgress(95, 'Finalizando interface...');
                
                // Pequena pausa para mostrar conclusão
                await new Promise(resolve => setTimeout(resolve, 500));
                
                window.loadingManager.updateProgress(100, 'Sistema carregado com sucesso!');
                
                // Aguardar um pouco antes de esconder
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Esconder loading
                window.loadingManager.hide();
                
                console.log('✅ Sistema de medidas disciplinares inicializado com sucesso');
                
            } catch (error) {
                console.error('❌ Erro ao inicializar sistema:', error);
                window.loadingManager.updateProgress(100, 'Erro no carregamento - verifique a conexão');
                
                // Esconder loading após erro
                setTimeout(() => {
                    window.loadingManager.hide();
                    showMessage('Erro ao carregar sistema. Recarregue a página.', 'error');
                }, 2000);
            }
        }

        // Função de inicialização otimizada com carregamento progressivo (ANTIGA - mantida como backup)
        async function inicializarMedidasDisciplinares() {
            try {
                showMessage('Carregando módulo de medidas...', 'success');
                
                // Definir data atual no formulário de medidas (operação rápida)
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) {
                    dataMedida.value = hoje;
                }
                
                // Verificar se sistema Supabase está pronto
                if (!window.supabaseClient) {
                    showMessage('⚠️ Supabase não conectado - aguardando...', 'warning');
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                // ETAPA 1: Carregamento essencial (rápido)
                showMessage('📋 Carregando interface básica...', 'info');
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                showMessage('✅ Interface pronta! Carregando dados em background...', 'success');
                
                // ETAPA 2: Carregamento em background (não bloqueia)
                setTimeout(async () => {
                    try {
                        // Carregar estatísticas em background
                        await carregarEstatisticasMedidas();
                        
                        // Carregar registros recentes em background
                        await carregarRegistrosRecentes();
                        
                        // Carregar alertas em background
                        if (typeof carregarAlertas === 'function') {
                            await carregarAlertas();
                        }
                        
                        console.log('✅ Carregamento completo finalizado');
                    } catch (error) {
                        console.warn('Erro no carregamento em background:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro ao inicializar medidas:', error);
                showMessage('Erro ao carregar módulo de medidas', 'error');
            }
        }

        // Carregar alertas
        async function carregarAlertas() {
            const container = document.getElementById('alertasContainer');
            
            try {
                const alertas = [];
                
                // Verificar alunos com muitas medidas
                const limiteMedidas = parseInt(localStorage.getItem('limiteMedidas') || '5');
                
                // Buscar alunos com muitas medidas usando as views
                try {
                    const { data: alunosRisco, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .lt('nota_atual', 7.0); // Alunos com nota baixa
                    
                    if (!error && alunosRisco) {
                        alunosRisco.forEach(aluno => {
                            let tipo = 'warning';
                            let icone = '⚠️';
                            let texto = '';
                            
                            if (aluno.nota_atual < 5.0) {
                                tipo = 'danger';
                                icone = '🚨';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota CRÍTICA: ${aluno.nota_atual.toFixed(2)}`;
                            } else if (aluno.nota_atual < 6.0) {
                                tipo = 'warning';
                                icone = '⚠️';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota BAIXA: ${aluno.nota_atual.toFixed(2)}`;
                            }
                            
                            if (texto) {
                                alertas.push({ tipo, icone, texto, alunoId: aluno.codigo_aluno });
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Erro ao buscar alunos de risco:', error);
                }
                
                // Verificar se há medidas registradas hoje
                const hoje = new Date().toISOString().split('T')[0];
                try {
                    if (window.db) {
                        const medidasHoje = await window.db.collection('medidas_disciplinares')
                            .get();
                        
                        let contadorHoje = 0;
                        medidasHoje.forEach(doc => {
                            const data = doc.data();
                            const dataMedida = data.data ? data.data.split('T')[0] : null;
                            if (dataMedida === hoje) {
                                contadorHoje++;
                            }
                        });
                        
                        if (contadorHoje > 5) {
                            alertas.push({
                                tipo: 'info',
                                icone: '📊',
                                texto: `${contadorHoje} medidas registradas hoje - dia movimentado`
                            });
                        }
                    }
                } catch (error) {
                    console.log('Erro ao verificar medidas de hoje:', error);
                }
                
                // Exibir alertas
                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-text">✅ Nenhum alerta no momento - situação sob controle</div>
                            <span class="trend-indicator trend-down">📉 Positivo</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = alertas.map(alerta => `
                        <div class="insight-item" ${alerta.alunoId ? `style="cursor: pointer;" onclick="destacarAluno('${alerta.alunoId}')"` : ''}>
                            <div class="insight-text">${alerta.icone} ${alerta.texto}</div>
                            <span class="trend-indicator trend-${alerta.tipo === 'danger' ? 'up' : alerta.tipo === 'warning' ? 'stable' : 'down'}">
                                ${alerta.tipo === 'danger' ? '🚨 Crítico' : alerta.tipo === 'warning' ? '⚠️ Atenção' : 'ℹ️ Info'}
                            </span>
                        </div>
                    `).join('');
                }
                
                console.log(`🚨 ${alertas.length} alerta(s) carregado(s)`);
                
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-text">⚠️ Erro ao carregar alertas</div>
                        <span class="trend-indicator trend-up">❌ Erro</span>
                    </div>
                `;
            }
        }

        // Sistema de Nota Disciplinar
        // REMOVIDO: Função calcularNotaDisciplinar
        // Substituída pelas views v_nota_disciplinar_atual e v_nota_disciplinar_contadores
        
        async function obterNotaDisciplinar(codigoAluno) {
            try {
                // Usar o serviço importado se disponível
                if (window.getNotaDisciplinar) {
                    return await window.getNotaDisciplinar(codigoAluno);
                }
                
                // Fallback para implementação direta
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const { data, error } = await window.supabaseClient
                    .from('v_nota_disciplinar_atual')
                    .select('*')
                    .eq('codigo_aluno', codigoAluno)
                    .limit(1);

                if (error) {
                    console.warn('Erro ao obter nota disciplinar:', error);
                    return { data: null, error };
                }

                return { data: data?.[0] || null, error: null };
            } catch (error) {
                console.error('Erro ao consultar nota disciplinar:', error);
                return { data: null, error };
            }
        }
        
        function obterMencaoDisciplinar(nota) {
            if (nota >= 10) return { mencao: 'Excepcional', cor: '#28a745', emoji: '⭐' };
            if (nota >= 9) return { mencao: 'Ótimo', cor: '#17a2b8', emoji: '😊' };
            if (nota >= 7) return { mencao: 'Bom', cor: '#ffc107', emoji: '🙂' };
            if (nota >= 5) return { mencao: 'Regular', cor: '#fd7e14', emoji: '😐' };
            if (nota >= 2) return { mencao: 'Insuficiente', cor: '#dc3545', emoji: '😟' };
            return { mencao: 'Incompatível', cor: '#6c757d', emoji: '😨' };
        }

        // Função para destacar aluno na busca (placeholder)
        function destacarAluno(alunoId) {
            console.log('Destacando aluno:', alunoId);
            showMessage(`Aluno ${alunoId} selecionado`, 'info');
        }

        // Carregar estatísticas de medidas disciplinares
        async function carregarEstatisticasMedidas() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                console.log('📊 Carregando estatísticas de medidas...');
                
                // Carregar todas as medidas
                const { data: todasMedidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('id, codigo_matricula, criado_em');
                
                if (error) throw error;
                
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay()); // Início da semana (domingo)
                
                // Calcular estatísticas
                const totalMedidas = todasMedidas.length;
                
                const medidasMes = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioMes;
                }).length;
                
                const medidasSemana = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioSemana;
                }).length;
                
                // Contar alunos únicos com medidas
                const alunosUnicos = new Set(todasMedidas.map(medida => medida.codigo_matricula));
                const alunosAfetados = alunosUnicos.size;
                
                // Calcular média de nota disciplinar da escola
                let mediaNotaEscola = 8.0;
                try {
                    // Buscar todos os alunos
                    const { data: todosAlunos } = await window.supabaseClient
                        .from('alunos')
                        .select('codigo');
                    
                    if (todosAlunos && todosAlunos.length > 0) {
                        let somaNotas = 0;
                        const totalAlunos = todosAlunos.length;
                        
                        // Agrupar medidas por aluno
                        const medidasPorAluno = {};
                        todasMedidas.forEach(medida => {
                            if (!medidasPorAluno[medida.codigo_matricula]) {
                                medidasPorAluno[medida.codigo_matricula] = [];
                            }
                            medidasPorAluno[medida.codigo_matricula].push(medida);
                        });
                        
                        // Otimização: Buscar todas as notas de uma vez usando a view
                        try {
                            const { data: todasNotas, error: notasError } = await window.supabaseClient
                                .from('v_nota_disciplinar_atual')
                                .select('codigo_aluno, nota_atual');
                            
                            if (!notasError && todasNotas) {
                                // Criar mapa de notas por aluno
                                const notasPorAluno = {};
                                todasNotas.forEach(nota => {
                                    notasPorAluno[nota.codigo_aluno] = nota.nota_atual;
                                });
                                
                                // Somar notas de todos os alunos
                                todosAlunos.forEach(aluno => {
                                    const notaAluno = notasPorAluno[aluno.codigo] || 8.0;
                                    somaNotas += parseFloat(notaAluno) || 8.0;
                                });
                                
                                console.log(`📊 Notas calculadas via view: ${todasNotas.length} alunos processados`);
                            } else {
                                console.warn('Usando fallback para cálculo de notas:', notasError);
                                // Fallback: todos com nota 8.0
                                somaNotas = todosAlunos.length * 8.0;
                            }
                        } catch (viewError) {
                            console.warn('Erro ao buscar notas via view, usando fallback:', viewError);
                            // Fallback: todos com nota 8.0
                            somaNotas = todosAlunos.length * 8.0;
                        }
                        
                        mediaNotaEscola = (somaNotas / totalAlunos).toFixed(2);
                    }
                } catch (error) {
                    console.error('Erro ao calcular média da escola:', error);
                }
                
                // Atualizar interface
                document.getElementById('totalMedidas').textContent = totalMedidas;
                document.getElementById('medidasMes').textContent = medidasMes;
                document.getElementById('medidasSemana').textContent = medidasSemana;
                document.getElementById('alunosAfetados').textContent = alunosAfetados;
                document.getElementById('mediaNotaEscola').textContent = mediaNotaEscola;
                
                console.log(`📊 Estatísticas: ${totalMedidas} total, ${medidasMes} mês, ${medidasSemana} semana, ${alunosAfetados} alunos, média escola: ${mediaNotaEscola}`);
                
            } catch (error) {
                console.error('❌ Erro ao carregar estatísticas:', error);
                // Valores padrão em caso de erro
                document.getElementById('totalMedidas').textContent = '0';
                document.getElementById('medidasMes').textContent = '0';
                document.getElementById('medidasSemana').textContent = '0';
                document.getElementById('alunosAfetados').textContent = '0';
                document.getElementById('mediaNotaEscola').textContent = '8.00';
            }
        }

        // Carregar registros recentes de medidas
        async function carregarRegistrosRecentes() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                console.log('📋 Carregando registros recentes...');
                
                // Carregar últimas 10 medidas
                const { data: medidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .order('criado_em', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const container = document.getElementById('registrosRecentes');
                
                if (!medidas || medidas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📋</div>
                            <h3>Nenhuma medida encontrada</h3>
                            <p>As medidas disciplinares registradas aparecerão aqui</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="records-list">';
                medidas.forEach(medida => {
                    const dataFormatada = new Date(medida.criado_em).toLocaleDateString('pt-BR');
                    const horaFormatada = new Date(medida.criado_em).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <div class="record-item">
                            <div class="record-header">
                                <span class="record-student">${medida.nome_completo}</span>
                                <span class="record-date">${dataFormatada} às ${horaFormatada}</span>
                            </div>
                            <div class="record-details">
                                <span class="record-type">${medida.tipo_medida}</span>
                                <span class="record-turma">Turma: ${medida.turma}</span>
                            </div>
                            <div class="record-description">${medida.especificacao || 'Sem descrição'}</div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                console.log(`📋 ${medidas.length} registros recentes carregados`);
                
            } catch (error) {
                console.error('❌ Erro ao carregar registros recentes:', error);
                const container = document.getElementById('registrosRecentes');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">❌</div>
                        <h3>Erro ao carregar registros</h3>
                        <p>Tente recarregar a página</p>
                    </div>
                `;
            }
        }

        // Carregar dados de demonstração
        function carregarDadosDemoMedidas() {
            document.getElementById('registrosRecentes').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">📋</div>
                    <h3>Nenhum registro encontrado</h3>
                    <p>Sistema configurado para começar a registrar faltas e medidas</p>
                </div>
            `;

            document.getElementById('alertasContainer').innerHTML = `
                <div class="insight-item">
                    <div class="insight-text">📊 Sistema configurado para ver alertas reais</div>
                    <span class="trend-indicator trend-down">ℹ️ Info</span>
                </div>
            `;
        }

        // ======= FUNÇÕES DE FILTROS DINÂMICOS =======
        
        let todosAlunosMedidas = [];
        let todasTurmasMedidas = [];
        
        async function carregarTurmasEAlunos() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                console.log('🔄 Carregando alunos do Supabase...');
                
                todosAlunosMedidas = [];
                
                // Carregar diretamente do Supabase
                const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma');
                    
                if (error) throw error;
                
                alunosData.forEach(aluno => {
                    if (aluno['Nome completo'] && aluno.turma) {
                        todosAlunosMedidas.push({
                            id: aluno.codigo,
                            codigo: aluno.codigo,
                            nome: aluno['Nome completo'],
                            turma: aluno.turma
                        });
                    }
                });
                
                console.log('✅ Supabase direto:', todosAlunosMedidas.length, 'alunos carregados');
                
                /* CÓDIGO ANTIGO COMENTADO
                try {
                        const response = await fetch('../data/db.json');
                        const dbData = await response.json();
                        if (dbData.alunos) {
                            console.log('FREQ: Carregando alunos do arquivo db.json');
                            todosAlunosMedidas = [];
                            
                            // Converter objeto em array
                            Object.keys(dbData.alunos).forEach(alunoId => {
                                const aluno = dbData.alunos[alunoId];
                                if (aluno.nome_completo && aluno.turma) {
                                    todosAlunosMedidas.push({
                                        id: aluno.id || alunoId,
                                        codigo: aluno.codigo || alunoId,
                                        nome: aluno.nome_completo,
                                        turma: aluno.turma
                                    });
                                }
                            });
                            
                            console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos');
                            console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                        }
                    } catch (fileError) {
                        console.error('Erro ao carregar do arquivo:', fileError);
                        return;
                    }
                } else {
                    console.log('FREQ: Carregando alunos do localDb');
                    todosAlunosMedidas = [];
                    
                    // Carregar alunos do localDb
                    // USAR SISTEMA HÍBRIDO em vez de localDb diretamente
                    const alunosSnapshot = await window.db.collection('alunos').get();
                    alunosSnapshot.docs.forEach(doc => {
                        const aluno = doc.data();
                        if (aluno.nome_completo && aluno.turma) {
                            todosAlunosMedidas.push({
                                id: aluno.id || doc.id,
                                codigo: aluno.codigo || doc.id,
                                nome: aluno.nome_completo,
                                turma: aluno.turma
                            });
                        }
                    });
                    
                    console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos do localDb');
                    console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                }
                */ // Fim do código antigo comentado
                
                // Extrair turmas únicas
                todasTurmasMedidas = [...new Set(todosAlunosMedidas.map(a => a.turma))].sort();
                
                // Carregar turmas no select
                const selectTurma = document.getElementById('turmaConsulta');
                if (selectTurma) {
                    selectTurma.innerHTML = '<option value="">Selecione uma turma...</option>';
                    todasTurmasMedidas.forEach(turma => {
                        selectTurma.innerHTML += `<option value="${turma}">Turma ${turma}</option>`;
                    });
                }
                
                console.log(`✅ Carregados: ${todasTurmasMedidas.length} turmas, ${todosAlunosMedidas.length} alunos`);
                
            } catch (error) {
                console.error('Erro ao carregar turmas e alunos:', error);
            }
        }
        
        function carregarAlunosPorTurma() {
            const selectTurma = document.getElementById('turmaConsulta');
            const selectAluno = document.getElementById('alunoConsulta');
            
            if (!selectTurma || !selectAluno) return;
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar seleção atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = todosAlunosMedidas.filter(aluno => aluno.turma === turmaSelecionada);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                // Usar o ID interno do aluno (que será convertido para código depois)
                selectAluno.innerHTML += `<option value="${aluno.id}" data-codigo="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
            console.log(`✅ Carregados ${alunosDaTurma.length} alunos da turma ${turmaSelecionada}`);
        }
        
        // ======= FUNÇÃO DE CARREGAMENTO DA FICHA DISCIPLINAR =======
        
        async function carregarFichaDisciplinar() {
            // Mostrar loading rápido para ficha
            if (window.loadingManager && !window.loadingManager.isVisible) {
                window.loadingManager.show('Carregando Ficha', 'Buscando dados do aluno...');
                window.loadingManager.updateProgress(30, 'Carregando dados do aluno...');
            }
            try {
                console.log('FICHA: Funcao carregarFichaDisciplinar iniciada');
                const selectAluno = document.getElementById('alunoConsulta');
                const fichaContainer = document.getElementById('fichaAluno');
                const btnExportar = document.getElementById('btnExportarPDF');
                
                console.log('FICHA: Valor do select aluno:', selectAluno ? selectAluno.value : 'SELECT NAO ENCONTRADO');
                
                if (!selectAluno.value) {
                    fichaContainer.style.display = 'none';
                    btnExportar.disabled = true;
                    return;
                }
                
                showMessage('🔄 Carregando ficha disciplinar...', 'loading');
                
                // Carregar dados do aluno dos dados locais
                let alunoData = null;
                
                // Tentar encontrar o aluno nos dados globais
                if (window.alunosCarregados && window.alunosCarregados.length > 0) {
                    alunoData = window.alunosCarregados.find(aluno => aluno.id === selectAluno.value);
                    console.log('FICHA: Dados do aluno encontrados nos dados globais:', alunoData);
                }
                
                // Se não encontrou nos dados globais, buscar dos dados locais do select
                if (!alunoData) {
                    console.log('FICHA: Buscando aluno nos dados locais carregados...');
                    // Buscar nos dados locais carregados para o select
                    const alunoEncontrado = todosAlunosMedidas.find(aluno => 
                        aluno.codigo === selectAluno.value || aluno.id === selectAluno.value
                    );
                    
                    if (alunoEncontrado) {
                        alunoData = alunoEncontrado;
                        console.log('FICHA: Aluno encontrado nos dados locais:', alunoData);
                    } else {
                        console.log('FICHA: Criando dados básicos para o aluno:', selectAluno.value);
                        
                        // Tentar buscar turma dos dados de medidas se disponível
                        let turmaAluno = 'N/A';
                        if (window.alunosMedidasGlobal) {
                            const alunoComTurma = window.alunosMedidasGlobal.find(a => a.codigo == selectAluno.value || a.id == selectAluno.value);
                            if (alunoComTurma) {
                                turmaAluno = alunoComTurma.turma || 'N/A';
                            }
                        }
                        
                        alunoData = {
                            id: selectAluno.value,
                            nome: selectAluno.options[selectAluno.selectedIndex]?.text || 'Aluno não identificado',
                            codigo: selectAluno.value,
                            turma: turmaAluno
                        };
                    }
                }
                
                // Se ainda não temos turma, tentar buscar do Supabase
                if (!alunoData.turma || alunoData.turma === 'N/A') {
                    try {
                        const { data: dadosSupabase, error } = await window.supabaseClient
                            .from('alunos')
                            .select('turma, "Nome completo"')
                            .eq('codigo', parseInt(selectAluno.value))
                            .single();
                            
                        if (!error && dadosSupabase) {
                            alunoData.turma = dadosSupabase.turma || 'N/A';
                            alunoData.nome_completo = dadosSupabase['Nome completo'] || alunoData.nome;
                            console.log('FICHA: Dados complementados do Supabase:', dadosSupabase);
                        }
                    } catch (error) {
                        console.warn('FICHA: Não foi possível buscar dados do Supabase:', error);
                    }
                }
                
                console.log('FICHA: Dados finais do aluno utilizados:', alunoData);
                
                // Carregar medidas disciplinares do aluno (usar dados locais se disponível)
                let medidas = [];
                
                try {
                    // Aguardar supabaseClient estar disponível
                    if (!window.supabaseClient) {
                        await new Promise(resolve => {
                            const check = setInterval(() => {
                                if (window.supabaseClient) {
                                    clearInterval(check);
                                    resolve();
                                }
                            }, 100);
                        });
                    }
                    
                    console.log('FICHA: Tentando carregar medidas do Supabase...');
                    const { data: medidasData, error } = await window.supabaseClient
                        .from('medidas')
                        .select('*')
                        .eq('codigo_matricula', selectAluno.value)
                        .order('criado_em', { ascending: false });
                        
                    if (error) throw error;
                    
                    console.log(`FICHA: Query retornou ${medidasData?.length || 0} medidas para código ${selectAluno.value}`);
                    
                    if (medidasData) {
                        medidasData.forEach(item => {
                            const medidaData = {
                                id: item.id,
                                codigo_aluno: item.codigo_matricula,
                                nome_aluno: item.nome_completo,
                                turma: item.turma,
                                data: item.data,
                                especificacao: item.especificacao,
                                observacao: item.observacao,
                                tipo_medida: item.tipo_medida,
                                data_registro: item.criado_em
                            };
                            console.log('FICHA: Medida encontrada:', medidaData);
                            medidas.push(medidaData);
                        });
                    }
                } catch (supaError) {
                    console.log('FICHA: Erro ao carregar medidas do Supabase:', supaError.message);
                }
                
                // Debug: Listar todas as medidas disponíveis
                try {
                    const { data: todasMedidas, error: debugError } = await window.supabaseClient
                        .from('medidas')
                        .select('id, codigo_matricula, nome_completo');
                        
                    if (!debugError && todasMedidas) {
                        console.log(`DEBUG: Total de medidas na tabela: ${todasMedidas.length}`);
                        todasMedidas.forEach(item => {
                            console.log(`DEBUG: Medida ID ${item.id} - Código: ${item.codigo_matricula}, Nome: ${item.nome_completo}`);
                        });
                    }
                } catch (debugError) {
                    console.log('DEBUG: Erro ao listar todas as medidas:', debugError.message);
                }
                
                console.log('FICHA: Encontradas ' + medidas.length + ' medidas disciplinares');
                
                console.log('FICHA: Carregando frequência...');
                
                // Atualizar progresso antes de exibir
                if (window.loadingManager && window.loadingManager.isVisible) {
                    window.loadingManager.updateProgress(80, 'Processando dados...');
                }
                
                // Exibir ficha completa
                await exibirFichaDisciplinar(alunoData, medidas);
                
                // Finalizar loading
                if (window.loadingManager && window.loadingManager.isVisible) {
                    window.loadingManager.updateProgress(100, 'Ficha carregada!');
                    setTimeout(() => window.loadingManager.hide(), 500);
                }
                
                fichaContainer.style.display = 'block';
                btnExportar.disabled = false;
                
                showMessage('✅ Ficha disciplinar carregada com sucesso!', 'success');
                
            } catch (error) {
                console.error('FICHA: ERRO CAPTURADO na funcao carregarFichaDisciplinar:', error);
                console.error('FICHA: Stack trace:', error.stack);
                
                // Esconder loading em caso de erro
                if (window.loadingManager && window.loadingManager.isVisible) {
                    window.loadingManager.updateProgress(100, 'Erro ao carregar ficha');
                    setTimeout(() => window.loadingManager.hide(), 1000);
                }
                showMessage('❌ Erro ao carregar ficha disciplinar: ' + error.message, 'error');
                const fichaContainer = document.getElementById('fichaAluno');
                const btnExportar = document.getElementById('btnExportarPDF');
                if (fichaContainer) fichaContainer.style.display = 'none';
                if (btnExportar) btnExportar.disabled = true;
            }
        }
        
        
        
        // Função para excluir medida disciplinar
        async function excluirMedida(medidaId, botao) {
            // Primeira confirmação
            if (!confirm('⚠️ Tem certeza que deseja excluir esta medida disciplinar?\n\nEsta ação não pode ser desfeita.')) {
                return;
            }
            
            // Segunda confirmação mais específica
            if (!confirm('🚨 CONFIRMAÇÃO FINAL:\n\nVocê está prestes a EXCLUIR PERMANENTEMENTE esta medida disciplinar do sistema.\n\nEsta operação:\n• Remove a medida do Supabase\n• Afeta o cálculo da nota disciplinar\n• NÃO pode ser desfeita\n\nDeseja realmente continuar?')) {
                return;
            }
            
            try {
                botao.disabled = true;
                botao.style.opacity = '0.5';
                botao.textContent = '⏳';
                
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                console.log('🗑️ Excluindo medida ID:', medidaId);
                
                // Excluir do Supabase
                const { error } = await window.supabaseClient
                    .from('medidas')
                    .delete()
                    .eq('id', medidaId);
                
                if (error) throw error;
                
                // Remover o item da interface
                const medidaItem = document.querySelector(`[data-medida-id="${medidaId}"]`);
                if (medidaItem) {
                    medidaItem.style.transition = 'all 0.3s ease';
                    medidaItem.style.opacity = '0';
                    medidaItem.style.transform = 'translateX(-100%)';
                    
                    setTimeout(() => {
                        medidaItem.remove();
                        
                        // Verificar se ainda há medidas
                        const medidasRestantes = document.querySelectorAll('.medida-item');
                        if (medidasRestantes.length === 0) {
                            document.getElementById('historicoMedidas').innerHTML = `
                                <div class="info-box info-success">
                                    <h4>✅ Comportamento exemplar!</h4>
                                    <p>Este aluno não possui medidas disciplinares registradas</p>
                                </div>
                            `;
                        }
                    }, 300);
                }
                
                showMessage('✅ Medida disciplinar excluída com sucesso!', 'success');
                
                // Recarregar estatísticas
                await carregarEstatisticasMedidas();
                
                console.log('✅ Medida excluída com sucesso');
                
            } catch (error) {
                console.error('❌ Erro ao excluir medida:', error);
                showMessage('❌ Erro ao excluir medida: ' + error.message, 'error');
                
                // Restaurar botão em caso de erro
                botao.disabled = false;
                botao.style.opacity = '0.7';
                botao.textContent = '🗑️';
            }
        }

        async function exibirFichaDisciplinar(aluno, medidas) {
            // Dados pessoais
            document.getElementById('dadosPessoais').innerHTML = `
                <div class="dados-grid">
                    <div class="dado-item">
                        <span class="dado-label">Nome:</span>
                        <span class="dado-valor">${aluno.nome_completo || aluno.nome || 'N/A'}</span>
                    </div>
                    <div class="dado-item">
                        <span class="dado-label">Código:</span>
                        <span class="dado-valor">${aluno.codigo || aluno.id || 'N/A'}</span>
                    </div>
                    <div class="dado-item">
                        <span class="dado-label">Turma:</span>
                        <span class="dado-valor">${aluno.turma || aluno.Turma || 'N/A'}</span>
                    </div>
                </div>
            `;
            
            
            // Dados de frequência escolar
            await exibirFrequenciaEscolar(aluno);
            
            // Histórico de medidas disciplinares
            exibirHistoricoMedidas(medidas);
            
            // Resumo estatístico
            await exibirResumoEstatistico(aluno, medidas);
        }
        
        // Função para exibir dados de frequência escolar
        async function exibirFrequenciaEscolar(aluno) {
            const container = document.getElementById('frequenciaEscolar');
            const codigoAluno = aluno.codigo || aluno.id || aluno.codigo_matricula;
            
            try {
                // Obter dados de frequência em paralelo
                const [resumoResult, faltasResult, mensalResult] = await Promise.all([
                    window.getResumoAcumuladoAluno(codigoAluno),
                    window.getFaltasAluno(codigoAluno, 5), // Últimas 5 faltas
                    window.getResumoMensalAtualAluno(codigoAluno)
                ]);
                
                const resumoAcumulado = resumoResult.data;
                const faltas = faltasResult.data || [];
                const resumoMensal = mensalResult.data;
                
                // Determinar classe de presença para estilo
                let classePresenca = 'presenca-regular';
                if (resumoAcumulado?.pct_presenca_operacional) {
                    const pct = resumoAcumulado.pct_presenca_operacional;
                    if (pct >= 95) classePresenca = 'presenca-excelente';
                    else if (pct >= 85) classePresenca = 'presenca-boa';
                    else if (pct >= 75) classePresenca = 'presenca-regular';
                    else classePresenca = 'presenca-baixa';
                }
                
                // Gerar HTML da seção de frequência
                container.innerHTML = `
                    <div class="frequencia-grid">
                        <!-- Card de Presença Acumulada -->
                        <div class="frequencia-card ${classePresenca}">
                            <div class="frequencia-card-title">
                                📊 Presença Acumulada
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoAcumulado.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.getDescricaoPresenca(resumoAcumulado.pct_presenca_operacional) : 
                                    'Dados não disponíveis'
                                }
                            </div>
                            ${resumoAcumulado ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoAcumulado.presencas || 0}P + ${resumoAcumulado.atestados || 0}A + ${resumoAcumulado.faltas || 0}F = ${resumoAcumulado.total_aulas || 0} aulas
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Card do Resumo Mensal -->
                        <div class="frequencia-card">
                            <div class="frequencia-card-title">
                                📅 Mês Atual
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoMensal.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarMesAno(resumoMensal.mes) : 
                                    'Dados não disponíveis'
                                }
                            </div>
                            ${resumoMensal ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoMensal.presencas || 0}P + ${resumoMensal.atestados || 0}A + ${resumoMensal.faltas || 0}F
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Faltas Recentes -->
                    <div class="faltas-recentes">
                        <div class="faltas-recentes-title">
                            📋 Faltas Recentes
                        </div>
                        ${faltas.length > 0 ? 
                            faltas.map(falta => `
                                <div class="falta-item">
                                    <div class="falta-data">
                                        ${window.FrequenciaUtils.formatarData(falta.data)}
                                    </div>
                                    <div class="falta-info">
                                        ${falta.turma || 'Turma não informada'}
                                    </div>
                                </div>
                            `).join('') :
                            `<div class="sem-faltas">
                                ✅ Nenhuma falta registrada recentemente
                            </div>`
                        }
                        ${faltas.length >= 5 ? `
                            <a href="#" class="ver-todas-faltas" onclick="verTodasFaltas('${codigoAluno}')">
                                Ver todas as faltas
                            </a>
                        ` : ''}
                    </div>
                `;
                
                console.log(`📅 Frequência exibida para aluno ${codigoAluno}`);
                
            } catch (error) {
                console.error('❌ Erro ao exibir frequência:', error);
                
                // Fallback em caso de erro
                container.innerHTML = `
                    <div class="frequencia-card">
                        <div class="frequencia-card-title">
                            ⚠️ Erro ao Carregar
                        </div>
                        <div class="frequencia-card-subtitle" style="color: #dc3545;">
                            Não foi possível carregar os dados de frequência.
                            Tente novamente mais tarde.
                        </div>
                    </div>
                `;
            }
        }
        
        // Função para mostrar todas as faltas de um aluno
        async function verTodasFaltas(codigoAluno) {
            try {
                const { data: todasFaltas } = await window.getFaltasAluno(codigoAluno, 50);
                
                if (!todasFaltas || todasFaltas.length === 0) {
                    alert('Nenhuma falta encontrada para este aluno.');
                    return;
                }
                
                // Criar modal ou popup com todas as faltas
                const faltasHTML = todasFaltas.map(falta => 
                    `${window.FrequenciaUtils.formatarData(falta.data)} - ${falta.turma || 'N/A'}`
                ).join('\n');
                
                alert(`Todas as faltas do aluno:\n\n${faltasHTML}`);
                
            } catch (error) {
                console.error('❌ Erro ao carregar todas as faltas:', error);
                alert('Erro ao carregar faltas. Tente novamente.');
            }
        }
        
        
        // Função para calcular pontos de uma medida
        function calcularPontosMedida(tipoMedida, diasSuspensao = 1) {
            let pontos = 0;
            
            // Medidas positivas
            if (tipoMedida === 'Elogio Individual') pontos = 0.5;
            else if (tipoMedida === 'Elogio Coletivo') pontos = 0.3;
            else if (tipoMedida === 'Fato Observado Positivo') pontos = 0.1;
            
            // Medidas negativas
            else if (tipoMedida === 'Fato Observado Negativo') pontos = -0.1;
            else if (tipoMedida === 'Advertência Verbal' || tipoMedida === 'Advertência Escrita' || tipoMedida === 'Advertência') pontos = -0.3;
            else if (tipoMedida === 'Suspensão') {
                pontos = -0.5 * diasSuspensao;
            }
            else if (tipoMedida === 'Ação Educativa') pontos = -1.0;
            
            return pontos;
        }

        // Função para verificar se é medida positiva
        function isMedidaPositiva(tipoMedida) {
            return ['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida);
        }

        function exibirHistoricoMedidas(medidas) {
            const container = document.getElementById('historicoMedidas');
            
            if (!medidas || medidas.length === 0) {
                container.innerHTML = `
                    <div class="info-box info-success">
                        <h4>✅ Comportamento exemplar!</h4>
                        <p>Este aluno não possui medidas disciplinares registradas</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar medidas por data (mais recentes primeiro)
            medidas.sort((a, b) => new Date(b.data_registro) - new Date(a.data_registro));
            
            let html = `
                <div class="medidas-resumo">
                    <div class="resumo-item resumo-warning">
                        <span class="resumo-numero">${medidas.length}</span>
                        <span class="resumo-label">Total de Medidas</span>
                    </div>
                </div>
                
                <div class="medidas-timeline">
            `;
            
            medidas.forEach(medida => {
                const dataFormatada = new Date(medida.data_registro).toLocaleDateString('pt-BR');
                const tipoMedida = medida.tipo_medida || 'N/A';
                const diasSuspensao = medida.dias_suspensao || 1;
                const pontos = calcularPontosMedida(tipoMedida, diasSuspensao);
                const isPositiva = isMedidaPositiva(tipoMedida);
                
                // Debug para verificar pontos
                console.log(`🔍 EXIBIÇÃO: "${tipoMedida}" = ${pontos} pontos`);
                
                // Formatar exibição dos pontos
                let pontosTexto = '';
                if (pontos > 0) {
                    pontosTexto = `<span class="medida-pontos positivos">+${pontos}</span>`;
                } else if (pontos < 0) {
                    pontosTexto = `<span class="medida-pontos negativos">${pontos}</span>`;
                } else if (pontos === 0) {
                    pontosTexto = `<span class="medida-pontos" style="background:#ffeaa7; color:#d63031;">⚠️ 0</span>`;
                }
                
                html += `
                    <div class="medida-item ${isPositiva ? 'positiva' : ''}" data-medida-id="${medida.id}">
                        <div class="medida-data">${dataFormatada}</div>
                        <div class="medida-content">
                            <div class="medida-tipo">
                                ${tipoMedida}
                                ${pontosTexto}
                            </div>
                            <div class="medida-descricao">
                                <strong>Especificação:</strong> ${medida.especificacao || 'N/A'}
                            </div>
                            ${medida.observacao ? `<div class="medida-providencias"><strong>Observações:</strong> ${medida.observacao}</div>` : ''}
                        </div>
                        <div class="medida-actions">
                            <button class="btn-excluir-medida" onclick="excluirMedida('${medida.id}', this)" title="Excluir medida">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function exibirResumoEstatistico(aluno, medidas) {
            const container = document.getElementById('resumoEstatistico');
            const totalMedidas = medidas.length;
            
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Calcular estatísticas avançadas
                let mediasRecentes = 0;
                let tipoMaisComum = 'N/A';
                let mediaGeral = 0;
                let posicaoRanking = 'N/A';
                
                if (medidas.length > 0) {
                    // Medidas nos últimos 30 dias
                    const dataLimite = new Date();
                    dataLimite.setDate(dataLimite.getDate() - 30);
                    mediasRecentes = medidas.filter(m => 
                        new Date(m.data_registro) >= dataLimite
                    ).length;
                    
                    // Tipo mais comum
                    const tiposCount = {};
                    medidas.forEach(m => {
                        tiposCount[m.tipo_medida] = (tiposCount[m.tipo_medida] || 0) + 1;
                    });
                    tipoMaisComum = Object.keys(tiposCount).reduce((a, b) => 
                        tiposCount[a] > tiposCount[b] ? a : b, 'N/A'
                    );
                }
                
                // Buscar dados gerais para comparação
                const { data: todasMedidas } = await window.supabaseClient
                    .from('medidas')
                    .select('codigo_matricula, criado_em');
                
                if (todasMedidas) {
                    // Calcular média geral por aluno
                    const alunosCount = {};
                    todasMedidas.forEach(m => {
                        alunosCount[m.codigo_matricula] = (alunosCount[m.codigo_matricula] || 0) + 1;
                    });
                    
                    const medidasPorAluno = Object.values(alunosCount);
                    mediaGeral = medidasPorAluno.length > 0 ? 
                        (medidasPorAluno.reduce((a, b) => a + b, 0) / medidasPorAluno.length).toFixed(1) : 0;
                    
                    // Calcular posição no ranking (quantos alunos têm mais medidas)
                    const alunosComMais = medidasPorAluno.filter(count => count > totalMedidas).length;
                    posicaoRanking = `${alunosComMais + 1}º de ${medidasPorAluno.length}`;
                }
                
                // Obter nota disciplinar das views (nova implementação)
                let notaDisciplinar = 8.0;
                let dadosNota = null;
                
                try {
                    const codigoAluno = aluno.codigo || aluno.id || selectAluno.value;
                    
                    const { data: notaData, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .eq('codigo_aluno', codigoAluno)
                        .limit(1);
                    
                    if (!error && notaData && notaData.length > 0) {
                        dadosNota = notaData[0];
                        notaDisciplinar = dadosNota.nota_atual || 8.0;
                        console.log(`📊 Nota obtida das views para ${codigoAluno}:`, notaDisciplinar);
                    } else {
                        console.log(`⚠️ Nota não encontrada para ${codigoAluno}, usando padrão 8.0`);
                    }
                } catch (error) {
                    console.warn('Erro ao obter nota das views:', error);
                }
                
                const mencao = obterMencaoDisciplinar(notaDisciplinar);
                
                container.innerHTML = `
                    <!-- Nota Disciplinar - Destaque Principal -->
                    <div class="disciplinary-score-card" style="background: linear-gradient(135deg, ${mencao.cor}20, ${mencao.cor}10); border: 2px solid ${mencao.cor}; margin-bottom: 20px;">
                        <div class="score-content">
                            <div class="score-header">
                                <span class="score-emoji">${mencao.emoji}</span>
                                <div class="score-info">
                                    <div class="score-title">Nota Disciplinar</div>
                                    <div class="score-subtitle">${mencao.mencao}</div>
                                </div>
                            </div>
                            <div class="score-number" style="color: ${mencao.cor};">${notaDisciplinar.toFixed(2)}</div>
                        </div>
                        
                        ${dadosNota.data_ultima_negativa ? `
                            <div class="score-details">
                                <span>Última ocorrência negativa: ${dadosNota.dias_desde_ultima_negativa || 0} dias atrás</span>
                                ${dadosNota.bonus_ativo ? 
                                    `<span style="color: #28a745;">🎉 Bônus de recuperação ativo!</span>` : 
                                    `<span>Aguardando período de recuperação</span>`
                                }
                            </div>
                        ` : `
                            <div class="score-details">
                                <span style="color: #28a745;">✨ Nenhuma medida negativa registrada!</span>
                            </div>
                        `}
                    </div>
                
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">⚖️</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-info">
                            <div class="stat-icon">📊</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediaGeral}</div>
                                <div class="stat-label">Média Geral (por aluno)</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-danger">
                            <div class="stat-icon">📈</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediasRecentes}</div>
                                <div class="stat-label">Últimos 30 dias</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-primary">
                            <div class="stat-icon">🏆</div>
                            <div class="stat-content">
                                <div class="stat-number">${posicaoRanking}</div>
                                <div class="stat-label">Ranking Disciplinar</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">Código do Aluno</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-secondary">
                            <div class="stat-icon">📋</div>
                            <div class="stat-content">
                                <div class="stat-number" style="font-size: 0.8em;">${tipoMaisComum.length > 15 ? tipoMaisComum.substring(0, 15) + '...' : tipoMaisComum}</div>
                                <div class="stat-label">Tipo Mais Comum</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-section" style="margin-top: 20px;">
                        <h5>📊 Análise Comparativa</h5>
                        <div class="comparison-grid">
                            <div class="comparison-item ${totalMedidas > mediaGeral ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Situação vs Média Geral:</span>
                                <span class="comparison-value">
                                    ${totalMedidas > mediaGeral ? 
                                        `⚠️ Acima da média (+${(totalMedidas - mediaGeral).toFixed(1)})` : 
                                        `✅ Abaixo da média (-${(mediaGeral - totalMedidas).toFixed(1)})`
                                    }
                                </span>
                            </div>
                            
                            <div class="comparison-item ${mediasRecentes > 2 ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Tendência Recente:</span>
                                <span class="comparison-value">
                                    ${mediasRecentes === 0 ? '✅ Sem ocorrências recentes' :
                                      mediasRecentes <= 2 ? '🟡 Situação controlada' :
                                      '🔴 Requer atenção'
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao calcular estatísticas avançadas:', error);
                // Fallback para exibição simples
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">⚖️</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">Código do Aluno</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        

        // Inicializar filtros quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                await carregarTurmasEAlunos();
            }, 2000);
        });

        // FUNÇÕES DE FREQUÊNCIA SEPARADAS (baseadas no teste que funciona)
        async function verFrequenciaAluno() {
            const selectAluno = document.getElementById('alunoConsulta');
            const areaFrequencia = document.getElementById('areaFrequenciaAluno');
            const resultado = document.getElementById('resultadoFrequenciaAluno');
            
            if (!selectAluno || !selectAluno.value) {
                alert('Primeiro selecione um aluno!');
                return;
            }
            
            // Pegar código do aluno - BUSCAR NOS DADOS CARREGADOS
            let codigo = selectAluno.value;
            const nomeAluno = selectAluno.options[selectAluno.selectedIndex]?.text || '';
            
            console.log('DEBUG: selectAluno.value =', selectAluno.value);
            console.log('DEBUG: nomeAluno =', nomeAluno);
            console.log('DEBUG: todosAlunosMedidas =', todosAlunosMedidas);
            
            // Tentar buscar código real se disponível
            if (todosAlunosMedidas && todosAlunosMedidas.length > 0) {
                const alunoEncontrado = todosAlunosMedidas.find(aluno => aluno.id === selectAluno.value);
                console.log('DEBUG: alunoEncontrado =', alunoEncontrado);
                if (alunoEncontrado && alunoEncontrado.codigo) {
                    codigo = alunoEncontrado.codigo;
                    console.log('DEBUG: Converteu para código =', codigo);
                }
            }
            
            // Se ainda não encontrou código, tentar usar o value do option
            if (codigo === selectAluno.value && selectAluno.options[selectAluno.selectedIndex]) {
                const dataCode = selectAluno.options[selectAluno.selectedIndex].getAttribute('data-codigo');
                if (dataCode) {
                    codigo = dataCode;
                    console.log('DEBUG: Usando data-codigo =', codigo);
                }
            }
            
            console.log('🔍 Buscando frequência para código:', codigo);
            resultado.innerHTML = '🔄 Carregando frequência...';
            areaFrequencia.style.display = 'block';
            
            try {
                console.log('TESTE: Fazendo fetch do arquivo...');
                const response = await fetch('../assets/js/dados-frequencia-agosto.js');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar arquivo: ' + response.status);
                }
                
                const jsContent = await response.text();
                console.log('TESTE: Arquivo carregado, tamanho:', jsContent.length);
                
                // Extrair dados CSV
                const csvMatch = jsContent.match(/const dadosCSV = `([^`]+)`/);
                if (!csvMatch || !csvMatch[1]) {
                    throw new Error('Dados CSV não encontrados no arquivo');
                }
                
                const csvData = csvMatch[1];
                console.log('TESTE: CSV extraído, primeiras 200 chars:', csvData.substring(0, 200));
                
                // Parse CSV
                const linhas = csvData.trim().split('\n');
                console.log('TESTE: Total de linhas CSV:', linhas.length);
                
                // Buscar linha do aluno
                let linhaAluno = null;
                console.log('TESTE: Procurando por linha que começa com:', codigo + ',');
                
                for (let linha of linhas) {
                    if (linha.startsWith(codigo + ',')) {
                        linhaAluno = linha;
                        console.log('TESTE: Linha do aluno encontrada:', linhaAluno);
                        break;
                    }
                }
                
                if (!linhaAluno) {
                    console.log('TESTE: Aluno não encontrado. Primeiras 5 linhas:', linhas.slice(0, 5));
                    console.log('TESTE: Procurando pelo código:', codigo);
                    resultado.innerHTML = `❌ Aluno ${codigo} não encontrado no arquivo de frequência`;
                    return;
                }
                
                const campos = linhaAluno.split(',');
                const nome = campos[1];
                const turma = campos[2];
                const diasAgosto = [1, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15, 18, 19, 20, 21, 22, 25, 26, 27, 28, 29];
                
                const faltas = [];
                for (let i = 3; i < campos.length && i - 3 < diasAgosto.length; i++) {
                    const marcacao = campos[i];
                    if (marcacao === 'F' || marcacao === 'FC' || marcacao === 'A') {
                        const dia = diasAgosto[i - 3];
                        faltas.push({
                            dia: dia,
                            marcacao: marcacao,
                            data: `${dia.toString().padStart(2, '0')}/08`
                        });
                    }
                }
                
                let html = `
                    <h5>✅ ${nome}</h5>
                    <p><strong>Código:</strong> ${codigo}</p>
                    <p><strong>Turma:</strong> ${turma}</p>
                    <p><strong>Total de faltas:</strong> ${faltas.length}</p>
                `;
                
                if (faltas.length > 0) {
                    html += '<p><strong>Faltas encontradas:</strong></p>';
                    faltas.forEach(falta => {
                        let cor = '#dc3545'; // Vermelho para F
                        if (falta.marcacao === 'FC') cor = '#ffc107'; // Amarelo para FC
                        if (falta.marcacao === 'A') cor = '#17a2b8'; // Azul para A
                        
                        html += `<span style="background: ${cor}; color: white; padding: 6px 12px; margin: 3px; border-radius: 5px; display: inline-block;">${falta.data} - ${falta.marcacao}</span> `;
                    });
                    html += '<br><small style="color: #666; margin-top: 10px; display: block;">F = Falta | FC = Falta Controlada | A = Atestado</small>';
                } else {
                    html += '<p style="color: green;">✅ Nenhuma falta registrada</p>';
                }
                
                resultado.innerHTML = html;
                console.log('✅ Frequência carregada com sucesso!');
                
            } catch (error) {
                console.error('❌ Erro ao carregar frequência:', error);
                resultado.innerHTML = `❌ Erro: ${error.message}`;
            }
        }

        function fecharFrequencia() {
            document.getElementById('areaFrequenciaAluno').style.display = 'none';
        }
    </script>
    <script>
        // Proteger página - requer autenticação
        // Aguardar carregamento dos scripts antes de verificar auth
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🛑 RequireAuth DESABILITADO temporariamente - corrigindo loops');
            // TEMPORARIAMENTE desabilitado para corrigir loop de redirecionamento
            // setTimeout(() => {
            //     if (typeof requireAuth === 'function') {
            //         console.log('RequireAuth disponível, ativando proteção...');
            //         requireAuth({
            //             loginPath: 'login.html',
            //             onAuth: function(user) {
            //                 console.log('Usuário logado nas medidas disciplinares:', user.email);
            //                 // Página já inicializa automaticamente via DOMContentLoaded
            //             }
            //         });
            //     } else {
            //         console.log('RequireAuth não disponível - executando sem autenticação');
            //     }
            // }, 100);
        });
    </script>

</body>
</html>
