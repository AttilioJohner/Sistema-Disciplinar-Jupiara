<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidas Disciplinares - Dashboard Disciplinar</title>
    <link rel="icon" type="image/jpeg" href="../assets/images/logo-escola.jpeg">
    <!-- Deploy test -->
    
    <!-- CSS Externos -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/modern-layout.css">
    
    <!-- Script para corrigir cor dos emojis nos t√≠tulos -->
    <script src="../assets/js/fix-emoji-titles.js"></script>
    
    <!-- Script para barra superior moderna -->
    <script src="../assets/js/modern-topbar.js"></script>
    
    <!-- APENAS SUPABASE -->
    <script src="../netlify-env.js" onerror="console.log('Vari√°veis do Netlify n√£o encontradas')"></script>
    <script src="../assets/js/env-config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-only.js"></script>

    <!-- SISTEMA DE SELE√á√ÉO DE UNIDADE (Sede/Anexa) -->
    <script src="../assets/js/unidade-selector.js"></script>

    <!-- SISTEMA DE TURMAS DIN√ÇMICAS -->
    <script src="../assets/js/turmas-dinamicas.js"></script>

    <!-- jsPDF para exporta√ß√£o em PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    
    <!-- Scripts de categoria de medidas -->
    <script src="../assets/js/medidas-categorias.js"></script>

    <!-- WhatsApp Sender Integration -->
    <script defer src="../assets/js/whatsapp-sender.js?v=20250923"></script>
    
    <!-- Estilos espec√≠ficos para ficha disciplinar -->
    <style>
        /* ===== LAYOUT PRINCIPAL BASEADO EM RELAT√ìRIOS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #2c3e50;
            overflow-x: hidden;
        }
        
        /* Layout Principal */
        .main-layout {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar modernizada */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar-section {
            padding: 20px 0;
        }
        
        .sidebar-title {
            padding: 0 20px 15px 20px;
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #495057;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        
        .sidebar-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding-left: 25px;
        }
        
        .sidebar-item.active {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-left: 4px solid #667eea;
            font-weight: 600;
        }
        
        .sidebar-icon {
            margin-right: 12px;
            width: 20px;
            display: inline-block;
            text-align: center;
        }
        
        .sidebar-text {
            flex: 1;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
            overflow-y: auto;
        }
        
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Module title padr√£o - removido CSS customizado para usar o padr√£o do framework */
        
        /* Cards de estat√≠sticas */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            font-size: 2.5em;
            opacity: 0.8;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        
        /* Se√ß√µes principais com design moderno */
        .management-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .management-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .management-header h3 {
            font-size: 1.4em;
            font-weight: 600;
            margin: 0;
        }
        
        .management-content {
            padding: 30px;
        }
        
        /* Mobile responsividade */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .content-area {
                margin-left: 0;
            }
            
            .module-title {
                font-size: 1.8em;
                padding: 20px;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px;
            }
        }

        /* Sistema de expans√£o/colapso de se√ß√µes */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            margin: 0;
        }
        
        .section-header:hover {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }
        
        .section-toggle {
            font-size: 1.2em;
            color: #007bff;
            transition: transform 0.3s ease;
            user-select: none;
        }
        
        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 0px;
            opacity: 0;
            transition: all 0.4s ease;
            overflow: hidden;
        }
        
        .section-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        
        .section-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .management-title {
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        /* Sistema de sele√ß√£o m√∫ltipla de faltas */
        .faltas-multi-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }
        
        /* Tabelas de hist√≥rico - container com scroll */
        #tableMedidasNegativas, #tableMedidasPositivas {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .historico-table thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }
        
        .historico-table thead th {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            color: #333;
        }
        
        .historico-table tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        .historico-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .historico-table td {
            padding: 8px;
            vertical-align: top;
        }
        
        .falta-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .falta-option:hover {
            background: #f8f9fa;
        }
        
        .falta-option:last-child {
            border-bottom: none;
        }
        
        .falta-checkbox {
            margin-right: 8px;
        }
        
        .faltas-selecionadas {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .faltas-selecionadas-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .falta-tag {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px 4px 2px 0;
            cursor: pointer;
        }
        
        .falta-tag:hover {
            background: #dc3545;
        }
        
        .falta-tag::after {
            content: ' ‚úï';
            margin-left: 4px;
        }
        
        /* Status do prazo */
        .status-prazo {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        
        .status-prazo.em-prazo {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-prazo.atencao {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-prazo.vencido {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .form-help {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            display: block;
        }
        
        /* Sistema de categorias m√∫ltiplas */
        .categorias-container {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .categoria-group {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .categoria-group:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .categoria-group.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .categoria-checkbox {
            margin-right: 8px;
        }
        
        .categoria-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Se√ß√µes de faltas por categoria */
        .categoria-secao {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .categoria-header {
            background: #f8f9fa;
            padding: 10px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
        }
        
        .categoria-faltas {
            padding: 10px;
        }

        /* Dados pessoais */
        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dado-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .dado-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .dado-valor {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }
        
        /* Sistema de Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .loading-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            color: #666;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading-steps {
            text-align: left;
            margin-top: 20px;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 5px 0;
            font-size: 0.85em;
            color: #666;
        }
        
        .loading-step.active {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .loading-step.completed {
            color: #28a745;
        }
        
        .loading-step-icon {
            margin-right: 8px;
            width: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Top Loading Bar */
        .top-loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            z-index: 9998;
            overflow: hidden;
        }
        
        .top-loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Componentes de Frequ√™ncia */
        .frequencia-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .frequencia-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .frequencia-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .frequencia-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #17a2b8;
        }
        
        .frequencia-card.presenca-excelente {
            border-left-color: #28a745;
        }
        
        .frequencia-card.presenca-boa {
            border-left-color: #17a2b8;
        }
        
        .frequencia-card.presenca-regular {
            border-left-color: #ffc107;
        }
        
        .frequencia-card.presenca-baixa {
            border-left-color: #dc3545;
        }
        
        .frequencia-card-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .frequencia-card-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .frequencia-card-subtitle {
            font-size: 0.8em;
            color: #888;
        }
        
        .faltas-recentes {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .faltas-recentes-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .falta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #fff5f5;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #dc3545;
        }
        
        .falta-data {
            font-weight: 500;
            color: #dc3545;
        }
        
        .falta-info {
            font-size: 0.85em;
            color: #666;
        }
        
        .sem-faltas {
            text-align: center;
            padding: 20px;
            color: #28a745;
            font-weight: 500;
        }
        
        .ver-todas-faltas {
            display: block;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            color: #007bff;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .ver-todas-faltas:hover {
            background: #e9ecef;
        }
        
        .resumo-mensal {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .resumo-mensal-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resumo-mensal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .resumo-mensal-stat {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .resumo-mensal-stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        
        .resumo-mensal-stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }

        /* Resumos */
        .faltas-resumo, .medidas-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .resumo-item {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .resumo-danger { background: linear-gradient(135deg, #dc3545, #e55565); color: white; }
        .resumo-warning { background: linear-gradient(135deg, #ffc107, #ffcd3c); color: #333; }
        .resumo-info { background: linear-gradient(135deg, #17a2b8, #3bc4db); color: white; }
        .resumo-secondary { background: linear-gradient(135deg, #6c757d, #868e96); color: white; }
        .resumo-success { background: linear-gradient(135deg, #28a745, #34ce57); color: white; }
        
        .resumo-numero {
            display: block;
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .resumo-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
            display: block;
        }
        
        /* Timeline de faltas */
        .faltas-timeline {
            margin-top: 20px;
        }
        
        .mes-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .mes-titulo {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            padding: 12px 20px;
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .faltas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .falta-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .falta-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .falta-simples {
            background: linear-gradient(135deg, #dc3545, #e55565);
            color: white;
        }
        
        .falta-controlada {
            background: linear-gradient(135deg, #ffc107, #ffcd3c);
            color: #333;
        }
        
        .atestado {
            background: linear-gradient(135deg, #17a2b8, #3bc4db);
            color: white;
        }
        
        .falta-icon {
            font-size: 1.8em;
            margin-right: 12px;
        }
        
        .falta-info {
            flex-grow: 1;
        }
        
        .falta-data {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 2px;
        }
        
        .falta-dia {
            font-size: 0.85em;
            opacity: 0.8;
            text-transform: capitalize;
        }
        
        .falta-tipo {
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Estat√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .stat-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .stat-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .stat-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .stat-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
        
        .stat-icon {
            font-size: 2.5em;
            margin-right: 15px;
            opacity: 0.8;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        /* Breakdown */
        .breakdown-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .breakdown-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #495057;
        }
        
        .breakdown-value {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }
        
        /* Info boxes */
        .info-box {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .info-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .info-box h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        /* Medidas timeline */
        .medidas-timeline {
            margin-top: 20px;
        }
        
        .medida-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .medida-data {
            font-weight: bold;
            color: #495057;
            margin-right: 20px;
            min-width: 100px;
            font-size: 0.9em;
        }
        
        .medida-content {
            flex-grow: 1;
        }
        
        .medida-actions {
            margin-left: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .btn-excluir-medida {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .btn-excluir-medida:hover {
            background: #c82333;
            opacity: 1;
            transform: scale(1.1);
        }
        
        .medida-tipo {
            font-weight: bold;
            color: #dc3545;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        /* Medidas positivas - verde */
        .medida-item.positiva {
            border-left: 4px solid #28a745;
        }
        
        .medida-item.positiva .medida-tipo {
            color: #28a745;
        }
        
        /* Pontua√ß√£o da medida */
        .medida-pontos {
            display: inline-block;
            margin-left: 10px;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .medida-pontos.positivos {
            background: #d4edda;
            color: #155724;
        }
        
        .medida-pontos.negativos {
            background: #f8d7da;
            color: #721c24;
        }
        
        .medida-descricao {
            color: #495057;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .medida-providencias {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Registros recentes */
        .records-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .record-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .record-student {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }
        
        .record-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-details {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
        }
        
        .record-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .record-turma {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-description {
            color: #495057;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        /* Compara√ß√µes */
        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .comparison-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .comparison-good {
            border-left-color: #28a745;
        }
        
        .comparison-alert {
            border-left-color: #dc3545;
        }
        
        .comparison-label {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }
        
        .comparison-value {
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 15px;
        }
        
        /* Nota Disciplinar */
        .disciplinary-score-card {
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .score-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .score-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-emoji {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .score-info .score-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .score-info .score-subtitle {
            font-size: 1.1em;
            font-weight: 600;
            opacity: 0.8;
        }
        
        .score-number {
            font-size: 3.5em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 20px;
        }
        
        .score-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.95em;
            color: #495057;
            background: rgba(255,255,255,0.7);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid currentColor;
        }
        
        .score-details span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dados-grid, .faltas-grid, .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .disciplinary-score-card {
                padding: 20px;
            }
            
            .score-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .score-number {
                font-size: 2.5em;
                margin-left: 0;
            }
            
            .score-emoji {
                font-size: 2em;
            }
            
            .score-info .score-title {
                font-size: 1.2em;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .faltas-resumo, .medidas-resumo {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .breakdown-grid {
                grid-template-columns: 1fr;
            }
            
            .medida-item {
                flex-direction: column;
            }
            
            .medida-data {
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
        
        /* Estilos para alertas de prazo */
        .alerta-prazo {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .insight-content {
            flex: 1;
            margin-right: 15px;
        }
        
        .insight-detalhes {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .insight-prazo {
            font-size: 0.8em;
            color: #007bff;
            font-weight: bold;
            margin-top: 3px;
        }
        
        .insight-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .btn-marcar-entregue {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        .btn-marcar-entregue:hover {
            background: #218838;
        }
        
        .btn-marcar-entregue:active {
            transform: translateY(1px);
        }
        
        /* Responsividade para alertas */
        @media (max-width: 768px) {
            .alerta-prazo {
                flex-direction: column;
                gap: 10px;
            }
            
            .insight-content {
                margin-right: 0;
            }
            
            .insight-actions {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* Estilos para tabelas de hist√≥rico de medidas */
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .historico-table th,
        .historico-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .historico-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .historico-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .historico-table .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        
        .historico-table .codigo-cell {
            width: 80px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .historico-table .data-cell {
            width: 90px;
        }
        
        .historico-table .tipo-cell {
            width: 120px;
        }
        
        .historico-table .categoria-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .categoria-badge.leve {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .categoria-badge.media {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .categoria-badge.grave {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .categoria-badge.positiva {
            background-color: #d4edda;
            color: #155724;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 15px;
            cursor: pointer;
        }
        
        .table-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .table-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .checkbox-label {
                margin: 5px 0;
            }
        }

        /* === ESTILOS DAS TABELAS === */
        .table-responsive {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 500px;
        }
        
        .table {
            width: 100%;
            margin-bottom: 0;
            color: #212529;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            vertical-align: middle;
            border-top: 1px solid #dee2e6;
            text-align: left;
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border-top: 0;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,123,255,0.05);
        }
        
        .table tbody tr:hover {
            background-color: rgba(0,123,255,0.1);
            cursor: pointer;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 4px;
        }
        
        .badge-danger {
            color: #fff;
            background-color: #dc3545;
        }
        
        .badge-success {
            color: #fff;
            background-color: #28a745;
        }
        
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .text-center {
            text-align: center !important;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        @media (max-width: 768px) {
            .table th,
            .table td {
                padding: 8px 4px;
                font-size: 14px;
            }
            
            .text-truncate {
                max-width: 150px;
            }
        }

        /* === ESTILOS DO PRAZO AUTOM√ÅTICO === */
        .prazo-automatico {
            background: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 5px;
        }
        
        .prazo-display {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #007bff;
            margin-bottom: 10px;
        }
        
        .prazo-display strong {
            color: #007bff;
            font-size: 16px;
        }

        /* Estilos para categorias m√∫ltiplas */
        .categorias-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .categoria-grupo {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .categoria-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .categoria-checkbox:hover {
            border-color: #007bff;
            background: #f0f7ff;
        }
        
        .categoria-checkbox input[type="checkbox"]:checked + span {
            color: #007bff;
            font-weight: 600;
        }
        
        .falta-checkbox {
            display: block;
            margin: 8px 0;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        
        .falta-checkbox:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .texto-instrucao {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <img src="../assets/images/logo-escola.jpeg" alt="Logo da Escola" class="top-bar-logo" style="height: 40px; margin-right: 15px; border-radius: 4px;">
            <div class="app-launcher">
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
            </div>
            <span class="app-name">Dashboard Disciplinar</span>
        </div>
        <div class="top-bar-center">
            <input type="text" class="search-box" placeholder="Pesquisar registros...">
        </div>
        <div class="top-bar-right">
            <div class="user-profile">A</div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="main-layout">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">M√≥dulos Principais</div>
                
                <a href="../index.html" class="sidebar-item">
                    <span class="sidebar-icon">üè†</span>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                
                <a href="gestao-alunos.html" class="sidebar-item">
                    <span class="sidebar-icon">üë•</span>
                    <span class="sidebar-text">Gest√£o de Alunos</span>
                </a>
                
                <a href="medidas-disciplinares.html" class="sidebar-item active">
                    <span class="sidebar-icon">üìã</span>
                    <span class="sidebar-text">Medidas Disciplinares</span>
                </a>
                
                <a href="/pages/consulta-ficha.html" class="sidebar-item">
                    <span class="sidebar-icon">üë§</span>
                    <span class="sidebar-text">Ficha Disciplinar</span>
                </a>
                
                <a href="frequencia.html" class="sidebar-item">
                    <span class="sidebar-icon">üìÖ</span>
                    <span class="sidebar-text">Controle de Frequ√™ncia</span>
                </a>

                <a href="/pages/boletim.html" class="sidebar-item"><span class="sidebar-icon">üìö</span><span class="sidebar-text">Boletim Escolar</span></a>

                <a href="relatorios.html" class="sidebar-item">
                    <span class="sidebar-icon">üìä</span>
                    <span class="sidebar-text">Relat√≥rios</span>
                </a>
                
                <a href="analises.html" class="sidebar-item">
                    <span class="sidebar-icon">üìà</span>
                    <span class="sidebar-text">An√°lises</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ferramentas</div>
                
                
                <a href="configuracoes.html" class="sidebar-item">
                    <span class="sidebar-icon">‚öôÔ∏è</span>
                    <span class="sidebar-text">Configura√ß√µes</span>
                </a>
                
                <a href="/pages/comunicacao.html" class="sidebar-item">
                    <span class="sidebar-icon">üì±</span>
                    <span class="sidebar-text">Comunica√ß√£o</span>
                </a>
                
                <a href="login.html" class="sidebar-item">
                    <span class="sidebar-icon">üîê</span>
                    <span class="sidebar-text">Login/Logout</span>
                </a>
            </div>
        </div>

        <!-- √ÅREA DE CONTE√öDO -->
        <div class="content-area">
            <div class="main-content">
                
                <!-- T√çTULO -->
                <div class="module-title">
                    üìã Medidas Disciplinares
                </div>

                <!-- SE√á√ÉO: ESTAT√çSTICAS R√ÅPIDAS -->
                <div class="quick-stats">
                    <div class="stat-card stat-highlight" style="background: linear-gradient(135deg, #28a74520, #17a2b820); border: 2px solid #28a745;">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="mediaNotaEscola" style="color: #28a745;">0.0</div>
                            <div class="stat-label">M√©dia Disciplinar da Escola</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">‚öñÔ∏è</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalMedidas">0</div>
                            <div class="stat-label">Total de Medidas</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-info">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasMes">0</div>
                            <div class="stat-label">Medidas este M√™s</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-success">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasSemana">0</div>
                            <div class="stat-label">Medidas esta Semana</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <div class="stat-number" id="alunosAfetados">0</div>
                            <div class="stat-label">Alunos com Medidas</div>
                        </div>
                    </div>
                </div>

                <!-- PAINEL DE ALERTAS -->
                <div class="management-section" id="painelAlertas">
                    <div class="section-header" onclick="toggleSection('alertas')">
                        <div class="management-title">
                            üö® Alertas e Prioridades
                        </div>
                        <span class="section-toggle" id="alertas-toggle">üîΩ</span>
                    </div>
                    <div class="section-content" id="alertas-content">
                        <div id="alertasContainer">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Carregando alertas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO: MEDIDAS DISCIPLINARES -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidas')">
                        <div class="management-title">
                            ‚öñÔ∏è Registrar Medida Disciplinar
                        </div>
                        <span class="section-toggle" id="medidas-toggle">üîΩ</span>
                    </div>
                    
                    <div class="section-content" id="medidas-content">
                        <form id="formMedida" onsubmit="salvarMedida(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Turma *</label>
                                <select id="turmaMedida" class="form-select" onchange="carregarAlunosPorTurmaMedida()" required>
                                    <option value="">Selecione a turma...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Turno *</label>
                                <select id="turnoMedida" class="form-select" required>
                                    <option value="">Selecione o turno...</option>
                                    <option value="Matutino">Matutino</option>
                                    <option value="Vespertino">Vespertino</option>
                                    <option value="Integral">Integral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aluno *</label>
                                <select id="alunoMedida" class="form-select" required disabled>
                                    <option value="">Primeiro selecione uma turma...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Data da Ocorr√™ncia *</label>
                                <input 
                                    type="date" 
                                    id="dataMedida" 
                                    class="form-input" 
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Medida *</label>
                                <select id="tipoMedida" class="form-select" onchange="configurarCamposMedida()" required>
                                    <option value="">Selecione...</option>
                                    <optgroup label="üìà Medidas Positivas">
                                        <option value="Elogio Individual">Elogio Individual (+0,5)</option>
                                        <option value="Elogio Coletivo">Elogio Coletivo (+0,3)</option>
                                        <option value="Fato Observado Positivo">Fato Observado Positivo (+0,1)</option>
                                    </optgroup>
                                    <optgroup label="üìâ Medidas Disciplinares">
                                        <option value="Fato Observado Negativo">Fato Observado Negativo (-0,1)</option>
                                        <option value="Advert√™ncia Verbal">Advert√™ncia Verbal (-0,3)</option>
                                        <option value="Advert√™ncia Escrita">Advert√™ncia Escrita (-0,3)</option>
                                        <option value="Suspens√£o">Suspens√£o (-0,5 por dia)</option>
                                        <option value="A√ß√£o Educativa">A√ß√£o Educativa (-1,0)</option>
                                    </optgroup>
                                    <optgroup label="üîÑ Medidas Educativas">
                                        <option value="Reuni√£o com Respons√°veis">Reuni√£o com Respons√°veis</option>
                                        <option value="Encaminhamento Coordena√ß√£o">Encaminhamento √† Coordena√ß√£o</option>
                                        <option value="Trabalho Educativo">Trabalho Educativo</option>
                                        <option value="Acompanhamento Psicopedag√≥gico">Acompanhamento Psicopedag√≥gico</option>
                                        <option value="Outro">Outro</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <!-- Campos de categoria de faltas - inicialmente ocultos -->
                            
                            <div class="form-group form-group-full" id="campoSelecaoFalta" style="display: none;">
                                <label class="form-label">Selecionar Faltas Espec√≠ficas *</label>
                                <div id="faltasMultiContainer" class="faltas-multi-container">
                                    <div style="padding: 20px; text-align: center; color: #666;">
                                        Primeiro selecione uma categoria...
                                    </div>
                                </div>
                                <div id="faltasSelecionadas" class="faltas-selecionadas" style="display: none;">
                                    <div class="faltas-selecionadas-title">Faltas selecionadas:</div>
                                    <div id="faltasTagsContainer"></div>
                                </div>
                                <!-- Hidden input para armazenar as faltas selecionadas -->
                                <input type="hidden" id="faltaEspecifica" name="faltasEspecificas" />
                            </div>
                            
                            <div class="form-group" id="campoSuspensao" style="display: none;">
                                <label class="form-label">Dias de Suspens√£o *</label>
                                <input 
                                    type="number" 
                                    id="diasSuspensao" 
                                    class="form-input" 
                                    min="1" 
                                    max="30"
                                    placeholder="N√∫mero de dias"
                                >
                            </div>
                            
                            <div class="form-group form-group-full" id="campoMotivoOriginal">
                                <label class="form-label">Motivo/Descri√ß√£o *</label>
                                <textarea 
                                    id="motivoMedida" 
                                    class="form-textarea" 
                                    placeholder="Descreva detalhadamente o motivo da medida disciplinar..." 
                                    rows="4"
                                ></textarea>
                            </div>
                            
                            <div class="form-group" id="prazoAssinaturaInfo" style="display: none;">
                                <label class="form-label">üìÖ Prazo para Assinatura (Autom√°tico)</label>
                                <div class="prazo-automatico">
                                    <div class="prazo-display">
                                        <strong id="prazoDataDisplay">üìÖ Ser√° calculado ap√≥s selecionar a data</strong>
                                    </div>
                                    <small class="form-help">ü§ñ <strong>Autom√°tico:</strong> Sempre 3 dias √∫teis ap√≥s a data de ocorr√™ncia</small>
                                </div>
                            </div>
                            
                            <div class="form-group" id="diasRestantesInfo" style="display: none;">
                                <label class="form-label">Status do Prazo</label>
                                <div id="statusPrazo" class="status-prazo">
                                    <!-- Ser√° preenchido automaticamente -->
                                </div>
                            </div>
                            
                            <div class="form-group form-group-full">
                                <label class="form-label">A√ß√µes Tomadas</label>
                                <textarea 
                                    id="acoesMedida" 
                                    class="form-textarea" 
                                    placeholder="Descreva as a√ß√µes tomadas ou que ser√£o tomadas..." 
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        
                        <!-- Op√ß√£o de envio autom√°tico por WhatsApp -->
                        <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500;">
                                <input type="checkbox" id="enviarWhatsAppAuto" style="transform: scale(1.2);">
                                üì± Enviar WhatsApp automaticamente aos respons√°veis ap√≥s salvar
                            </label>
                            <small style="color: #666; margin-left: 28px; display: block; margin-top: 4px;">
                                Notifica√ß√£o ser√° enviada para o n√∫mero cadastrado do respons√°vel
                            </small>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="limparFormMedida()">
                                üîÑ Limpar
                            </button>
                            <button type="submit" class="btn btn-warning" id="btnSalvarMedida">
                                ‚ö†Ô∏è Salvar Medida
                            </button>
                        </div>
                        </form>
                    </div>
                </div>


                <!-- SE√á√ÉO: REGISTROS RECENTES -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('registros')">
                        <div class="management-title">
                            üìã Registros Recentes
                        </div>
                        <span class="section-toggle" id="registros-toggle">üîº</span>
                    </div>
                    <div class="section-content" id="registros-content">
                        <div class="management-content">
                            <div class="table-actions">
                                <button class="btn btn-info btn-small" onclick="carregarRegistrosRecentes()">
                                    üîÑ Atualizar
                                </button>
                                <select class="filter-select" onchange="filtrarRegistrosRecentes(this.value)">
                                    <option value="todos">Todos os tipos</option>
                                    <option value="faltas">Apenas Faltas</option>
                                    <option value="medidas">Apenas Medidas</option>
                                </select>
                                <button class="btn btn-secondary btn-small" onclick="exportarRegistros()">
                                    üìä Exportar
                                </button>
                            </div>
                            
                            <div id="registrosRecentes" class="table-content">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <p>Carregando registros recentes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO: HIST√ìRICO DE MEDIDAS NEGATIVAS -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidasNegativas')">
                        <div class="management-title">
                            üìä Hist√≥rico de Medidas Disciplinares (Negativas)
                        </div>
                        <span class="section-toggle" id="medidasNegativas-toggle">üîº</span>
                    </div>
                    <div class="section-content" id="medidasNegativas-content">
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="carregarMedidasNegativas()">
                                üìã Carregar Medidas Negativas
                            </button>
                            <input type="text" id="pesquisaNegativas" class="form-input" placeholder="üîç Pesquisar por nome ou c√≥digo..." style="max-width: 250px;" oninput="aplicarFiltrosNegativas()">
                            <select class="filter-select" id="filtroTurmaNegativas" onchange="aplicarFiltrosNegativas()">
                                <option value="todas">Todas as turmas</option>
                            </select>
                            <select class="filter-select" id="quantidadeNegativas" onchange="aplicarFiltrosNegativas()">
                                <option value="10" selected>√öltimas 10</option>
                                <option value="20">√öltimas 20</option>
                                <option value="50">√öltimas 50</option>
                                <option value="100">√öltimas 100</option>
                                <option value="todas">Todas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="limparPesquisaNegativas()">
                                üßπ Limpar
                            </button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="selecionarTodasNegativas" onchange="selecionarTodasMedidasNegativas()">
                                Selecionar Todas
                            </label>
                            <button class="btn btn-success" onclick="exportarMedidasSelecionadas('negativas')">
                                üìÑ Exportar Selecionadas
                            </button>
                        </div>
                        <div id="tableMedidasNegativas" class="table-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                Clique em "üìã Carregar Medidas Negativas" para visualizar o hist√≥rico completo
                            </p>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO: HIST√ìRICO DE MEDIDAS POSITIVAS -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidasPositivas')">
                        <div class="management-title">
                            üåü Hist√≥rico de Medidas Disciplinares (Positivas)
                        </div>
                        <span class="section-toggle" id="medidasPositivas-toggle">üîº</span>
                    </div>
                    <div class="section-content" id="medidasPositivas-content">
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="carregarMedidasPositivas()">
                                üåü Carregar Medidas Positivas
                            </button>
                            <input type="text" id="pesquisaPositivas" class="form-input" placeholder="üîç Pesquisar por nome ou c√≥digo..." style="max-width: 250px;" oninput="aplicarFiltrosPositivas()">
                            <select class="filter-select" id="filtroTurmaPositivas" onchange="aplicarFiltrosPositivas()">
                                <option value="todas">Todas as turmas</option>
                            </select>
                            <select class="filter-select" id="quantidadePositivas" onchange="aplicarFiltrosPositivas()">
                                <option value="10" selected>√öltimas 10</option>
                                <option value="20">√öltimas 20</option>
                                <option value="50">√öltimas 50</option>
                                <option value="100">√öltimas 100</option>
                                <option value="todas">Todas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="limparPesquisaPositivas()">
                                üßπ Limpar
                            </button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="selecionarTodasPositivas" onchange="selecionarTodasMedidasPositivas()">
                                Selecionar Todas
                            </label>
                            <button class="btn btn-warning" onclick="exportarMedidasSelecionadas('positivas')">
                                üìÑ Exportar Selecionadas
                            </button>
                        </div>
                        <div id="tableMedidasPositivas" class="table-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                Clique em "üåü Carregar Medidas Positivas" para visualizar o hist√≥rico completo
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Sistema de Loading -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-title">Carregando Sistema</div>
            <div class="loading-subtitle">Preparando dados disciplinares...</div>
            
            <div class="progress-container">
                <div id="loadingProgressBar" class="progress-bar"></div>
            </div>
            <div id="loadingProgressText" class="progress-text">0%</div>
            
            <div class="loading-steps">
                <div id="loadingStep1" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Conectando ao banco de dados...</span>
                </div>
                <div id="loadingStep2" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Carregando lista de alunos...</span>
                </div>
                <div id="loadingStep3" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Calculando estat√≠sticas...</span>
                </div>
                <div id="loadingStep4" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Carregando registros recentes...</span>
                </div>
                <div id="loadingStep5" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Finalizando interface...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Loading Bar -->
    <div id="topLoadingBar" class="top-loading-bar" style="display: none;">
        <div id="topLoadingProgress" class="top-loading-progress"></div>
    </div>

    <!-- JAVASCRIPT -->
    
    <script src="../assets/js/main.js" defer></script>
    <script src="../assets/js/gestao.js" defer></script>
    
    <!-- Servi√ßos de notas disciplinares e frequ√™ncia -->
    <script type="module">
        import { getNotaDisciplinar, NotasUtils } from '../assets/js/notas-disciplinares.js';
        import { 
            getResumoAcumuladoAluno, 
            getFaltasAluno, 
            getResumoMensalAtualAluno,
            FrequenciaUtils 
        } from '../data/frequencia.js';
        
        // Tornar fun√ß√µes dispon√≠veis globalmente
        window.getNotaDisciplinar = getNotaDisciplinar;
        window.NotasUtils = NotasUtils;
        window.getResumoAcumuladoAluno = getResumoAcumuladoAluno;
        window.getFaltasAluno = getFaltasAluno;
        window.getResumoMensalAtualAluno = getResumoMensalAtualAluno;
        window.FrequenciaUtils = FrequenciaUtils;
    </script>
    
    <script>
        // Sistema de Loading Inteligente
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loadingOverlay');
                this.topBar = document.getElementById('topLoadingBar');
                this.progressBar = document.getElementById('loadingProgressBar');
                this.progressText = document.getElementById('loadingProgressText');
                this.topProgress = document.getElementById('topLoadingProgress');
                this.currentStep = 0;
                this.totalSteps = 5;
                this.isVisible = false;
            }
            
            show(title = 'Carregando Sistema', subtitle = 'Preparando dados disciplinares...') {
                if (this.isVisible) return;
                
                document.querySelector('.loading-title').textContent = title;
                document.querySelector('.loading-subtitle').textContent = subtitle;
                
                this.overlay.style.display = 'flex';
                this.topBar.style.display = 'block';
                this.isVisible = true;
                this.currentStep = 0;
                this.updateProgress(0);
            }
            
            hide() {
                setTimeout(() => {
                    this.overlay.style.display = 'none';
                    this.topBar.style.display = 'none';
                    this.isVisible = false;
                }, 500);
            }
            
            updateProgress(percentage, stepText = null) {
                this.progressBar.style.width = percentage + '%';
                this.progressText.textContent = Math.round(percentage) + '%';
                this.topProgress.style.width = percentage + '%';
                
                if (stepText) {
                    const stepNumber = Math.ceil((percentage / 100) * this.totalSteps);
                    this.setStepActive(stepNumber, stepText);
                }
            }
            
            setStepActive(stepNumber, text = null) {
                // Limpar estados anteriores
                for (let i = 1; i <= this.totalSteps; i++) {
                    const step = document.getElementById(`loadingStep${i}`);
                    if (step) {
                        step.classList.remove('active', 'completed');
                        const icon = step.querySelector('.loading-step-icon');
                        if (i < stepNumber) {
                            step.classList.add('completed');
                            icon.textContent = '‚úÖ';
                        } else if (i === stepNumber) {
                            step.classList.add('active');
                            icon.textContent = 'üîÑ';
                            if (text) {
                                step.querySelector('span:last-child').textContent = text;
                            }
                        } else {
                            icon.textContent = '‚è≥';
                        }
                    }
                }
            }
            
            async simulateProgress(duration = 2000) {
                const steps = [
                    { progress: 20, text: 'Conectando ao banco de dados...' },
                    { progress: 40, text: 'Carregando lista de alunos...' },
                    { progress: 60, text: 'Calculando estat√≠sticas...' },
                    { progress: 80, text: 'Carregando registros recentes...' },
                    { progress: 100, text: 'Finalizando interface...' }
                ];
                
                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => {
                        setTimeout(() => {
                            this.updateProgress(steps[i].progress, steps[i].text);
                            resolve();
                        }, duration / steps.length);
                    });
                }
            }
        }
        
        // Inst√¢ncia global do loading
        window.loadingManager = new LoadingManager();
        
        // Inicializa√ß√£o da p√°gina com loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã P√°gina de Medidas Disciplinares carregada');
            
            // Mostrar loading imediatamente
            window.loadingManager.show();
            
            // Inicializar sistema com progresso
            inicializarMedidasDisciplinaresComLoading();
        });

        // Carregar alunos para os selects dos formul√°rios
        async function carregarSelectsAlunos() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`üìö Carregando alunos da unidade: ${unidadeAtual}`);

                // Carregar alunos FILTRADOS pela unidade
                const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma, unidade')
                    .eq('unidade', unidadeAtual)
                    .order('"Nome completo"');

                if (error) throw error;

                const alunos = alunosData.map(item => ({
                    id: item.codigo,
                    codigo: item.codigo,
                    nome: item['Nome completo'],
                    turma: item.turma,
                    foto_url: item.foto_url
                }));

                // Guardar dados para uso posterior
                window.alunosMedidasGlobal = alunos;

                // Preencher select de turmas
                const selectTurmaMedida = document.getElementById('turmaMedida');
                if (selectTurmaMedida) {
                    const turmasUnicas = [...new Set(alunos.map(aluno => aluno.turma))].sort();
                    selectTurmaMedida.innerHTML = '<option value="">Selecione a turma...</option>';
                    turmasUnicas.forEach(turma => {
                        selectTurmaMedida.innerHTML += `<option value="${turma}">${turma}</option>`;
                    });
                }

                // Select de alunos come√ßa desabilitado
                const selectMedida = document.getElementById('alunoMedida');
                if (selectMedida) {
                    selectMedida.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                    selectMedida.disabled = true;
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar alunos para os selects:', error);
            }
        }

        // Fun√ß√£o para carregar alunos por turma no formul√°rio de medidas
        function carregarAlunosPorTurmaMedida() {
            const selectTurma = document.getElementById('turmaMedida');
            const selectAluno = document.getElementById('alunoMedida');
            
            if (!selectTurma || !selectAluno || !window.alunosMedidasGlobal) return;
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar sele√ß√£o atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = window.alunosMedidasGlobal.filter(aluno => aluno.turma === turmaSelecionada);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                selectAluno.innerHTML += `<option value="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
        }

        // Controlar exibi√ß√£o do campo de suspens√£o e calcular prazo
        document.getElementById('tipoMedida').addEventListener('change', function() {
            const campoSuspensao = document.getElementById('campoSuspensao');
            const diasSuspensao = document.getElementById('diasSuspensao');

            if (this.value === 'Suspens√£o') {
                campoSuspensao.style.display = 'block';
                diasSuspensao.required = true;
            } else {
                campoSuspensao.style.display = 'none';
                diasSuspensao.required = false;
                diasSuspensao.value = '';
            }

            // Recalcular prazo quando tipo de medida muda
            if (typeof calcularPrazoAutomatico === 'function') {
                calcularPrazoAutomatico();
            }
        });

        // Fun√ß√£o para salvar medida disciplinar
        async function salvarMedida(event) {
            event.preventDefault();
            
            const form = event.target;
            const btn = form.querySelector('button[type="submit"]');
            const alunoId = document.getElementById('alunoMedida').value;
            const turno = document.getElementById('turnoMedida').value;
            const tipoMedida = document.getElementById('tipoMedida').value;
            const data = document.getElementById('dataMedida').value;
            const motivo = document.getElementById('motivoMedida').value;
            let acoes = document.getElementById('acoesMedida').value;
            const diasSuspensao = document.getElementById('diasSuspensao').value;

            // S√≥ definir prazo para medidas que requerem assinatura
            const medidasComPrazo = ['Advert√™ncia Verbal', 'Advert√™ncia Escrita', 'Suspens√£o', 'A√ß√£o Educativa'];
            const prazoAssinatura = medidasComPrazo.includes(tipoMedida) ? (window.prazoCalculado || null) : null;

            console.log('üîç Debug prazo:', {
                tipoMedida,
                requerPrazo: medidasComPrazo.includes(tipoMedida),
                prazoCalculado: window.prazoCalculado,
                prazoFinal: prazoAssinatura
            });
            
            if (!alunoId) {
                alert('Selecione um aluno');
                return;
            }
            
            if (!tipoMedida) {
                alert('Selecione o tipo de medida');
                return;
            }
            
            if (tipoMedida === 'Suspens√£o' && !diasSuspensao) {
                alert('Informe o n√∫mero de dias de suspens√£o');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Buscar dados do aluno do Supabase
                const { data: dadosAluno, error: alunoError } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma')
                    .eq('codigo', parseInt(alunoId))
                    .single();
                    
                if (alunoError || !dadosAluno) {
                    throw new Error('Aluno n√£o encontrado');
                }
                
                // Preparar descri√ß√£o da medida
                let especificacao = motivo;
                
                // Se faltas foram selecionadas, usar elas como especifica√ß√£o
                if (faltasSelecionadas && faltasSelecionadas.length > 0) {
                    especificacao = faltasSelecionadas.join(' | ');
                    console.log(`‚úÖ Faltas selecionadas: ${especificacao}`);
                } else if (!motivo || motivo.trim() === '') {
                    // Se n√£o h√° faltas selecionadas nem motivo, usar tipo da medida
                    especificacao = tipoMedida;
                }
                
                // Preparar dados base para salvar
                const dadosBase = {
                    codigo_matricula: dadosAluno.codigo.toString(),
                    nome_completo: dadosAluno['Nome completo'],
                    turma: dadosAluno.turma,
                    turno: turno,
                    data: data,
                    especificacao: especificacao,
                    observacao: acoes,
                    tipo_medida: tipoMedida,
                    criado_em: new Date().toISOString()
                };
                
                // Tentar incluir campos de prazo (se existirem no banco)
                if (prazoAssinatura) {
                    dadosBase.prazo_assinatura = prazoAssinatura;
                    dadosBase.prazo_status = 'pendente';
                }
                
                // Salvar medida diretamente no Supabase
                const { data: result, error: saveError } = await window.supabaseClient
                    .from('medidas')
                    .insert([dadosBase]);
                
                if (saveError) {
                    // Se erro √© por causa das colunas de prazo, tentar sem elas
                    if (saveError.code === '42703' && prazoAssinatura) {
                        console.warn('‚ö†Ô∏è Salvando sem campos de prazo (colunas n√£o existem)');
                        delete dadosBase.prazo_assinatura;
                        delete dadosBase.prazo_status;
                        
                        const { data: result2, error: saveError2 } = await window.supabaseClient
                            .from('medidas')
                            .insert([dadosBase]);
                            
                        if (saveError2) throw saveError2;
                        
                        showMessage('‚ö†Ô∏è Medida salva (prazo ser√° registrado ap√≥s configura√ß√£o do banco)', 'warning');
                    } else {
                        throw saveError;
                    }
                }
                
                // ARMAZENAR DADOS ANTES DE LIMPAR FORMUL√ÅRIO
                // Armazenar dados do aluno para WhatsApp
                window.ultimoAlunoSalvo = {
                    id: dadosAluno.codigo,
                    nome: dadosAluno['Nome completo'],
                    turma: dadosAluno.turma,
                    telefone1: dadosAluno['Telefone do respons√°vel'] || dadosAluno['Telefone do respons√°vel 2'] || null,
                    telefone2: null
                };

                // Armazenar dados da medida para WhatsApp
                window.ultimaMedidaSalva = {
                    tipo: tipoMedida,
                    especificacao: especificacao, // Usar especifica√ß√£o real que foi salva (faltas selecionadas ou motivo)
                    motivo: motivo,
                    providencias: acoes,
                    data: data || new Date().toISOString().split('T')[0] // Passar sempre no formato YYYY-MM-DD
                };

                console.log('üìã Dados da medida armazenados para WhatsApp:', window.ultimaMedidaSalva);

                // ‚ö° VERIFICAR CHECKBOX ANTES DE LIMPAR FORMUL√ÅRIO
                const checkboxElement = document.getElementById('enviarWhatsAppAuto');
                const enviarAuto = checkboxElement?.checked;

                console.log('üîç Debug checkbox WhatsApp (ANTES do reset):', {
                    elemento: !!checkboxElement,
                    checked: enviarAuto,
                    valor: checkboxElement?.checked
                });

                // Atualizar nota disciplinar do aluno
                if (typeof window.atualizarNotaDisciplinar === 'function') {
                    await window.atualizarNotaDisciplinar(alunoId, dadosAluno);
                }

                // Limpar formul√°rio
                form.reset();
                const campoSuspensao = document.getElementById('campoSuspensao');
                const diasSuspensao = document.getElementById('diasSuspensao');
                const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
                const campoMotivoOriginal = document.getElementById('campoMotivoOriginal');

                if (campoSuspensao) campoSuspensao.style.display = 'none';
                if (diasSuspensao) diasSuspensao.required = false;
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'none';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'block';

                // Mostrar mensagem de sucesso
                showMessage('‚úÖ Medida disciplinar salva com sucesso!', 'success');

                // ‚úÖ PROCESSAR ENVIO WHATSAPP (checkbox j√° verificado antes do reset)
                if (enviarAuto) {
                    // Enviar WhatsApp automaticamente
                    console.log('üì± ‚úÖ CHECKBOX ESTAVA MARCADO - Enviando WhatsApp automaticamente...');
                    showMessage('üì± Enviando WhatsApp...', 'info');
                    setTimeout(() => {
                        console.log('üì± ‚è∞ Timeout executado - chamando enviarWhatsAppMedida()');
                        enviarWhatsAppMedida();
                    }, 1000); // Pequeno delay para garantir que dados est√£o prontos
                } else {
                    console.log('üì± ‚ùå CHECKBOX N√ÉO ESTAVA MARCADO - n√£o enviando WhatsApp');
                }

                // Recarregar registros recentes
                await carregarRegistrosRecentes();
                
                // Recarregar estat√≠sticas
                await carregarEstatisticasMedidas();
                
                // Recarregar alertas de prazo
                await carregarAlertasPrazo();
                
                // Se a ficha do aluno estiver aberta, recarregar
                if (window.dadosAlunoAtual && window.dadosAlunoAtual.id === alunoId) {
                    await carregarFichaDisciplinar();
                }
                
                // Mostrar nota disciplinar atualizada
                showMessage(`üéØ Medida registrada! Nota disciplinar atualizada.`, 'info');
                
            } catch (error) {
                console.error('Erro ao salvar medida:', error);
                alert('Erro ao salvar medida: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö†Ô∏è Salvar Medida';
            }
        }
        
        // Fun√ß√µes para gerenciar sele√ß√£o de medidas categorizadas
        function configurarCamposMedida() {
            const tipoMedida = document.getElementById('tipoMedida').value;
            const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
            const campoMotivoOriginal = document.getElementById('campoMotivoOriginal');
            const selectCategoria = document.getElementById('categoriaMedida');
            const selectFalta = document.getElementById('faltaEspecifica');
            const textareaMotivo = document.getElementById('motivoMedida');

            // Controlar exibi√ß√£o do campo de prazo
            const campoPrazo = document.getElementById('prazoAssinaturaInfo');
            const campoStatusPrazo = document.getElementById('diasRestantesInfo');
            const medidasComPrazo = [
                'Advert√™ncia Verbal',
                'Advert√™ncia Escrita',
                'Suspens√£o',
                'A√ß√£o Educativa'
            ];

            // Controlar campo de prazo principal
            if (campoPrazo) {
                if (medidasComPrazo.includes(tipoMedida)) {
                    campoPrazo.style.display = 'block';
                    console.log(`‚úÖ Campo de prazo exibido para: ${tipoMedida}`);
                } else {
                    campoPrazo.style.display = 'none';
                    console.log(`‚ùå Campo de prazo oculto para: ${tipoMedida}`);
                }
            }

            // Controlar campo de status do prazo
            if (campoStatusPrazo) {
                if (medidasComPrazo.includes(tipoMedida)) {
                    // Manter l√≥gica existente para quando mostrar status
                    // (ser√° controlado por outras fun√ß√µes conforme necess√°rio)
                } else {
                    campoStatusPrazo.style.display = 'none';
                }
            }

            // Medidas que requerem sele√ß√£o de falta categorizada
            const medidasComCategoria = [
                'Fato Observado Negativo',
                'Advert√™ncia Verbal',
                'Advert√™ncia Escrita',
                'Suspens√£o',
                'A√ß√£o Educativa'
            ];

            // Medidas positivas que tamb√©m usam sele√ß√£o de categoria
            const medidasPositivas = [
                'Elogio Individual',
                'Elogio Coletivo',
                'Fato Observado Positivo'
            ];
            
            if (medidasComCategoria.includes(tipoMedida)) {
                // Mostrar campos de categoria para medidas disciplinares (M√öLTIPLAS CATEGORIAS)
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'block';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'none';
                if (selectCategoria) selectCategoria.required = false; // N√£o usar o select antigo
                if (selectFalta) selectFalta.required = false; // Usar sistema de m√∫ltiplas categorias
                if (textareaMotivo) {
                    textareaMotivo.required = false;
                    textareaMotivo.removeAttribute('required');
                }
                
                // Esconder o select antigo de categoria (mantendo para compatibilidade)
                if (selectCategoria) {
                    selectCategoria.style.display = 'none';
                }
                
                // Limpar sele√ß√µes m√∫ltiplas anteriores
                limparSelecoesCategorias();
                
                // Carregar interface de categorias m√∫ltiplas
                carregarFaltasMultiplasCategorias();
                
            } else if (medidasPositivas.includes(tipoMedida)) {
                // Para medidas positivas, mostrar sele√ß√£o de situa√ß√µes espec√≠ficas
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'block';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'none';
                if (selectCategoria) selectCategoria.style.display = 'none';
                if (selectFalta) selectFalta.required = false;
                if (textareaMotivo) {
                    textareaMotivo.required = false;
                    textareaMotivo.removeAttribute('required');
                }
                
                // Limpar sele√ß√µes m√∫ltiplas
                limparSelecoesCategorias();
                
                // Carregar op√ß√µes espec√≠ficas para medidas positivas
                carregarOpcoesPositivas(tipoMedida);
                
            } else {
                // Para outras medidas, usar campo de texto tradicional
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'none';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'block';
                if (selectCategoria) selectCategoria.required = false;
                if (selectFalta) selectFalta.required = false;
                if (textareaMotivo) {
                    textareaMotivo.required = true;
                    textareaMotivo.setAttribute('required', '');
                }
                
                // Mostrar select normal se estiver escondido
                if (selectCategoria) {
                    selectCategoria.style.display = 'block';
                }
                
                // Limpar sele√ß√µes m√∫ltiplas
                limparSelecoesCategorias();
            }
            
            // Gerenciar campo de suspens√£o
            const campoSuspensao = document.getElementById('campoSuspensao');
            const diasSuspensao = document.getElementById('diasSuspensao');
            
            if (tipoMedida === 'Suspens√£o') {
                campoSuspensao.style.display = 'block';
                diasSuspensao.required = true;
            } else {
                campoSuspensao.style.display = 'none';
                diasSuspensao.required = false;
            }

            // Recalcular prazo quando campos de medida mudam
            setTimeout(() => {
                if (typeof calcularPrazoAutomatico === 'function') {
                    calcularPrazoAutomatico();
                }
            }, 100);
        }
        
        function carregarFaltasPorCategoria() {
            console.log('üéØ carregarFaltasPorCategoria() chamada');
            const categoria = document.getElementById('categoriaMedida').value;
            const selectFalta = document.getElementById('faltaEspecifica');
            const tipoMedida = document.getElementById('tipoMedida').value;
            const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
            
            if (!categoria) {
                // Limpar sistema de sele√ß√£o m√∫ltipla
                const container = document.getElementById('faltasMultiContainer');
                if (container) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Primeiro selecione uma categoria...</div>';
                }
                faltasSelecionadas = [];
                atualizarTagsFaltas();
                return;
            }
            
            console.log('Tipo de medida:', tipoMedida, 'Categoria:', categoria);
            
            // Mostrar campo de sele√ß√£o
            if (campoSelecaoFalta) {
                campoSelecaoFalta.style.display = 'block';
            }
            
            // Para medidas positivas, usar sistema de sele√ß√£o m√∫ltipla
            if (['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida)) {
                carregarOpcoesPositivas(categoria, tipoMedida);
                return; // Sai da fun√ß√£o aqui para evitar c√≥digo duplicado
            }
            
            // Para medidas disciplinares (negativas), usar sele√ß√£o m√∫ltipla de faltas
            if (['Fato Observado Negativo', 'Advert√™ncia Verbal', 'Advert√™ncia Escrita', 'Suspens√£o', 'A√ß√£o Educativa'].includes(tipoMedida)) {
                carregarFaltasMultiplas(categoria);
                return; // Sai da fun√ß√£o aqui
            }
            
            // C√ìDIGO ORIGINAL PRESERVADO PARA COMPATIBILIDADE:
            if (['Elogio Individual - ORIGINAL', 'Elogio Coletivo - ORIGINAL', 'Fato Observado Positivo - ORIGINAL'].includes(tipoMedida)) {
                let opcoes = '';
                
                if (categoria === 'comportamento') {
                    opcoes = `
                        <option value="Demonstrou excel√™ncia em disciplina e respeito">Demonstrou excel√™ncia em disciplina e respeito</option>
                        <option value="Auxiliou colegas e demonstrou solidariedade">Auxiliou colegas e demonstrou solidariedade</option>
                        <option value="Apresentou-se impecavelmente uniformizado">Apresentou-se impecavelmente uniformizado</option>
                        <option value="Liderou atividades com responsabilidade">Liderou atividades com responsabilidade</option>
                        <option value="Manteve postura exemplar em forma√ß√£o">Manteve postura exemplar em forma√ß√£o</option>
                    `;
                } else if (categoria === 'academico') {
                    opcoes = `
                        <option value="Excelente desempenho em avalia√ß√µes">Excelente desempenho em avalia√ß√µes</option>
                        <option value="Participa√ß√£o ativa e construtiva em aula">Participa√ß√£o ativa e construtiva em aula</option>
                        <option value="Entrega pontual de todas as atividades">Entrega pontual de todas as atividades</option>
                        <option value="Demonstrou evolu√ß√£o significativa no aprendizado">Demonstrou evolu√ß√£o significativa no aprendizado</option>
                    `;
                } else if (categoria === 'cidadania') {
                    opcoes = `
                        <option value="Participou ativamente de a√ß√µes c√≠vicas">Participou ativamente de a√ß√µes c√≠vicas</option>
                        <option value="Demonstrou respeito aos s√≠mbolos nacionais">Demonstrou respeito aos s√≠mbolos nacionais</option>
                        <option value="Promoveu a√ß√µes de cidadania na escola">Promoveu a√ß√µes de cidadania na escola</option>
                        <option value="Colaborou com a manuten√ß√£o do patrim√¥nio escolar">Colaborou com a manuten√ß√£o do patrim√¥nio escolar</option>
                    `;
                }
                
                selectFalta.innerHTML = `
                    <option value="">Selecione o motivo do elogio...</option>
                    ${opcoes}
                    <option value="outro">Outro (especificar nas observa√ß√µes)</option>
                `;
                
            } else {
                // Para medidas disciplinares, usar as faltas categorizadas
                if (window.MEDIDAS_DISCIPLINARES && window.MEDIDAS_DISCIPLINARES[categoria]) {
                    const medidas = window.MEDIDAS_DISCIPLINARES[categoria];
                    
                    selectFalta.innerHTML = `
                        <option value="">Selecione a falta espec√≠fica...</option>
                        ${medidas.map(medida => `<option value="${medida}">${medida}</option>`).join('')}
                    `;
                } else {
                    selectFalta.innerHTML = '<option value="">Erro ao carregar faltas da categoria</option>';
                }
            }
        }

        // Nova fun√ß√£o de inicializa√ß√£o com sistema de loading
        async function inicializarMedidasDisciplinaresComLoading() {
            try {
                // ETAPA 1: Conectar ao banco (20%)
                window.loadingManager.updateProgress(10, 'Conectando ao banco de dados...');
                
                // Verificar se sistema Supabase est√° pronto
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                window.loadingManager.updateProgress(20, 'Conectado ao banco de dados');
                
                // ETAPA 2: Carregar lista de alunos (40%)
                window.loadingManager.updateProgress(25, 'Carregando lista de alunos...');
                
                // Definir data atual no formul√°rio
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) dataMedida.value = hoje;
                
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                window.loadingManager.updateProgress(40, 'Alunos carregados com sucesso');
                
                // ETAPA 3: Calcular estat√≠sticas (60%)
                window.loadingManager.updateProgress(45, 'Calculando estat√≠sticas...');
                await carregarEstatisticasMedidas();
                window.loadingManager.updateProgress(60, 'Estat√≠sticas calculadas');
                
                // ETAPA 4: Carregar registros recentes (80%)
                window.loadingManager.updateProgress(65, 'Carregando registros recentes...');
                await carregarRegistrosRecentes();
                window.loadingManager.updateProgress(80, 'Registros carregados');
                
                // ETAPA 5: Finalizar interface (100%)
                window.loadingManager.updateProgress(85, 'Configurando alertas...');
                
                // Carregar alertas em background
                await carregarAlertasPrazo();
                
                window.loadingManager.updateProgress(95, 'Finalizando interface...');
                
                // Pequena pausa para mostrar conclus√£o
                await new Promise(resolve => setTimeout(resolve, 500));
                
                window.loadingManager.updateProgress(100, 'Sistema carregado com sucesso!');
                
                // Aguardar um pouco antes de esconder
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Esconder loading
                window.loadingManager.hide();
                
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar sistema:', error);
                window.loadingManager.updateProgress(100, 'Erro no carregamento - verifique a conex√£o');
                
                // Esconder loading ap√≥s erro
                setTimeout(() => {
                    window.loadingManager.hide();
                    showMessage('Erro ao carregar sistema. Recarregue a p√°gina.', 'error');
                }, 2000);
            }
        }

        // Fun√ß√£o de inicializa√ß√£o otimizada com carregamento progressivo (ANTIGA - mantida como backup)
        async function inicializarMedidasDisciplinares() {
            try {
                showMessage('Carregando m√≥dulo de medidas...', 'success');
                
                // Definir data atual no formul√°rio de medidas (opera√ß√£o r√°pida)
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) {
                    dataMedida.value = hoje;
                }
                
                // Verificar se sistema Supabase est√° pronto
                if (!window.supabaseClient) {
                    showMessage('‚ö†Ô∏è Supabase n√£o conectado - aguardando...', 'warning');
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                // ETAPA 1: Carregamento essencial (r√°pido)
                showMessage('üìã Carregando interface b√°sica...', 'info');
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                showMessage('‚úÖ Interface pronta! Carregando dados em background...', 'success');
                
                // ETAPA 2: Carregamento em background (n√£o bloqueia)
                setTimeout(async () => {
                    try {
                        // Carregar estat√≠sticas em background
                        await carregarEstatisticasMedidas();
                        
                        // Carregar registros recentes em background
                        await carregarRegistrosRecentes();
                        
                        // Carregar alertas em background
                        // Carregar alertas de prazo
                        await carregarAlertasPrazo();
                        
                        console.log('‚úÖ Carregamento completo finalizado');
                    } catch (error) {
                        console.warn('Erro no carregamento em background:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro ao inicializar medidas:', error);
                showMessage('Erro ao carregar m√≥dulo de medidas', 'error');
            }
        }

        // Carregar alertas
        async function carregarAlertas() {
            const container = document.getElementById('alertasContainer');
            
            try {
                const alertas = [];
                
                // Verificar alunos com muitas medidas
                const limiteMedidas = parseInt(localStorage.getItem('limiteMedidas') || '5');
                
                // Buscar alunos com muitas medidas usando as views
                try {
                    const { data: alunosRisco, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .lt('nota_atual', 7.0); // Alunos com nota baixa
                    
                    if (!error && alunosRisco) {
                        alunosRisco.forEach(aluno => {
                            let tipo = 'warning';
                            let icone = '‚ö†Ô∏è';
                            let texto = '';
                            
                            if (aluno.nota_atual < 5.0) {
                                tipo = 'danger';
                                icone = 'üö®';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota CR√çTICA: ${aluno.nota_atual.toFixed(2)}`;
                            } else if (aluno.nota_atual < 6.0) {
                                tipo = 'warning';
                                icone = '‚ö†Ô∏è';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota BAIXA: ${aluno.nota_atual.toFixed(2)}`;
                            }
                            
                            if (texto) {
                                alertas.push({ tipo, icone, texto, alunoId: aluno.codigo_aluno });
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Erro ao buscar alunos de risco:', error);
                }
                
                // Verificar se h√° medidas registradas hoje
                const hoje = new Date().toISOString().split('T')[0];
                try {
                    if (window.db) {
                        const medidasHoje = await window.db.collection('medidas_disciplinares')
                            .get();
                        
                        let contadorHoje = 0;
                        medidasHoje.forEach(doc => {
                            const data = doc.data();
                            const dataMedida = data.data ? data.data.split('T')[0] : null;
                            if (dataMedida === hoje) {
                                contadorHoje++;
                            }
                        });
                        
                        if (contadorHoje > 5) {
                            alertas.push({
                                tipo: 'info',
                                icone: 'üìä',
                                texto: `${contadorHoje} medidas registradas hoje - dia movimentado`
                            });
                        }
                    }
                } catch (error) {
                    console.log('Erro ao verificar medidas de hoje:', error);
                }
                
                // Exibir alertas
                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-text">‚úÖ Nenhum alerta no momento - situa√ß√£o sob controle</div>
                            <span class="trend-indicator trend-down">üìâ Positivo</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = alertas.map(alerta => `
                        <div class="insight-item" ${alerta.alunoId ? `style="cursor: pointer;" onclick="destacarAluno('${alerta.alunoId}')"` : ''}>
                            <div class="insight-text">${alerta.icone} ${alerta.texto}</div>
                            <span class="trend-indicator trend-${alerta.tipo === 'danger' ? 'up' : alerta.tipo === 'warning' ? 'stable' : 'down'}">
                                ${alerta.tipo === 'danger' ? 'üö® Cr√≠tico' : alerta.tipo === 'warning' ? '‚ö†Ô∏è Aten√ß√£o' : '‚ÑπÔ∏è Info'}
                            </span>
                        </div>
                    `).join('');
                }
                
                console.log(`üö® ${alertas.length} alerta(s) carregado(s)`);
                
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-text">‚ö†Ô∏è Erro ao carregar alertas</div>
                        <span class="trend-indicator trend-up">‚ùå Erro</span>
                    </div>
                `;
            }
        }

        // Sistema de Nota Disciplinar
        // REMOVIDO: Fun√ß√£o calcularNotaDisciplinar
        // Substitu√≠da pelas views v_nota_disciplinar_atual e v_nota_disciplinar_contadores
        
        async function obterNotaDisciplinar(codigoAluno) {
            try {
                // Usar o servi√ßo importado se dispon√≠vel
                if (window.getNotaDisciplinar) {
                    return await window.getNotaDisciplinar(codigoAluno);
                }
                
                // Fallback para implementa√ß√£o direta
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const { data, error } = await window.supabaseClient
                    .from('v_nota_disciplinar_atual')
                    .select('*')
                    .eq('codigo_aluno', codigoAluno)
                    .limit(1);

                if (error) {
                    console.warn('Erro ao obter nota disciplinar:', error);
                    return { data: null, error };
                }

                return { data: data?.[0] || null, error: null };
            } catch (error) {
                console.error('Erro ao consultar nota disciplinar:', error);
                return { data: null, error };
            }
        }
        
        function obterMencaoDisciplinar(nota) {
            if (nota >= 10) return { mencao: 'Excepcional', cor: '#28a745', emoji: '‚≠ê' };
            if (nota >= 9) return { mencao: '√ìtimo', cor: '#17a2b8', emoji: 'üòä' };
            if (nota >= 7) return { mencao: 'Bom', cor: '#ffc107', emoji: 'üôÇ' };
            if (nota >= 5) return { mencao: 'Regular', cor: '#fd7e14', emoji: 'üòê' };
            if (nota >= 2) return { mencao: 'Insuficiente', cor: '#dc3545', emoji: 'üòü' };
            return { mencao: 'Incompat√≠vel', cor: '#6c757d', emoji: 'üò®' };
        }

        // Fun√ß√£o para destacar aluno na busca (placeholder)
        function destacarAluno(alunoId) {
            console.log('Destacando aluno:', alunoId);
            showMessage(`Aluno ${alunoId} selecionado`, 'info');
        }

        // Carregar alertas de prazos de assinatura
        async function carregarAlertasPrazo() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);

                // Buscar medidas com prazo de assinatura pendente
                let medidasComPrazo = [];
                
                try {
                    const { data, error } = await window.supabaseClient
                        .from('medidas')
                        .select('id, codigo_matricula, nome_completo, tipo_medida, especificacao, prazo_assinatura, prazo_status, data')
                        .not('prazo_assinatura', 'is', null)
                        .neq('prazo_status', 'entregue')
                        .in('tipo_medida', ['Advert√™ncia Verbal', 'Advert√™ncia Escrita', 'Suspens√£o', 'A√ß√£o Educativa'])
                        .order('prazo_assinatura', { ascending: true });

                    if (error) {
                        // Se as colunas n√£o existem, mostrar alerta amig√°vel
                        if (error.code === '42703') {
                            console.warn('‚ö†Ô∏è Colunas de prazo n√£o encontradas no banco.');
                            console.log(`
üí° Para ativar os alertas de prazo, execute este SQL no Supabase:

ALTER TABLE medidas
ADD COLUMN IF NOT EXISTS prazo_assinatura date,
ADD COLUMN IF NOT EXISTS prazo_status text default 'pendente',
ADD COLUMN IF NOT EXISTS prazo_entregue_em timestamp;

-- Definir prazo de 3 dias √∫teis para medidas j√° existentes
UPDATE medidas
SET prazo_assinatura = (data + interval '3 days')::date
WHERE prazo_assinatura IS NULL
  AND tipo_medida IN ('Advert√™ncia Verbal', 'Advert√™ncia Escrita', 'Suspens√£o', 'A√ß√£o Educativa');
                            `);
                            await atualizarContainerAlertas([{
                                tipo: 'warning',
                                icone: '‚öôÔ∏è',
                                texto: 'Sistema de alertas de prazo em configura√ß√£o',
                                detalhes: 'Verifique o console para instru√ß√µes de ativa√ß√£o'
                            }]);
                            return;
                        }
                        throw error;
                    }
                    
                    medidasComPrazo = data || [];
                    
                } catch (error) {
                    console.warn('Erro ao buscar prazos:', error);
                    // Mostrar mensagem amig√°vel em caso de erro
                    await atualizarContainerAlertas([{
                        tipo: 'info',
                        icone: '‚ÑπÔ∏è',
                        texto: 'Sistema de alertas de prazo em configura√ß√£o',
                        detalhes: 'As funcionalidades de prazo estar√£o dispon√≠veis ap√≥s a configura√ß√£o do banco'
                    }]);
                    return;
                }

                const alertasPrazo = [];

                // Processar cada medida com prazo
                medidasComPrazo?.forEach(medida => {
                    const dataPrazo = new Date(medida.prazo_assinatura);
                    dataPrazo.setHours(0, 0, 0, 0);
                    
                    const diffTime = dataPrazo - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let statusTexto, statusIcon, prioridade;
                    
                    if (diffDays < 0) {
                        // Vencido
                        statusTexto = `Prazo vencido h√° ${Math.abs(diffDays)} dia(s)`;
                        statusIcon = 'üî¥';
                        prioridade = 'danger';
                    } else if (diffDays === 0) {
                        // Vence hoje
                        statusTexto = 'Prazo vence hoje!';
                        statusIcon = 'üü°';
                        prioridade = 'warning';
                    } else if (diffDays <= 2) {
                        // Vence em 1-2 dias
                        statusTexto = `Prazo em ${diffDays} dia(s)`;
                        statusIcon = 'üü†';
                        prioridade = 'warning';
                    } else {
                        // Em prazo normal
                        statusTexto = `Prazo em ${diffDays} dia(s)`;
                        statusIcon = 'üü¢';
                        prioridade = 'info';
                    }
                    
                    alertasPrazo.push({
                        id: medida.id,
                        tipo: prioridade,
                        icone: statusIcon,
                        texto: `${medida.nome_completo} - ${medida.tipo_medida}: ${statusTexto}`,
                        detalhes: medida.especificacao,
                        diasRestantes: diffDays,
                        alunoId: medida.codigo_matricula,
                        prazoData: medida.prazo_assinatura
                    });
                });

                // Ordenar por prioridade (vencidos primeiro, depois por proximidade)
                alertasPrazo.sort((a, b) => {
                    if (a.diasRestantes < 0 && b.diasRestantes >= 0) return -1;
                    if (b.diasRestantes < 0 && a.diasRestantes >= 0) return 1;
                    return a.diasRestantes - b.diasRestantes;
                });

                // Atualizar container de alertas com os prazos
                await atualizarContainerAlertas(alertasPrazo);

            } catch (error) {
                console.error('Erro ao carregar alertas de prazo:', error);
            }
        }
        
        // Atualizar container de alertas incluindo prazos e outros alertas
        async function atualizarContainerAlertas(alertasPrazo = []) {
            const container = document.getElementById('alertasContainer');
            
            try {
                // Carregar outros alertas existentes (da fun√ß√£o original)
                const outrosAlertas = await obterOutrosAlertas();
                
                // Combinar todos os alertas
                const todosAlertas = [...alertasPrazo, ...outrosAlertas];
                
                if (todosAlertas.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-text">‚úÖ Nenhum alerta no momento - situa√ß√£o sob controle</div>
                            <span class="trend-indicator trend-down">üìâ Positivo</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = todosAlertas.map(alerta => {
                        const botaoEntregue = alerta.id ? 
                            `<button class="btn-marcar-entregue" onclick="marcarPrazoEntregue(${alerta.id})" title="Marcar como entregue">
                                ‚úÖ Entregue
                            </button>` : '';
                        
                        return `
                            <div class="insight-item alerta-prazo" ${alerta.alunoId ? `style="cursor: pointer;" onclick="destacarAluno('${alerta.alunoId}')"` : ''}>
                                <div class="insight-content">
                                    <div class="insight-text">${alerta.icone} ${alerta.texto}</div>
                                    ${alerta.detalhes ? `<div class="insight-detalhes">${alerta.detalhes}</div>` : ''}
                                    ${alerta.prazoData ? `<div class="insight-prazo">Prazo: ${new Date(alerta.prazoData).toLocaleDateString('pt-BR')}</div>` : ''}
                                </div>
                                <div class="insight-actions">
                                    <span class="trend-indicator trend-${alerta.tipo === 'danger' ? 'up' : alerta.tipo === 'warning' ? 'stable' : 'down'}">
                                        ${alerta.tipo === 'danger' ? 'üö® Cr√≠tico' : alerta.tipo === 'warning' ? '‚ö†Ô∏è Aten√ß√£o' : '‚ÑπÔ∏è Info'}
                                    </span>
                                    ${botaoEntregue}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log(`üìã ${todosAlertas.length} alerta(s) carregado(s) (${alertasPrazo.length} de prazos)`);
                
            } catch (error) {
                console.error('Erro ao atualizar container de alertas:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-text">‚ö†Ô∏è Erro ao carregar alertas</div>
                        <span class="trend-indicator trend-up">‚ùå Erro</span>
                    </div>
                `;
            }
        }
        
        // Obter outros alertas (da fun√ß√£o original)
        async function obterOutrosAlertas() {
            const alertas = [];
            
            try {
                // Verificar alunos com nota baixa
                const { data: alunosRisco, error } = await window.supabaseClient
                    .from('v_nota_disciplinar_atual')
                    .select('*')
                    .lt('nota_atual', 7.0)
                    .limit(5);

                if (!error && alunosRisco?.length > 0) {
                    alunosRisco.forEach(aluno => {
                        // Detectar o nome correto (pode variar entre campos)
                        const nomeAluno = aluno.nome_aluno || aluno.nome_completo || aluno['Nome completo'] || 'Nome n√£o encontrado';
                        const turmaAluno = aluno.turma || 'Turma n√£o informada';
                        const codigoAluno = aluno.codigo_aluno || aluno.codigo_matricula || aluno.codigo;
                        
                        alertas.push({
                            tipo: 'warning',
                            icone: '‚ö†Ô∏è',
                            texto: `${nomeAluno} (${turmaAluno}) - Nota disciplinar baixa: ${aluno.nota_atual?.toFixed(1)}`,
                            alunoId: codigoAluno
                        });
                    });
                }
            } catch (error) {
                console.warn('Erro ao obter alertas de nota:', error);
            }
            
            return alertas;
        }
        
        // Marcar prazo como entregue
        async function marcarPrazoEntregue(medidaId) {
            try {
                const { error } = await window.supabaseClient
                    .from('medidas')
                    .update({
                        prazo_status: 'entregue',
                        prazo_entregue_em: new Date().toISOString()
                    })
                    .eq('id', medidaId);

                if (error) throw error;

                showMessage('‚úÖ Prazo marcado como entregue!', 'success');
                
                // Recarregar alertas
                await carregarAlertasPrazo();
                
            } catch (error) {
                console.error('Erro ao marcar prazo como entregue:', error);
                alert('Erro ao marcar prazo como entregue: ' + error.message);
            }
        }

        // Carregar estat√≠sticas de medidas disciplinares
        async function carregarEstatisticasMedidas() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`üìä [ESTAT√çSTICAS] Carregando estat√≠sticas da unidade: ${unidadeAtual}`);

                // Buscar c√≥digos dos alunos da unidade atual
                const { data: alunosDaUnidade, error: errorAlunos } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo')
                    .eq('unidade', unidadeAtual);

                if (errorAlunos) throw errorAlunos;

                const codigosDaUnidade = alunosDaUnidade?.map(a => a.codigo) || [];

                if (codigosDaUnidade.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum aluno encontrado na unidade selecionada');
                    // Zerar estat√≠sticas
                    document.getElementById('totalMedidas').textContent = '0';
                    document.getElementById('medidasMes').textContent = '0';
                    document.getElementById('medidasSemana').textContent = '0';
                    document.getElementById('alunosAfetados').textContent = '0';
                    document.getElementById('mediaNotaEscola').textContent = '8.0';
                    return;
                }

                // Carregar medidas APENAS dos alunos da unidade
                const { data: todasMedidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('id, codigo_matricula, criado_em')
                    .in('codigo_matricula', codigosDaUnidade);

                if (error) throw error;
                
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay()); // In√≠cio da semana (domingo)
                
                // Calcular estat√≠sticas
                const totalMedidas = todasMedidas.length;
                
                const medidasMes = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioMes;
                }).length;
                
                const medidasSemana = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioSemana;
                }).length;
                
                // Contar alunos √∫nicos com medidas
                const alunosUnicos = new Set(todasMedidas.map(medida => medida.codigo_matricula));
                const alunosAfetados = alunosUnicos.size;
                
                // Calcular m√©dia de nota disciplinar da unidade
                let mediaNotaEscola = 8.0;
                try {
                    // Usar alunos da unidade (j√° carregados acima)
                    const todosAlunos = alunosDaUnidade;

                    if (todosAlunos && todosAlunos.length > 0) {
                        let somaNotas = 0;
                        const totalAlunos = todosAlunos.length;
                        
                        // Agrupar medidas por aluno
                        const medidasPorAluno = {};
                        todasMedidas.forEach(medida => {
                            if (!medidasPorAluno[medida.codigo_matricula]) {
                                medidasPorAluno[medida.codigo_matricula] = [];
                            }
                            medidasPorAluno[medida.codigo_matricula].push(medida);
                        });
                        
                        // Otimiza√ß√£o: Buscar notas dos alunos da unidade usando a view
                        try {
                            const { data: todasNotas, error: notasError } = await window.supabaseClient
                                .from('v_nota_disciplinar_atual')
                                .select('codigo_aluno, nota_atual')
                                .in('codigo_aluno', codigosDaUnidade);
                            
                            if (!notasError && todasNotas) {
                                // Criar mapa de notas por aluno
                                const notasPorAluno = {};
                                todasNotas.forEach(nota => {
                                    notasPorAluno[nota.codigo_aluno] = nota.nota_atual;
                                });
                                
                                // Somar notas de todos os alunos
                                todosAlunos.forEach(aluno => {
                                    const notaAluno = notasPorAluno[aluno.codigo] || 8.0;
                                    somaNotas += parseFloat(notaAluno) || 8.0;
                                });
                                
                            } else {
                                console.warn('Usando fallback para c√°lculo de notas:', notasError);
                                // Fallback: todos com nota 8.0
                                somaNotas = todosAlunos.length * 8.0;
                            }
                        } catch (viewError) {
                            console.warn('Erro ao buscar notas via view, usando fallback:', viewError);
                            // Fallback: todos com nota 8.0
                            somaNotas = todosAlunos.length * 8.0;
                        }
                        
                        mediaNotaEscola = (somaNotas / totalAlunos).toFixed(2);
                    }
                } catch (error) {
                    console.error('Erro ao calcular m√©dia da escola:', error);
                }
                
                // Atualizar interface
                document.getElementById('totalMedidas').textContent = totalMedidas;
                document.getElementById('medidasMes').textContent = medidasMes;
                document.getElementById('medidasSemana').textContent = medidasSemana;
                document.getElementById('alunosAfetados').textContent = alunosAfetados;
                document.getElementById('mediaNotaEscola').textContent = mediaNotaEscola;
                
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
                // Valores padr√£o em caso de erro
                document.getElementById('totalMedidas').textContent = '0';
                document.getElementById('medidasMes').textContent = '0';
                document.getElementById('medidasSemana').textContent = '0';
                document.getElementById('alunosAfetados').textContent = '0';
                document.getElementById('mediaNotaEscola').textContent = '8.00';
            }
        }

        // Fun√ß√£o auxiliar para formatar datas corretamente (evitar problema de timezone)
        function formatarDataCorreta(dataInput) {
            if (!dataInput) return 'Data n√£o informada';

            if (typeof dataInput === 'string') {
                // Se √© string, extrair apenas a parte da data (YYYY-MM-DD)
                const dateStr = dataInput.split('T')[0];
                const [ano, mes, dia] = dateStr.split('-');
                return `${dia}/${mes}/${ano}`;
            } else {
                // Se √© objeto Date, usar toLocaleDateString mas for√ßar UTC
                const utcDate = new Date(dataInput.getTime() + (dataInput.getTimezoneOffset() * 60000));
                return utcDate.toLocaleDateString('pt-BR');
            }
        }

        // Carregar registros recentes de medidas
        async function carregarRegistrosRecentes() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                console.log('üìã Carregando registros recentes...');
                
                // Carregar √∫ltimas 5 medidas
                const { data: medidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .order('criado_em', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                const container = document.getElementById('registrosRecentes');
                
                if (!medidas || medidas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>Nenhuma medida encontrada</h3>
                            <p>As medidas disciplinares registradas aparecer√£o aqui</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="records-list">';
                medidas.forEach(medida => {
                    // Usar data da ocorr√™ncia (n√£o criado_em) e corrigir timezone
                    const dataOcorrencia = medida.data || medida.criado_em;
                    const dataFormatada = formatarDataCorreta(dataOcorrencia);
                    const horaFormatada = new Date(medida.criado_em).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <div class="record-item">
                            <div class="record-header">
                                <span class="record-student">${medida.nome_completo}</span>
                                <span class="record-date">${dataFormatada} √†s ${horaFormatada}</span>
                            </div>
                            <div class="record-details">
                                <span class="record-type">${medida.tipo_medida}</span>
                                <span class="record-turma">Turma: ${medida.turma}</span>
                            </div>
                            <div class="record-description">${medida.especificacao || 'Sem descri√ß√£o'}</div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                console.log(`üìã ${medidas.length} registros recentes carregados`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar registros recentes:', error);
                const container = document.getElementById('registrosRecentes');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ùå</div>
                        <h3>Erro ao carregar registros</h3>
                        <p>Tente recarregar a p√°gina</p>
                    </div>
                `;
            }
        }
        
        // Tornar fun√ß√£o dispon√≠vel globalmente
        window.carregarRegistrosRecentes = carregarRegistrosRecentes;

        // Carregar dados de demonstra√ß√£o
        function carregarDadosDemoMedidas() {
            document.getElementById('registrosRecentes').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h3>Nenhum registro encontrado</h3>
                    <p>Sistema configurado para come√ßar a registrar faltas e medidas</p>
                </div>
            `;

            document.getElementById('alertasContainer').innerHTML = `
                <div class="insight-item">
                    <div class="insight-text">üìä Sistema configurado para ver alertas reais</div>
                    <span class="trend-indicator trend-down">‚ÑπÔ∏è Info</span>
                </div>
            `;
        }

        // ======= FUN√á√ïES DE FILTROS DIN√ÇMICOS =======
        
        let todosAlunosMedidas = [];
        let todasTurmasMedidas = [];
        
        // Tornar vari√°veis dispon√≠veis globalmente
        window.todosAlunosMedidas = todosAlunosMedidas;
        window.todasTurmasMedidas = todasTurmasMedidas;
        
        async function carregarTurmasEAlunos() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                    
                todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`üìö [CONSULTA] Carregando alunos da unidade: ${unidadeAtual}`);

                // Carregar alunos FILTRADOS pela unidade
                const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma, unidade')
                    .eq('unidade', unidadeAtual);

                if (error) throw error;
                
                alunosData.forEach(aluno => {
                    if (aluno['Nome completo'] && aluno.turma) {
                        todosAlunosMedidas.push({
                            id: aluno.codigo,
                            codigo: aluno.codigo,
                            nome: aluno['Nome completo'],
                            turma: aluno.turma,
                            foto_url: aluno.foto_url
                        });
                    }
                });
                
                
                /* C√ìDIGO ANTIGO COMENTADO
                try {
                        const response = await fetch('../data/db.json');
                        const dbData = await response.json();
                        if (dbData.alunos) {
                            console.log('FREQ: Carregando alunos do arquivo db.json');
                            todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;
                            
                            // Converter objeto em array
                            Object.keys(dbData.alunos).forEach(alunoId => {
                                const aluno = dbData.alunos[alunoId];
                                if (aluno.nome_completo && aluno.turma) {
                                    todosAlunosMedidas.push({
                                        id: aluno.id || alunoId,
                                        codigo: aluno.codigo || alunoId,
                                        nome: aluno.nome_completo,
                                        turma: aluno.turma
                                    });
                                }
                            });
                            
                            console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos');
                            console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                        }
                    } catch (fileError) {
                        console.error('Erro ao carregar do arquivo:', fileError);
                        return;
                    }
                } else {
                    console.log('FREQ: Carregando alunos do localDb');
                    todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;
                    
                    // Carregar alunos do localDb
                    // USAR SISTEMA H√çBRIDO em vez de localDb diretamente
                    const alunosSnapshot = await window.db.collection('alunos').get();
                    alunosSnapshot.docs.forEach(doc => {
                        const aluno = doc.data();
                        if (aluno.nome_completo && aluno.turma) {
                            todosAlunosMedidas.push({
                                id: aluno.id || doc.id,
                                codigo: aluno.codigo || doc.id,
                                nome: aluno.nome_completo,
                                turma: aluno.turma
                            });
                        }
                    });
                    
                    console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos do localDb');
                    console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                }
                */ // Fim do c√≥digo antigo comentado
                
                // Extrair turmas √∫nicas
                todasTurmasMedidas = [...new Set(todosAlunosMedidas.map(a => a.turma))].sort();
                window.todasTurmasMedidas = todasTurmasMedidas;
                
                // Carregar turmas no select
                const selectTurma = document.getElementById('turmaConsulta');
                if (selectTurma) {
                    const valorAtual = selectTurma.value; // Preservar sele√ß√£o atual
                    selectTurma.innerHTML = '<option value="">Selecione uma turma...</option>';
                    todasTurmasMedidas.forEach(turma => {
                        const selected = valorAtual === turma ? 'selected' : '';
                        selectTurma.innerHTML += `<option value="${turma}" ${selected}>Turma ${turma}</option>`;
                    });
                    
                } else {
                    console.log('‚ÑπÔ∏è [TURMAS] Elemento turmaConsulta n√£o encontrado (se√ß√£o pode ter sido removida)');
                }
                
                console.log(`‚úÖ Carregados: ${todasTurmasMedidas.length} turmas, ${todosAlunosMedidas.length} alunos`);
                
            } catch (error) {
                console.error('Erro ao carregar turmas e alunos:', error);
            }
        }
        
        // Tornar fun√ß√£o dispon√≠vel globalmente
        window.carregarTurmasEAlunos = carregarTurmasEAlunos;
        
        // Fun√ß√£o separada para configurar evento de turma (evita conflitos)
        function configurarEventoTurma() {
            console.log('‚öôÔ∏è [CONFIG] Configurando evento de sele√ß√£o de turma...');
            const selectTurma = document.getElementById('turmaConsulta');
            if (!selectTurma) {
                console.error('‚ùå [CONFIG] Select de turma n√£o encontrado');
                return;
            }
            
            // Remover todos os listeners antigos
            const novoSelect = selectTurma.cloneNode(true);
            selectTurma.parentNode.replaceChild(novoSelect, selectTurma);
            
            // Adicionar evento ao novo select
            novoSelect.addEventListener('change', function() {
                console.log('üî• [CONFIG-EVENT] Turma selecionada:', this.value);
                carregarAlunosPorTurma();
            });
            
            console.log('‚úÖ [CONFIG] Evento configurado com sucesso');
        }
        
        function carregarAlunosPorTurma() {
            console.log('üîç [CONSULTA] ========== INICIANDO carregarAlunosPorTurma ==========');
            const selectTurma = document.getElementById('turmaConsulta');
            const selectAluno = document.getElementById('alunoConsulta');
            
            if (!selectTurma || !selectAluno) {
                console.log('‚ÑπÔ∏è [CONSULTA] Elementos de consulta n√£o encontrados (se√ß√£o pode ter sido removida)');
                return;
            }
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar sele√ß√£o atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            if (!todosAlunosMedidas || todosAlunosMedidas.length === 0) {
                selectAluno.innerHTML = '<option value="">‚ùå Dados de alunos n√£o carregados</option>';
                selectAluno.disabled = true;
                carregarTurmasEAlunos().then(() => {
                    carregarAlunosPorTurma();
                });
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = todosAlunosMedidas.filter(aluno => aluno.turma === turmaSelecionada);
            console.log(`üîç [CONSULTA] Alunos encontrados na turma ${turmaSelecionada}:`, alunosDaTurma.length);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                // Usar o ID interno do aluno (que ser√° convertido para c√≥digo depois)
                selectAluno.innerHTML += `<option value="${aluno.id}" data-codigo="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
            console.log(`‚úÖ [CONSULTA] Carregados ${alunosDaTurma.length} alunos da turma ${turmaSelecionada}`);
            console.log('üèÅ [CONSULTA] ========== FIM carregarAlunosPorTurma ==========');
        }
        
        // Fun√ß√£o simplificada que s√≥ carrega alunos (sem recarregar dados)
        function carregarAlunosPorTurmaSimples() {
            const selectTurma = document.getElementById('turmaConsulta');
            const selectAluno = document.getElementById('alunoConsulta');
            
            if (!selectTurma || !selectAluno) {
                console.log('‚ÑπÔ∏è [CONSULTA-SIMPLES] Elementos de consulta n√£o encontrados (se√ß√£o pode ter sido removida)');
                return;
            }
            
            const turmaSelecionada = selectTurma.value;
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                habilitarBotaoPesquisa();
                return;
            }
            
            // Verificar se dados est√£o dispon√≠veis
            if (!todosAlunosMedidas || todosAlunosMedidas.length === 0) {
                carregarTurmasEAlunos(); // S√≥ se necess√°rio
                return;
            }
            
            // Filtrar alunos da turma selecionada
            const alunosDaTurma = todosAlunosMedidas.filter(aluno => 
                aluno.turma && aluno.turma.toString() === turmaSelecionada.toString()
            );
            
            if (alunosDaTurma.length === 0) {
                selectAluno.innerHTML = '<option value="">Nenhum aluno encontrado nesta turma</option>';
            } else {
                selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
                alunosDaTurma
                    .sort((a, b) => a.nome.localeCompare(b.nome))
                    .forEach(aluno => {
                        selectAluno.innerHTML += `<option value="${aluno.id}">${aluno.nome}</option>`;
                    });
            }
            
            habilitarBotaoPesquisa();
        }
        
        
        
        
        
        // Fun√ß√£o para excluir medida disciplinar
        async function excluirMedida(medidaId, botao) {
            // Primeira confirma√ß√£o
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir esta medida disciplinar?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            // Segunda confirma√ß√£o mais espec√≠fica
            if (!confirm('üö® CONFIRMA√á√ÉO FINAL:\n\nVoc√™ est√° prestes a EXCLUIR PERMANENTEMENTE esta medida disciplinar do sistema.\n\nEsta opera√ß√£o:\n‚Ä¢ Remove a medida do Supabase\n‚Ä¢ Afeta o c√°lculo da nota disciplinar\n‚Ä¢ N√ÉO pode ser desfeita\n\nDeseja realmente continuar?')) {
                return;
            }
            
            try {
                botao.disabled = true;
                botao.style.opacity = '0.5';
                botao.textContent = '‚è≥';
                
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                console.log('üóëÔ∏è Excluindo medida ID:', medidaId);
                
                // Excluir do Supabase
                const { error } = await window.supabaseClient
                    .from('medidas')
                    .delete()
                    .eq('id', medidaId);
                
                if (error) throw error;
                
                // Remover o item da interface
                const medidaItem = document.querySelector(`[data-medida-id="${medidaId}"]`);
                if (medidaItem) {
                    medidaItem.style.transition = 'all 0.3s ease';
                    medidaItem.style.opacity = '0';
                    medidaItem.style.transform = 'translateX(-100%)';
                    
                    setTimeout(() => {
                        medidaItem.remove();
                        
                        // Verificar se ainda h√° medidas
                        const medidasRestantes = document.querySelectorAll('.medida-item');
                        if (medidasRestantes.length === 0) {
                            document.getElementById('historicoMedidas').innerHTML = `
                                <div class="info-box info-success">
                                    <h4>‚úÖ Comportamento exemplar!</h4>
                                    <p>Este aluno n√£o possui medidas disciplinares registradas</p>
                                </div>
                            `;
                        }
                    }, 300);
                }
                
                showMessage('‚úÖ Medida disciplinar exclu√≠da com sucesso!', 'success');
                
                // Recarregar estat√≠sticas
                await carregarEstatisticasMedidas();
                
                console.log('‚úÖ Medida exclu√≠da com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir medida:', error);
                showMessage('‚ùå Erro ao excluir medida: ' + error.message, 'error');
                
                // Restaurar bot√£o em caso de erro
                botao.disabled = false;
                botao.style.opacity = '0.7';
                botao.textContent = 'üóëÔ∏è';
            }
        }

        
        // Fun√ß√£o para exibir dados de frequ√™ncia escolar
        async function exibirFrequenciaEscolar(aluno) {
            const container = document.getElementById('frequenciaEscolar');
            const codigoAluno = aluno.codigo || aluno.id || aluno.codigo_matricula;
            
            try {
                // Obter dados de frequ√™ncia em paralelo
                const [resumoResult, faltasResult, mensalResult] = await Promise.all([
                    window.getResumoAcumuladoAluno(codigoAluno),
                    window.getFaltasAluno(codigoAluno), // TODAS as faltas (sem limite)
                    window.getResumoMensalAtualAluno(codigoAluno)
                ]);
                
                const resumoAcumulado = resumoResult.data;
                const faltas = faltasResult.data || [];
                const resumoMensal = mensalResult.data;
                
                // Determinar classe de presen√ßa para estilo
                let classePresenca = 'presenca-regular';
                if (resumoAcumulado?.pct_presenca_operacional) {
                    const pct = resumoAcumulado.pct_presenca_operacional;
                    if (pct >= 95) classePresenca = 'presenca-excelente';
                    else if (pct >= 85) classePresenca = 'presenca-boa';
                    else if (pct >= 75) classePresenca = 'presenca-regular';
                    else classePresenca = 'presenca-baixa';
                }
                
                // Gerar HTML da se√ß√£o de frequ√™ncia
                container.innerHTML = `
                    <div class="frequencia-grid">
                        <!-- Card de Presen√ßa Acumulada -->
                        <div class="frequencia-card ${classePresenca}">
                            <div class="frequencia-card-title">
                                üìä Presen√ßa Acumulada
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoAcumulado.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.getDescricaoPresenca(resumoAcumulado.pct_presenca_operacional) : 
                                    'Dados n√£o dispon√≠veis'
                                }
                            </div>
                            ${resumoAcumulado ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoAcumulado.presencas || 0}P + ${resumoAcumulado.atestados || 0}A + ${resumoAcumulado.faltas || 0}F = ${resumoAcumulado.total_aulas || 0} aulas
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Card do Resumo Mensal -->
                        <div class="frequencia-card">
                            <div class="frequencia-card-title">
                                üìÖ M√™s Atual
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoMensal.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarMesAno(resumoMensal.mes) : 
                                    'Dados n√£o dispon√≠veis'
                                }
                            </div>
                            ${resumoMensal ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoMensal.presencas || 0}P + ${resumoMensal.atestados || 0}A + ${resumoMensal.faltas || 0}F
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Faltas Registradas -->
                    <div class="faltas-recentes">
                        <div class="faltas-recentes-title">
                            üìã Faltas Registradas
                        </div>
                        ${faltas.length > 0 ? 
                            `<div class="faltas-datas" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                ${faltas.map(falta => `
                                    <span class="falta-data-chip" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 4px 8px; font-size: 0.85em; color: #495057;">
                                        ${window.FrequenciaUtils.formatarData(falta.data)}
                                    </span>
                                `).join('')}
                            </div>` :
                            `<div class="sem-faltas" style="color: #28a745; font-size: 0.9em; margin-top: 8px;">
                                ‚úÖ Nenhuma falta registrada
                            </div>`
                        }
                    </div>
                `;
                
                
            } catch (error) {
                console.error('‚ùå Erro ao exibir frequ√™ncia:', error);
                
                // Fallback em caso de erro
                container.innerHTML = `
                    <div class="frequencia-card">
                        <div class="frequencia-card-title">
                            ‚ö†Ô∏è Erro ao Carregar
                        </div>
                        <div class="frequencia-card-subtitle" style="color: #dc3545;">
                            N√£o foi poss√≠vel carregar os dados de frequ√™ncia.
                            Tente novamente mais tarde.
                        </div>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o para mostrar todas as faltas de um aluno
        async function verTodasFaltas(codigoAluno) {
            try {
                const { data: todasFaltas } = await window.getFaltasAluno(codigoAluno, 50);
                
                if (!todasFaltas || todasFaltas.length === 0) {
                    alert('Nenhuma falta encontrada para este aluno.');
                    return;
                }
                
                // Criar modal ou popup com todas as faltas
                const faltasHTML = todasFaltas.map(falta => 
                    `${window.FrequenciaUtils.formatarData(falta.data)} - ${falta.turma || 'N/A'}`
                ).join('\n');
                
                alert(`Todas as faltas do aluno:\n\n${faltasHTML}`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar todas as faltas:', error);
                alert('Erro ao carregar faltas. Tente novamente.');
            }
        }
        
        
        // Fun√ß√£o para calcular pontos de uma medida (apenas para exibi√ß√£o)
        // NOTA: C√°lculos oficiais s√£o feitos nas views do Postgres
        function calcularPontosMedidaExibicao(tipoMedida, diasSuspensao = 1) {
            let pontos = 0;
            
            // Medidas positivas
            if (tipoMedida === 'Elogio Individual') pontos = 0.5;
            else if (tipoMedida === 'Elogio Coletivo') pontos = 0.3;
            else if (tipoMedida === 'Fato Observado Positivo') pontos = 0.1;
            
            // Medidas negativas
            else if (tipoMedida === 'Fato Observado Negativo') pontos = -0.1;
            else if (tipoMedida === 'Advert√™ncia Verbal' || tipoMedida === 'Advert√™ncia Escrita' || tipoMedida === 'Advert√™ncia') pontos = -0.3;
            else if (tipoMedida === 'Suspens√£o') {
                pontos = -0.5 * diasSuspensao;
            }
            else if (tipoMedida === 'A√ß√£o Educativa') pontos = -1.0;
            
            return pontos;
        }

        // Fun√ß√£o para verificar se √© medida positiva
        function isMedidaPositiva(tipoMedida) {
            return ['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida);
        }

        function exibirHistoricoMedidas(medidas) {
            const container = document.getElementById('historicoMedidas');
            
            if (!medidas || medidas.length === 0) {
                container.innerHTML = `
                    <div class="info-box info-success">
                        <h4>‚úÖ Comportamento exemplar!</h4>
                        <p>Este aluno n√£o possui medidas disciplinares registradas</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar medidas por data (mais recentes primeiro)
            medidas.sort((a, b) => new Date(b.data_registro) - new Date(a.data_registro));
            
            let html = `
                <div class="medidas-resumo">
                    <div class="resumo-item resumo-warning">
                        <span class="resumo-numero">${medidas.length}</span>
                        <span class="resumo-label">Total de Medidas</span>
                    </div>
                </div>
                
                <div class="medidas-timeline">
            `;
            
            medidas.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data_registro || medida.data);
                const tipoMedida = medida.tipo_medida || 'N/A';
                const diasSuspensao = medida.dias_suspensao || 1;
                const pontos = calcularPontosMedidaExibicao(tipoMedida, diasSuspensao);
                const isPositiva = isMedidaPositiva(tipoMedida);
                
                // Debug para verificar pontos
                
                // Formatar exibi√ß√£o dos pontos
                let pontosTexto = '';
                if (pontos > 0) {
                    pontosTexto = `<span class="medida-pontos positivos">+${pontos}</span>`;
                } else if (pontos < 0) {
                    pontosTexto = `<span class="medida-pontos negativos">${pontos}</span>`;
                } else if (pontos === 0) {
                    pontosTexto = `<span class="medida-pontos" style="background:#ffeaa7; color:#d63031;">‚ö†Ô∏è 0</span>`;
                }
                
                html += `
                    <div class="medida-item ${isPositiva ? 'positiva' : ''}" data-medida-id="${medida.id}">
                        <div class="medida-data">${dataFormatada}</div>
                        <div class="medida-content">
                            <div class="medida-tipo">
                                ${tipoMedida}
                                ${pontosTexto}
                            </div>
                            <div class="medida-descricao">
                                <strong>Especifica√ß√£o:</strong> ${medida.especificacao || 'N/A'}
                            </div>
                            ${medida.observacao ? `<div class="medida-providencias"><strong>Observa√ß√µes:</strong> ${medida.observacao}</div>` : ''}
                        </div>
                        <div class="medida-actions">
                            <button class="btn-excluir-medida" onclick="excluirMedida('${medida.id}', this)" title="Excluir medida">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function exibirResumoEstatistico(aluno, medidas) {
            const container = document.getElementById('resumoEstatistico');
            const totalMedidas = medidas.length;
            
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Calcular estat√≠sticas avan√ßadas
                let mediasRecentes = 0;
                let tipoMaisComum = 'N/A';
                let mediaGeral = 0;
                let posicaoRanking = 'N/A';
                
                if (medidas.length > 0) {
                    // Medidas nos √∫ltimos 30 dias
                    const dataLimite = new Date();
                    dataLimite.setDate(dataLimite.getDate() - 30);
                    mediasRecentes = medidas.filter(m => 
                        new Date(m.data_registro) >= dataLimite
                    ).length;
                    
                    // Tipo mais comum
                    const tiposCount = {};
                    medidas.forEach(m => {
                        tiposCount[m.tipo_medida] = (tiposCount[m.tipo_medida] || 0) + 1;
                    });
                    tipoMaisComum = Object.keys(tiposCount).reduce((a, b) => 
                        tiposCount[a] > tiposCount[b] ? a : b, 'N/A'
                    );
                }
                
                // Buscar dados gerais para compara√ß√£o
                const { data: todasMedidas } = await window.supabaseClient
                    .from('medidas')
                    .select('codigo_matricula, criado_em');
                
                if (todasMedidas) {
                    // Calcular m√©dia geral por aluno
                    const alunosCount = {};
                    todasMedidas.forEach(m => {
                        alunosCount[m.codigo_matricula] = (alunosCount[m.codigo_matricula] || 0) + 1;
                    });
                    
                    const medidasPorAluno = Object.values(alunosCount);
                    mediaGeral = medidasPorAluno.length > 0 ? 
                        (medidasPorAluno.reduce((a, b) => a + b, 0) / medidasPorAluno.length).toFixed(1) : 0;
                    
                    // Calcular posi√ß√£o no ranking (quantos alunos t√™m mais medidas)
                    const alunosComMais = medidasPorAluno.filter(count => count > totalMedidas).length;
                    posicaoRanking = `${alunosComMais + 1}¬∫ de ${medidasPorAluno.length}`;
                }
                
                // Obter nota disciplinar das views (nova implementa√ß√£o)
                let notaDisciplinar = 8.0;
                let dadosNota = null;
                
                try {
                    const codigoAluno = aluno.codigo || aluno.id || selectAluno.value;
                    
                    const { data: notaData, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .eq('codigo_aluno', codigoAluno)
                        .limit(1);
                    
                    if (!error && notaData && notaData.length > 0) {
                        dadosNota = notaData[0];
                        notaDisciplinar = dadosNota.nota_atual || 8.0;
                    } else {
                        console.log(`‚ö†Ô∏è Nota n√£o encontrada para ${codigoAluno}, usando padr√£o 8.0`);
                    }
                } catch (error) {
                    console.warn('Erro ao obter nota das views:', error);
                }
                
                const mencao = obterMencaoDisciplinar(notaDisciplinar);
                
                container.innerHTML = `
                    <!-- Nota Disciplinar - Destaque Principal -->
                    <div class="disciplinary-score-card" style="background: linear-gradient(135deg, ${mencao.cor}20, ${mencao.cor}10); border: 2px solid ${mencao.cor}; margin-bottom: 20px;">
                        <div class="score-content">
                            <div class="score-header">
                                <span class="score-emoji">${mencao.emoji}</span>
                                <div class="score-info">
                                    <div class="score-title">Nota Disciplinar</div>
                                    <div class="score-subtitle">${mencao.mencao}</div>
                                </div>
                            </div>
                            <div class="score-number" style="color: ${mencao.cor};">${notaDisciplinar.toFixed(2)}</div>
                        </div>
                        
                        ${dadosNota.data_ultima_negativa ? `
                            <div class="score-details">
                                <span>√öltima ocorr√™ncia negativa: ${dadosNota.dias_desde_ultima_negativa || 0} dias atr√°s</span>
                                ${dadosNota.bonus_ativo ? 
                                    `<span style="color: #28a745;">üéâ B√¥nus de recupera√ß√£o ativo!</span>` : 
                                    `<span>Aguardando per√≠odo de recupera√ß√£o</span>`
                                }
                            </div>
                        ` : `
                            <div class="score-details">
                                <span style="color: #28a745;">‚ú® Nenhuma medida negativa registrada!</span>
                            </div>
                        `}
                    </div>
                
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">‚öñÔ∏è</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-info">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediaGeral}</div>
                                <div class="stat-label">M√©dia Geral (por aluno)</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-danger">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediasRecentes}</div>
                                <div class="stat-label">√öltimos 30 dias</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-primary">
                            <div class="stat-icon">üèÜ</div>
                            <div class="stat-content">
                                <div class="stat-number">${posicaoRanking}</div>
                                <div class="stat-label">Ranking Disciplinar</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">C√≥digo do Aluno</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-secondary">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-content">
                                <div class="stat-number" style="font-size: 0.8em;">${tipoMaisComum.length > 15 ? tipoMaisComum.substring(0, 15) + '...' : tipoMaisComum}</div>
                                <div class="stat-label">Tipo Mais Comum</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-section" style="margin-top: 20px;">
                        <h5>üìä An√°lise Comparativa</h5>
                        <div class="comparison-grid">
                            <div class="comparison-item ${totalMedidas > mediaGeral ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Situa√ß√£o vs M√©dia Geral:</span>
                                <span class="comparison-value">
                                    ${totalMedidas > mediaGeral ? 
                                        `‚ö†Ô∏è Acima da m√©dia (+${(totalMedidas - mediaGeral).toFixed(1)})` : 
                                        `‚úÖ Abaixo da m√©dia (-${(mediaGeral - totalMedidas).toFixed(1)})`
                                    }
                                </span>
                            </div>
                            
                            <div class="comparison-item ${mediasRecentes > 2 ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Tend√™ncia Recente:</span>
                                <span class="comparison-value">
                                    ${mediasRecentes === 0 ? '‚úÖ Sem ocorr√™ncias recentes' :
                                      mediasRecentes <= 2 ? 'üü° Situa√ß√£o controlada' :
                                      'üî¥ Requer aten√ß√£o'
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao calcular estat√≠sticas avan√ßadas:', error);
                // Fallback para exibi√ß√£o simples
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">‚öñÔ∏è</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">C√≥digo do Aluno</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        

        // Inicializar filtros quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                await carregarTurmasEAlunos();
            }, 2000);
        });

        // FUN√á√ïES DE FREQU√äNCIA SEPARADAS (baseadas no teste que funciona)
        async function verFrequenciaAluno() {
            const selectAluno = document.getElementById('alunoConsulta');
            const areaFrequencia = document.getElementById('areaFrequenciaAluno');
            const resultado = document.getElementById('resultadoFrequenciaAluno');
            
            if (!selectAluno || !selectAluno.value) {
                alert('Primeiro selecione um aluno!');
                return;
            }
            
            // Pegar c√≥digo do aluno - BUSCAR NOS DADOS CARREGADOS
            let codigo = selectAluno.value;
            const nomeAluno = selectAluno.options[selectAluno.selectedIndex]?.text || '';
            
            console.log('DEBUG: selectAluno.value =', selectAluno.value);
            console.log('DEBUG: nomeAluno =', nomeAluno);
            console.log('DEBUG: todosAlunosMedidas =', todosAlunosMedidas);
            
            // Tentar buscar c√≥digo real se dispon√≠vel
            if (todosAlunosMedidas && todosAlunosMedidas.length > 0) {
                const alunoEncontrado = todosAlunosMedidas.find(aluno => aluno.id === selectAluno.value);
                console.log('DEBUG: alunoEncontrado =', alunoEncontrado);
                if (alunoEncontrado && alunoEncontrado.codigo) {
                    codigo = alunoEncontrado.codigo;
                    console.log('DEBUG: Converteu para c√≥digo =', codigo);
                }
            }
            
            // Se ainda n√£o encontrou c√≥digo, tentar usar o value do option
            if (codigo === selectAluno.value && selectAluno.options[selectAluno.selectedIndex]) {
                const dataCode = selectAluno.options[selectAluno.selectedIndex].getAttribute('data-codigo');
                if (dataCode) {
                    codigo = dataCode;
                    console.log('DEBUG: Usando data-codigo =', codigo);
                }
            }
            
            console.log('üîç Buscando frequ√™ncia para c√≥digo:', codigo);
            resultado.innerHTML = 'üîÑ Carregando frequ√™ncia...';
            areaFrequencia.style.display = 'block';
            
            try {
                console.log('TESTE: Fazendo fetch do arquivo...');
                const response = await fetch('../assets/js/dados-frequencia-agosto.js');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar arquivo: ' + response.status);
                }
                
                const jsContent = await response.text();
                console.log('TESTE: Arquivo carregado, tamanho:', jsContent.length);
                
                // Extrair dados CSV
                const csvMatch = jsContent.match(/const dadosCSV = `([^`]+)`/);
                if (!csvMatch || !csvMatch[1]) {
                    throw new Error('Dados CSV n√£o encontrados no arquivo');
                }
                
                const csvData = csvMatch[1];
                console.log('TESTE: CSV extra√≠do, primeiras 200 chars:', csvData.substring(0, 200));
                
                // Parse CSV
                const linhas = csvData.trim().split('\n');
                console.log('TESTE: Total de linhas CSV:', linhas.length);
                
                // Buscar linha do aluno
                let linhaAluno = null;
                console.log('TESTE: Procurando por linha que come√ßa com:', codigo + ',');
                
                for (let linha of linhas) {
                    if (linha.startsWith(codigo + ',')) {
                        linhaAluno = linha;
                        console.log('TESTE: Linha do aluno encontrada:', linhaAluno);
                        break;
                    }
                }
                
                if (!linhaAluno) {
                    console.log('TESTE: Aluno n√£o encontrado. Primeiras 5 linhas:', linhas.slice(0, 5));
                    console.log('TESTE: Procurando pelo c√≥digo:', codigo);
                    resultado.innerHTML = `‚ùå Aluno ${codigo} n√£o encontrado no arquivo de frequ√™ncia`;
                    return;
                }
                
                const campos = linhaAluno.split(',');
                const nome = campos[1];
                const turma = campos[2];
                const diasAgosto = [1, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15, 18, 19, 20, 21, 22, 25, 26, 27, 28, 29];
                
                const faltas = [];
                for (let i = 3; i < campos.length && i - 3 < diasAgosto.length; i++) {
                    const marcacao = campos[i];
                    if (marcacao === 'F' || marcacao === 'FC' || marcacao === 'A') {
                        const dia = diasAgosto[i - 3];
                        faltas.push({
                            dia: dia,
                            marcacao: marcacao,
                            data: `${dia.toString().padStart(2, '0')}/08`
                        });
                    }
                }
                
                let html = `
                    <h5>‚úÖ ${nome}</h5>
                    <p><strong>C√≥digo:</strong> ${codigo}</p>
                    <p><strong>Turma:</strong> ${turma}</p>
                    <p><strong>Total de faltas:</strong> ${faltas.length}</p>
                `;
                
                if (faltas.length > 0) {
                    html += '<p><strong>Faltas encontradas:</strong></p>';
                    faltas.forEach(falta => {
                        let cor = '#dc3545'; // Vermelho para F
                        if (falta.marcacao === 'FC') cor = '#ffc107'; // Amarelo para FC
                        if (falta.marcacao === 'A') cor = '#17a2b8'; // Azul para A
                        
                        html += `<span style="background: ${cor}; color: white; padding: 6px 12px; margin: 3px; border-radius: 5px; display: inline-block;">${falta.data} - ${falta.marcacao}</span> `;
                    });
                    html += '<br><small style="color: #666; margin-top: 10px; display: block;">F = Falta | FC = Falta Controlada | A = Atestado</small>';
                } else {
                    html += '<p style="color: green;">‚úÖ Nenhuma falta registrada</p>';
                }
                
                resultado.innerHTML = html;
                console.log('‚úÖ Frequ√™ncia carregada com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar frequ√™ncia:', error);
                resultado.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }


        // ======= FUN√á√ÉO DE EXPORTA√á√ÉO PARA PDF TEMPORARIAMENTE DESABILITADA =======
        async function exportarFichaPDF() {
            alert('Funcionalidade PDF temporariamente desabilitada para corre√ß√£o de erros. Use outras op√ß√µes de relat√≥rio dispon√≠veis.');
            return;
        }
        
        // FUN√á√ÉO ORIGINAL COMENTADA PARA EVITAR ERROS
        /*
        async function exportarFichaPDF_original() {
            console.log('üìÑ Iniciando exporta√ß√£o para PDF...');
            const btnExportar = document.getElementById('btnExportarPDF');
            const selectAluno = document.getElementById('alunoConsulta');
            
            // Desabilitar bot√£o durante exporta√ß√£o
            const textoOriginal = btnExportar.innerHTML;
            btnExportar.disabled = true;
            btnExportar.innerHTML = '‚è≥ Gerando PDF...';
            
            try {
                // Verificar se ficha est√° carregada
                const fichaContainer = document.getElementById('fichaAluno');
                if (!fichaContainer || fichaContainer.style.display === 'none') {
                    alert('‚ùå Por favor, primeiro carregue a ficha disciplinar do aluno!');
                    return;
                }
                
                // Obter dados do aluno para nome do arquivo
                const nomeAluno = selectAluno.options[selectAluno.selectedIndex]?.text || 'Aluno';
                const codigoAluno = selectAluno.value;
                
                // ============= NOVA ABORDAGEM: CAPTURAR APAR√äNCIA EXATA =============
                
                // Aguardar html2canvas estar dispon√≠vel
                if (!window.html2canvas) {
                    // Carregar html2canvas dinamicamente se necess√°rio
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }
                
                // Preparar a ficha para captura
                const originalScrollBehavior = fichaContainer.style.overflow;
                const originalMaxHeight = fichaContainer.style.maxHeight;
                
                // Remover scroll temporariamente para capturar tudo
                fichaContainer.style.overflow = 'visible';
                fichaContainer.style.maxHeight = 'none';
                
                // Aguardar um momento para o layout se ajustar
                await new Promise(resolve => setTimeout(resolve, 500));
                
                btnExportar.innerHTML = 'üì∏ Capturando ficha...';
                
                // Capturar a ficha como imagem
                const canvas = await html2canvas(fichaContainer, {
                    scale: 2, // Alta qualidade
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: fichaContainer.scrollWidth,
                    height: fichaContainer.scrollHeight,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // Restaurar estilos originais
                fichaContainer.style.overflow = originalScrollBehavior;
                fichaContainer.style.maxHeight = originalMaxHeight;
                
                btnExportar.innerHTML = 'üñ®Ô∏è Criando PDF...';
                
                // Criar PDF com as dimens√µes corretas
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                
                // Calcular dimens√µes para PDF
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgHeight / imgWidth;
                
                // Usar A4 em modo paisagem se necess√°rio, ou retrato
                const pdfWidth = 210; // A4 width in mm
                const pdfHeight = pdfWidth * ratio;
                
                let pdf;
                if (pdfHeight > 297) { // Se for muito alto para A4 retrato
                    pdf = new jsPDF('l', 'mm', 'a4'); // Paisagem
                    const landscapeWidth = 297;
                    const landscapeHeight = landscapeWidth * ratio;
                    pdf.addImage(imgData, 'PNG', 10, 10, landscapeWidth - 20, landscapeHeight);
                } else {
                    pdf = new jsPDF('p', 'mm', 'a4'); // Retrato
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                }
                
                // Se a imagem for muito alta, criar p√°ginas adicionais
                if (pdfHeight > 280) {
                    const pagesNeeded = Math.ceil(pdfHeight / 280);
                    for (let i = 1; i < pagesNeeded; i++) {
                        pdf.addPage();
                        const yOffset = -(280 * i);
                        pdf.addImage(imgData, 'PNG', 10, yOffset + 10, pdfWidth - 20, pdfHeight);
                    }
                }
                
                // Salvar PDF
                const fileName = `Ficha_Disciplinar_${nomeAluno.replace(/[^a-zA-Z0-9]/g, '_')}_${codigoAluno}.pdf`;
                pdf.save(fileName);
                
                console.log('‚úÖ PDF gerado com sucesso:', fileName);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF:', error);
                alert('‚ùå Erro ao gerar PDF: ' + error.message);
            } finally {
                // Restaurar bot√£o
                btnExportar.disabled = false;
                btnExportar.innerHTML = textoOriginal;
            }
        }
        */

        // Fun√ß√£o para controle de se√ß√µes expans√≠veis
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content) {
                // Usar classes CSS em vez de style.display
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
                    if (toggle) toggle.textContent = 'üîΩ';
                    console.log(`üîΩ Se√ß√£o ${sectionId} recolhida`);
                } else {
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                    if (toggle) toggle.textContent = 'üîº';
                    console.log(`‚úÖ Se√ß√£o ${sectionId} expandida`);
                }
            } else {
                console.warn(`‚ùå Elemento ${sectionId}-content n√£o encontrado`);
            }
        }

        // === SISTEMA DE CATEGORIAS M√öLTIPLAS ===
        let faltasSelecionadas = [];
        let categoriasSelecionadas = [];

        function limparSelecoesCategorias() {
            categoriasSelecionadas = [];
            faltasSelecionadas = [];
            
            // Desmarcar todos os checkboxes
            document.querySelectorAll('#faltasMultiContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Limpar container
            const container = document.getElementById('faltasMultiContainer');
            if (container) container.innerHTML = '';
            
            const tagsContainer = document.getElementById('faltasTagsContainer');
            if (tagsContainer) tagsContainer.innerHTML = '';
        }

        function toggleCategoria(categoria) {
            const checkbox = document.getElementById(`cat_${categoria}`);
            const index = categoriasSelecionadas.indexOf(categoria);
            
            if (checkbox && checkbox.checked && index === -1) {
                categoriasSelecionadas.push(categoria);
            } else if (checkbox && !checkbox.checked && index > -1) {
                categoriasSelecionadas.splice(index, 1);
            }
            
            // Recarregar faltas baseado nas categorias selecionadas
            const container = document.getElementById('faltasCategoriasContainer');
            if (container) {
                container.innerHTML = '';
                
                if (categoriasSelecionadas.length === 0) {
                    container.innerHTML = '<p class="texto-instrucao">üëÜ Marque as categorias acima para ver as faltas espec√≠ficas</p>';
                } else {
                    // Criar se√ß√£o para cada categoria selecionada
                    categoriasSelecionadas.forEach(cat => {
                        const faltas = carregarFaltasCategorizadas(cat);
                        const categoriaLabel = cat === 'leve' ? '‚ö° Faltas Leves' : 
                                              cat === 'media' ? '‚ö†Ô∏è Faltas M√©dias' : 
                                              'üö® Faltas Graves';
                        
                        const secaoDiv = document.createElement('div');
                        secaoDiv.className = 'categoria-secao';
                        secaoDiv.innerHTML = `
                            <h5 style="color: #333; margin: 15px 0 10px 0;">${categoriaLabel}</h5>
                            <div class="faltas-categoria">
                                ${faltas.map(falta => `
                                    <label class="falta-checkbox categoria-${cat}">
                                        <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                        <span>${falta}</span>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                        container.appendChild(secaoDiv);
                    });
                }
            }
        }

        function carregarFaltasCategorizadas(categoria) {
            const faltasPorCategoria = {
                'leve': [
                    'Item 1 - Apresentar-se com uniforme diferente do estabelecido pelo regulamento',
                    'Item 2 - Apresentar-se com barba ou bigode sem fazer',
                    'Item 3 - Comparecer √† EECM com cabelo em desalinho ou fora do padr√£o',
                    'Item 4 - Chegar atrasado √† EECM para o in√≠cio das aulas, instru√ß√£o, treinamento, formatura ou atividade escolar',
                    'Item 5 - Comparecer √† EECM sem levar o material necess√°rio',
                    'Item 6 - Adentrar ou permanecer em qualquer depend√™ncia da EECM, sem autoriza√ß√£o',
                    'Item 7 - Consumir alimentos, balas, doces l√≠quidos ou mascar chicletes durante a aula, instru√ß√£o, treinamento, formatura, atividade escolar',
                    'Item 8 - Conversar ou se mexer quando estiver em forma',
                    'Item 9 - Deixar de entregar √† Monitoria, Secretaria ou a Coordena√ß√£o, qualquer objeto que n√£o lhe perten√ßa',
                    'Item 10 - Deixar de retribuir cumprimentos ou de prestar sinais de respeito regulamentares',
                    'Item 11 - Deixar material escolar, objetos ou pe√ßas de uniforme em locais inapropriados',
                    'Item 12 - Descartar pap√©is, restos de comida, embalagens ou qualquer objeto no ch√£o ou fora de locais apropriados',
                    'Item 13 - Dobrar qualquer pe√ßa de uniforme para diminuir seu tamanho, desfigurando sua originalidade',
                    'Item 14 - Debru√ßar-se sobre a carteira e dormir durante o hor√°rio das aulas ou instru√ß√µes',
                    'Item 15 - Executar movimentos de ordem unida de forma displicente ou desatenciosa',
                    'Item 16 - Fazer ou provocar excessivo barulho em qualquer depend√™ncia da EECM, durante o hor√°rio de aula',
                    'Item 17 - N√£o levar ao conhecimento de autoridade competente falta ou irregularidade que presenciar ou de que tiver ci√™ncia',
                    'Item 18 - Perturbar o estudo do(s) colega(s), com ru√≠dos ou brincadeiras',
                    'Item 19 - Utilizar-se, na sala, de qualquer publica√ß√£o estranha √† sua atividade escolar, salvo quando autorizado',
                    'Item 20 - Retardar ou contribuir para o atraso da execu√ß√£o de qualquer atividade sem justo motivo',
                    'Item 21 - Sentar-se no ch√£o, atentando contra a postura e compostura, estando uniformizado',
                    'Item 22 - Utilizar qualquer tipo de jogo, brinquedo, figurinhas, cole√ß√µes no interior da EECM',
                    'Item 23 - Usar, a aluna, piercings, brinco fora do padr√£o estabelecido, mais de um brinco em cada orelha, alargador ou similares',
                    'Item 24 - Usar, o aluno, piercings, brinco, alargador ou similares, quando uniformizado',
                    'Item 25 - Usar, quando uniformizado, bon√©, capuz ou outros adornos, durante a atividade escolar',
                    'Item 26 - Ficar na sala de aula durante os intervalos e as formaturas di√°rias'
                ],
                'media': [
                    'Item 27 - Atrasar ou deixar de atender ao chamado da Diretoria, coordena√ß√£o, Oficial de Gest√£o Educacional-Militar',
                    'Item 28 - Deixar de comparecer a qualquer atividade extraclasse para a qual tenha sido designado',
                    'Item 29 - Deixar de comparecer √†s atividades escolares, formaturas, ou delas se ausentar, sem autoriza√ß√£o',
                    'Item 30 - Deixar de cumprir ou esquivar-se de medidas disciplinares impostas pelo Gestor Educacional-Militar',
                    'Item 31 - Deixar de devolver √† EECM, dentro do prazo estipulado, documentos devidamente assinados pelo seu respons√°vel',
                    'Item 32 - Deixar de devolver, no prazo fixado, livros da biblioteca ou outros materiais pertencentes √†s EECM',
                    'Item 33 - Deixar de entregar ao pai ou respons√°vel, documento que lhe foi encaminhado pela EECM',
                    'Item 34 - Deixar de executar tarefas atribu√≠das da Diretoria, coordena√ß√£o, Oficial de Gest√£o Educacional-Militar',
                    'Item 35 - Deixar de zelar por sua apresenta√ß√£o pessoal',
                    'Item 36 - Dirigir memoriais ou peti√ß√µes a qualquer autoridade, sobre assuntos da al√ßada da Diretoria',
                    'Item 37 - Entrar ou sair da EECM por locais n√£o permitidos',
                    'Item 38 - Espalhar boatos ou not√≠cias tendenciosas por qualquer meio',
                    'Item 39 - Tocar a sirene, sem ordem para tal',
                    'Item 40 - Fumar dentro ou nas imedia√ß√µes da EECM ou quando uniformizado',
                    'Item 41 - Ingressar ou sair da EECM sem estar com o uniforme regulamentar',
                    'Item 42 - Ler ou distribuir, dentro da EECM, publica√ß√µes estampas ou jornais que atentem contra a disciplina',
                    'Item 43 - Manter contato f√≠sico que denota envolvimento de cunho amoroso (namoro, beijos, etc.)',
                    'Item 44 - N√£o zelar pelo nome da Institui√ß√£o que representa, deixando de portar-se adequadamente',
                    'Item 45 - Negar-se a colaborar ou participar nos eventos, formaturas, solenidades e desfiles oficiais',
                    'Item 46 - Ofender a moral de colegas ou de qualquer membro da Comunidade Escolar por atos, gestos ou palavras',
                    'Item 47 - Portar-se de forma inconveniente em sala de aula ou outro local de instru√ß√£o/recrea√ß√£o',
                    'Item 48 - Portar-se de maneira desrespeitosa ou inconveniente nos eventos sociais ou esportivos',
                    'Item 49 - Proferir palavras de baixo cal√£o, incompat√≠veis com as normas da boa educa√ß√£o',
                    'Item 50 - Propor ou aceitar transa√ß√£o pecuni√°ria de qualquer natureza, no interior da EECM',
                    'Item 51 - Provocar ou disseminar a disc√≥rdia entre colegas',
                    'Item 52 - Publicar ou contribuir para que sejam publicadas mensagens, fotos, v√≠deos que possam expor a integridade da EECM',
                    'Item 53 - Retirar ou tentar retirar objeto, de qualquer depend√™ncia da EECM, sem ordem do respons√°vel',
                    'Item 54 - Sair de forma sem autoriza√ß√£o',
                    'Item 55 - Sair, entrar ou permanecer na sala de aula sem permiss√£o',
                    'Item 56 - Ser retirado, por mau comportamento, de sala de aula ou qualquer ambiente',
                    'Item 57 - Simular doen√ßas para esquivar-se ao atendimento de obriga√ß√µes e de atividades escolares',
                    'Item 58 - Tomar parte em jogos de azar ou em apostas na unidade escolar ou fora dela',
                    'Item 59 - Usar as instala√ß√µes ou equipamentos esportivos da EECM, sem uniformes adequados, ou sem autoriza√ß√£o',
                    'Item 60 - Usar o uniforme ou o nome da EECM em ambiente inapropriado',
                    'Item 61 - Utilizar, sem autoriza√ß√£o, telefones celulares ou quaisquer aparelhos eletr√¥nicos durante as atividades escolares',
                    'Item 62 - Usar indevidamente distintivos ou ins√≠gnias'
                ],
                'grave': [
                    'Item 63 - Assinar pelo respons√°vel, documento que deve ser entregue √† unidade escolar',
                    'Item 64 - Causar danos ao patrim√¥nio da unidade escolar',
                    'Item 65 - Causar ou contribuir para a ocorr√™ncia de acidentes de qualquer natureza',
                    'Item 66 - Comunicar-se com outro aluno ou utilizar-se de qualquer meio n√£o permitido durante qualquer instrumento de avalia√ß√£o',
                    'Item 67 - Denegrir o nome da ECM e/ou de qualquer de seus membros atrav√©s de procedimentos desrespeitosos',
                    'Item 68 - Desrespeitar, desobedecer ou desafiar a Diretoria, coordena√ß√£o, Oficial de gest√£o Educacional-Militar',
                    'Item 69 - Divulgar, ou concorrer para que isso aconte√ßa, qualquer imagem ou mat√©ria que induza a apologia √†s drogas, √† viol√™ncia e/ou pornografia',
                    'Item 70 - Entrar na unidade escolar, ou dela se ausentar, sem autoriza√ß√£o',
                    'Item 71 - Extraviar documentos que estejam sob sua responsabilidade',
                    'Item 72 - Faltar com a verdade e/ou utilizar-se do anonimato para a pr√°tica de qualquer falta disciplinar',
                    'Item 73 - Fazer uso, portar, distribuir, estar sob a√ß√£o ou induzir outrem ao uso de bebida alco√≥lica, entorpecentes, t√≥xicos ou produtos alucin√≥genos',
                    'Item 74 - Hastear ou arriar bandeiras e estandartes, sem autoriza√ß√£o',
                    'Item 75 - Instigar colegas a cometer faltas disciplinares e/ou a√ß√µes delituosas',
                    'Item 76 - Manter contato f√≠sico com conota√ß√£o libidinosa no ambiente da EECM ou fora dela',
                    'Item 77 - Obter ou fazer uso de imagens, v√≠deos, √°udios ou de qualquer tipo de publica√ß√£o difamat√≥ria contra qualquer membro da Comunidade Escolar',
                    'Item 78 - Ofender membros da Comunidade Escolar com a pr√°tica de Bullying e Cyberbullying',
                    'Item 79 - Pichar ou causar qualquer polui√ß√£o visual ou sonora dentro e nas proximidades da EECM',
                    'Item 80 - Portar objetos que ameacem a seguran√ßa individual e/ou da coletividade',
                    'Item 81 - Praticar atos contr√°rios ao culto e ao respeito aos s√≠mbolos nacionais',
                    'Item 82 - Promover ou tomar parte de qualquer manifesta√ß√£o coletiva que venha a macular o nome da EECM',
                    'Item 83 - Promover trotes de qualquer natureza',
                    'Item 84 - Promover, incitar ou envolver-se em rixa, inclusive luta corporal, dentro ou fora da EECM',
                    'Item 85 - Provocar ou tomar parte, uniformizado ou estando na EECM, em manifesta√ß√µes de natureza pol√≠tica',
                    'Item 86 - Rasurar, violar ou alterar documentos ou o conte√∫do dos mesmos',
                    'Item 87 - Representar a EECM e/ou por ela tomar compromisso, sem estar para isso autorizado',
                    'Item 88 - Ter em seu poder, introduzir, ler ou distribuir, dentro da EECM, cartazes, jornais ou publica√ß√µes que atentem contra a disciplina',
                    'Item 89 - Utilizar ou subtrair indevidamente objetos ou valores alheios',
                    'Item 90 - Utilizar-se de processos fraudulentos na realiza√ß√£o de trabalhos pedag√≥gicos',
                    'Item 91 - Utilizar-se indevidamente e/ou causar avaria e/ou destrui√ß√£o do patrim√¥nio pertencente √† EECM'
                ]
            };
            
            return faltasPorCategoria[categoria] || [];
        }

        function toggleFalta(falta) {
            const index = faltasSelecionadas.indexOf(falta);
            if (index > -1) {
                faltasSelecionadas.splice(index, 1);
            } else {
                faltasSelecionadas.push(falta);
            }
            atualizarTagsFaltas();
        }

        function atualizarTagsFaltas() {
            const tagsContainer = document.getElementById('faltasTagsContainer');
            if (!tagsContainer) return;
            
            tagsContainer.innerHTML = '';
            
            faltasSelecionadas.forEach(falta => {
                const tag = document.createElement('span');
                tag.className = 'falta-tag';
                tag.innerHTML = `
                    ${falta}
                    <button type="button" onclick="removerFalta('${falta}')" class="remover-tag">√ó</button>
                `;
                tagsContainer.appendChild(tag);
            });
            
            // Atualizar o campo oculto se necess√°rio
            const hiddenField = document.getElementById('faltasSelecionadasHidden');
            if (hiddenField) {
                hiddenField.value = JSON.stringify(faltasSelecionadas);
            }
        }

        function removerFalta(falta) {
            faltasSelecionadas = faltasSelecionadas.filter(f => f !== falta);
            
            // Desmarcar checkbox correspondente
            const checkbox = document.querySelector(`input[value="${falta}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            atualizarTagsFaltas();
        }

        // === FUNCIONALIDADES DE MEDIDAS NEGATIVAS E POSITIVAS ===
        let medidasNegativasData = [];
        let medidasPositivasData = [];

        async function carregarMedidasNegativas() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '‚è≥ Carregando...';
                button.disabled = true;

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`üìä [NEGATIVAS] Carregando medidas da unidade: ${unidadeAtual}`);

                // Buscar c√≥digos dos alunos da unidade atual
                const { data: alunosDaUnidade, error: errorAlunos } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo')
                    .eq('unidade', unidadeAtual);

                if (errorAlunos) throw errorAlunos;

                const codigosDaUnidade = alunosDaUnidade?.map(a => a.codigo) || [];

                if (codigosDaUnidade.length === 0) {
                    medidasNegativasData = [];
                    document.getElementById('tableMedidasNegativas').innerHTML = '<p class="text-center text-muted">Nenhum aluno encontrado na unidade selecionada</p>';
                    return;
                }

                // Carregar medidas APENAS dos alunos da unidade
                const { data, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .in('codigo_matricula', codigosDaUnidade)
                    .in('tipo_medida', ['Fato Observado Negativo', 'Advert√™ncia Verbal', 'Advert√™ncia Escrita', 'Suspens√£o', 'A√ß√£o Educativa'])
                    .order('criado_em', { ascending: false });

                if (error) throw error;
                
                medidasNegativasData = data || [];
                console.log(`‚úÖ ${medidasNegativasData.length} medidas negativas carregadas`);
                
                // Popular filtros de turmas e aplicar filtros iniciais
                popularFiltrosTurmas();
                aplicarFiltrosNegativas();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar medidas negativas:', error);
                alert('Erro ao carregar medidas negativas: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function carregarMedidasPositivas() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '‚è≥ Carregando...';
                button.disabled = true;

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`üìä [POSITIVAS] Carregando medidas da unidade: ${unidadeAtual}`);

                // Buscar c√≥digos dos alunos da unidade atual
                const { data: alunosDaUnidade, error: errorAlunos } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo')
                    .eq('unidade', unidadeAtual);

                if (errorAlunos) throw errorAlunos;

                const codigosDaUnidade = alunosDaUnidade?.map(a => a.codigo) || [];

                if (codigosDaUnidade.length === 0) {
                    medidasPositivasData = [];
                    document.getElementById('tableMedidasPositivas').innerHTML = '<p class="text-center text-muted">Nenhum aluno encontrado na unidade selecionada</p>';
                    return;
                }

                // Carregar medidas APENAS dos alunos da unidade
                const { data, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .in('codigo_matricula', codigosDaUnidade)
                    .in('tipo_medida', ['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'])
                    .order('criado_em', { ascending: false });

                if (error) throw error;
                
                medidasPositivasData = data || [];
                console.log(`‚úÖ ${medidasPositivasData.length} medidas positivas carregadas`);
                
                // Popular filtros de turmas e aplicar filtros iniciais
                popularFiltrosTurmas();
                aplicarFiltrosPositivas();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar medidas positivas:', error);
                alert('Erro ao carregar medidas positivas: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function renderizarTabelaMedidasNegativas() {
            const container = document.getElementById('tableMedidasNegativas');
            if (!container) return;
            
            if (medidasNegativasData.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhuma medida negativa encontrada.</p>';
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Aluno</th>
                                <th>Turma</th>
                                <th>Tipo</th>
                                <th>Especifica√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            medidasNegativasData.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data || medida.criado_em);
                
                html += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${medida.nome_completo || 'N/A'}</td>
                        <td>${medida.turma || 'N/A'}</td>
                        <td><span class="badge badge-danger">${medida.tipo_medida}</span></td>
                        <td class="text-truncate" style="max-width: 300px;" title="${medida.especificacao || medida.tipo_medida}">${medida.especificacao || medida.tipo_medida}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderizarTabelaMedidasPositivas() {
            const container = document.getElementById('tableMedidasPositivas');
            if (!container) return;
            
            if (medidasPositivasData.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhuma medida positiva encontrada.</p>';
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Aluno</th>
                                <th>Turma</th>
                                <th>Tipo</th>
                                <th>Especifica√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            medidasPositivasData.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data || medida.criado_em);
                
                html += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${medida.nome_completo || 'N/A'}</td>
                        <td>${medida.turma || 'N/A'}</td>
                        <td><span class="badge badge-success">${medida.tipo_medida}</span></td>
                        <td class="text-truncate" style="max-width: 300px;" title="${medida.especificacao || medida.tipo_medida}">${medida.especificacao || medida.tipo_medida}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // === FUN√á√ïES DE FILTROS DAS TABELAS ===
        function aplicarFiltrosNegativas() {
            const pesquisa = document.getElementById('pesquisaNegativas')?.value.toLowerCase() || '';
            const filtroTurma = document.getElementById('filtroTurmaNegativas')?.value || 'todas';
            const quantidade = document.getElementById('quantidadeNegativas')?.value || '10';
            
            let dadosFiltrados = [...medidasNegativasData];
            
            // Primeiro: Limitar quantidade dos dados originais (mais recentes)
            if (quantidade !== 'todas') {
                const limite = parseInt(quantidade);
                dadosFiltrados = dadosFiltrados.slice(0, limite);
            }
            
            // Depois: Filtrar por turma
            if (filtroTurma !== 'todas') {
                dadosFiltrados = dadosFiltrados.filter(medida => medida.turma === filtroTurma);
            }
            
            // Por √∫ltimo: Filtrar por pesquisa (nome ou c√≥digo)
            if (pesquisa) {
                dadosFiltrados = dadosFiltrados.filter(medida => {
                    const nome = medida.nome_completo?.toLowerCase() || '';
                    const codigo = medida.codigo_matricula?.toString().toLowerCase() || '';
                    return nome.includes(pesquisa) || codigo.includes(pesquisa);
                });
            }
            
            renderizarTabelaFiltrada('tableMedidasNegativas', dadosFiltrados, 'negativa');
        }

        function aplicarFiltrosPositivas() {
            const pesquisa = document.getElementById('pesquisaPositivas')?.value.toLowerCase() || '';
            const filtroTurma = document.getElementById('filtroTurmaPositivas')?.value || 'todas';
            const quantidade = document.getElementById('quantidadePositivas')?.value || '10';
            
            let dadosFiltrados = [...medidasPositivasData];
            
            // Primeiro: Limitar quantidade dos dados originais (mais recentes)
            if (quantidade !== 'todas') {
                const limite = parseInt(quantidade);
                dadosFiltrados = dadosFiltrados.slice(0, limite);
            }
            
            // Depois: Filtrar por turma
            if (filtroTurma !== 'todas') {
                dadosFiltrados = dadosFiltrados.filter(medida => medida.turma === filtroTurma);
            }
            
            // Por √∫ltimo: Filtrar por pesquisa (nome ou c√≥digo)
            if (pesquisa) {
                dadosFiltrados = dadosFiltrados.filter(medida => {
                    const nome = medida.nome_completo?.toLowerCase() || '';
                    const codigo = medida.codigo_matricula?.toString().toLowerCase() || '';
                    return nome.includes(pesquisa) || codigo.includes(pesquisa);
                });
            }
            
            renderizarTabelaFiltrada('tableMedidasPositivas', dadosFiltrados, 'positiva');
        }

        function renderizarTabelaFiltrada(containerId, dados, tipo) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (dados.length === 0) {
                container.innerHTML = `<p class="text-center text-muted">Nenhuma medida ${tipo} encontrada com os filtros aplicados.</p>`;
                return;
            }
            
            const badgeClass = tipo === 'negativa' ? 'badge-danger' : 'badge-success';
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Aluno</th>
                                <th>Turma</th>
                                <th>Tipo</th>
                                <th>Especifica√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            dados.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data || medida.criado_em);
                
                html += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${medida.nome_completo || 'N/A'}</td>
                        <td>${medida.turma || 'N/A'}</td>
                        <td><span class="badge ${badgeClass}">${medida.tipo_medida}</span></td>
                        <td class="text-truncate" style="max-width: 300px;" title="${medida.especificacao || medida.tipo_medida}">${medida.especificacao || medida.tipo_medida}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Carregar turmas nos filtros quando os dados s√£o carregados
        function popularFiltrosTurmas() {
            const turmasNegativas = [...new Set(medidasNegativasData.map(m => m.turma).filter(Boolean))];
            const turmasPositivas = [...new Set(medidasPositivasData.map(m => m.turma).filter(Boolean))];
            
            const selectNegativas = document.getElementById('filtroTurmaNegativas');
            const selectPositivas = document.getElementById('filtroTurmaPositivas');
            
            if (selectNegativas) {
                selectNegativas.innerHTML = '<option value="todas">Todas as turmas</option>';
                turmasNegativas.sort().forEach(turma => {
                    selectNegativas.innerHTML += `<option value="${turma}">${turma}</option>`;
                });
            }
            
            if (selectPositivas) {
                selectPositivas.innerHTML = '<option value="todas">Todas as turmas</option>';
                turmasPositivas.sort().forEach(turma => {
                    selectPositivas.innerHTML += `<option value="${turma}">${turma}</option>`;
                });
            }
        }

        function carregarFaltasMultiplasCategorias() {
            const container = document.getElementById('faltasMultiContainer');
            if (!container) return;
            
            // Carregar todas as faltas diretamente sem sele√ß√£o de categoria
            const todasFaltas = [
                ...carregarFaltasCategorizadas('leve'),
                ...carregarFaltasCategorizadas('media'),
                ...carregarFaltasCategorizadas('grave')
            ];
            
            container.innerHTML = `
                <div class="categorias-selector">
                    <h4>üìã Selecione as faltas disciplinares aplic√°veis:</h4>
                    <p class="texto-instrucao">Marque todas as faltas que se aplicam ao caso:</p>
                </div>
                <div class="todas-faltas">
                    <div class="categoria-secao">
                        <h5 style="color: #333; margin: 15px 0 10px 0;">‚ö° Faltas Leves (Itens 1-26)</h5>
                        <div class="faltas-categoria">
                            ${carregarFaltasCategorizadas('leve').map(falta => `
                                <label class="falta-checkbox categoria-leve">
                                    <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                    <span>${falta}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div class="categoria-secao">
                        <h5 style="color: #333; margin: 15px 0 10px 0;">‚ö†Ô∏è Faltas M√©dias (Itens 27-62)</h5>
                        <div class="faltas-categoria">
                            ${carregarFaltasCategorizadas('media').map(falta => `
                                <label class="falta-checkbox categoria-media">
                                    <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                    <span>${falta}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div class="categoria-secao">
                        <h5 style="color: #333; margin: 15px 0 10px 0;">üö® Faltas Graves (Itens 63-91)</h5>
                        <div class="faltas-categoria">
                            ${carregarFaltasCategorizadas('grave').map(falta => `
                                <label class="falta-checkbox categoria-grave">
                                    <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                    <span>${falta}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function carregarOpcoesPositivas(tipoMedida) {
            const container = document.getElementById('faltasMultiContainer');
            if (!container) return;
            
            const opcoesPorTipo = {
                'Elogio Individual': [
                    // üìå Comportamento e Disciplina
                    'Aluno bem apresentado',
                    'Apresentou postura exemplar',
                    'Demonstrou respeito',
                    'Ajudou espontaneamente na manuten√ß√£o da ordem da sala',
                    'Apresentou melhoramento de Disciplina',
                    'Elogiado pelo Professor',
                    
                    // üìå Civismo e Atitude
                    'Cantou o hino nacional com entusiasmo',
                    'Participou ativamente do hasteamento da bandeira',
                    'Apresentou contin√™ncia correta e bem executada',
                    'Demonstrou esp√≠rito de equipe em atividade c√≠vico-militar',
                    'Colaborou na organiza√ß√£o de evento escolar',
                    
                    // üìå Dedica√ß√£o e Responsabilidade
                    'Realizou todas as tarefas dentro do prazo',
                    'Trouxe materiais extras para auxiliar colegas',
                    'Assumiu responsabilidade volunt√°ria em atividade',
                    'Apresentou melhora significativa na pontualidade',
                    'Cumpriu escala de servi√ßo com excel√™ncia',
                    
                    // üìå Conviv√™ncia e Respeito
                    'Ajudou colega com dificuldade sem ser solicitado',
                    'Mediou conflito entre colegas de forma positiva',
                    'Tratou todos com cortesia e educa√ß√£o',
                    'Apresentou lideran√ßa positiva no grupo',
                    'Demonstrou solidariedade em situa√ß√£o de necessidade',
                    
                    // üìå Participa√ß√£o e Proatividade
                    'Participou com destaque em atividade esportiva',
                    'Contribuiu ativamente em clube/atividade extracurricular',
                    'Fez perguntas pertinentes durante a aula',
                    'Apresentou sugest√µes construtivas para a turma',
                    'Engajou-se em atividades de leitura e estudo',
                    
                    // üéñÔ∏è Elogios Individuais
                    'Demonstrou lideran√ßa positiva em atividade de grupo',
                    'Exerceu exemplo de disciplina e postura durante toda a semana',
                    'Obteve destaque na participa√ß√£o em evento c√≠vico-militar',
                    'Apresentou melhora significativa no comportamento e rendimento',
                    'Recebeu elogio espont√¢neo de professor ou servidor',
                    'Manteve uniforme completo e impec√°vel em todas as forma√ß√µes',
                    'Cumpriu com excel√™ncia sua fun√ß√£o de escala de servi√ßo',
                    'Demonstrou iniciativa e proatividade em situa√ß√µes escolares',
                    'Conduziu colegas com respeito e esp√≠rito de equipe',
                    'Realizou apresenta√ß√£o ou tarefa acad√™mica de destaque'
                ],
                'Elogio Coletivo': [
                    // üèÖ Elogios Coletivos (Turma / Grupo)
                    'Turma apresentou disciplina exemplar durante a forma√ß√£o',
                    'Executou o hasteamento da bandeira de forma impec√°vel',
                    'Destacou-se pela pontualidade coletiva ao longo da semana',
                    'Demonstrou esp√≠rito de equipe em atividade esportiva/c√≠vica',
                    'Participou de evento externo representando a escola com honra',
                    'Realizou atividade de sala com organiza√ß√£o e coopera√ß√£o',
                    'Manteve ambiente de sala limpo e organizado coletivamente',
                    'Demonstrou respeito coletivo aos professores e colegas',
                    'Alcan√ßou melhor m√©dia de frequ√™ncia entre as turmas',
                    'Recebeu elogio p√∫blico da dire√ß√£o/coordena√ß√£o pela postura'
                ],
                'Fato Observado Positivo': [
                    // Baseado nas categorias de Elogio Individual para Fatos Observados
                    'Observado comportamento exemplar fora do ambiente escolar',
                    'Observado ajuda espont√¢nea a pessoa necessitada',
                    'Observado cuidado especial com patrim√¥nio p√∫blico',
                    'Observado media√ß√£o pac√≠fica em situa√ß√£o de conflito',
                    'Observado iniciativa em preserva√ß√£o do meio ambiente',
                    'Observado atitude inclusiva com pessoa especial',
                    'Observado demonstra√ß√£o pr√°tica de valores √©ticos',
                    'Observado gesto de bondade com colega/pessoa necessitada',
                    'Observado respeito aos s√≠mbolos nacionais em evento p√∫blico',
                    'Observado atitude de coragem em situa√ß√£o de risco',
                    'Observado solidariedade com a comunidade',
                    'Observado honestidade ao devolver objeto encontrado',
                    'Observado lideran√ßa positiva em atividade comunit√°ria'
                ]
            };
            
            const opcoes = opcoesPorTipo[tipoMedida] || [];
            container.innerHTML = `
                <div class="categorias-selector">
                    <h4>‚ú® Situa√ß√µes espec√≠ficas para ${tipoMedida}:</h4>
                    <p class="texto-instrucao">Selecione uma ou mais situa√ß√µes que se aplicam:</p>
                </div>
                <div class="opcoes-positivas">
                    ${opcoes.map(opcao => `
                        <label class="falta-checkbox opcao-positiva">
                            <input type="checkbox" value="${opcao}" onchange="toggleFalta('${opcao}')">
                            <span>‚úÖ ${opcao}</span>
                        </label>
                    `).join('')}
                </div>
            `;
        }

        // === SISTEMA DE C√ÅLCULO DE PRAZO ===
        function adicionarDiasUteis(data, diasUteis) {
            const resultado = new Date(data);
            let diasAdicionados = 0;
            
            while (diasAdicionados < diasUteis) {
                resultado.setDate(resultado.getDate() + 1);
                // Se n√£o for s√°bado (6) nem domingo (0)
                if (resultado.getDay() !== 0 && resultado.getDay() !== 6) {
                    diasAdicionados++;
                }
            }
            
            return resultado;
        }

        function calcularPrazoAutomatico() {
            // Verificar se o campo de prazo deve estar vis√≠vel
            const campoPrazo = document.getElementById('prazoAssinaturaInfo');
            const tipoMedida = document.getElementById('tipoMedida').value;

            const medidasComPrazo = [
                'Advert√™ncia Verbal',
                'Advert√™ncia Escrita',
                'Suspens√£o',
                'A√ß√£o Educativa'
            ];

            // S√≥ calcular se o tipo de medida requer prazo
            if (!medidasComPrazo.includes(tipoMedida)) {
                console.log(`‚ùå Tipo de medida "${tipoMedida}" n√£o requer prazo - n√£o calculando`);
                return;
            }

            const dataOcorrencia = document.getElementById('dataMedida').value;
            const prazoDisplay = document.getElementById('prazoDataDisplay');

            if (!dataOcorrencia || !prazoDisplay) return;

            try {
                const dataOcorr = new Date(dataOcorrencia);
                // 3 dias √∫teis ap√≥s a ocorr√™ncia
                const dataPrazo = adicionarDiasUteis(dataOcorr, 3);

                // Formatar para exibi√ß√£o brasileira
                const prazoFormatado = dataPrazo.toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                prazoDisplay.innerHTML = `üìÖ ${prazoFormatado}`;
                console.log(`‚úÖ Prazo calculado: ${prazoFormatado}`);

                // Salvar data formatada para ISO para uso no salvamento
                window.prazoCalculado = dataPrazo.toISOString().split('T')[0];

            } catch (error) {
                console.error('Erro ao calcular prazo:', error);
                prazoDisplay.innerHTML = '‚ùå Erro ao calcular prazo';
            }
        }

        // Adicionar evento ao campo de data quando carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) {
                    dataMedida.addEventListener('change', calcularPrazoAutomatico);
                    // Calcular prazo inicial se data j√° estiver preenchida
                    if (dataMedida.value) {
                        calcularPrazoAutomatico();
                    }
                }
            }, 1000);
        });

        // ========================================
        // üì± WHATSAPP INTEGRATION FUNCTIONS
        // ========================================

        // FUN√á√ÉO REMOVIDA: mostrarBotaoWhatsApp()
        // Agora usamos apenas envio autom√°tico via checkbox

        // Enviar notifica√ß√£o WhatsApp
        async function enviarWhatsAppMedida() {
            console.log('üöÄ FUN√á√ÉO enviarWhatsAppMedida() CHAMADA!');
            try {
                // Verificar se WhatsApp Sender est√° dispon√≠vel
                if (!window.whatsappSender) {
                    showMessage('‚ùå Sistema WhatsApp n√£o carregado', 'error');
                    return;
                }

                // Obter dados do aluno da √∫ltima medida salva
                const dadosAluno = window.ultimoAlunoSalvo;
                if (!dadosAluno) {
                    showMessage('‚ùå Dados do aluno n√£o encontrados', 'error');
                    return;
                }

                // Obter dados da medida armazenados
                const medida = window.ultimaMedidaSalva;
                if (!medida) {
                    showMessage('‚ùå Dados da medida n√£o encontrados. Salve uma medida primeiro.', 'error');
                    return;
                }

                console.log('üì± Enviando WhatsApp:', { dadosAluno, medida });

                // Enviar via WhatsApp Sender
                const resultado = await window.whatsappSender.notificarMedidaDisciplinar(dadosAluno, medida);

                if (resultado.success) {
                    showMessage('‚úÖ WhatsApp enviado com sucesso!', 'success');
                } else {
                    showMessage(`‚ùå Erro ao enviar WhatsApp: ${resultado.error}`, 'error');
                }

            } catch (error) {
                console.error('‚ùå Erro ao enviar WhatsApp:', error);
                showMessage('‚ùå Erro ao enviar WhatsApp: ' + error.message, 'error');
            }
        }

        // FUN√á√ÉO REMOVIDA: obterDadosMedidaFormulario()
        // Agora usamos os dados que foram armazenados em window.ultimaMedidaSalva

        // FUN√á√ÉO REMOVIDA: obterEspecificacaoMedida()
        // Agora usamos a especifica√ß√£o real que foi salva no banco (faltas selecionadas ou motivo)

        // Atualizar fun√ß√£o limparFormMedida para esconder bot√£o WhatsApp
        const limparFormMedidaOriginal = window.limparFormMedida;
        window.limparFormMedida = function() {
            // Chamar fun√ß√£o original de limpar
            if (limparFormMedidaOriginal) {
                limparFormMedidaOriginal();
            } else {
                // Implementa√ß√£o b√°sica se n√£o existir
                const form = document.getElementById('medidaForm');
                if (form) form.reset();
            }

            // Resetar bot√£o de salvar para estado padr√£o
            const btnSalvar = document.getElementById('btnSalvarMedida');
            if (btnSalvar) {
                btnSalvar.innerHTML = '‚ö†Ô∏è Salvar Medida';
                btnSalvar.className = 'btn btn-warning';
            }

            // Limpar checkbox WhatsApp
            const checkboxWhatsApp = document.getElementById('enviarWhatsAppAuto');
            if (checkboxWhatsApp) {
                checkboxWhatsApp.checked = false;
            }

            // Limpar dados armazenados
            window.ultimoAlunoSalvo = null;
            window.ultimaMedidaSalva = null;

            console.log('üîÑ Formul√°rio limpo e bot√£o WhatsApp escondido');
        };

        // Variables para armazenar dados da √∫ltima medida salva
        window.ultimoAlunoSalvo = null;
        window.ultimaMedidaSalva = null;

        // FUN√á√ÉO REMOVIDA: resetarBotaoWhatsApp()
        // N√£o precisamos mais resetar bot√£o separado

        // Fun√ß√£o para atualizar texto do bot√£o salvar baseado no checkbox
        function atualizarTextoBotaoSalvar() {
            const checkbox = document.getElementById('enviarWhatsAppAuto');
            const btnSalvar = document.getElementById('btnSalvarMedida');

            if (checkbox && btnSalvar) {
                if (checkbox.checked) {
                    btnSalvar.innerHTML = '‚ö†Ô∏èüì± Salvar e Enviar WhatsApp';
                    btnSalvar.className = 'btn btn-success';
                } else {
                    btnSalvar.innerHTML = '‚ö†Ô∏è Salvar Medida';
                    btnSalvar.className = 'btn btn-warning';
                }
            }
        }

        // Adicionar listener para atualizar texto do bot√£o
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Listener para atualizar texto do bot√£o ao marcar/desmarcar checkbox
                const checkboxWhatsApp = document.getElementById('enviarWhatsAppAuto');
                if (checkboxWhatsApp) {
                    checkboxWhatsApp.addEventListener('change', atualizarTextoBotaoSalvar);
                }

                console.log('üëÇ Listener do checkbox WhatsApp adicionado');
            }, 1500);
        });

        console.log('üì± Fun√ß√µes WhatsApp carregadas com sucesso');

    </script>

</body>
</html>
