<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidas Disciplinares - Dashboard Disciplinar</title>
    <link rel="icon" type="image/jpeg" href="../assets/images/logo-escola.jpeg">
    <!-- Deploy test -->
    
    <!-- CSS Externos -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    
    <!-- APENAS SUPABASE -->
    <script src="../netlify-env.js" onerror="console.log('Vari√°veis do Netlify n√£o encontradas')"></script>
    <script src="../assets/js/env-config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-only.js"></script>
    
    <!-- jsPDF para exporta√ß√£o em PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    
    <!-- Scripts de categoria de medidas -->
    <script src="../assets/js/medidas-categorias.js"></script>
    
    <!-- Estilos espec√≠ficos para ficha disciplinar -->
    <style>
        /* Sistema de expans√£o/colapso de se√ß√µes */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            margin: 0;
        }
        
        .section-header:hover {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }
        
        .section-toggle {
            font-size: 1.2em;
            color: #007bff;
            transition: transform 0.3s ease;
            user-select: none;
        }
        
        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 0px;
            opacity: 0;
            transition: all 0.4s ease;
            overflow: hidden;
        }
        
        .section-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        
        .section-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .management-title {
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        /* Sistema de sele√ß√£o m√∫ltipla de faltas */
        .faltas-multi-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }
        
        /* Tabelas de hist√≥rico - container com scroll */
        #tableMedidasNegativas, #tableMedidasPositivas {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .historico-table thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }
        
        .historico-table thead th {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            color: #333;
        }
        
        .historico-table tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        .historico-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .historico-table td {
            padding: 8px;
            vertical-align: top;
        }
        
        .falta-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .falta-option:hover {
            background: #f8f9fa;
        }
        
        .falta-option:last-child {
            border-bottom: none;
        }
        
        .falta-checkbox {
            margin-right: 8px;
        }
        
        .faltas-selecionadas {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .faltas-selecionadas-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .falta-tag {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px 4px 2px 0;
            cursor: pointer;
        }
        
        .falta-tag:hover {
            background: #dc3545;
        }
        
        .falta-tag::after {
            content: ' ‚úï';
            margin-left: 4px;
        }
        
        /* Status do prazo */
        .status-prazo {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        
        .status-prazo.em-prazo {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-prazo.atencao {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-prazo.vencido {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .form-help {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            display: block;
        }
        
        /* Sistema de categorias m√∫ltiplas */
        .categorias-container {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .categoria-group {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .categoria-group:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .categoria-group.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .categoria-checkbox {
            margin-right: 8px;
        }
        
        .categoria-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Se√ß√µes de faltas por categoria */
        .categoria-secao {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .categoria-header {
            background: #f8f9fa;
            padding: 10px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
        }
        
        .categoria-faltas {
            padding: 10px;
        }

        /* Dados pessoais */
        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dado-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .dado-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .dado-valor {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }
        
        /* Sistema de Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .loading-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            color: #666;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading-steps {
            text-align: left;
            margin-top: 20px;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 5px 0;
            font-size: 0.85em;
            color: #666;
        }
        
        .loading-step.active {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .loading-step.completed {
            color: #28a745;
        }
        
        .loading-step-icon {
            margin-right: 8px;
            width: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Top Loading Bar */
        .top-loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            z-index: 9998;
            overflow: hidden;
        }
        
        .top-loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Componentes de Frequ√™ncia */
        .frequencia-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .frequencia-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .frequencia-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .frequencia-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #17a2b8;
        }
        
        .frequencia-card.presenca-excelente {
            border-left-color: #28a745;
        }
        
        .frequencia-card.presenca-boa {
            border-left-color: #17a2b8;
        }
        
        .frequencia-card.presenca-regular {
            border-left-color: #ffc107;
        }
        
        .frequencia-card.presenca-baixa {
            border-left-color: #dc3545;
        }
        
        .frequencia-card-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .frequencia-card-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .frequencia-card-subtitle {
            font-size: 0.8em;
            color: #888;
        }
        
        .faltas-recentes {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .faltas-recentes-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .falta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #fff5f5;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #dc3545;
        }
        
        .falta-data {
            font-weight: 500;
            color: #dc3545;
        }
        
        .falta-info {
            font-size: 0.85em;
            color: #666;
        }
        
        .sem-faltas {
            text-align: center;
            padding: 20px;
            color: #28a745;
            font-weight: 500;
        }
        
        .ver-todas-faltas {
            display: block;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            color: #007bff;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .ver-todas-faltas:hover {
            background: #e9ecef;
        }
        
        .resumo-mensal {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .resumo-mensal-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resumo-mensal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .resumo-mensal-stat {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .resumo-mensal-stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        
        .resumo-mensal-stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }

        /* Resumos */
        .faltas-resumo, .medidas-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .resumo-item {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .resumo-danger { background: linear-gradient(135deg, #dc3545, #e55565); color: white; }
        .resumo-warning { background: linear-gradient(135deg, #ffc107, #ffcd3c); color: #333; }
        .resumo-info { background: linear-gradient(135deg, #17a2b8, #3bc4db); color: white; }
        .resumo-secondary { background: linear-gradient(135deg, #6c757d, #868e96); color: white; }
        .resumo-success { background: linear-gradient(135deg, #28a745, #34ce57); color: white; }
        
        .resumo-numero {
            display: block;
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .resumo-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
            display: block;
        }
        
        /* Timeline de faltas */
        .faltas-timeline {
            margin-top: 20px;
        }
        
        .mes-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .mes-titulo {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            padding: 12px 20px;
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .faltas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .falta-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .falta-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .falta-simples {
            background: linear-gradient(135deg, #dc3545, #e55565);
            color: white;
        }
        
        .falta-controlada {
            background: linear-gradient(135deg, #ffc107, #ffcd3c);
            color: #333;
        }
        
        .atestado {
            background: linear-gradient(135deg, #17a2b8, #3bc4db);
            color: white;
        }
        
        .falta-icon {
            font-size: 1.8em;
            margin-right: 12px;
        }
        
        .falta-info {
            flex-grow: 1;
        }
        
        .falta-data {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 2px;
        }
        
        .falta-dia {
            font-size: 0.85em;
            opacity: 0.8;
            text-transform: capitalize;
        }
        
        .falta-tipo {
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Estat√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .stat-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .stat-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .stat-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .stat-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
        
        .stat-icon {
            font-size: 2.5em;
            margin-right: 15px;
            opacity: 0.8;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        /* Breakdown */
        .breakdown-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .breakdown-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #495057;
        }
        
        .breakdown-value {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }
        
        /* Info boxes */
        .info-box {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .info-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .info-box h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        /* Medidas timeline */
        .medidas-timeline {
            margin-top: 20px;
        }
        
        .medida-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .medida-data {
            font-weight: bold;
            color: #495057;
            margin-right: 20px;
            min-width: 100px;
            font-size: 0.9em;
        }
        
        .medida-content {
            flex-grow: 1;
        }
        
        .medida-actions {
            margin-left: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .btn-excluir-medida {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .btn-excluir-medida:hover {
            background: #c82333;
            opacity: 1;
            transform: scale(1.1);
        }
        
        .medida-tipo {
            font-weight: bold;
            color: #dc3545;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        /* Medidas positivas - verde */
        .medida-item.positiva {
            border-left: 4px solid #28a745;
        }
        
        .medida-item.positiva .medida-tipo {
            color: #28a745;
        }
        
        /* Pontua√ß√£o da medida */
        .medida-pontos {
            display: inline-block;
            margin-left: 10px;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .medida-pontos.positivos {
            background: #d4edda;
            color: #155724;
        }
        
        .medida-pontos.negativos {
            background: #f8d7da;
            color: #721c24;
        }
        
        .medida-descricao {
            color: #495057;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .medida-providencias {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Registros recentes */
        .records-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .record-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .record-student {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }
        
        .record-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-details {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
        }
        
        .record-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .record-turma {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-description {
            color: #495057;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        /* Compara√ß√µes */
        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .comparison-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .comparison-good {
            border-left-color: #28a745;
        }
        
        .comparison-alert {
            border-left-color: #dc3545;
        }
        
        .comparison-label {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }
        
        .comparison-value {
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 15px;
        }
        
        /* Nota Disciplinar */
        .disciplinary-score-card {
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .score-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .score-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-emoji {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .score-info .score-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .score-info .score-subtitle {
            font-size: 1.1em;
            font-weight: 600;
            opacity: 0.8;
        }
        
        .score-number {
            font-size: 3.5em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 20px;
        }
        
        .score-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.95em;
            color: #495057;
            background: rgba(255,255,255,0.7);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid currentColor;
        }
        
        .score-details span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dados-grid, .faltas-grid, .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .disciplinary-score-card {
                padding: 20px;
            }
            
            .score-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .score-number {
                font-size: 2.5em;
                margin-left: 0;
            }
            
            .score-emoji {
                font-size: 2em;
            }
            
            .score-info .score-title {
                font-size: 1.2em;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .faltas-resumo, .medidas-resumo {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .breakdown-grid {
                grid-template-columns: 1fr;
            }
            
            .medida-item {
                flex-direction: column;
            }
            
            .medida-data {
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
        
        /* Estilos para alertas de prazo */
        .alerta-prazo {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .insight-content {
            flex: 1;
            margin-right: 15px;
        }
        
        .insight-detalhes {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .insight-prazo {
            font-size: 0.8em;
            color: #007bff;
            font-weight: bold;
            margin-top: 3px;
        }
        
        .insight-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .btn-marcar-entregue {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        .btn-marcar-entregue:hover {
            background: #218838;
        }
        
        .btn-marcar-entregue:active {
            transform: translateY(1px);
        }
        
        /* Responsividade para alertas */
        @media (max-width: 768px) {
            .alerta-prazo {
                flex-direction: column;
                gap: 10px;
            }
            
            .insight-content {
                margin-right: 0;
            }
            
            .insight-actions {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* Estilos para tabelas de hist√≥rico de medidas */
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .historico-table th,
        .historico-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .historico-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .historico-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .historico-table .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        
        .historico-table .codigo-cell {
            width: 80px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .historico-table .data-cell {
            width: 90px;
        }
        
        .historico-table .tipo-cell {
            width: 120px;
        }
        
        .historico-table .categoria-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .categoria-badge.leve {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .categoria-badge.media {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .categoria-badge.grave {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .categoria-badge.positiva {
            background-color: #d4edda;
            color: #155724;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 15px;
            cursor: pointer;
        }
        
        .table-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .table-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .checkbox-label {
                margin: 5px 0;
            }
        }
    </style>
</head>

<body>
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <img src="../assets/images/logo-escola.jpeg" alt="Logo da Escola" class="top-bar-logo" style="height: 40px; margin-right: 15px; border-radius: 4px;">
            <div class="app-launcher">
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
            </div>
            <span class="app-name">Dashboard Disciplinar</span>
        </div>
        <div class="top-bar-center">
            <input type="text" class="search-box" placeholder="Pesquisar registros...">
        </div>
        <div class="top-bar-right">
            <div class="user-profile">A</div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="main-layout">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">M√≥dulos Principais</div>
                
                <a href="../index.html" class="sidebar-item">
                    <span class="sidebar-icon">üè†</span>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                
                <a href="gestao-alunos.html" class="sidebar-item">
                    <span class="sidebar-icon">üë•</span>
                    <span class="sidebar-text">Gest√£o de Alunos</span>
                </a>
                
                <a href="medidas-disciplinares.html" class="sidebar-item active">
                    <span class="sidebar-icon">üìã</span>
                    <span class="sidebar-text">Medidas Disciplinares</span>
                </a>
                
                <a href="frequencia.html" class="sidebar-item">
                    <span class="sidebar-icon">üìÖ</span>
                    <span class="sidebar-text">Controle de Frequ√™ncia</span>
                </a>
                
                <a href="relatorios.html" class="sidebar-item">
                    <span class="sidebar-icon">üìä</span>
                    <span class="sidebar-text">Relat√≥rios</span>
                </a>
                
                <a href="analises.html" class="sidebar-item">
                    <span class="sidebar-icon">üìà</span>
                    <span class="sidebar-text">An√°lises</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ferramentas</div>
                
                <a href="configuracoes.html" class="sidebar-item">
                    <span class="sidebar-icon">‚öôÔ∏è</span>
                    <span class="sidebar-text">Configura√ß√µes</span>
                </a>
                
                <a href="comunicacao.html" class="sidebar-item">
                    <span class="sidebar-icon">üì±</span>
                    <span class="sidebar-text">Comunica√ß√£o</span>
                </a>
                
                <a href="login.html" class="sidebar-item">
                    <span class="sidebar-icon">üîê</span>
                    <span class="sidebar-text">Login/Logout</span>
                </a>
            </div>
        </div>

        <!-- √ÅREA DE CONTE√öDO -->
        <div class="content-area">
            <div class="main-content">
                
                <!-- T√çTULO -->
                <div class="module-title">
                    üìã Medidas Disciplinares
                </div>

                <!-- SE√á√ÉO: ESTAT√çSTICAS R√ÅPIDAS -->
                <div class="quick-stats">
                    <div class="stat-card stat-highlight" style="background: linear-gradient(135deg, #28a74520, #17a2b820); border: 2px solid #28a745;">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="mediaNotaEscola" style="color: #28a745;">0.0</div>
                            <div class="stat-label">M√©dia Disciplinar da Escola</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">‚öñÔ∏è</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalMedidas">0</div>
                            <div class="stat-label">Total de Medidas</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-info">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasMes">0</div>
                            <div class="stat-label">Medidas este M√™s</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-success">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasSemana">0</div>
                            <div class="stat-label">Medidas esta Semana</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <div class="stat-number" id="alunosAfetados">0</div>
                            <div class="stat-label">Alunos com Medidas</div>
                        </div>
                    </div>
                </div>

                <!-- PAINEL DE ALERTAS -->
                <div class="management-section" id="painelAlertas">
                    <div class="section-header" onclick="toggleSection('alertas')">
                        <div class="management-title">
                            üö® Alertas e Prioridades
                        </div>
                        <span class="section-toggle" id="alertas-toggle">üîΩ</span>
                    </div>
                    <div class="section-content" id="alertas-content">
                        <div id="alertasContainer">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Carregando alertas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO: MEDIDAS DISCIPLINARES -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidas')">
                        <div class="management-title">
                            ‚öñÔ∏è Registrar Medida Disciplinar
                        </div>
                        <span class="section-toggle" id="medidas-toggle">üîΩ</span>
                    </div>
                    
                    <div class="section-content" id="medidas-content">
                        <form id="formMedida" onsubmit="salvarMedida(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Turma *</label>
                                <select id="turmaMedida" class="form-select" onchange="carregarAlunosPorTurmaMedida()" required>
                                    <option value="">Selecione a turma...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aluno *</label>
                                <select id="alunoMedida" class="form-select" required disabled>
                                    <option value="">Primeiro selecione uma turma...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Data da Ocorr√™ncia *</label>
                                <input 
                                    type="date" 
                                    id="dataMedida" 
                                    class="form-input" 
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Medida *</label>
                                <select id="tipoMedida" class="form-select" onchange="configurarCamposMedida()" required>
                                    <option value="">Selecione...</option>
                                    <optgroup label="üìà Medidas Positivas">
                                        <option value="Elogio Individual">Elogio Individual (+0,5)</option>
                                        <option value="Elogio Coletivo">Elogio Coletivo (+0,3)</option>
                                        <option value="Fato Observado Positivo">Fato Observado Positivo (+0,1)</option>
                                    </optgroup>
                                    <optgroup label="üìâ Medidas Disciplinares">
                                        <option value="Fato Observado Negativo">Fato Observado Negativo (-0,1)</option>
                                        <option value="Advert√™ncia Verbal">Advert√™ncia Verbal (-0,3)</option>
                                        <option value="Advert√™ncia Escrita">Advert√™ncia Escrita (-0,3)</option>
                                        <option value="Suspens√£o">Suspens√£o (-0,5 por dia)</option>
                                        <option value="A√ß√£o Educativa">A√ß√£o Educativa (-1,0)</option>
                                    </optgroup>
                                    <optgroup label="üîÑ Medidas Educativas">
                                        <option value="Reuni√£o com Respons√°veis">Reuni√£o com Respons√°veis</option>
                                        <option value="Encaminhamento Coordena√ß√£o">Encaminhamento √† Coordena√ß√£o</option>
                                        <option value="Trabalho Educativo">Trabalho Educativo</option>
                                        <option value="Acompanhamento Psicopedag√≥gico">Acompanhamento Psicopedag√≥gico</option>
                                        <option value="Outro">Outro</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <!-- Campos de categoria de faltas - inicialmente ocultos -->
                            <div class="form-group form-group-full" id="campoCategoriaMedida" style="display: none;">
                                <label class="form-label">Categorias de Faltas</label>
                                <div class="categorias-container">
                                    <div class="categoria-group" onclick="toggleCategoria('leves')">
                                        <input type="checkbox" id="cat_leves" class="categoria-checkbox" />
                                        <label for="cat_leves">üìó Faltas Leves (1-26)</label>
                                    </div>
                                    <div class="categoria-group" onclick="toggleCategoria('medias')">
                                        <input type="checkbox" id="cat_medias" class="categoria-checkbox" />
                                        <label for="cat_medias">üìô Faltas M√©dias (27-62)</label>
                                    </div>
                                    <div class="categoria-group" onclick="toggleCategoria('graves')">
                                        <input type="checkbox" id="cat_graves" class="categoria-checkbox" />
                                        <label for="cat_graves">üìï Faltas Graves (63-91)</label>
                                    </div>
                                </div>
                                <small class="form-help">Voc√™ pode selecionar m√∫ltiplas categorias para o mesmo incidente</small>
                            </div>
                            
                            <div class="form-group form-group-full" id="campoSelecaoFalta" style="display: none;">
                                <label class="form-label">Selecionar Faltas Espec√≠ficas *</label>
                                <div id="faltasMultiContainer" class="faltas-multi-container">
                                    <div style="padding: 20px; text-align: center; color: #666;">
                                        Primeiro selecione uma categoria...
                                    </div>
                                </div>
                                <div id="faltasSelecionadas" class="faltas-selecionadas" style="display: none;">
                                    <div class="faltas-selecionadas-title">Faltas selecionadas:</div>
                                    <div id="faltasTagsContainer"></div>
                                </div>
                                <!-- Hidden input para armazenar as faltas selecionadas -->
                                <input type="hidden" id="faltaEspecifica" name="faltasEspecificas" />
                            </div>
                            
                            <div class="form-group" id="campoSuspensao" style="display: none;">
                                <label class="form-label">Dias de Suspens√£o *</label>
                                <input 
                                    type="number" 
                                    id="diasSuspensao" 
                                    class="form-input" 
                                    min="1" 
                                    max="30"
                                    placeholder="N√∫mero de dias"
                                >
                            </div>
                            
                            <div class="form-group form-group-full" id="campoMotivoOriginal">
                                <label class="form-label">Motivo/Descri√ß√£o *</label>
                                <textarea 
                                    id="motivoMedida" 
                                    class="form-textarea" 
                                    placeholder="Descreva detalhadamente o motivo da medida disciplinar..." 
                                    rows="4"
                                ></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Prazo para entrega de Assinatura</label>
                                <input 
                                    type="date" 
                                    id="prazoAssinatura" 
                                    class="form-input"
                                    title="Data limite para o respons√°vel devolver o documento assinado"
                                >
                                <small class="form-help">ü§ñ <strong>Autom√°tico:</strong> 3 dias √∫teis a partir da data de ocorr√™ncia (ajust√°vel se necess√°rio)</small>
                            </div>
                            
                            <div class="form-group" id="diasRestantesInfo" style="display: none;">
                                <label class="form-label">Status do Prazo</label>
                                <div id="statusPrazo" class="status-prazo">
                                    <!-- Ser√° preenchido automaticamente -->
                                </div>
                            </div>
                            
                            <div class="form-group form-group-full">
                                <label class="form-label">A√ß√µes Tomadas</label>
                                <textarea 
                                    id="acoesMedida" 
                                    class="form-textarea" 
                                    placeholder="Descreva as a√ß√µes tomadas ou que ser√£o tomadas..." 
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="limparFormMedida()">
                                üîÑ Limpar
                            </button>
                            <button type="submit" class="btn btn-warning">
                                ‚ö†Ô∏è Salvar Medida
                            </button>
                        </div>
                        </form>
                    </div>
                </div>

                <!-- SE√á√ÉO: FICHA DISCIPLINAR DO ALUNO -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('consulta')">
                        <div class="management-title">
                            üîç Consultar Ficha Disciplinar do Aluno
                        </div>
                        <span class="section-toggle" id="consulta-toggle">üîΩ</span>
                    </div>
                    
                    <div class="section-content" id="consulta-content">
                        <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Selecionar Turma *</label>
                            <select id="turmaConsulta" class="form-select" onchange="console.log('ONCHANGE DIRETO:', this.value); carregarAlunosPorTurmaSimples();" required>
                                <option value="">Selecione uma turma...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Selecionar Aluno *</label>
                            <select id="alunoConsulta" class="form-select" onchange="habilitarBotaoPesquisa()" required>
                                <option value="">Primeiro selecione uma turma...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-success" onclick="exportarFichaPDF()" id="btnExportarPDF" disabled>
                                üìÑ Exportar Ficha em PDF
                            </button>
                        </div>
                        
                        <!-- BOT√ïES DE A√á√ÉO -->
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-primary" onclick="carregarFichaDisciplinar()" id="btnPesquisarFicha" disabled>
                                üîç Pesquisar Ficha Disciplinar
                            </button>
                        </div>
                    </div>
                    
                    <!-- √ÅREA DE FREQU√äNCIA SEPARADA -->
                    <div id="areaFrequenciaAluno" style="display: none; margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; border: 2px solid #2196f3;">
                        <h4>üìÖ Frequ√™ncia do Aluno Selecionado</h4>
                        <div id="resultadoFrequenciaAluno"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="fecharFrequencia()" style="margin-top: 10px;">
                            ‚úñÔ∏è Fechar
                        </button>
                    </div>
                    
                    <!-- √ÅREA DE EXIBI√á√ÉO DA FICHA -->
                    <div id="fichaAluno" class="ficha-container" style="display: none;">
                        <!-- Dados pessoais do aluno -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">üë§ Dados Pessoais</h3>
                            <div id="dadosPessoais" class="dados-pessoais"></div>
                        </div>
                        
                        
                        <!-- Hist√≥rico de medidas disciplinares -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">‚öñÔ∏è Hist√≥rico de Medidas Disciplinares</h3>
                            <div id="historicoMedidas" class="historico-container"></div>
                        </div>
                        
                        <!-- Frequ√™ncia Escolar -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">üìÖ Frequ√™ncia Escolar</h3>
                            <div id="frequenciaEscolar" class="frequencia-container">
                                <div class="loading-state">
                                    <p>Carregando dados de frequ√™ncia...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Resumo estat√≠stico -->
                        <div class="ficha-section">
                            <h3 class="ficha-section-title">üìä Resumo Estat√≠stico</h3>
                            <div id="resumoEstatistico" class="resumo-stats" style="max-height: 300px; overflow-y: auto; overflow-x: hidden;"></div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO: REGISTROS RECENTES -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="section-header" onclick="toggleSection('registros')">
                            <div class="table-title">
                                üìã Registros Recentes
                            </div>
                            <span class="section-toggle" id="registros-toggle">üîΩ</span>
                        </div>
                    </div>
                    <div class="section-content" id="registros-content">
                        <div class="table-actions">
                            <button class="btn btn-info btn-small" onclick="carregarRegistrosRecentes()">
                                üîÑ Atualizar
                            </button>
                            <select class="filter-select" onchange="filtrarRegistrosRecentes(this.value)">
                                <option value="todos">Todos os tipos</option>
                                <option value="faltas">Apenas Faltas</option>
                                <option value="medidas">Apenas Medidas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="exportarRegistros()">
                                üìä Exportar
                            </button>
                        </div>
                        
                        <div id="registrosRecentes" class="table-content">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Carregando registros recentes...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO: HIST√ìRICO DE MEDIDAS NEGATIVAS -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidasNegativas')">
                        <div class="management-title">
                            üìä Hist√≥rico de Medidas Disciplinares (Negativas)
                        </div>
                        <span class="section-toggle" id="medidasNegativas-toggle">üîº</span>
                    </div>
                    <div class="section-content" id="medidasNegativas-content">
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="carregarMedidasNegativas()">
                                üìã Carregar Medidas Negativas
                            </button>
                            <input type="text" id="pesquisaNegativas" class="form-input" placeholder="üîç Pesquisar por nome ou c√≥digo..." style="max-width: 250px;" oninput="aplicarFiltrosNegativas()">
                            <select class="filter-select" id="filtroTurmaNegativas" onchange="aplicarFiltrosNegativas()">
                                <option value="todas">Todas as turmas</option>
                            </select>
                            <select class="filter-select" id="quantidadeNegativas" onchange="aplicarFiltrosNegativas()">
                                <option value="10" selected>√öltimas 10</option>
                                <option value="20">√öltimas 20</option>
                                <option value="50">√öltimas 50</option>
                                <option value="100">√öltimas 100</option>
                                <option value="todas">Todas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="limparPesquisaNegativas()">
                                üßπ Limpar
                            </button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="selecionarTodasNegativas" onchange="selecionarTodasMedidasNegativas()">
                                Selecionar Todas
                            </label>
                            <button class="btn btn-success" onclick="exportarMedidasSelecionadas('negativas')">
                                üìÑ Exportar Selecionadas
                            </button>
                        </div>
                        <div id="tableMedidasNegativas" class="table-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                Clique em "üìã Carregar Medidas Negativas" para visualizar o hist√≥rico completo
                            </p>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO: HIST√ìRICO DE MEDIDAS POSITIVAS -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidasPositivas')">
                        <div class="management-title">
                            üåü Hist√≥rico de Medidas Disciplinares (Positivas)
                        </div>
                        <span class="section-toggle" id="medidasPositivas-toggle">üîº</span>
                    </div>
                    <div class="section-content" id="medidasPositivas-content">
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="carregarMedidasPositivas()">
                                üåü Carregar Medidas Positivas
                            </button>
                            <input type="text" id="pesquisaPositivas" class="form-input" placeholder="üîç Pesquisar por nome ou c√≥digo..." style="max-width: 250px;" oninput="aplicarFiltrosPositivas()">
                            <select class="filter-select" id="filtroTurmaPositivas" onchange="aplicarFiltrosPositivas()">
                                <option value="todas">Todas as turmas</option>
                            </select>
                            <select class="filter-select" id="quantidadePositivas" onchange="aplicarFiltrosPositivas()">
                                <option value="10" selected>√öltimas 10</option>
                                <option value="20">√öltimas 20</option>
                                <option value="50">√öltimas 50</option>
                                <option value="100">√öltimas 100</option>
                                <option value="todas">Todas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="limparPesquisaPositivas()">
                                üßπ Limpar
                            </button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="selecionarTodasPositivas" onchange="selecionarTodasMedidasPositivas()">
                                Selecionar Todas
                            </label>
                            <button class="btn btn-warning" onclick="exportarMedidasSelecionadas('positivas')">
                                üìÑ Exportar Selecionadas
                            </button>
                        </div>
                        <div id="tableMedidasPositivas" class="table-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                Clique em "üåü Carregar Medidas Positivas" para visualizar o hist√≥rico completo
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Sistema de Loading -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-title">Carregando Sistema</div>
            <div class="loading-subtitle">Preparando dados disciplinares...</div>
            
            <div class="progress-container">
                <div id="loadingProgressBar" class="progress-bar"></div>
            </div>
            <div id="loadingProgressText" class="progress-text">0%</div>
            
            <div class="loading-steps">
                <div id="loadingStep1" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Conectando ao banco de dados...</span>
                </div>
                <div id="loadingStep2" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Carregando lista de alunos...</span>
                </div>
                <div id="loadingStep3" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Calculando estat√≠sticas...</span>
                </div>
                <div id="loadingStep4" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Carregando registros recentes...</span>
                </div>
                <div id="loadingStep5" class="loading-step">
                    <span class="loading-step-icon">‚è≥</span>
                    <span>Finalizando interface...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Loading Bar -->
    <div id="topLoadingBar" class="top-loading-bar" style="display: none;">
        <div id="topLoadingProgress" class="top-loading-progress"></div>
    </div>

    <!-- JAVASCRIPT -->
    
    <script src="../assets/js/main.js" defer></script>
    <script src="../assets/js/gestao.js" defer></script>
    
    <!-- Servi√ßos de notas disciplinares e frequ√™ncia -->
    <script type="module">
        import { getNotaDisciplinar, NotasUtils } from '../assets/js/notas-disciplinares.js';
        import { 
            getResumoAcumuladoAluno, 
            getFaltasAluno, 
            getResumoMensalAtualAluno,
            FrequenciaUtils 
        } from '../data/frequencia.js';
        
        // Tornar fun√ß√µes dispon√≠veis globalmente
        window.getNotaDisciplinar = getNotaDisciplinar;
        window.NotasUtils = NotasUtils;
        window.getResumoAcumuladoAluno = getResumoAcumuladoAluno;
        window.getFaltasAluno = getFaltasAluno;
        window.getResumoMensalAtualAluno = getResumoMensalAtualAluno;
        window.FrequenciaUtils = FrequenciaUtils;
    </script>
    
    <script>
        // Sistema de Loading Inteligente
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loadingOverlay');
                this.topBar = document.getElementById('topLoadingBar');
                this.progressBar = document.getElementById('loadingProgressBar');
                this.progressText = document.getElementById('loadingProgressText');
                this.topProgress = document.getElementById('topLoadingProgress');
                this.currentStep = 0;
                this.totalSteps = 5;
                this.isVisible = false;
            }
            
            show(title = 'Carregando Sistema', subtitle = 'Preparando dados disciplinares...') {
                if (this.isVisible) return;
                
                document.querySelector('.loading-title').textContent = title;
                document.querySelector('.loading-subtitle').textContent = subtitle;
                
                this.overlay.style.display = 'flex';
                this.topBar.style.display = 'block';
                this.isVisible = true;
                this.currentStep = 0;
                this.updateProgress(0);
            }
            
            hide() {
                setTimeout(() => {
                    this.overlay.style.display = 'none';
                    this.topBar.style.display = 'none';
                    this.isVisible = false;
                }, 500);
            }
            
            updateProgress(percentage, stepText = null) {
                this.progressBar.style.width = percentage + '%';
                this.progressText.textContent = Math.round(percentage) + '%';
                this.topProgress.style.width = percentage + '%';
                
                if (stepText) {
                    const stepNumber = Math.ceil((percentage / 100) * this.totalSteps);
                    this.setStepActive(stepNumber, stepText);
                }
            }
            
            setStepActive(stepNumber, text = null) {
                // Limpar estados anteriores
                for (let i = 1; i <= this.totalSteps; i++) {
                    const step = document.getElementById(`loadingStep${i}`);
                    if (step) {
                        step.classList.remove('active', 'completed');
                        const icon = step.querySelector('.loading-step-icon');
                        if (i < stepNumber) {
                            step.classList.add('completed');
                            icon.textContent = '‚úÖ';
                        } else if (i === stepNumber) {
                            step.classList.add('active');
                            icon.textContent = 'üîÑ';
                            if (text) {
                                step.querySelector('span:last-child').textContent = text;
                            }
                        } else {
                            icon.textContent = '‚è≥';
                        }
                    }
                }
            }
            
            async simulateProgress(duration = 2000) {
                const steps = [
                    { progress: 20, text: 'Conectando ao banco de dados...' },
                    { progress: 40, text: 'Carregando lista de alunos...' },
                    { progress: 60, text: 'Calculando estat√≠sticas...' },
                    { progress: 80, text: 'Carregando registros recentes...' },
                    { progress: 100, text: 'Finalizando interface...' }
                ];
                
                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => {
                        setTimeout(() => {
                            this.updateProgress(steps[i].progress, steps[i].text);
                            resolve();
                        }, duration / steps.length);
                    });
                }
            }
        }
        
        // Inst√¢ncia global do loading
        window.loadingManager = new LoadingManager();
        
        // Inicializa√ß√£o da p√°gina com loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã P√°gina de Medidas Disciplinares carregada');
            
            // Mostrar loading imediatamente
            window.loadingManager.show();
            
            // Inicializar sistema com progresso
            inicializarMedidasDisciplinaresComLoading();
        });

        // Carregar alunos para os selects dos formul√°rios
        async function carregarSelectsAlunos() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                    const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma')
                    .order('"Nome completo"');

                if (error) throw error;

                const alunos = alunosData.map(item => ({
                    id: item.codigo,
                    codigo: item.codigo,
                    nome: item['Nome completo'],
                    turma: item.turma,
                    foto_url: item.foto_url
                }));

                // Guardar dados para uso posterior
                window.alunosMedidasGlobal = alunos;

                // Preencher select de turmas
                const selectTurmaMedida = document.getElementById('turmaMedida');
                if (selectTurmaMedida) {
                    const turmasUnicas = [...new Set(alunos.map(aluno => aluno.turma))].sort();
                    selectTurmaMedida.innerHTML = '<option value="">Selecione a turma...</option>';
                    turmasUnicas.forEach(turma => {
                        selectTurmaMedida.innerHTML += `<option value="${turma}">${turma}</option>`;
                    });
                }

                // Select de alunos come√ßa desabilitado
                const selectMedida = document.getElementById('alunoMedida');
                if (selectMedida) {
                    selectMedida.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                    selectMedida.disabled = true;
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar alunos para os selects:', error);
            }
        }

        // Fun√ß√£o para carregar alunos por turma no formul√°rio de medidas
        function carregarAlunosPorTurmaMedida() {
            const selectTurma = document.getElementById('turmaMedida');
            const selectAluno = document.getElementById('alunoMedida');
            
            if (!selectTurma || !selectAluno || !window.alunosMedidasGlobal) return;
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar sele√ß√£o atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = window.alunosMedidasGlobal.filter(aluno => aluno.turma === turmaSelecionada);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                selectAluno.innerHTML += `<option value="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
        }

        // Controlar exibi√ß√£o do campo de suspens√£o
        document.getElementById('tipoMedida').addEventListener('change', function() {
            const campoSuspensao = document.getElementById('campoSuspensao');
            const diasSuspensao = document.getElementById('diasSuspensao');
            
            if (this.value === 'Suspens√£o') {
                campoSuspensao.style.display = 'block';
                diasSuspensao.required = true;
            } else {
                campoSuspensao.style.display = 'none';
                diasSuspensao.required = false;
                diasSuspensao.value = '';
            }
        });

        // Fun√ß√£o para salvar medida disciplinar
        async function salvarMedida(event) {
            event.preventDefault();
            
            const form = event.target;
            const btn = form.querySelector('button[type="submit"]');
            const alunoId = document.getElementById('alunoMedida').value;
            const tipoMedida = document.getElementById('tipoMedida').value;
            const data = document.getElementById('dataMedida').value;
            const motivo = document.getElementById('motivoMedida').value;
            let acoes = document.getElementById('acoesMedida').value;
            const diasSuspensao = document.getElementById('diasSuspensao').value;
            const prazoAssinatura = document.getElementById('prazoAssinatura')?.value || null;
            
            if (!alunoId) {
                alert('Selecione um aluno');
                return;
            }
            
            if (!tipoMedida) {
                alert('Selecione o tipo de medida');
                return;
            }
            
            if (tipoMedida === 'Suspens√£o' && !diasSuspensao) {
                alert('Informe o n√∫mero de dias de suspens√£o');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Buscar dados do aluno do Supabase
                const { data: dadosAluno, error: alunoError } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma')
                    .eq('codigo', parseInt(alunoId))
                    .single();
                    
                if (alunoError || !dadosAluno) {
                    throw new Error('Aluno n√£o encontrado');
                }
                
                // Preparar descri√ß√£o da medida
                let especificacao = motivo;
                const faltaEspecifica = document.getElementById('faltaEspecifica')?.value;
                const categoriaMedida = document.getElementById('categoriaMedida')?.value;
                
                // Se uma falta espec√≠fica foi selecionada, usar ela como especifica√ß√£o
                if (faltaEspecifica && faltaEspecifica !== '') {
                    especificacao = faltaEspecifica;
                    
                    // Adicionar categoria nas observa√ß√µes se n√£o estiver preenchida
                    if (categoriaMedida && ['leves', 'medias', 'graves'].includes(categoriaMedida)) {
                        const categoriaTexto = categoriaMedida === 'leves' ? 'LEVE' : 
                                              categoriaMedida === 'medias' ? 'M√âDIA' : 'GRAVE';
                        acoes = `[FALTA ${categoriaTexto}] ${acoes || ''}`;
                    }
                }
                
                // Preparar dados base para salvar
                const dadosBase = {
                    codigo_matricula: dadosAluno.codigo.toString(),
                    nome_completo: dadosAluno['Nome completo'],
                    turma: dadosAluno.turma,
                    data: data,
                    especificacao: especificacao,
                    observacao: acoes,
                    tipo_medida: tipoMedida,
                    criado_em: new Date().toISOString()
                };
                
                // Tentar incluir campos de prazo (se existirem no banco)
                if (prazoAssinatura) {
                    dadosBase.prazo_assinatura = prazoAssinatura;
                    dadosBase.prazo_status = 'pendente';
                }
                
                // Salvar medida diretamente no Supabase
                const { data: result, error: saveError } = await window.supabaseClient
                    .from('medidas')
                    .insert([dadosBase]);
                
                if (saveError) {
                    // Se erro √© por causa das colunas de prazo, tentar sem elas
                    if (saveError.code === '42703' && prazoAssinatura) {
                        console.warn('‚ö†Ô∏è Salvando sem campos de prazo (colunas n√£o existem)');
                        delete dadosBase.prazo_assinatura;
                        delete dadosBase.prazo_status;
                        
                        const { data: result2, error: saveError2 } = await window.supabaseClient
                            .from('medidas')
                            .insert([dadosBase]);
                            
                        if (saveError2) throw saveError2;
                        
                        showMessage('‚ö†Ô∏è Medida salva (prazo ser√° registrado ap√≥s configura√ß√£o do banco)', 'warning');
                    } else {
                        throw saveError;
                    }
                }
                
                // Atualizar nota disciplinar do aluno
                if (typeof window.atualizarNotaDisciplinar === 'function') {
                    await window.atualizarNotaDisciplinar(alunoId, dadosAluno);
                }
                
                // Limpar formul√°rio
                form.reset();
                document.getElementById('campoSuspensao').style.display = 'none';
                document.getElementById('diasSuspensao').required = false;
                document.getElementById('campoCategoriaMedida').style.display = 'none';
                document.getElementById('campoSelecaoFalta').style.display = 'none';
                document.getElementById('campoMotivoOriginal').style.display = 'block';
                
                // Mostrar mensagem de sucesso
                showMessage('‚úÖ Medida disciplinar salva com sucesso!', 'success');
                
                // Recarregar registros recentes
                await carregarRegistrosRecentes();
                
                // Recarregar estat√≠sticas
                await carregarEstatisticasMedidas();
                
                // Recarregar alertas de prazo
                await carregarAlertasPrazo();
                
                // Se a ficha do aluno estiver aberta, recarregar
                if (window.dadosAlunoAtual && window.dadosAlunoAtual.id === alunoId) {
                    await carregarFichaDisciplinar();
                }
                
                // Mostrar nota disciplinar atualizada
                showMessage(`üéØ Medida registrada! Nota disciplinar atualizada.`, 'info');
                
            } catch (error) {
                console.error('Erro ao salvar medida:', error);
                alert('Erro ao salvar medida: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö†Ô∏è Salvar Medida';
            }
        }
        
        // Fun√ß√µes para gerenciar sele√ß√£o de medidas categorizadas
        function configurarCamposMedida() {
            const tipoMedida = document.getElementById('tipoMedida').value;
            const campoCategoria = document.getElementById('campoCategoriaMedida');
            const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
            const campoMotivoOriginal = document.getElementById('campoMotivoOriginal');
            const selectCategoria = document.getElementById('categoriaMedida');
            const selectFalta = document.getElementById('faltaEspecifica');
            const textareaMotivo = document.getElementById('motivoMedida');
            
            // Medidas que requerem sele√ß√£o de falta categorizada
            const medidasComCategoria = [
                'Fato Observado Negativo',
                'Advert√™ncia Verbal', 
                'Advert√™ncia Escrita',
                'Suspens√£o',
                'A√ß√£o Educativa'
            ];
            
            // Medidas positivas que tamb√©m usam sele√ß√£o de categoria
            const medidasPositivas = [
                'Elogio Individual',
                'Elogio Coletivo',
                'Fato Observado Positivo'
            ];
            
            if (medidasComCategoria.includes(tipoMedida)) {
                // Mostrar campos de categoria para medidas disciplinares (M√öLTIPLAS CATEGORIAS)
                if (campoCategoria) campoCategoria.style.display = 'block';
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'block';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'none';
                if (selectCategoria) selectCategoria.required = false; // N√£o usar o select antigo
                if (selectFalta) selectFalta.required = true;
                if (textareaMotivo) {
                    textareaMotivo.required = false;
                    textareaMotivo.removeAttribute('required');
                }
                
                // Esconder o select antigo de categoria (mantendo para compatibilidade)
                if (selectCategoria) {
                    selectCategoria.style.display = 'none';
                }
                
                // Limpar sele√ß√µes m√∫ltiplas anteriores
                limparSelecoesCategorias();
                
            } else if (medidasPositivas.includes(tipoMedida)) {
                // Para medidas positivas, esconder sele√ß√£o de categorias m√∫ltiplas e usar select tradicional
                if (campoCategoria) campoCategoria.style.display = 'none';
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'block';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'none';
                
                // Mostrar select antigo para medidas positivas
                if (selectCategoria) {
                    selectCategoria.style.display = 'block';
                    // Modificar as op√ß√µes para medidas positivas
                    selectCategoria.innerHTML = `
                        <option value="">Selecione a categoria...</option>
                        <option value="comportamento">Comportamento Exemplar</option>
                        <option value="academico">Desempenho Acad√™mico</option>
                        <option value="cidadania">Cidadania e Respeito</option>
                        <option value="lideranca">Lideran√ßa</option>
                    `;
                    selectCategoria.required = false;
                }
                
                if (selectFalta) selectFalta.required = false;
                if (textareaMotivo) {
                    textareaMotivo.required = true;
                    textareaMotivo.setAttribute('required', '');
                }
                
                // Limpar sele√ß√µes m√∫ltiplas
                limparSelecoesCategorias();
                
            } else {
                // Para outras medidas, usar campo de texto tradicional
                if (campoCategoria) campoCategoria.style.display = 'none';
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'none';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'block';
                if (selectCategoria) selectCategoria.required = false;
                if (selectFalta) selectFalta.required = false;
                if (textareaMotivo) {
                    textareaMotivo.required = true;
                    textareaMotivo.setAttribute('required', '');
                }
                
                // Mostrar select normal se estiver escondido
                if (selectCategoria) {
                    selectCategoria.style.display = 'block';
                }
                
                // Limpar sele√ß√µes m√∫ltiplas
                limparSelecoesCategorias();
            }
            
            // Gerenciar campo de suspens√£o
            const campoSuspensao = document.getElementById('campoSuspensao');
            const diasSuspensao = document.getElementById('diasSuspensao');
            
            if (tipoMedida === 'Suspens√£o') {
                campoSuspensao.style.display = 'block';
                diasSuspensao.required = true;
            } else {
                campoSuspensao.style.display = 'none';
                diasSuspensao.required = false;
            }
        }
        
        function carregarFaltasPorCategoria() {
            console.log('üéØ carregarFaltasPorCategoria() chamada');
            const categoria = document.getElementById('categoriaMedida').value;
            const selectFalta = document.getElementById('faltaEspecifica');
            const tipoMedida = document.getElementById('tipoMedida').value;
            const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
            
            if (!categoria) {
                // Limpar sistema de sele√ß√£o m√∫ltipla
                const container = document.getElementById('faltasMultiContainer');
                if (container) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Primeiro selecione uma categoria...</div>';
                }
                faltasSelecionadas = [];
                atualizarTagsFaltas();
                return;
            }
            
            console.log('Tipo de medida:', tipoMedida, 'Categoria:', categoria);
            
            // Mostrar campo de sele√ß√£o
            if (campoSelecaoFalta) {
                campoSelecaoFalta.style.display = 'block';
            }
            
            // Para medidas positivas, usar sistema de sele√ß√£o m√∫ltipla
            if (['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida)) {
                carregarOpcoesPositivas(categoria, tipoMedida);
                return; // Sai da fun√ß√£o aqui para evitar c√≥digo duplicado
            }
            
            // Para medidas disciplinares (negativas), usar sele√ß√£o m√∫ltipla de faltas
            if (['Fato Observado Negativo', 'Advert√™ncia Verbal', 'Advert√™ncia Escrita', 'Suspens√£o', 'A√ß√£o Educativa'].includes(tipoMedida)) {
                carregarFaltasMultiplas(categoria);
                return; // Sai da fun√ß√£o aqui
            }
            
            // C√ìDIGO ORIGINAL PRESERVADO PARA COMPATIBILIDADE:
            if (['Elogio Individual - ORIGINAL', 'Elogio Coletivo - ORIGINAL', 'Fato Observado Positivo - ORIGINAL'].includes(tipoMedida)) {
                let opcoes = '';
                
                if (categoria === 'comportamento') {
                    opcoes = `
                        <option value="Demonstrou excel√™ncia em disciplina e respeito">Demonstrou excel√™ncia em disciplina e respeito</option>
                        <option value="Auxiliou colegas e demonstrou solidariedade">Auxiliou colegas e demonstrou solidariedade</option>
                        <option value="Apresentou-se impecavelmente uniformizado">Apresentou-se impecavelmente uniformizado</option>
                        <option value="Liderou atividades com responsabilidade">Liderou atividades com responsabilidade</option>
                        <option value="Manteve postura exemplar em forma√ß√£o">Manteve postura exemplar em forma√ß√£o</option>
                    `;
                } else if (categoria === 'academico') {
                    opcoes = `
                        <option value="Excelente desempenho em avalia√ß√µes">Excelente desempenho em avalia√ß√µes</option>
                        <option value="Participa√ß√£o ativa e construtiva em aula">Participa√ß√£o ativa e construtiva em aula</option>
                        <option value="Entrega pontual de todas as atividades">Entrega pontual de todas as atividades</option>
                        <option value="Demonstrou evolu√ß√£o significativa no aprendizado">Demonstrou evolu√ß√£o significativa no aprendizado</option>
                    `;
                } else if (categoria === 'cidadania') {
                    opcoes = `
                        <option value="Participou ativamente de a√ß√µes c√≠vicas">Participou ativamente de a√ß√µes c√≠vicas</option>
                        <option value="Demonstrou respeito aos s√≠mbolos nacionais">Demonstrou respeito aos s√≠mbolos nacionais</option>
                        <option value="Promoveu a√ß√µes de cidadania na escola">Promoveu a√ß√µes de cidadania na escola</option>
                        <option value="Colaborou com a manuten√ß√£o do patrim√¥nio escolar">Colaborou com a manuten√ß√£o do patrim√¥nio escolar</option>
                    `;
                }
                
                selectFalta.innerHTML = `
                    <option value="">Selecione o motivo do elogio...</option>
                    ${opcoes}
                    <option value="outro">Outro (especificar nas observa√ß√µes)</option>
                `;
                
            } else {
                // Para medidas disciplinares, usar as faltas categorizadas
                if (window.MEDIDAS_DISCIPLINARES && window.MEDIDAS_DISCIPLINARES[categoria]) {
                    const medidas = window.MEDIDAS_DISCIPLINARES[categoria];
                    
                    selectFalta.innerHTML = `
                        <option value="">Selecione a falta espec√≠fica...</option>
                        ${medidas.map(medida => `<option value="${medida}">${medida}</option>`).join('')}
                    `;
                } else {
                    selectFalta.innerHTML = '<option value="">Erro ao carregar faltas da categoria</option>';
                }
            }
        }

        // Nova fun√ß√£o de inicializa√ß√£o com sistema de loading
        async function inicializarMedidasDisciplinaresComLoading() {
            try {
                // ETAPA 1: Conectar ao banco (20%)
                window.loadingManager.updateProgress(10, 'Conectando ao banco de dados...');
                
                // Verificar se sistema Supabase est√° pronto
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                window.loadingManager.updateProgress(20, 'Conectado ao banco de dados');
                
                // ETAPA 2: Carregar lista de alunos (40%)
                window.loadingManager.updateProgress(25, 'Carregando lista de alunos...');
                
                // Definir data atual no formul√°rio
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) dataMedida.value = hoje;
                
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                window.loadingManager.updateProgress(40, 'Alunos carregados com sucesso');
                
                // ETAPA 3: Calcular estat√≠sticas (60%)
                window.loadingManager.updateProgress(45, 'Calculando estat√≠sticas...');
                await carregarEstatisticasMedidas();
                window.loadingManager.updateProgress(60, 'Estat√≠sticas calculadas');
                
                // ETAPA 4: Carregar registros recentes (80%)
                window.loadingManager.updateProgress(65, 'Carregando registros recentes...');
                await carregarRegistrosRecentes();
                window.loadingManager.updateProgress(80, 'Registros carregados');
                
                // ETAPA 5: Finalizar interface (100%)
                window.loadingManager.updateProgress(85, 'Configurando alertas...');
                
                // Carregar alertas em background
                await carregarAlertasPrazo();
                
                window.loadingManager.updateProgress(95, 'Finalizando interface...');
                
                // Pequena pausa para mostrar conclus√£o
                await new Promise(resolve => setTimeout(resolve, 500));
                
                window.loadingManager.updateProgress(100, 'Sistema carregado com sucesso!');
                
                // Aguardar um pouco antes de esconder
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Esconder loading
                window.loadingManager.hide();
                
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar sistema:', error);
                window.loadingManager.updateProgress(100, 'Erro no carregamento - verifique a conex√£o');
                
                // Esconder loading ap√≥s erro
                setTimeout(() => {
                    window.loadingManager.hide();
                    showMessage('Erro ao carregar sistema. Recarregue a p√°gina.', 'error');
                }, 2000);
            }
        }

        // Fun√ß√£o de inicializa√ß√£o otimizada com carregamento progressivo (ANTIGA - mantida como backup)
        async function inicializarMedidasDisciplinares() {
            try {
                showMessage('Carregando m√≥dulo de medidas...', 'success');
                
                // Definir data atual no formul√°rio de medidas (opera√ß√£o r√°pida)
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) {
                    dataMedida.value = hoje;
                }
                
                // Verificar se sistema Supabase est√° pronto
                if (!window.supabaseClient) {
                    showMessage('‚ö†Ô∏è Supabase n√£o conectado - aguardando...', 'warning');
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                // ETAPA 1: Carregamento essencial (r√°pido)
                showMessage('üìã Carregando interface b√°sica...', 'info');
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                showMessage('‚úÖ Interface pronta! Carregando dados em background...', 'success');
                
                // ETAPA 2: Carregamento em background (n√£o bloqueia)
                setTimeout(async () => {
                    try {
                        // Carregar estat√≠sticas em background
                        await carregarEstatisticasMedidas();
                        
                        // Carregar registros recentes em background
                        await carregarRegistrosRecentes();
                        
                        // Carregar alertas em background
                        // Carregar alertas de prazo
                        await carregarAlertasPrazo();
                        
                        console.log('‚úÖ Carregamento completo finalizado');
                    } catch (error) {
                        console.warn('Erro no carregamento em background:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro ao inicializar medidas:', error);
                showMessage('Erro ao carregar m√≥dulo de medidas', 'error');
            }
        }

        // Carregar alertas
        async function carregarAlertas() {
            const container = document.getElementById('alertasContainer');
            
            try {
                const alertas = [];
                
                // Verificar alunos com muitas medidas
                const limiteMedidas = parseInt(localStorage.getItem('limiteMedidas') || '5');
                
                // Buscar alunos com muitas medidas usando as views
                try {
                    const { data: alunosRisco, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .lt('nota_atual', 7.0); // Alunos com nota baixa
                    
                    if (!error && alunosRisco) {
                        alunosRisco.forEach(aluno => {
                            let tipo = 'warning';
                            let icone = '‚ö†Ô∏è';
                            let texto = '';
                            
                            if (aluno.nota_atual < 5.0) {
                                tipo = 'danger';
                                icone = 'üö®';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota CR√çTICA: ${aluno.nota_atual.toFixed(2)}`;
                            } else if (aluno.nota_atual < 6.0) {
                                tipo = 'warning';
                                icone = '‚ö†Ô∏è';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota BAIXA: ${aluno.nota_atual.toFixed(2)}`;
                            }
                            
                            if (texto) {
                                alertas.push({ tipo, icone, texto, alunoId: aluno.codigo_aluno });
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Erro ao buscar alunos de risco:', error);
                }
                
                // Verificar se h√° medidas registradas hoje
                const hoje = new Date().toISOString().split('T')[0];
                try {
                    if (window.db) {
                        const medidasHoje = await window.db.collection('medidas_disciplinares')
                            .get();
                        
                        let contadorHoje = 0;
                        medidasHoje.forEach(doc => {
                            const data = doc.data();
                            const dataMedida = data.data ? data.data.split('T')[0] : null;
                            if (dataMedida === hoje) {
                                contadorHoje++;
                            }
                        });
                        
                        if (contadorHoje > 5) {
                            alertas.push({
                                tipo: 'info',
                                icone: 'üìä',
                                texto: `${contadorHoje} medidas registradas hoje - dia movimentado`
                            });
                        }
                    }
                } catch (error) {
                    console.log('Erro ao verificar medidas de hoje:', error);
                }
                
                // Exibir alertas
                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-text">‚úÖ Nenhum alerta no momento - situa√ß√£o sob controle</div>
                            <span class="trend-indicator trend-down">üìâ Positivo</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = alertas.map(alerta => `
                        <div class="insight-item" ${alerta.alunoId ? `style="cursor: pointer;" onclick="destacarAluno('${alerta.alunoId}')"` : ''}>
                            <div class="insight-text">${alerta.icone} ${alerta.texto}</div>
                            <span class="trend-indicator trend-${alerta.tipo === 'danger' ? 'up' : alerta.tipo === 'warning' ? 'stable' : 'down'}">
                                ${alerta.tipo === 'danger' ? 'üö® Cr√≠tico' : alerta.tipo === 'warning' ? '‚ö†Ô∏è Aten√ß√£o' : '‚ÑπÔ∏è Info'}
                            </span>
                        </div>
                    `).join('');
                }
                
                console.log(`üö® ${alertas.length} alerta(s) carregado(s)`);
                
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-text">‚ö†Ô∏è Erro ao carregar alertas</div>
                        <span class="trend-indicator trend-up">‚ùå Erro</span>
                    </div>
                `;
            }
        }

        // Sistema de Nota Disciplinar
        // REMOVIDO: Fun√ß√£o calcularNotaDisciplinar
        // Substitu√≠da pelas views v_nota_disciplinar_atual e v_nota_disciplinar_contadores
        
        async function obterNotaDisciplinar(codigoAluno) {
            try {
                // Usar o servi√ßo importado se dispon√≠vel
                if (window.getNotaDisciplinar) {
                    return await window.getNotaDisciplinar(codigoAluno);
                }
                
                // Fallback para implementa√ß√£o direta
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const { data, error } = await window.supabaseClient
                    .from('v_nota_disciplinar_atual')
                    .select('*')
                    .eq('codigo_aluno', codigoAluno)
                    .limit(1);

                if (error) {
                    console.warn('Erro ao obter nota disciplinar:', error);
                    return { data: null, error };
                }

                return { data: data?.[0] || null, error: null };
            } catch (error) {
                console.error('Erro ao consultar nota disciplinar:', error);
                return { data: null, error };
            }
        }
        
        function obterMencaoDisciplinar(nota) {
            if (nota >= 10) return { mencao: 'Excepcional', cor: '#28a745', emoji: '‚≠ê' };
            if (nota >= 9) return { mencao: '√ìtimo', cor: '#17a2b8', emoji: 'üòä' };
            if (nota >= 7) return { mencao: 'Bom', cor: '#ffc107', emoji: 'üôÇ' };
            if (nota >= 5) return { mencao: 'Regular', cor: '#fd7e14', emoji: 'üòê' };
            if (nota >= 2) return { mencao: 'Insuficiente', cor: '#dc3545', emoji: 'üòü' };
            return { mencao: 'Incompat√≠vel', cor: '#6c757d', emoji: 'üò®' };
        }

        // Fun√ß√£o para destacar aluno na busca (placeholder)
        function destacarAluno(alunoId) {
            console.log('Destacando aluno:', alunoId);
            showMessage(`Aluno ${alunoId} selecionado`, 'info');
        }

        // Carregar alertas de prazos de assinatura
        async function carregarAlertasPrazo() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);

                // Buscar medidas com prazo de assinatura pendente
                let medidasComPrazo = [];
                
                try {
                    const { data, error } = await window.supabaseClient
                        .from('medidas')
                        .select('id, codigo_matricula, nome_completo, tipo_medida, especificacao, prazo_assinatura, prazo_status, data')
                        .not('prazo_assinatura', 'is', null)
                        .neq('prazo_status', 'entregue')
                        .order('prazo_assinatura', { ascending: true });

                    if (error) {
                        // Se as colunas n√£o existem, mostrar alerta amig√°vel
                        if (error.code === '42703') {
                            console.warn('‚ö†Ô∏è Colunas de prazo n√£o encontradas no banco. Execute o SQL de cria√ß√£o de colunas.');
                            await atualizarContainerAlertas([{
                                tipo: 'warning',
                                icone: '‚öôÔ∏è',
                                texto: 'Sistema de prazos dispon√≠vel ap√≥s configura√ß√£o do banco de dados',
                                detalhes: 'Execute o SQL fornecido no Supabase Dashboard para ativar o controle de prazos'
                            }]);
                            return;
                        }
                        throw error;
                    }
                    
                    medidasComPrazo = data || [];
                    
                } catch (error) {
                    console.warn('Erro ao buscar prazos:', error);
                    // Mostrar mensagem amig√°vel em caso de erro
                    await atualizarContainerAlertas([{
                        tipo: 'info',
                        icone: '‚ÑπÔ∏è',
                        texto: 'Sistema de alertas de prazo em configura√ß√£o',
                        detalhes: 'As funcionalidades de prazo estar√£o dispon√≠veis ap√≥s a configura√ß√£o do banco'
                    }]);
                    return;
                }

                const alertasPrazo = [];

                // Processar cada medida com prazo
                medidasComPrazo?.forEach(medida => {
                    const dataPrazo = new Date(medida.prazo_assinatura);
                    dataPrazo.setHours(0, 0, 0, 0);
                    
                    const diffTime = dataPrazo - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let statusTexto, statusIcon, prioridade;
                    
                    if (diffDays < 0) {
                        // Vencido
                        statusTexto = `Prazo vencido h√° ${Math.abs(diffDays)} dia(s)`;
                        statusIcon = 'üî¥';
                        prioridade = 'danger';
                    } else if (diffDays === 0) {
                        // Vence hoje
                        statusTexto = 'Prazo vence hoje!';
                        statusIcon = 'üü°';
                        prioridade = 'warning';
                    } else if (diffDays <= 2) {
                        // Vence em 1-2 dias
                        statusTexto = `Prazo em ${diffDays} dia(s)`;
                        statusIcon = 'üü†';
                        prioridade = 'warning';
                    } else {
                        // Em prazo normal
                        statusTexto = `Prazo em ${diffDays} dia(s)`;
                        statusIcon = 'üü¢';
                        prioridade = 'info';
                    }
                    
                    alertasPrazo.push({
                        id: medida.id,
                        tipo: prioridade,
                        icone: statusIcon,
                        texto: `${medida.nome_completo} - ${medida.tipo_medida}: ${statusTexto}`,
                        detalhes: medida.especificacao,
                        diasRestantes: diffDays,
                        alunoId: medida.codigo_matricula,
                        prazoData: medida.prazo_assinatura
                    });
                });

                // Ordenar por prioridade (vencidos primeiro, depois por proximidade)
                alertasPrazo.sort((a, b) => {
                    if (a.diasRestantes < 0 && b.diasRestantes >= 0) return -1;
                    if (b.diasRestantes < 0 && a.diasRestantes >= 0) return 1;
                    return a.diasRestantes - b.diasRestantes;
                });

                // Atualizar container de alertas com os prazos
                await atualizarContainerAlertas(alertasPrazo);

            } catch (error) {
                console.error('Erro ao carregar alertas de prazo:', error);
            }
        }
        
        // Atualizar container de alertas incluindo prazos e outros alertas
        async function atualizarContainerAlertas(alertasPrazo = []) {
            const container = document.getElementById('alertasContainer');
            
            try {
                // Carregar outros alertas existentes (da fun√ß√£o original)
                const outrosAlertas = await obterOutrosAlertas();
                
                // Combinar todos os alertas
                const todosAlertas = [...alertasPrazo, ...outrosAlertas];
                
                if (todosAlertas.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-text">‚úÖ Nenhum alerta no momento - situa√ß√£o sob controle</div>
                            <span class="trend-indicator trend-down">üìâ Positivo</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = todosAlertas.map(alerta => {
                        const botaoEntregue = alerta.id ? 
                            `<button class="btn-marcar-entregue" onclick="marcarPrazoEntregue(${alerta.id})" title="Marcar como entregue">
                                ‚úÖ Entregue
                            </button>` : '';
                        
                        return `
                            <div class="insight-item alerta-prazo" ${alerta.alunoId ? `style="cursor: pointer;" onclick="destacarAluno('${alerta.alunoId}')"` : ''}>
                                <div class="insight-content">
                                    <div class="insight-text">${alerta.icone} ${alerta.texto}</div>
                                    ${alerta.detalhes ? `<div class="insight-detalhes">${alerta.detalhes}</div>` : ''}
                                    ${alerta.prazoData ? `<div class="insight-prazo">Prazo: ${new Date(alerta.prazoData).toLocaleDateString('pt-BR')}</div>` : ''}
                                </div>
                                <div class="insight-actions">
                                    <span class="trend-indicator trend-${alerta.tipo === 'danger' ? 'up' : alerta.tipo === 'warning' ? 'stable' : 'down'}">
                                        ${alerta.tipo === 'danger' ? 'üö® Cr√≠tico' : alerta.tipo === 'warning' ? '‚ö†Ô∏è Aten√ß√£o' : '‚ÑπÔ∏è Info'}
                                    </span>
                                    ${botaoEntregue}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log(`üìã ${todosAlertas.length} alerta(s) carregado(s) (${alertasPrazo.length} de prazos)`);
                
            } catch (error) {
                console.error('Erro ao atualizar container de alertas:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-text">‚ö†Ô∏è Erro ao carregar alertas</div>
                        <span class="trend-indicator trend-up">‚ùå Erro</span>
                    </div>
                `;
            }
        }
        
        // Obter outros alertas (da fun√ß√£o original)
        async function obterOutrosAlertas() {
            const alertas = [];
            
            try {
                // Verificar alunos com nota baixa
                const { data: alunosRisco, error } = await window.supabaseClient
                    .from('v_nota_disciplinar_atual')
                    .select('*')
                    .lt('nota_atual', 7.0)
                    .limit(5);

                if (!error && alunosRisco?.length > 0) {
                    alunosRisco.forEach(aluno => {
                        // Detectar o nome correto (pode variar entre campos)
                        const nomeAluno = aluno.nome_aluno || aluno.nome_completo || aluno['Nome completo'] || 'Nome n√£o encontrado';
                        const turmaAluno = aluno.turma || 'Turma n√£o informada';
                        const codigoAluno = aluno.codigo_aluno || aluno.codigo_matricula || aluno.codigo;
                        
                        alertas.push({
                            tipo: 'warning',
                            icone: '‚ö†Ô∏è',
                            texto: `${nomeAluno} (${turmaAluno}) - Nota disciplinar baixa: ${aluno.nota_atual?.toFixed(1)}`,
                            alunoId: codigoAluno
                        });
                    });
                }
            } catch (error) {
                console.warn('Erro ao obter alertas de nota:', error);
            }
            
            return alertas;
        }
        
        // Marcar prazo como entregue
        async function marcarPrazoEntregue(medidaId) {
            try {
                const { error } = await window.supabaseClient
                    .from('medidas')
                    .update({ 
                        prazo_status: 'entregue',
                        prazo_entregue_em: new Date().toISOString()
                    })
                    .eq('id', medidaId);

                if (error) throw error;

                showMessage('‚úÖ Prazo marcado como entregue!', 'success');
                
                // Recarregar alertas
                await carregarAlertasPrazo();
                
            } catch (error) {
                console.error('Erro ao marcar prazo como entregue:', error);
                alert('Erro ao marcar prazo como entregue: ' + error.message);
            }
        }

        // Carregar estat√≠sticas de medidas disciplinares
        async function carregarEstatisticasMedidas() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                
                // Carregar todas as medidas
                const { data: todasMedidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('id, codigo_matricula, criado_em');
                
                if (error) throw error;
                
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay()); // In√≠cio da semana (domingo)
                
                // Calcular estat√≠sticas
                const totalMedidas = todasMedidas.length;
                
                const medidasMes = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioMes;
                }).length;
                
                const medidasSemana = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioSemana;
                }).length;
                
                // Contar alunos √∫nicos com medidas
                const alunosUnicos = new Set(todasMedidas.map(medida => medida.codigo_matricula));
                const alunosAfetados = alunosUnicos.size;
                
                // Calcular m√©dia de nota disciplinar da escola
                let mediaNotaEscola = 8.0;
                try {
                    // Buscar todos os alunos
                    const { data: todosAlunos } = await window.supabaseClient
                        .from('alunos')
                        .select('codigo');
                    
                    if (todosAlunos && todosAlunos.length > 0) {
                        let somaNotas = 0;
                        const totalAlunos = todosAlunos.length;
                        
                        // Agrupar medidas por aluno
                        const medidasPorAluno = {};
                        todasMedidas.forEach(medida => {
                            if (!medidasPorAluno[medida.codigo_matricula]) {
                                medidasPorAluno[medida.codigo_matricula] = [];
                            }
                            medidasPorAluno[medida.codigo_matricula].push(medida);
                        });
                        
                        // Otimiza√ß√£o: Buscar todas as notas de uma vez usando a view
                        try {
                            const { data: todasNotas, error: notasError } = await window.supabaseClient
                                .from('v_nota_disciplinar_atual')
                                .select('codigo_aluno, nota_atual');
                            
                            if (!notasError && todasNotas) {
                                // Criar mapa de notas por aluno
                                const notasPorAluno = {};
                                todasNotas.forEach(nota => {
                                    notasPorAluno[nota.codigo_aluno] = nota.nota_atual;
                                });
                                
                                // Somar notas de todos os alunos
                                todosAlunos.forEach(aluno => {
                                    const notaAluno = notasPorAluno[aluno.codigo] || 8.0;
                                    somaNotas += parseFloat(notaAluno) || 8.0;
                                });
                                
                            } else {
                                console.warn('Usando fallback para c√°lculo de notas:', notasError);
                                // Fallback: todos com nota 8.0
                                somaNotas = todosAlunos.length * 8.0;
                            }
                        } catch (viewError) {
                            console.warn('Erro ao buscar notas via view, usando fallback:', viewError);
                            // Fallback: todos com nota 8.0
                            somaNotas = todosAlunos.length * 8.0;
                        }
                        
                        mediaNotaEscola = (somaNotas / totalAlunos).toFixed(2);
                    }
                } catch (error) {
                    console.error('Erro ao calcular m√©dia da escola:', error);
                }
                
                // Atualizar interface
                document.getElementById('totalMedidas').textContent = totalMedidas;
                document.getElementById('medidasMes').textContent = medidasMes;
                document.getElementById('medidasSemana').textContent = medidasSemana;
                document.getElementById('alunosAfetados').textContent = alunosAfetados;
                document.getElementById('mediaNotaEscola').textContent = mediaNotaEscola;
                
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
                // Valores padr√£o em caso de erro
                document.getElementById('totalMedidas').textContent = '0';
                document.getElementById('medidasMes').textContent = '0';
                document.getElementById('medidasSemana').textContent = '0';
                document.getElementById('alunosAfetados').textContent = '0';
                document.getElementById('mediaNotaEscola').textContent = '8.00';
            }
        }

        // Carregar registros recentes de medidas
        async function carregarRegistrosRecentes() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                console.log('üìã Carregando registros recentes...');
                
                // Carregar √∫ltimas 5 medidas
                const { data: medidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .order('criado_em', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                const container = document.getElementById('registrosRecentes');
                
                if (!medidas || medidas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>Nenhuma medida encontrada</h3>
                            <p>As medidas disciplinares registradas aparecer√£o aqui</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="records-list">';
                medidas.forEach(medida => {
                    const dataFormatada = new Date(medida.criado_em).toLocaleDateString('pt-BR');
                    const horaFormatada = new Date(medida.criado_em).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <div class="record-item">
                            <div class="record-header">
                                <span class="record-student">${medida.nome_completo}</span>
                                <span class="record-date">${dataFormatada} √†s ${horaFormatada}</span>
                            </div>
                            <div class="record-details">
                                <span class="record-type">${medida.tipo_medida}</span>
                                <span class="record-turma">Turma: ${medida.turma}</span>
                            </div>
                            <div class="record-description">${medida.especificacao || 'Sem descri√ß√£o'}</div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                console.log(`üìã ${medidas.length} registros recentes carregados`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar registros recentes:', error);
                const container = document.getElementById('registrosRecentes');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ùå</div>
                        <h3>Erro ao carregar registros</h3>
                        <p>Tente recarregar a p√°gina</p>
                    </div>
                `;
            }
        }
        
        // Tornar fun√ß√£o dispon√≠vel globalmente
        window.carregarRegistrosRecentes = carregarRegistrosRecentes;

        // Carregar dados de demonstra√ß√£o
        function carregarDadosDemoMedidas() {
            document.getElementById('registrosRecentes').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h3>Nenhum registro encontrado</h3>
                    <p>Sistema configurado para come√ßar a registrar faltas e medidas</p>
                </div>
            `;

            document.getElementById('alertasContainer').innerHTML = `
                <div class="insight-item">
                    <div class="insight-text">üìä Sistema configurado para ver alertas reais</div>
                    <span class="trend-indicator trend-down">‚ÑπÔ∏è Info</span>
                </div>
            `;
        }

        // ======= FUN√á√ïES DE FILTROS DIN√ÇMICOS =======
        
        let todosAlunosMedidas = [];
        let todasTurmasMedidas = [];
        
        // Tornar vari√°veis dispon√≠veis globalmente
        window.todosAlunosMedidas = todosAlunosMedidas;
        window.todasTurmasMedidas = todasTurmasMedidas;
        
        async function carregarTurmasEAlunos() {
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                    
                todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;
                
                // Carregar diretamente do Supabase
                const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma');
                    
                if (error) throw error;
                
                alunosData.forEach(aluno => {
                    if (aluno['Nome completo'] && aluno.turma) {
                        todosAlunosMedidas.push({
                            id: aluno.codigo,
                            codigo: aluno.codigo,
                            nome: aluno['Nome completo'],
                            turma: aluno.turma,
                            foto_url: aluno.foto_url
                        });
                    }
                });
                
                
                /* C√ìDIGO ANTIGO COMENTADO
                try {
                        const response = await fetch('../data/db.json');
                        const dbData = await response.json();
                        if (dbData.alunos) {
                            console.log('FREQ: Carregando alunos do arquivo db.json');
                            todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;
                            
                            // Converter objeto em array
                            Object.keys(dbData.alunos).forEach(alunoId => {
                                const aluno = dbData.alunos[alunoId];
                                if (aluno.nome_completo && aluno.turma) {
                                    todosAlunosMedidas.push({
                                        id: aluno.id || alunoId,
                                        codigo: aluno.codigo || alunoId,
                                        nome: aluno.nome_completo,
                                        turma: aluno.turma
                                    });
                                }
                            });
                            
                            console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos');
                            console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                        }
                    } catch (fileError) {
                        console.error('Erro ao carregar do arquivo:', fileError);
                        return;
                    }
                } else {
                    console.log('FREQ: Carregando alunos do localDb');
                    todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;
                    
                    // Carregar alunos do localDb
                    // USAR SISTEMA H√çBRIDO em vez de localDb diretamente
                    const alunosSnapshot = await window.db.collection('alunos').get();
                    alunosSnapshot.docs.forEach(doc => {
                        const aluno = doc.data();
                        if (aluno.nome_completo && aluno.turma) {
                            todosAlunosMedidas.push({
                                id: aluno.id || doc.id,
                                codigo: aluno.codigo || doc.id,
                                nome: aluno.nome_completo,
                                turma: aluno.turma
                            });
                        }
                    });
                    
                    console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos do localDb');
                    console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                }
                */ // Fim do c√≥digo antigo comentado
                
                // Extrair turmas √∫nicas
                todasTurmasMedidas = [...new Set(todosAlunosMedidas.map(a => a.turma))].sort();
                window.todasTurmasMedidas = todasTurmasMedidas;
                
                // Carregar turmas no select
                const selectTurma = document.getElementById('turmaConsulta');
                if (selectTurma) {
                    const valorAtual = selectTurma.value; // Preservar sele√ß√£o atual
                    selectTurma.innerHTML = '<option value="">Selecione uma turma...</option>';
                    todasTurmasMedidas.forEach(turma => {
                        const selected = valorAtual === turma ? 'selected' : '';
                        selectTurma.innerHTML += `<option value="${turma}" ${selected}>Turma ${turma}</option>`;
                    });
                    
                } else {
                    console.error('‚ùå [TURMAS] Elemento turmaConsulta n√£o encontrado');
                }
                
                console.log(`‚úÖ Carregados: ${todasTurmasMedidas.length} turmas, ${todosAlunosMedidas.length} alunos`);
                
            } catch (error) {
                console.error('Erro ao carregar turmas e alunos:', error);
            }
        }
        
        // Tornar fun√ß√£o dispon√≠vel globalmente
        window.carregarTurmasEAlunos = carregarTurmasEAlunos;
        
        // Fun√ß√£o separada para configurar evento de turma (evita conflitos)
        function configurarEventoTurma() {
            console.log('‚öôÔ∏è [CONFIG] Configurando evento de sele√ß√£o de turma...');
            const selectTurma = document.getElementById('turmaConsulta');
            if (!selectTurma) {
                console.error('‚ùå [CONFIG] Select de turma n√£o encontrado');
                return;
            }
            
            // Remover todos os listeners antigos
            const novoSelect = selectTurma.cloneNode(true);
            selectTurma.parentNode.replaceChild(novoSelect, selectTurma);
            
            // Adicionar evento ao novo select
            novoSelect.addEventListener('change', function() {
                console.log('üî• [CONFIG-EVENT] Turma selecionada:', this.value);
                carregarAlunosPorTurma();
            });
            
            console.log('‚úÖ [CONFIG] Evento configurado com sucesso');
        }
        
        function carregarAlunosPorTurma() {
            console.log('üîç [CONSULTA] ========== INICIANDO carregarAlunosPorTurma ==========');
            const selectTurma = document.getElementById('turmaConsulta');
            const selectAluno = document.getElementById('alunoConsulta');
            
            if (!selectTurma || !selectAluno) {
                console.error('‚ùå [CONSULTA] Elementos select n√£o encontrados:', {
                    selectTurma: !!selectTurma,
                    selectAluno: !!selectAluno
                });
                return;
            }
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar sele√ß√£o atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            if (!todosAlunosMedidas || todosAlunosMedidas.length === 0) {
                selectAluno.innerHTML = '<option value="">‚ùå Dados de alunos n√£o carregados</option>';
                selectAluno.disabled = true;
                carregarTurmasEAlunos().then(() => {
                    carregarAlunosPorTurma();
                });
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = todosAlunosMedidas.filter(aluno => aluno.turma === turmaSelecionada);
            console.log(`üîç [CONSULTA] Alunos encontrados na turma ${turmaSelecionada}:`, alunosDaTurma.length);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                // Usar o ID interno do aluno (que ser√° convertido para c√≥digo depois)
                selectAluno.innerHTML += `<option value="${aluno.id}" data-codigo="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
            console.log(`‚úÖ [CONSULTA] Carregados ${alunosDaTurma.length} alunos da turma ${turmaSelecionada}`);
            console.log('üèÅ [CONSULTA] ========== FIM carregarAlunosPorTurma ==========');
        }
        
        // Fun√ß√£o simplificada que s√≥ carrega alunos (sem recarregar dados)
        function carregarAlunosPorTurmaSimples() {
            const selectTurma = document.getElementById('turmaConsulta');
            const selectAluno = document.getElementById('alunoConsulta');
            
            if (!selectTurma || !selectAluno) {
                return;
            }
            
            const turmaSelecionada = selectTurma.value;
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                habilitarBotaoPesquisa();
                return;
            }
            
            // Verificar se dados est√£o dispon√≠veis
            if (!todosAlunosMedidas || todosAlunosMedidas.length === 0) {
                carregarTurmasEAlunos(); // S√≥ se necess√°rio
                return;
            }
            
            // Filtrar alunos da turma selecionada
            const alunosDaTurma = todosAlunosMedidas.filter(aluno => 
                aluno.turma && aluno.turma.toString() === turmaSelecionada.toString()
            );
            
            if (alunosDaTurma.length === 0) {
                selectAluno.innerHTML = '<option value="">Nenhum aluno encontrado nesta turma</option>';
            } else {
                selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
                alunosDaTurma
                    .sort((a, b) => a.nome.localeCompare(b.nome))
                    .forEach(aluno => {
                        selectAluno.innerHTML += `<option value="${aluno.id}">${aluno.nome}</option>`;
                    });
            }
            
            habilitarBotaoPesquisa();
        }
        
        // Fun√ß√£o para habilitar bot√£o de pesquisa quando aluno for selecionado
        function habilitarBotaoPesquisa() {
            const selectAluno = document.getElementById('alunoConsulta');
            const btnPesquisar = document.getElementById('btnPesquisarFicha');
            const btnExportar = document.getElementById('btnExportarPDF');
            
            if (selectAluno.value) {
                btnPesquisar.disabled = false;
                console.log('‚úÖ [CONSULTA] Bot√£o de pesquisa habilitado para aluno:', selectAluno.value);
            } else {
                btnPesquisar.disabled = true;
                btnExportar.disabled = true;
                // Esconder ficha se nenhum aluno selecionado
                document.getElementById('fichaAluno').style.display = 'none';
                console.log('‚ö†Ô∏è [CONSULTA] Bot√£o de pesquisa desabilitado - nenhum aluno selecionado');
            }
        }
        
        // ======= FUN√á√ÉO DE CARREGAMENTO DA FICHA DISCIPLINAR =======
        
        async function carregarFichaDisciplinar() {
            // Mostrar loading r√°pido para ficha
            if (window.loadingManager && !window.loadingManager.isVisible) {
                window.loadingManager.show('Carregando Ficha', 'Buscando dados do aluno...');
                window.loadingManager.updateProgress(30, 'Carregando dados do aluno...');
            }
            try {
                const selectAluno = document.getElementById('alunoConsulta');
                const fichaContainer = document.getElementById('fichaAluno');
                const btnExportar = document.getElementById('btnExportarPDF');
                
                
                if (!selectAluno.value) {
                    fichaContainer.style.display = 'none';
                    btnExportar.disabled = true;
                    return;
                }
                
                showMessage('üîÑ Carregando ficha disciplinar...', 'loading');
                
                // Carregar dados do aluno dos dados locais
                let alunoData = null;
                
                // Tentar encontrar o aluno nos dados globais
                if (window.alunosCarregados && window.alunosCarregados.length > 0) {
                    alunoData = window.alunosCarregados.find(aluno => aluno.id === selectAluno.value);
                }
                
                // Se n√£o encontrou nos dados globais, buscar dos dados locais do select
                if (!alunoData) {
                    // Buscar nos dados locais carregados para o select
                    const alunoEncontrado = todosAlunosMedidas.find(aluno => 
                        aluno.codigo === selectAluno.value || aluno.id === selectAluno.value
                    );
                    
                    if (alunoEncontrado) {
                        alunoData = alunoEncontrado;
                    } else {
                        
                        // Tentar buscar turma e foto dos dados de medidas se dispon√≠vel
                        let turmaAluno = 'N/A';
                        let fotoAluno = null;
                        if (window.alunosMedidasGlobal) {
                            const alunoComDados = window.alunosMedidasGlobal.find(a => a.codigo == selectAluno.value || a.id == selectAluno.value);
                            if (alunoComDados) {
                                turmaAluno = alunoComDados.turma || 'N/A';
                                fotoAluno = alunoComDados.foto_url;
                            }
                        }
                        
                        alunoData = {
                            id: selectAluno.value,
                            nome: selectAluno.options[selectAluno.selectedIndex]?.text || 'Aluno n√£o identificado',
                            codigo: selectAluno.value,
                            turma: turmaAluno,
                            foto_url: fotoAluno
                        };
                    }
                }
                
                // Se ainda n√£o temos turma ou foto, tentar buscar do Supabase
                if (!alunoData.turma || alunoData.turma === 'N/A' || !alunoData.foto_url) {
                    try {
                        const { data: dadosSupabase, error } = await window.supabaseClient
                            .from('alunos')
                            .select('*')
                            .eq('codigo', parseInt(selectAluno.value))
                            .single();
                            
                        if (!error && dadosSupabase) {
                            alunoData.turma = dadosSupabase.turma || 'N/A';
                            alunoData.nome_completo = dadosSupabase['Nome completo'] || alunoData.nome;
                            // Verificar m√∫ltiplos campos poss√≠veis para foto
                            alunoData.foto_url = dadosSupabase.foto_url || dadosSupabase.foto_base64 || dadosSupabase.foto;
                        }
                    } catch (error) {
                        console.warn('FICHA: N√£o foi poss√≠vel buscar dados do Supabase:', error);
                    }
                }
                
                
                // Carregar medidas disciplinares do aluno (usar dados locais se dispon√≠vel)
                let medidas = [];
                
                try {
                    // Aguardar supabaseClient estar dispon√≠vel
                    if (!window.supabaseClient) {
                        await new Promise(resolve => {
                            const check = setInterval(() => {
                                if (window.supabaseClient) {
                                    clearInterval(check);
                                    resolve();
                                }
                            }, 100);
                        });
                    }
                    
                    const { data: medidasData, error } = await window.supabaseClient
                        .from('medidas')
                        .select('*')
                        .eq('codigo_matricula', selectAluno.value)
                        .order('criado_em', { ascending: false });
                        
                    if (error) throw error;
                    
                    
                    if (medidasData) {
                        medidasData.forEach(item => {
                            const medidaData = {
                                id: item.id,
                                codigo_aluno: item.codigo_matricula,
                                nome_aluno: item.nome_completo,
                                turma: item.turma,
                                data: item.data,
                                especificacao: item.especificacao,
                                observacao: item.observacao,
                                tipo_medida: item.tipo_medida,
                                data_registro: item.criado_em
                            };
                            medidas.push(medidaData);
                        });
                    }
                } catch (supaError) {
                    console.log('FICHA: Erro ao carregar medidas do Supabase:', supaError.message);
                }
                
                /* EXPLICA√á√ÉO DEBUG: Este bloco √© necess√°rio para diagnosticar problemas de conectividade 
                 * com o Supabase e verificar a estrutura de dados da tabela 'medidas'.
                 * √ötil para: 1) Confirmar conex√£o com banco, 2) Verificar campos dispon√≠veis,
                 * 3) Identificar discrep√¢ncias nos dados. Pode ser mantido em produ√ß√£o 
                 * pois s√≥ executa quando h√° problemas de carregamento de dados. */
                try {
                    const { data: todasMedidas, error: debugError } = await window.supabaseClient
                        .from('medidas')
                        .select('id, codigo_matricula, nome_completo');
                        
                    if (!debugError && todasMedidas) {
                    }
                } catch (debugError) {
                    // Debug removido
                }
                
                
                // Atualizar progresso antes de exibir
                if (window.loadingManager && window.loadingManager.isVisible) {
                    window.loadingManager.updateProgress(80, 'Processando dados...');
                }
                
                // Exibir ficha completa
                await exibirFichaDisciplinar(alunoData, medidas);
                
                // Finalizar loading
                if (window.loadingManager && window.loadingManager.isVisible) {
                    window.loadingManager.updateProgress(100, 'Ficha carregada!');
                    setTimeout(() => window.loadingManager.hide(), 500);
                }
                
                fichaContainer.style.display = 'block';
                btnExportar.disabled = false;
                
                showMessage('‚úÖ Ficha disciplinar carregada com sucesso!', 'success');
                
            } catch (error) {
                console.error('FICHA: ERRO CAPTURADO na funcao carregarFichaDisciplinar:', error);
                console.error('FICHA: Stack trace:', error.stack);
                
                // Esconder loading em caso de erro
                if (window.loadingManager && window.loadingManager.isVisible) {
                    window.loadingManager.updateProgress(100, 'Erro ao carregar ficha');
                    setTimeout(() => window.loadingManager.hide(), 1000);
                }
                showMessage('‚ùå Erro ao carregar ficha disciplinar: ' + error.message, 'error');
                const fichaContainer = document.getElementById('fichaAluno');
                const btnExportar = document.getElementById('btnExportarPDF');
                if (fichaContainer) fichaContainer.style.display = 'none';
                if (btnExportar) btnExportar.disabled = true;
            }
        }
        
        
        
        // Fun√ß√£o para excluir medida disciplinar
        async function excluirMedida(medidaId, botao) {
            // Primeira confirma√ß√£o
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir esta medida disciplinar?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            // Segunda confirma√ß√£o mais espec√≠fica
            if (!confirm('üö® CONFIRMA√á√ÉO FINAL:\n\nVoc√™ est√° prestes a EXCLUIR PERMANENTEMENTE esta medida disciplinar do sistema.\n\nEsta opera√ß√£o:\n‚Ä¢ Remove a medida do Supabase\n‚Ä¢ Afeta o c√°lculo da nota disciplinar\n‚Ä¢ N√ÉO pode ser desfeita\n\nDeseja realmente continuar?')) {
                return;
            }
            
            try {
                botao.disabled = true;
                botao.style.opacity = '0.5';
                botao.textContent = '‚è≥';
                
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                console.log('üóëÔ∏è Excluindo medida ID:', medidaId);
                
                // Excluir do Supabase
                const { error } = await window.supabaseClient
                    .from('medidas')
                    .delete()
                    .eq('id', medidaId);
                
                if (error) throw error;
                
                // Remover o item da interface
                const medidaItem = document.querySelector(`[data-medida-id="${medidaId}"]`);
                if (medidaItem) {
                    medidaItem.style.transition = 'all 0.3s ease';
                    medidaItem.style.opacity = '0';
                    medidaItem.style.transform = 'translateX(-100%)';
                    
                    setTimeout(() => {
                        medidaItem.remove();
                        
                        // Verificar se ainda h√° medidas
                        const medidasRestantes = document.querySelectorAll('.medida-item');
                        if (medidasRestantes.length === 0) {
                            document.getElementById('historicoMedidas').innerHTML = `
                                <div class="info-box info-success">
                                    <h4>‚úÖ Comportamento exemplar!</h4>
                                    <p>Este aluno n√£o possui medidas disciplinares registradas</p>
                                </div>
                            `;
                        }
                    }, 300);
                }
                
                showMessage('‚úÖ Medida disciplinar exclu√≠da com sucesso!', 'success');
                
                // Recarregar estat√≠sticas
                await carregarEstatisticasMedidas();
                
                console.log('‚úÖ Medida exclu√≠da com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir medida:', error);
                showMessage('‚ùå Erro ao excluir medida: ' + error.message, 'error');
                
                // Restaurar bot√£o em caso de erro
                botao.disabled = false;
                botao.style.opacity = '0.7';
                botao.textContent = 'üóëÔ∏è';
            }
        }

        async function exibirFichaDisciplinar(aluno, medidas) {
            /* EXPLICA√á√ÉO DEBUG FOTO: Logs essenciais para diagnosticar problemas na funcionalidade 
             * de fotos 3x4 dos alunos. Identifica: 1) Estrutura de dados recebidos,
             * 2) Exist√™ncia e tipo do campo foto_url, 3) Diferen√ßas entre cache e banco,
             * 4) Problemas de parsing/convers√£o. Recomendado manter para suporte t√©cnico. */
            
            // Verifica√ß√£o cruzada com banco para diagn√≥stico
            if (window.supabaseClient && aluno.codigo) {
                try {
                    const { data: fotoCheck, error } = await window.supabaseClient
                        .from('alunos')
                        .select('codigo, "Nome completo"')
                        .eq('codigo', parseInt(aluno.codigo))
                        .single();
                    // Debug tempor√°rio removido
                } catch (e) {
                    // Debug tempor√°rio removido
                }
            }
            
            // Dados pessoais com foto
            const fotoHtml = aluno.foto_url ? 
                `<div class="dado-item" style="grid-column: 1; grid-row: 1 / span 3; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px;">
                    <span class="dado-label" style="margin-bottom: 10px;">Foto 3x4:</span>
                    <img src="${aluno.foto_url}" alt="Foto do aluno" style="width: 120px; height: 160px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" />
                </div>` : 
                `<div class="dado-item" style="grid-column: 1; grid-row: 1 / span 3; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; background: #f0f0f0; color: #999;">
                    <span class="dado-label" style="margin-bottom: 10px;">Foto 3x4:</span>
                    <div style="width: 120px; height: 160px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ddd; border-radius: 8px; font-size: 14px; text-align: center;">Sem foto</div>
                </div>`;
            
            document.getElementById('dadosPessoais').innerHTML = `
                <div class="dados-grid" style="grid-template-columns: 200px 1fr 1fr; gap: 20px;">
                    ${fotoHtml}
                    <div class="dado-item">
                        <span class="dado-label">Nome:</span>
                        <span class="dado-valor">${aluno.nome_completo || aluno.nome || 'N/A'}</span>
                    </div>
                    <div class="dado-item">
                        <span class="dado-label">C√≥digo:</span>
                        <span class="dado-valor">${aluno.codigo || aluno.id || 'N/A'}</span>
                    </div>
                    <div class="dado-item">
                        <span class="dado-label">Turma:</span>
                        <span class="dado-valor">${aluno.turma || aluno.Turma || 'N/A'}</span>
                    </div>
                    <div class="dado-item">
                        <span class="dado-label">Respons√°vel:</span>
                        <span class="dado-valor">${aluno.responsavel || aluno['respons√°vel'] || 'N/A'}</span>
                    </div>
                    <div class="dado-item">
                        <span class="dado-label">Status:</span>
                        <span class="dado-valor">${aluno.status || 'Ativo'}</span>
                    </div>
                </div>
            `;
            
            
            // Dados de frequ√™ncia escolar
            await exibirFrequenciaEscolar(aluno);
            
            // Hist√≥rico de medidas disciplinares
            exibirHistoricoMedidas(medidas);
            
            // Resumo estat√≠stico
            await exibirResumoEstatistico(aluno, medidas);
        }
        
        // Fun√ß√£o para exibir dados de frequ√™ncia escolar
        async function exibirFrequenciaEscolar(aluno) {
            const container = document.getElementById('frequenciaEscolar');
            const codigoAluno = aluno.codigo || aluno.id || aluno.codigo_matricula;
            
            try {
                // Obter dados de frequ√™ncia em paralelo
                const [resumoResult, faltasResult, mensalResult] = await Promise.all([
                    window.getResumoAcumuladoAluno(codigoAluno),
                    window.getFaltasAluno(codigoAluno), // TODAS as faltas (sem limite)
                    window.getResumoMensalAtualAluno(codigoAluno)
                ]);
                
                const resumoAcumulado = resumoResult.data;
                const faltas = faltasResult.data || [];
                const resumoMensal = mensalResult.data;
                
                // Determinar classe de presen√ßa para estilo
                let classePresenca = 'presenca-regular';
                if (resumoAcumulado?.pct_presenca_operacional) {
                    const pct = resumoAcumulado.pct_presenca_operacional;
                    if (pct >= 95) classePresenca = 'presenca-excelente';
                    else if (pct >= 85) classePresenca = 'presenca-boa';
                    else if (pct >= 75) classePresenca = 'presenca-regular';
                    else classePresenca = 'presenca-baixa';
                }
                
                // Gerar HTML da se√ß√£o de frequ√™ncia
                container.innerHTML = `
                    <div class="frequencia-grid">
                        <!-- Card de Presen√ßa Acumulada -->
                        <div class="frequencia-card ${classePresenca}">
                            <div class="frequencia-card-title">
                                üìä Presen√ßa Acumulada
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoAcumulado.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.getDescricaoPresenca(resumoAcumulado.pct_presenca_operacional) : 
                                    'Dados n√£o dispon√≠veis'
                                }
                            </div>
                            ${resumoAcumulado ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoAcumulado.presencas || 0}P + ${resumoAcumulado.atestados || 0}A + ${resumoAcumulado.faltas || 0}F = ${resumoAcumulado.total_aulas || 0} aulas
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Card do Resumo Mensal -->
                        <div class="frequencia-card">
                            <div class="frequencia-card-title">
                                üìÖ M√™s Atual
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoMensal.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarMesAno(resumoMensal.mes) : 
                                    'Dados n√£o dispon√≠veis'
                                }
                            </div>
                            ${resumoMensal ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoMensal.presencas || 0}P + ${resumoMensal.atestados || 0}A + ${resumoMensal.faltas || 0}F
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Faltas Registradas -->
                    <div class="faltas-recentes">
                        <div class="faltas-recentes-title">
                            üìã Faltas Registradas
                        </div>
                        ${faltas.length > 0 ? 
                            `<div class="faltas-datas" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                ${faltas.map(falta => `
                                    <span class="falta-data-chip" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 4px 8px; font-size: 0.85em; color: #495057;">
                                        ${window.FrequenciaUtils.formatarData(falta.data)}
                                    </span>
                                `).join('')}
                            </div>` :
                            `<div class="sem-faltas" style="color: #28a745; font-size: 0.9em; margin-top: 8px;">
                                ‚úÖ Nenhuma falta registrada
                            </div>`
                        }
                    </div>
                `;
                
                
            } catch (error) {
                console.error('‚ùå Erro ao exibir frequ√™ncia:', error);
                
                // Fallback em caso de erro
                container.innerHTML = `
                    <div class="frequencia-card">
                        <div class="frequencia-card-title">
                            ‚ö†Ô∏è Erro ao Carregar
                        </div>
                        <div class="frequencia-card-subtitle" style="color: #dc3545;">
                            N√£o foi poss√≠vel carregar os dados de frequ√™ncia.
                            Tente novamente mais tarde.
                        </div>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o para mostrar todas as faltas de um aluno
        async function verTodasFaltas(codigoAluno) {
            try {
                const { data: todasFaltas } = await window.getFaltasAluno(codigoAluno, 50);
                
                if (!todasFaltas || todasFaltas.length === 0) {
                    alert('Nenhuma falta encontrada para este aluno.');
                    return;
                }
                
                // Criar modal ou popup com todas as faltas
                const faltasHTML = todasFaltas.map(falta => 
                    `${window.FrequenciaUtils.formatarData(falta.data)} - ${falta.turma || 'N/A'}`
                ).join('\n');
                
                alert(`Todas as faltas do aluno:\n\n${faltasHTML}`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar todas as faltas:', error);
                alert('Erro ao carregar faltas. Tente novamente.');
            }
        }
        
        
        // Fun√ß√£o para calcular pontos de uma medida (apenas para exibi√ß√£o)
        // NOTA: C√°lculos oficiais s√£o feitos nas views do Postgres
        function calcularPontosMedidaExibicao(tipoMedida, diasSuspensao = 1) {
            let pontos = 0;
            
            // Medidas positivas
            if (tipoMedida === 'Elogio Individual') pontos = 0.5;
            else if (tipoMedida === 'Elogio Coletivo') pontos = 0.3;
            else if (tipoMedida === 'Fato Observado Positivo') pontos = 0.1;
            
            // Medidas negativas
            else if (tipoMedida === 'Fato Observado Negativo') pontos = -0.1;
            else if (tipoMedida === 'Advert√™ncia Verbal' || tipoMedida === 'Advert√™ncia Escrita' || tipoMedida === 'Advert√™ncia') pontos = -0.3;
            else if (tipoMedida === 'Suspens√£o') {
                pontos = -0.5 * diasSuspensao;
            }
            else if (tipoMedida === 'A√ß√£o Educativa') pontos = -1.0;
            
            return pontos;
        }

        // Fun√ß√£o para verificar se √© medida positiva
        function isMedidaPositiva(tipoMedida) {
            return ['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida);
        }

        function exibirHistoricoMedidas(medidas) {
            const container = document.getElementById('historicoMedidas');
            
            if (!medidas || medidas.length === 0) {
                container.innerHTML = `
                    <div class="info-box info-success">
                        <h4>‚úÖ Comportamento exemplar!</h4>
                        <p>Este aluno n√£o possui medidas disciplinares registradas</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar medidas por data (mais recentes primeiro)
            medidas.sort((a, b) => new Date(b.data_registro) - new Date(a.data_registro));
            
            let html = `
                <div class="medidas-resumo">
                    <div class="resumo-item resumo-warning">
                        <span class="resumo-numero">${medidas.length}</span>
                        <span class="resumo-label">Total de Medidas</span>
                    </div>
                </div>
                
                <div class="medidas-timeline">
            `;
            
            medidas.forEach(medida => {
                const dataFormatada = new Date(medida.data_registro).toLocaleDateString('pt-BR');
                const tipoMedida = medida.tipo_medida || 'N/A';
                const diasSuspensao = medida.dias_suspensao || 1;
                const pontos = calcularPontosMedidaExibicao(tipoMedida, diasSuspensao);
                const isPositiva = isMedidaPositiva(tipoMedida);
                
                // Debug para verificar pontos
                
                // Formatar exibi√ß√£o dos pontos
                let pontosTexto = '';
                if (pontos > 0) {
                    pontosTexto = `<span class="medida-pontos positivos">+${pontos}</span>`;
                } else if (pontos < 0) {
                    pontosTexto = `<span class="medida-pontos negativos">${pontos}</span>`;
                } else if (pontos === 0) {
                    pontosTexto = `<span class="medida-pontos" style="background:#ffeaa7; color:#d63031;">‚ö†Ô∏è 0</span>`;
                }
                
                html += `
                    <div class="medida-item ${isPositiva ? 'positiva' : ''}" data-medida-id="${medida.id}">
                        <div class="medida-data">${dataFormatada}</div>
                        <div class="medida-content">
                            <div class="medida-tipo">
                                ${tipoMedida}
                                ${pontosTexto}
                            </div>
                            <div class="medida-descricao">
                                <strong>Especifica√ß√£o:</strong> ${medida.especificacao || 'N/A'}
                            </div>
                            ${medida.observacao ? `<div class="medida-providencias"><strong>Observa√ß√µes:</strong> ${medida.observacao}</div>` : ''}
                        </div>
                        <div class="medida-actions">
                            <button class="btn-excluir-medida" onclick="excluirMedida('${medida.id}', this)" title="Excluir medida">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function exibirResumoEstatistico(aluno, medidas) {
            const container = document.getElementById('resumoEstatistico');
            const totalMedidas = medidas.length;
            
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Calcular estat√≠sticas avan√ßadas
                let mediasRecentes = 0;
                let tipoMaisComum = 'N/A';
                let mediaGeral = 0;
                let posicaoRanking = 'N/A';
                
                if (medidas.length > 0) {
                    // Medidas nos √∫ltimos 30 dias
                    const dataLimite = new Date();
                    dataLimite.setDate(dataLimite.getDate() - 30);
                    mediasRecentes = medidas.filter(m => 
                        new Date(m.data_registro) >= dataLimite
                    ).length;
                    
                    // Tipo mais comum
                    const tiposCount = {};
                    medidas.forEach(m => {
                        tiposCount[m.tipo_medida] = (tiposCount[m.tipo_medida] || 0) + 1;
                    });
                    tipoMaisComum = Object.keys(tiposCount).reduce((a, b) => 
                        tiposCount[a] > tiposCount[b] ? a : b, 'N/A'
                    );
                }
                
                // Buscar dados gerais para compara√ß√£o
                const { data: todasMedidas } = await window.supabaseClient
                    .from('medidas')
                    .select('codigo_matricula, criado_em');
                
                if (todasMedidas) {
                    // Calcular m√©dia geral por aluno
                    const alunosCount = {};
                    todasMedidas.forEach(m => {
                        alunosCount[m.codigo_matricula] = (alunosCount[m.codigo_matricula] || 0) + 1;
                    });
                    
                    const medidasPorAluno = Object.values(alunosCount);
                    mediaGeral = medidasPorAluno.length > 0 ? 
                        (medidasPorAluno.reduce((a, b) => a + b, 0) / medidasPorAluno.length).toFixed(1) : 0;
                    
                    // Calcular posi√ß√£o no ranking (quantos alunos t√™m mais medidas)
                    const alunosComMais = medidasPorAluno.filter(count => count > totalMedidas).length;
                    posicaoRanking = `${alunosComMais + 1}¬∫ de ${medidasPorAluno.length}`;
                }
                
                // Obter nota disciplinar das views (nova implementa√ß√£o)
                let notaDisciplinar = 8.0;
                let dadosNota = null;
                
                try {
                    const codigoAluno = aluno.codigo || aluno.id || selectAluno.value;
                    
                    const { data: notaData, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .eq('codigo_aluno', codigoAluno)
                        .limit(1);
                    
                    if (!error && notaData && notaData.length > 0) {
                        dadosNota = notaData[0];
                        notaDisciplinar = dadosNota.nota_atual || 8.0;
                    } else {
                        console.log(`‚ö†Ô∏è Nota n√£o encontrada para ${codigoAluno}, usando padr√£o 8.0`);
                    }
                } catch (error) {
                    console.warn('Erro ao obter nota das views:', error);
                }
                
                const mencao = obterMencaoDisciplinar(notaDisciplinar);
                
                container.innerHTML = `
                    <!-- Nota Disciplinar - Destaque Principal -->
                    <div class="disciplinary-score-card" style="background: linear-gradient(135deg, ${mencao.cor}20, ${mencao.cor}10); border: 2px solid ${mencao.cor}; margin-bottom: 20px;">
                        <div class="score-content">
                            <div class="score-header">
                                <span class="score-emoji">${mencao.emoji}</span>
                                <div class="score-info">
                                    <div class="score-title">Nota Disciplinar</div>
                                    <div class="score-subtitle">${mencao.mencao}</div>
                                </div>
                            </div>
                            <div class="score-number" style="color: ${mencao.cor};">${notaDisciplinar.toFixed(2)}</div>
                        </div>
                        
                        ${dadosNota.data_ultima_negativa ? `
                            <div class="score-details">
                                <span>√öltima ocorr√™ncia negativa: ${dadosNota.dias_desde_ultima_negativa || 0} dias atr√°s</span>
                                ${dadosNota.bonus_ativo ? 
                                    `<span style="color: #28a745;">üéâ B√¥nus de recupera√ß√£o ativo!</span>` : 
                                    `<span>Aguardando per√≠odo de recupera√ß√£o</span>`
                                }
                            </div>
                        ` : `
                            <div class="score-details">
                                <span style="color: #28a745;">‚ú® Nenhuma medida negativa registrada!</span>
                            </div>
                        `}
                    </div>
                
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">‚öñÔ∏è</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-info">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediaGeral}</div>
                                <div class="stat-label">M√©dia Geral (por aluno)</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-danger">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediasRecentes}</div>
                                <div class="stat-label">√öltimos 30 dias</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-primary">
                            <div class="stat-icon">üèÜ</div>
                            <div class="stat-content">
                                <div class="stat-number">${posicaoRanking}</div>
                                <div class="stat-label">Ranking Disciplinar</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">C√≥digo do Aluno</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-secondary">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-content">
                                <div class="stat-number" style="font-size: 0.8em;">${tipoMaisComum.length > 15 ? tipoMaisComum.substring(0, 15) + '...' : tipoMaisComum}</div>
                                <div class="stat-label">Tipo Mais Comum</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-section" style="margin-top: 20px;">
                        <h5>üìä An√°lise Comparativa</h5>
                        <div class="comparison-grid">
                            <div class="comparison-item ${totalMedidas > mediaGeral ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Situa√ß√£o vs M√©dia Geral:</span>
                                <span class="comparison-value">
                                    ${totalMedidas > mediaGeral ? 
                                        `‚ö†Ô∏è Acima da m√©dia (+${(totalMedidas - mediaGeral).toFixed(1)})` : 
                                        `‚úÖ Abaixo da m√©dia (-${(mediaGeral - totalMedidas).toFixed(1)})`
                                    }
                                </span>
                            </div>
                            
                            <div class="comparison-item ${mediasRecentes > 2 ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Tend√™ncia Recente:</span>
                                <span class="comparison-value">
                                    ${mediasRecentes === 0 ? '‚úÖ Sem ocorr√™ncias recentes' :
                                      mediasRecentes <= 2 ? 'üü° Situa√ß√£o controlada' :
                                      'üî¥ Requer aten√ß√£o'
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao calcular estat√≠sticas avan√ßadas:', error);
                // Fallback para exibi√ß√£o simples
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">‚öñÔ∏è</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">C√≥digo do Aluno</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        

        // Inicializar filtros quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                await carregarTurmasEAlunos();
            }, 2000);
        });

        // FUN√á√ïES DE FREQU√äNCIA SEPARADAS (baseadas no teste que funciona)
        async function verFrequenciaAluno() {
            const selectAluno = document.getElementById('alunoConsulta');
            const areaFrequencia = document.getElementById('areaFrequenciaAluno');
            const resultado = document.getElementById('resultadoFrequenciaAluno');
            
            if (!selectAluno || !selectAluno.value) {
                alert('Primeiro selecione um aluno!');
                return;
            }
            
            // Pegar c√≥digo do aluno - BUSCAR NOS DADOS CARREGADOS
            let codigo = selectAluno.value;
            const nomeAluno = selectAluno.options[selectAluno.selectedIndex]?.text || '';
            
            console.log('DEBUG: selectAluno.value =', selectAluno.value);
            console.log('DEBUG: nomeAluno =', nomeAluno);
            console.log('DEBUG: todosAlunosMedidas =', todosAlunosMedidas);
            
            // Tentar buscar c√≥digo real se dispon√≠vel
            if (todosAlunosMedidas && todosAlunosMedidas.length > 0) {
                const alunoEncontrado = todosAlunosMedidas.find(aluno => aluno.id === selectAluno.value);
                console.log('DEBUG: alunoEncontrado =', alunoEncontrado);
                if (alunoEncontrado && alunoEncontrado.codigo) {
                    codigo = alunoEncontrado.codigo;
                    console.log('DEBUG: Converteu para c√≥digo =', codigo);
                }
            }
            
            // Se ainda n√£o encontrou c√≥digo, tentar usar o value do option
            if (codigo === selectAluno.value && selectAluno.options[selectAluno.selectedIndex]) {
                const dataCode = selectAluno.options[selectAluno.selectedIndex].getAttribute('data-codigo');
                if (dataCode) {
                    codigo = dataCode;
                    console.log('DEBUG: Usando data-codigo =', codigo);
                }
            }
            
            console.log('üîç Buscando frequ√™ncia para c√≥digo:', codigo);
            resultado.innerHTML = 'üîÑ Carregando frequ√™ncia...';
            areaFrequencia.style.display = 'block';
            
            try {
                console.log('TESTE: Fazendo fetch do arquivo...');
                const response = await fetch('../assets/js/dados-frequencia-agosto.js');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar arquivo: ' + response.status);
                }
                
                const jsContent = await response.text();
                console.log('TESTE: Arquivo carregado, tamanho:', jsContent.length);
                
                // Extrair dados CSV
                const csvMatch = jsContent.match(/const dadosCSV = `([^`]+)`/);
                if (!csvMatch || !csvMatch[1]) {
                    throw new Error('Dados CSV n√£o encontrados no arquivo');
                }
                
                const csvData = csvMatch[1];
                console.log('TESTE: CSV extra√≠do, primeiras 200 chars:', csvData.substring(0, 200));
                
                // Parse CSV
                const linhas = csvData.trim().split('\n');
                console.log('TESTE: Total de linhas CSV:', linhas.length);
                
                // Buscar linha do aluno
                let linhaAluno = null;
                console.log('TESTE: Procurando por linha que come√ßa com:', codigo + ',');
                
                for (let linha of linhas) {
                    if (linha.startsWith(codigo + ',')) {
                        linhaAluno = linha;
                        console.log('TESTE: Linha do aluno encontrada:', linhaAluno);
                        break;
                    }
                }
                
                if (!linhaAluno) {
                    console.log('TESTE: Aluno n√£o encontrado. Primeiras 5 linhas:', linhas.slice(0, 5));
                    console.log('TESTE: Procurando pelo c√≥digo:', codigo);
                    resultado.innerHTML = `‚ùå Aluno ${codigo} n√£o encontrado no arquivo de frequ√™ncia`;
                    return;
                }
                
                const campos = linhaAluno.split(',');
                const nome = campos[1];
                const turma = campos[2];
                const diasAgosto = [1, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15, 18, 19, 20, 21, 22, 25, 26, 27, 28, 29];
                
                const faltas = [];
                for (let i = 3; i < campos.length && i - 3 < diasAgosto.length; i++) {
                    const marcacao = campos[i];
                    if (marcacao === 'F' || marcacao === 'FC' || marcacao === 'A') {
                        const dia = diasAgosto[i - 3];
                        faltas.push({
                            dia: dia,
                            marcacao: marcacao,
                            data: `${dia.toString().padStart(2, '0')}/08`
                        });
                    }
                }
                
                let html = `
                    <h5>‚úÖ ${nome}</h5>
                    <p><strong>C√≥digo:</strong> ${codigo}</p>
                    <p><strong>Turma:</strong> ${turma}</p>
                    <p><strong>Total de faltas:</strong> ${faltas.length}</p>
                `;
                
                if (faltas.length > 0) {
                    html += '<p><strong>Faltas encontradas:</strong></p>';
                    faltas.forEach(falta => {
                        let cor = '#dc3545'; // Vermelho para F
                        if (falta.marcacao === 'FC') cor = '#ffc107'; // Amarelo para FC
                        if (falta.marcacao === 'A') cor = '#17a2b8'; // Azul para A
                        
                        html += `<span style="background: ${cor}; color: white; padding: 6px 12px; margin: 3px; border-radius: 5px; display: inline-block;">${falta.data} - ${falta.marcacao}</span> `;
                    });
                    html += '<br><small style="color: #666; margin-top: 10px; display: block;">F = Falta | FC = Falta Controlada | A = Atestado</small>';
                } else {
                    html += '<p style="color: green;">‚úÖ Nenhuma falta registrada</p>';
                }
                
                resultado.innerHTML = html;
                console.log('‚úÖ Frequ√™ncia carregada com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar frequ√™ncia:', error);
                resultado.innerHTML = `‚ùå Erro: ${error.message}`;
            }
        }

        function fecharFrequencia() {
            document.getElementById('areaFrequenciaAluno').style.display = 'none';
        }

        // ======= FUN√á√ÉO DE EXPORTA√á√ÉO PARA PDF - LAYOUT ORGANIZADO =======
        async function exportarFichaPDF() {
            console.log('üìÑ Iniciando exporta√ß√£o para PDF...');
            const btnExportar = document.getElementById('btnExportarPDF');
            const selectAluno = document.getElementById('alunoConsulta');
            
            // Desabilitar bot√£o durante exporta√ß√£o
            const textoOriginal = btnExportar.innerHTML;
            btnExportar.disabled = true;
            btnExportar.innerHTML = '‚è≥ Gerando PDF...';
            
            try {
                // Verificar se ficha est√° carregada
                const fichaContainer = document.getElementById('fichaAluno');
                if (!fichaContainer || fichaContainer.style.display === 'none') {
                    alert('‚ùå Por favor, primeiro carregue a ficha disciplinar do aluno!');
                    return;
                }
                
                // Obter dados do aluno para nome do arquivo
                const nomeAluno = selectAluno.options[selectAluno.selectedIndex]?.text || 'Aluno';
                const codigoAluno = selectAluno.value;
                
                // ============= NOVA ABORDAGEM: CAPTURAR APAR√äNCIA EXATA =============
                
                // Aguardar html2canvas estar dispon√≠vel
                if (!window.html2canvas) {
                    // Carregar html2canvas dinamicamente se necess√°rio
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }
                
                // Preparar a ficha para captura
                const originalScrollBehavior = fichaContainer.style.overflow;
                const originalMaxHeight = fichaContainer.style.maxHeight;
                
                // Remover scroll temporariamente para capturar tudo
                fichaContainer.style.overflow = 'visible';
                fichaContainer.style.maxHeight = 'none';
                
                // Aguardar um momento para o layout se ajustar
                await new Promise(resolve => setTimeout(resolve, 500));
                
                btnExportar.innerHTML = 'üì∏ Capturando ficha...';
                
                // Capturar a ficha como imagem
                const canvas = await html2canvas(fichaContainer, {
                    scale: 2, // Alta qualidade
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: fichaContainer.scrollWidth,
                    height: fichaContainer.scrollHeight,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // Restaurar estilos originais
                fichaContainer.style.overflow = originalScrollBehavior;
                fichaContainer.style.maxHeight = originalMaxHeight;
                
                btnExportar.innerHTML = 'üñ®Ô∏è Criando PDF...';
                
                // Criar PDF com as dimens√µes corretas
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                
                // Calcular dimens√µes para PDF
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgHeight / imgWidth;
                
                // Usar A4 em modo paisagem se necess√°rio, ou retrato
                const pdfWidth = 210; // A4 width in mm
                const pdfHeight = pdfWidth * ratio;
                
                let pdf;
                if (pdfHeight > 297) { // Se for muito alto para A4 retrato
                    pdf = new jsPDF('l', 'mm', 'a4'); // Paisagem
                    const landscapeWidth = 297;
                    const landscapeHeight = landscapeWidth * ratio;
                    pdf.addImage(imgData, 'PNG', 10, 10, landscapeWidth - 20, landscapeHeight);
                } else {
                    pdf = new jsPDF('p', 'mm', 'a4'); // Retrato
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                }
                
                // Se a imagem for muito alta, criar p√°ginas adicionais
                if (pdfHeight > 280) {
                    const pagesNeeded = Math.ceil(pdfHeight / 280);
                    for (let i = 1; i < pagesNeeded; i++) {
                        pdf.addPage();
                        const yOffset = -(280 * i);
                        pdf.addImage(imgData, 'PNG', 10, yOffset + 10, pdfWidth - 20, pdfHeight);
                    }
                }
                
                // Salvar PDF
                const fileName = `Ficha_Disciplinar_${nomeAluno.replace(/[^a-zA-Z0-9]/g, '_')}_${codigoAluno}.pdf`;
                pdf.save(fileName);
                
                console.log('‚úÖ PDF gerado com sucesso:', fileName);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF:', error);
                alert('‚ùå Erro ao gerar PDF: ' + error.message);
            } finally {
                // Restaurar bot√£o
                btnExportar.disabled = false;
                btnExportar.innerHTML = textoOriginal;
            }
        }

        // ======= ADI√á√ÉO DE HTML2CANVAS AO CABE√áALHO =======
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        document.head.appendChild(html2canvasScript);

        // Carregar estat√≠sticas de medidas disciplinares
        async function carregarEstatisticasMedidas() {
                const pageHeight = 297;
                const margin = 12; // Margens mais compactas
                const contentWidth = pageWidth - (margin * 2);
                
                // Paleta de cores moderna
                const cores = {
                    azulPrimario: [0, 102, 204],      // Azul principal
                    azulSecundario: [51, 133, 214],   // Azul mais claro  
                    cinzaClaro: [248, 249, 250],      // Fundo suave
                    cinzaTexto: [60, 64, 67],        // Texto secund√°rio
                    vermelho: [234, 67, 53],          // Advert√™ncias
                    amarelo: [251, 188, 4],           // Observa√ß√µes  
                    verde: [52, 168, 83],             // Sucessos
                    branco: [255, 255, 255]
                };
                
                let yPos = 0;
                
                // ===== CABE√áALHO MODERNO COM GRADIENTE =====
                // Fundo gradiente (simulado com m√∫ltiplas cores)
                pdf.setFillColor(...cores.azulPrimario);
                pdf.rect(0, 0, pageWidth, 25, 'F');
                pdf.setFillColor(...cores.azulSecundario);
                pdf.rect(0, 20, pageWidth, 5, 'F'); // Gradiente simulado
                
                // Logo removida conforme solicitado - cabe√ßalho limpo
                
                // ===== T√çTULO PRINCIPAL =====
                pdf.setTextColor(...cores.branco);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text('FICHA DISCIPLINAR DO ALUNO', pageWidth/2, 12, { align: 'center' });
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Escola Estadual C√≠vico-Militar Jupiara', pageWidth/2, 18, { align: 'center' });
                
                // Logo removida completamente
                
                yPos = 35;
                
                // ===== SE√á√ÉO DE IDENTIFICA√á√ÉO MODERNA =====
                // Container com fundo suave e sombra
                pdf.setFillColor(...cores.cinzaClaro);
                pdf.rect(margin, yPos, contentWidth, 40, 'F');
                
                // Linha decorativa superior
                pdf.setFillColor(...cores.azulPrimario);
                pdf.rect(margin, yPos, contentWidth, 2, 'F');
                
                // T√≠tulo da se√ß√£o
                pdf.setTextColor(...cores.azulPrimario);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('IDENTIFICA√á√ÉO DO ALUNO', margin + 4, yPos + 8);
                
                yPos += 12;
                
                // ===== PROCESSAMENTO DOS DADOS COM √çCONES =====
                const dadosPessoais = document.getElementById('dadosPessoais');
                const dadosComIcones = [];
                let fotoAlunoSrc = null;
                
                // Mapeamento de marcadores para campos (sem emojis)
                const iconesCampos = {
                    'nome': '‚Ä¢', 'c√≥digo': '‚Ä¢', 'turma': '‚Ä¢', 's√©rie': '‚Ä¢',
                    'nascimento': '‚Ä¢', 'cpf': '‚Ä¢', 'rg': '‚Ä¢', 'telefone': '‚Ä¢',
                    'email': '‚Ä¢', 'endere√ßo': '‚Ä¢', 'respons√°vel': '‚Ä¢'
                };
                
                if (dadosPessoais) {
                    // Buscar foto do aluno em alta qualidade
                    const imgFoto = dadosPessoais.querySelector('img[alt="Foto do aluno"]');
                    if (imgFoto && imgFoto.src && !imgFoto.src.includes('placeholder')) {
                        fotoAlunoSrc = imgFoto.src;
                        console.log('üì∏ Foto encontrada para processamento HD');
                    }
                    
                    // Extrair e organizar dados com √≠cones
                    const items = dadosPessoais.querySelectorAll('.dado-item');
                    items.forEach(item => {
                        const label = item.querySelector('.dado-label')?.textContent?.trim();
                        const valor = item.querySelector('.dado-valor')?.textContent?.trim();
                        
                        if (label && label.toLowerCase().includes('foto')) return;
                        
                        if (label && valor && valor !== 'N/A') {
                            // Encontrar √≠cone apropriado
                            const chave = Object.keys(iconesCampos).find(k => label.toLowerCase().includes(k));
                            const icone = iconesCampos[chave] || 'üìã';
                            
                            dadosComIcones.push({
                                icone: icone,
                                label: label.replace(':', ''),
                                valor: valor
                            });
                        }
                    });
                }
                
                // Dados padr√£o se n√£o encontrou
                if (dadosComIcones.length === 0) {
                    dadosComIcones.push(
                        { icone: 'üë§', label: 'Nome', valor: nomeAluno },
                        { icone: 'üî¢', label: 'C√≥digo', valor: codigoAluno }
                    );
                }
                
                // ===== FOTO DO ALUNO EM ALTA QUALIDADE =====
                let fotoAdicionada = false;
                if (fotoAlunoSrc) {
                    try {
                        console.log('üì∏ Processando foto HD...');
                        const fotoImg = new Image();
                        fotoImg.crossOrigin = 'anonymous';
                        
                        const fotoPromise = new Promise((resolve, reject) => {
                            fotoImg.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Foto 3x4 otimizada
                                    const fotoWidth = 22;
                                    const fotoHeight = 28;
                                    
                                    // Canvas HD (4x resolu√ß√£o)
                                    canvas.width = fotoWidth * 4;
                                    canvas.height = fotoHeight * 4;
                                    
                                    ctx.imageSmoothingEnabled = true;
                                    ctx.imageSmoothingQuality = 'high';
                                    ctx.drawImage(fotoImg, 0, 0, canvas.width, canvas.height);
                                    
                                    const fotoDataURL = canvas.toDataURL('image/png', 1.0);
                                    
                                    // Posicionar no canto superior direito
                                    const fotoX = margin + contentWidth - fotoWidth - 3;
                                    const fotoY = yPos - 8;
                                    
                                    // Fundo branco com borda
                                    pdf.setFillColor(...cores.branco);
                                    pdf.rect(fotoX - 1, fotoY - 1, fotoWidth + 2, fotoHeight + 2, 'F');
                                    pdf.addImage(fotoDataURL, 'PNG', fotoX, fotoY, fotoWidth, fotoHeight);
                                    
                                    // Borda decorativa
                                    pdf.setDrawColor(...cores.azulSecundario);
                                    pdf.setLineWidth(0.5);
                                    pdf.rect(fotoX - 1, fotoY - 1, fotoWidth + 2, fotoHeight + 2, 'D');
                                    
                                    fotoAdicionada = true;
                                    console.log('‚úÖ Foto HD adicionada!');
                                    resolve();
                                } catch (e) {
                                    reject(e);
                                }
                            };
                            fotoImg.onerror = reject;
                        });
                        
                        fotoImg.src = fotoAlunoSrc;
                        await Promise.race([
                            fotoPromise,
                            new Promise((_, reject) => setTimeout(() => reject('Timeout'), 3000))
                        ]);
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Foto n√£o carregou:', error);
                        // Placeholder elegante
                        const fotoX = margin + contentWidth - 22 - 3;
                        const fotoY = yPos - 8;
                        pdf.setFillColor(...cores.cinzaClaro);
                        pdf.setDrawColor(...cores.azulSecundario);
                        pdf.rect(fotoX, fotoY, 22, 28, 'FD');
                        pdf.setTextColor(...cores.cinzaTexto);
                        pdf.setFontSize(8);
                        pdf.text('SEM FOTO', fotoX + 11, fotoY + 16, { align: 'center' });
                    }
                }
                
                // ===== LAYOUT OTIMIZADO EM 2 COLUNAS COM √çCONES =====
                const dadosWidth = contentWidth - 30; // Espa√ßo para foto
                const colunaWidth = dadosWidth / 2;
                
                pdf.setFont('helvetica', 'normal');
                let linha = 0;
                
                dadosComIcones.forEach((item, index) => {
                    const coluna = index % 2;
                    const x = margin + 4 + (coluna * colunaWidth);
                    const y = yPos + (linha * 5);
                    
                    // √çcone
                    pdf.setFontSize(8);
                    pdf.text(item.icone, x, y);
                    
                    // Label (pequeno e discreto)
                    pdf.setTextColor(...cores.cinzaTexto);
                    pdf.setFontSize(7);
                    pdf.text(item.label + ':', x + 6, y);
                    
                    // Valor (destaque)
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(8);
                    const valorTexto = item.valor.length > 25 ? 
                        item.valor.substring(0, 25) + '...' : item.valor;
                    pdf.text(valorTexto, x + 6 + pdf.getTextWidth(item.label + ': '), y);
                    
                    // Avan√ßar linha a cada 2 itens
                    if (coluna === 1) linha++;
                });
                
                yPos += Math.max(25, Math.ceil(dadosComIcones.length / 2) * 5 + 8);
                
                // ===== HIST√ìRICO DISCIPLINAR - TABELA ESTILIZADA =====
                const historicoContainer = document.getElementById('historicoMedidas');
                let todasMedidas = [];
                let notaDisciplinar = '10.0';
                
                // Extrair dados estruturados das medidas
                if (historicoContainer) {
                    const medidaElements = historicoContainer.querySelectorAll('.medida-item');
                    medidaElements.forEach((element, index) => {
                        const texto = element.textContent?.trim();
                        if (texto && !texto.includes('Nenhuma medida') && !texto.includes('Carregando')) {
                            const linhas = texto.split('\n').filter(l => l.trim());
                            
                            let medida = {
                                data: '',
                                tipo: '',
                                descricao: '',
                                pontos: '',
                                cor: cores.cinzaClaro
                            };
                            
                            linhas.forEach(linha => {
                                const l = linha.trim();
                                if (l.match(/\d{2}\/\d{2}\/\d{4}/)) {
                                    medida.data = l.match(/\d{2}\/\d{2}\/\d{4}/)[0];
                                } else if (l.includes('Advert√™ncia')) {
                                    medida.tipo = 'Advert√™ncia';
                                    medida.cor = [255, 235, 235]; // Vermelho suave
                                } else if (l.includes('Suspens√£o')) {
                                    medida.tipo = 'Suspens√£o';
                                    medida.cor = [255, 220, 220]; // Vermelho mais forte
                                } else if (l.includes('Fato Observado')) {
                                    medida.tipo = 'Observa√ß√£o';
                                    medida.cor = [255, 248, 220]; // Amarelo suave
                                } else if (l.includes('Especifica√ß√£o:')) {
                                    medida.descricao = l.replace('Especifica√ß√£o:', '').trim().substring(0, 50);
                                } else if (l.includes('Observa√ß√µes:')) {
                                    const obs = l.replace('Observa√ß√µes:', '').trim().substring(0, 30);
                                    medida.descricao += (medida.descricao ? ' - ' : '') + obs;
                                } else if (l.match(/-?\d+\.?\d*/)) {
                                    const ponto = l.match(/-?\d+\.?\d*/);
                                    if (ponto) medida.pontos = ponto[0];
                                }
                            });
                            
                            if (medida.data || medida.tipo) {
                                todasMedidas.push(medida);
                            }
                        }
                    });
                }
                
                // Buscar nota disciplinar 
                const resumoContainer = document.getElementById('resumoEstatistico');
                if (resumoContainer) {
                    const resumoTexto = resumoContainer.textContent || '';
                    const notaMatch = resumoTexto.match(/([0-9]+(?:\.[0-9]+)?)/);
                    if (notaMatch) notaDisciplinar = notaMatch[1];
                }
                
                // ===== CONTAINER DA TABELA =====
                const tabelaHeight = Math.max(35, todasMedidas.length * 8 + 25);
                
                // Fundo da se√ß√£o
                pdf.setFillColor(...cores.cinzaClaro);
                pdf.rect(margin, yPos, contentWidth, tabelaHeight, 'F');
                
                // Linha decorativa superior  
                pdf.setFillColor(...cores.vermelho);
                pdf.rect(margin, yPos, contentWidth, 2, 'F');
                
                // T√≠tulo com contador
                pdf.setTextColor(...cores.vermelho);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`HIST√ìRICO DISCIPLINAR (${todasMedidas.length} ocorr√™ncias)`, margin + 4, yPos + 10);
                
                // Nota disciplinar (canto superior direito)
                pdf.setTextColor(...cores.azulPrimario);
                pdf.setFontSize(10);
                pdf.text(`Nota: ${notaDisciplinar}`, margin + contentWidth - 35, yPos + 10);
                
                yPos += 16;
                
                if (todasMedidas.length > 0) {
                    // ===== CABE√áALHO DA TABELA =====
                    pdf.setFillColor(...cores.azulPrimario);
                    pdf.rect(margin + 2, yPos, contentWidth - 4, 6, 'F');
                    
                    pdf.setTextColor(...cores.branco);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('DATA', margin + 4, yPos + 4);
                    pdf.text('TIPO', margin + 25, yPos + 4);
                    pdf.text('DESCRI√á√ÉO', margin + 55, yPos + 4);
                    pdf.text('PONTOS', margin + contentWidth - 20, yPos + 4);
                    
                    yPos += 8;
                    
                    // ===== LINHAS DA TABELA (ZEBRA STRIPES) =====
                    todasMedidas.forEach((medida, index) => {
                        // Verificar nova p√°gina
                        if (yPos > pageHeight - 40) {
                            pdf.addPage();
                            yPos = margin + 10;
                        }
                        
                        // Fundo alternado (zebra stripes)
                        const corLinha = index % 2 === 0 ? cores.branco : medida.cor;
                        pdf.setFillColor(...corLinha);
                        pdf.rect(margin + 2, yPos - 1, contentWidth - 4, 7, 'F');
                        
                        // Dados da linha
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'normal');
                        
                        // Data
                        pdf.text(medida.data || '--', margin + 4, yPos + 3);
                        
                        // Tipo (com cor espec√≠fica)
                        const corTipo = medida.tipo === 'Advert√™ncia' ? cores.vermelho :
                                      medida.tipo === 'Suspens√£o' ? [200, 0, 0] :
                                      medida.tipo === 'Observa√ß√£o' ? [200, 140, 0] : [0, 0, 0];
                        pdf.setTextColor(...corTipo);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(medida.tipo || 'N/A', margin + 25, yPos + 3);
                        
                        // Descri√ß√£o
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFont('helvetica', 'normal');
                        const descLimitada = medida.descricao.length > 35 ?
                            medida.descricao.substring(0, 35) + '...' : medida.descricao;
                        pdf.text(descLimitada || 'Sem detalhes', margin + 55, yPos + 3);
                        
                        // Pontos
                        pdf.setTextColor(...cores.vermelho);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(medida.pontos || '0', margin + contentWidth - 15, yPos + 3);
                        
                        yPos += 7;
                    });
                    
                } else {
                    // Mensagem quando n√£o h√° medidas
                    pdf.setTextColor(...cores.verde);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('Nenhuma medida disciplinar registrada - Comportamento exemplar!', 
                            pageWidth/2, yPos + 8, { align: 'center' });
                    yPos += 20;
                }
                
                yPos += 10;
                
                // ===== FREQU√äNCIA ESCOLAR - GRID COMPACTO =====
                const frequenciaContainer = document.getElementById('frequenciaEscolar');
                
                let todasFaltas = [];
                let porcentagemFreq = '100%';
                let resumoAcumulado = null;
                
                // ===== BUSCAR DADOS COMPLETOS DE FREQU√äNCIA =====
                try {
                    console.log('üîÑ Buscando TODAS as faltas para o aluno:', codigoAluno);
                    
                    // Buscar dados completos sem limites
                    const [resumoResult, todasFaltasResult] = await Promise.all([
                        window.getResumoAcumuladoAluno(codigoAluno),
                        window.getFaltasAluno(codigoAluno, 999) // Aumentar limite para pegar todas
                    ]);
                    
                    resumoAcumulado = resumoResult.data;
                    const faltasData = todasFaltasResult.data || [];
                    
                    // Extrair porcentagem de frequ√™ncia
                    if (resumoAcumulado?.pct_presenca_operacional) {
                        porcentagemFreq = `${resumoAcumulado.pct_presenca_operacional.toFixed(1)}%`;
                    }
                    
                    // Processar TODAS as faltas encontradas
                    if (faltasData.length > 0) {
                        todasFaltas = faltasData.map(falta => {
                            // Extrair data e tipo da falta
                            let dataFormatada = '';
                            let tipoFalta = 'Falta';
                            
                            if (falta.data_ocorrencia || falta.data) {
                                const data = new Date(falta.data_ocorrencia || falta.data);
                                dataFormatada = data.toLocaleDateString('pt-BR');
                            }
                            
                            if (falta.tipo) {
                                tipoFalta = falta.tipo;
                            } else if (falta.motivo) {
                                tipoFalta = falta.motivo;
                            }
                            
                            return {
                                data: dataFormatada,
                                tipo: tipoFalta,
                                descricao: falta.descricao || ''
                            };
                        }).filter(f => f.data); // S√≥ faltas com data v√°lida
                        
                        // Ordenar por data (mais recentes primeiro)
                        todasFaltas.sort((a, b) => {
                            const dateA = new Date(a.data.split('/').reverse().join('-'));
                            const dateB = new Date(b.data.split('/').reverse().join('-'));
                            return dateB - dateA;
                        });
                    }
                    
                    console.log(`‚úÖ Total de faltas encontradas na base: ${todasFaltas.length}`, todasFaltas);
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao buscar faltas da base, usando dados da tela:', error);
                    
                    // Fallback: extrair dados da tela se API falhar
                    if (frequenciaContainer) {
                        const freqTexto = frequenciaContainer.textContent || '';
                        console.log('üîç Usando dados da tela como fallback...');
                        
                        // Buscar porcentagem de frequ√™ncia
                        const percMatch = freqTexto.match(/([0-9]+\.?[0-9]*%)/);
                        if (percMatch) porcentagemFreq = percMatch[1];
                        
                        // Buscar TODAS as datas da tela
                        const todasDatasPoss√≠veis = new Set();
                        const datasRegex = freqTexto.match(/\d{2}\/\d{2}\/\d{4}/g);
                        if (datasRegex) {
                            datasRegex.forEach(data => todasDatasPoss√≠veis.add(data));
                        }
                        
                        // Buscar em elementos espec√≠ficos
                        const elementosFilhos = frequenciaContainer.querySelectorAll('*');
                        elementosFilhos.forEach(el => {
                            const textoElemento = el.textContent || '';
                            const datasElemento = textoElemento.match(/\d{2}\/\d{2}\/\d{4}/g);
                            if (datasElemento) {
                                datasElemento.forEach(data => todasDatasPoss√≠veis.add(data));
                            }
                        });
                        
                        // Converter para formato padr√£o
                        if (todasDatasPoss√≠veis.size > 0) {
                            todasFaltas = Array.from(todasDatasPoss√≠veis).map(data => ({
                                data: data,
                                tipo: 'Falta',
                                descricao: ''
                            })).sort((a, b) => {
                                const dateA = new Date(a.data.split('/').reverse().join('-'));
                                const dateB = new Date(b.data.split('/').reverse().join('-'));
                                return dateB - dateA;
                            });
                        }
                    }
                }
                
                // ===== CONTAINER DA FREQU√äNCIA =====
                const freqHeight = Math.max(45, todasFaltas.length > 10 ? 60 : 45);
                
                // Fundo da se√ß√£o
                pdf.setFillColor(...cores.cinzaClaro);
                pdf.rect(margin, yPos, contentWidth, freqHeight, 'F');
                
                // Linha decorativa superior
                pdf.setFillColor(...cores.verde);
                pdf.rect(margin, yPos, contentWidth, 2, 'F');
                
                // T√≠tulo com estat√≠sticas
                pdf.setTextColor(...cores.verde);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('FREQU√äNCIA ESCOLAR', margin + 4, yPos + 10);
                
                // Percentual em destaque
                const porcentNum = parseFloat(porcentagemFreq.replace('%', ''));
                const corPercent = porcentNum >= 85 ? cores.verde : 
                                  porcentNum >= 75 ? cores.amarelo : cores.vermelho;
                
                pdf.setTextColor(...corPercent);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text(porcentagemFreq, margin + contentWidth - 30, yPos + 10);
                
                yPos += 16;
                
                if (todasFaltas.length > 0) {
                    // ===== MINI GR√ÅFICO DE BARRAS =====
                    const graficoWidth = 80;
                    const graficoHeight = 8;
                    const graficoX = margin + 4;
                    const graficoY = yPos;
                    
                    // Barra de fundo
                    pdf.setFillColor(220, 220, 220);
                    pdf.rect(graficoX, graficoY, graficoWidth, graficoHeight, 'F');
                    
                    // Barra de progresso (frequ√™ncia)
                    const larguraProgresso = (graficoWidth * porcentNum) / 100;
                    pdf.setFillColor(...corPercent);
                    pdf.rect(graficoX, graficoY, larguraProgresso, graficoHeight, 'F');
                    
                    // Labels do gr√°fico
                    pdf.setTextColor(...cores.cinzaTexto);
                    pdf.setFontSize(6);
                    pdf.text('0%', graficoX - 2, graficoY + graficoHeight + 3);
                    pdf.text('100%', graficoX + graficoWidth - 5, graficoY + graficoHeight + 3);
                    
                    yPos += 15;
                    
                    // ===== GRID COMPACTO DE AUS√äNCIAS =====
                    pdf.setTextColor(...cores.cinzaTexto);
                    pdf.setFontSize(8);
                    pdf.text(`Aus√™ncias registradas: ${todasFaltas.length}`, margin + 4, yPos);
                    
                    // Mostrar TODAS as aus√™ncias em grid compacto
                    const colunas = 4;
                    const espacoX = (contentWidth - 8) / colunas;
                    
                    yPos += 6;
                    
                    todasFaltas.forEach((falta, index) => {
                        // Verificar se precisa de nova p√°gina
                        if (yPos > pageHeight - 40) {
                            pdf.addPage();
                            yPos = margin + 10;
                        }
                        
                        const coluna = index % colunas;
                        const linha = Math.floor(index / colunas);
                        const x = margin + 4 + (coluna * espacoX);
                        const y = yPos + (linha * 5); // Reduzir espa√ßamento para 5px
                        
                        // Marcador de aus√™ncia
                        pdf.setTextColor(...cores.vermelho);
                        pdf.setFontSize(8);
                        pdf.text('X', x, y);
                        
                        // Data
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFontSize(7);
                        const dataFalta = typeof falta === 'object' ? falta.data : falta;
                        pdf.text(dataFalta, x + 6, y);
                        
                        // Quebrar linha a cada 4 colunas
                        if ((index + 1) % colunas === 0) {
                            yPos += 5;
                        }
                    });
                    
                    // Ajustar posi√ß√£o final
                    if (todasFaltas.length % colunas !== 0) {
                        yPos += 5;
                    }
                    
                    // Informa√ß√µes adicionais compactas
                    if (resumoAcumulado) {
                        yPos += 8;
                        pdf.setFontSize(6);
                        pdf.setTextColor(...cores.cinzaTexto);
                        const infos = [];
                        if (resumoAcumulado.dias_letivos) infos.push(`${resumoAcumulado.dias_letivos} dias letivos`);
                        if (resumoAcumulado.presencas_computadas) infos.push(`${resumoAcumulado.presencas_computadas} presen√ßas`);
                        if (infos.length > 0) {
                            pdf.text(infos.join(' ‚Ä¢ '), margin + 4, yPos);
                        }
                    }
                    
                } else {
                    // Mensagem quando n√£o h√° faltas
                    pdf.setTextColor(...cores.verde);
                    pdf.setFontSize(10);
                    pdf.text('Frequ√™ncia exemplar - Nenhuma aus√™ncia registrada!', 
                            pageWidth/2, yPos + 10, { align: 'center' });
                }
                
                yPos += 15;
                
                // ===== RESUMO ESTAT√çSTICO - 4 CARDS ESPEC√çFICOS =====
                console.log('üìä Criando resumo estat√≠stico com 4 cards espec√≠ficos...');
                
                // Calcular estat√≠sticas espec√≠ficas conforme solicitado
                const statsCards = [];
                
                // 1. DIAS DESDE √öLTIMA MEDIDA DISCIPLINAR
                let diasDesdeUltimaMedida = 'Nenhuma medida';
                if (todasMedidas.length > 0) {
                    // Encontrar a medida mais recente
                    const medidasComData = todasMedidas.filter(m => m.data).sort((a, b) => {
                        const dateA = new Date(a.data.split('/').reverse().join('-'));
                        const dateB = new Date(b.data.split('/').reverse().join('-'));
                        return dateB - dateA; // mais recente primeiro
                    });
                    
                    if (medidasComData.length > 0) {
                        const ultimaMedida = medidasComData[0];
                        const dataUltimaMedida = new Date(ultimaMedida.data.split('/').reverse().join('-'));
                        const hoje = new Date();
                        const diffTime = Math.abs(hoje - dataUltimaMedida);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        diasDesdeUltimaMedida = `${diffDays} dias`;
                        console.log(`üìÖ √öltima medida: ${ultimaMedida.data}, h√° ${diffDays} dias`);
                    }
                }
                
                // 2. M√âDIA DE COMPARA√á√ÉO COM O ALUNO ESPEC√çFICO
                let mediaComparacao = 'N/A';
                if (resumoAcumulado && resumoAcumulado.pct_presenca_operacional) {
                    // Usar porcentagem de frequ√™ncia como base de compara√ß√£o
                    const frequenciaAluno = resumoAcumulado.pct_presenca_operacional;
                    const mediaEscola = 85.0; // M√©dia t√≠pica escolar (pode ser ajustada)
                    const comparacao = frequenciaAluno - mediaEscola;
                    mediaComparacao = comparacao >= 0 ? 
                        `+${comparacao.toFixed(1)}% acima da m√©dia` : 
                        `${comparacao.toFixed(1)}% abaixo da m√©dia`;
                }
                
                // 3. POSI√á√ÉO NO RANKING DISCIPLINAR
                // Simula√ß√£o baseada no total de medidas (quanto menos, melhor posi√ß√£o)
                let posicaoRanking = 'N/A';
                const totalMedidas = todasMedidas.length;
                if (totalMedidas === 0) {
                    posicaoRanking = '1¬∫ - Exemplar';
                } else if (totalMedidas <= 2) {
                    posicaoRanking = 'Top 10% - Muito Bom';
                } else if (totalMedidas <= 5) {
                    posicaoRanking = 'Top 30% - Bom';
                } else if (totalMedidas <= 10) {
                    posicaoRanking = 'Top 60% - Regular';
                } else {
                    posicaoRanking = 'Abaixo de 60% - Aten√ß√£o';
                }
                
                // 4. TOTAL DE MEDIDAS COM BREAKDOWN POR TIPO
                const tiposMedidas = {};
                todasMedidas.forEach(medida => {
                    const tipo = medida.tipo || 'N√£o especificado';
                    tiposMedidas[tipo] = (tiposMedidas[tipo] || 0) + 1;
                });
                
                let breakdownTipos = `Total: ${totalMedidas}`;
                if (totalMedidas > 0) {
                    const tipos = Object.entries(tiposMedidas)
                        .sort((a, b) => b[1] - a[1]) // ordenar por quantidade
                        .map(([tipo, qtd]) => `${tipo}: ${qtd}`)
                        .join('\n');
                    breakdownTipos = `Total: ${totalMedidas}\n${tipos}`;
                }
                
                // Criar os 4 cards espec√≠ficos
                statsCards.push(
                    { 
                        titulo: 'Dias desde √∫ltima medida', 
                        valor: diasDesdeUltimaMedida,
                        cor: [40, 167, 69] // Verde
                    },
                    { 
                        titulo: 'Compara√ß√£o com m√©dia escolar', 
                        valor: mediaComparacao,
                        cor: [0, 123, 255] // Azul
                    },
                    { 
                        titulo: 'Posi√ß√£o ranking disciplinar', 
                        valor: posicaoRanking,
                        cor: [255, 193, 7] // Amarelo
                    },
                    { 
                        titulo: 'Total de medidas por tipo', 
                        valor: breakdownTipos,
                        cor: [220, 53, 69] // Vermelho
                    }
                );
                
                console.log('üìä Cards estat√≠sticos criados:', statsCards);
                
                // Layout em cards com mini-gr√°ficos
                const cardsHeight = Math.max(60, Math.ceil(statsCards.length / 2) * 30 + 20);
                
                if (yPos + cardsHeight > pageHeight - 30) {
                    pdf.addPage();
                    yPos = margin;
                }
                
                // Fundo da se√ß√£o
                pdf.setFillColor(255, 250, 235);
                pdf.rect(margin, yPos, contentWidth, cardsHeight, 'F');
                
                // T√≠tulo da se√ß√£o
                pdf.setTextColor(255, 193, 7);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('RESUMO ESTATISTICO', margin + 5, yPos + 8);
                
                yPos += 15;
                
                // ===== CARDS MODERNOS COM SOMBRAS E √çCONES =====
                const cardWidth = (contentWidth - 10) / 2;
                const cardHeight = 20;
                const cardSpacing = 5;
                
                // Marcadores para cada card (sem emojis problem√°ticos)
                const icones = ['‚Ä¢', '‚Ä¢', '‚Ä¢', '‚Ä¢'];
                
                statsCards.forEach((card, index) => {
                    const col = index % 2;
                    const row = Math.floor(index / 2);
                    
                    const cardX = margin + 3 + (col * (cardWidth + cardSpacing));
                    const cardY = yPos + (row * (cardHeight + cardSpacing));
                    
                    // ===== SOMBRA SUTIL =====
                    pdf.setFillColor(200, 200, 200);
                    pdf.rect(cardX + 1, cardY + 1, cardWidth, cardHeight, 'F');
                    
                    // ===== FUNDO DO CARD =====
                    const cor = card.cor || cores.cinzaClaro;
                    pdf.setFillColor(...cores.branco);
                    pdf.rect(cardX, cardY, cardWidth, cardHeight, 'F');
                    
                    // ===== BORDA COLORIDA =====
                    pdf.setDrawColor(...cor);
                    pdf.setLineWidth(0.8);
                    pdf.rect(cardX, cardY, cardWidth, cardHeight, 'D');
                    
                    // ===== FAIXA COLORIDA SUPERIOR =====
                    pdf.setFillColor(...cor);
                    pdf.rect(cardX, cardY, cardWidth, 3, 'F');
                    
                    // ===== √çCONE DO CARD =====
                    const icone = icones[index] || 'üìä';
                    pdf.setFontSize(12);
                    pdf.text(icone, cardX + 3, cardY + 8);
                    
                    // ===== T√çTULO COMPACTO =====
                    pdf.setTextColor(...cores.cinzaTexto);
                    pdf.setFontSize(6);
                    pdf.setFont('helvetica', 'normal');
                    const tituloCompacto = card.titulo.length > 28 ? 
                        card.titulo.substring(0, 28) + '...' : card.titulo;
                    pdf.text(tituloCompacto, cardX + 15, cardY + 6);
                    
                    // ===== VALOR DESTACADO =====
                    pdf.setTextColor(...cor);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    
                    const valorTexto = card.valor.toString();
                    if (valorTexto.length > 25) {
                        // Quebrar de forma inteligente por palavras
                        const palavras = valorTexto.split(' ');
                        let linha1 = '';
                        let linha2 = '';
                        let trocouLinha = false;
                        
                        palavras.forEach(palavra => {
                            if (!trocouLinha && (linha1 + palavra).length <= 20) {
                                linha1 += (linha1 ? ' ' : '') + palavra;
                            } else {
                                trocouLinha = true;
                                linha2 += (linha2 ? ' ' : '') + palavra;
                            }
                        });
                        
                        // Se linha2 muito longa, truncar
                        if (linha2.length > 22) {
                            linha2 = linha2.substring(0, 19) + '...';
                        }
                        
                        pdf.setFontSize(7);
                        pdf.text(linha1, cardX + 15, cardY + 10);
                        if (linha2) {
                            pdf.text(linha2, cardX + 15, cardY + 14);
                        }
                    } else {
                        pdf.text(valorTexto, cardX + 15, cardY + 12);
                    }
                    
                    // ===== MINI INDICADOR DE STATUS =====
                    const statusCor = index === 0 ? cores.verde :   // Dias desde √∫ltima medida
                                     index === 1 ? cores.azulPrimario : // Compara√ß√£o
                                     index === 2 ? cores.amarelo :      // Ranking
                                     cores.vermelho;                    // Total medidas
                    
                    pdf.setFillColor(...statusCor);
                    pdf.circle(cardX + cardWidth - 4, cardY + 4, 1.5, 'F');
                });
                
                yPos += Math.ceil(statsCards.length / 2) * (cardHeight + cardSpacing) + 8;
                
                // ===== FOOTER PROFISSIONAL =====
                const ultimaPagina = pdf.getNumberOfPages();
                const agora = new Date();
                const dataGeracao = agora.toLocaleDateString('pt-BR');
                const horaGeracao = agora.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                for (let i = 1; i <= ultimaPagina; i++) {
                    pdf.setPage(i);
                    
                    // ===== LINHA DECORATIVA =====
                    pdf.setDrawColor(...cores.azulPrimario);
                    pdf.setLineWidth(0.5);
                    pdf.line(margin, pageHeight - 18, pageWidth - margin, pageHeight - 18);
                    
                    // ===== INFORMA√á√ïES DA ESCOLA (ESQUERDA) =====
                    pdf.setTextColor(...cores.cinzaTexto);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('Escola Estadual C√≠vico-Militar Jupiara', margin, pageHeight - 12);
                    pdf.text('Sistema de Gest√£o Disciplinar', margin, pageHeight - 8);
                    
                    // ===== INFORMA√á√ïES DE GERA√á√ÉO (CENTRO) =====
                    pdf.setTextColor(...cores.azulPrimario);
                    pdf.setFontSize(6);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(`Gerado em ${dataGeracao} √†s ${horaGeracao}`, 
                             pageWidth/2, pageHeight - 12, { align: 'center' });
                    pdf.text(`Aluno: ${codigoAluno} - ${nomeAluno.substring(0, 30)}`, 
                             pageWidth/2, pageHeight - 8, { align: 'center' });
                    
                    // ===== PAGINA√á√ÉO (DIREITA) =====
                    pdf.setTextColor(...cores.cinzaTexto);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`P√°gina ${i}`, pageWidth - margin, pageHeight - 12, { align: 'right' });
                    pdf.text(`de ${ultimaPagina}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
                    
                    // ===== MARCA D'√ÅGUA DISCRETA =====
                    pdf.setTextColor(240, 240, 240);
                    pdf.setFontSize(5);
                    pdf.text('Documento Oficial', pageWidth - margin - 2, pageHeight - 4, { align: 'right' });
                }
                
                // ===== FINALIZAR E SALVAR =====
                const nomeArquivo = `ficha_disciplinar_${codigoAluno}_${dataGeracao.replace(/\//g, '-')}.pdf`;
                pdf.save(nomeArquivo);
                
                console.log('PDF MODERNO gerado:', nomeArquivo);
                console.log('Layout profissional aplicado com sucesso!');
                alert(`PDF gerado com sucesso!\n\nDesign moderno e profissional\nTodas as informa√ß√µes inclu√≠das\nArquivo: ${nomeArquivo}`);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + error.message);
            } finally {
                btnExportar.disabled = false;
                btnExportar.innerHTML = textoOriginal;
            }
        }
    </script>
    <script>
        // Proteger p√°gina - requer autentica√ß√£o
        // Aguardar carregamento dos scripts antes de verificar auth
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõë RequireAuth DESABILITADO temporariamente - corrigindo loops');
            // TEMPORARIAMENTE desabilitado para corrigir loop de redirecionamento
            // setTimeout(() => {
            //     if (typeof requireAuth === 'function') {
            //         console.log('RequireAuth dispon√≠vel, ativando prote√ß√£o...');
            //         requireAuth({
            //             loginPath: 'login.html',
            //             onAuth: function(user) {
            //                 console.log('Usu√°rio logado nas medidas disciplinares:', user.email);
            //                 // P√°gina j√° inicializa automaticamente via DOMContentLoaded
            //             }
            //         });
            //     } else {
            //         console.log('RequireAuth n√£o dispon√≠vel - executando sem autentica√ß√£o');
            //     }
            // }, 100);
        });
        
        // MISS√ÉO 1.1: Sistema de expans√£o/colapso de se√ß√µes
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (!content || !toggle) {
                console.warn('Elementos n√£o encontrados para se√ß√£o:', sectionId);
                return;
            }
            
            // Verificar se est√° expandido ou colapsado
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                // Colapsar
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = 'üîº';
            } else {
                // Expandir
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                toggle.classList.remove('collapsed');
                toggle.textContent = 'üîΩ';
                
                // Carregar dados espec√≠ficos quando expandir certas se√ß√µes
                if (sectionId === 'registros') {
                    if (window.carregarRegistrosRecentes) {
                        window.carregarRegistrosRecentes();
                    }
                } else if (sectionId === 'consulta') {
                    // Garantir que dados estejam carregados para consulta
                    console.log('üîç [TOGGLE] Se√ß√£o consulta expandida, verificando dados...');
                    console.log('üìä [TOGGLE] Estado atual todosAlunosMedidas:', window.todosAlunosMedidas ? window.todosAlunosMedidas.length : 'NULL/UNDEFINED');
                    if (!window.todosAlunosMedidas || window.todosAlunosMedidas.length === 0) {
                        console.log('üì¶ [TOGGLE] Dados vazios! For√ßando carregamento...');
                        if (window.carregarTurmasEAlunos) {
                            window.carregarTurmasEAlunos().then(() => {
                                console.log('‚úÖ [TOGGLE] Carregamento conclu√≠do via toggle');
                            }).catch(error => {
                                console.error('‚ùå [TOGGLE] Erro no carregamento:', error);
                            });
                        }
                    } else {
                        console.log('‚úÖ [TOGGLE] Dados j√° carregados:', window.todosAlunosMedidas.length, 'alunos');
                    }
                }
                // Removido carregamento autom√°tico das tabelas - s√≥ carrega quando clicar no bot√£o
            }
        }
        
        // Inicializar se√ß√µes colapsadas por padr√£o
        document.addEventListener('DOMContentLoaded', function() {
            const sections = ['alertas', 'medidas', 'consulta', 'registros', 'medidasNegativas', 'medidasPositivas'];
            sections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                const toggle = document.getElementById(sectionId + '-toggle');
                if (content && toggle) {
                    // Come√ßar colapsado
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                    toggle.textContent = 'üîº';
                }
            });
            
            // Inicializar sistema de prazos
            inicializarSistemaPrazos();
        });
        
        // MISS√ÉO 1.2: Sistema de sele√ß√£o m√∫ltipla de faltas
        let faltasSelecionadas = [];
        let categoriasSelecionadas = [];
        
        function carregarFaltasMultiplas(categoria) {
            const container = document.getElementById('faltasMultiContainer');
            const faltasTagsContainer = document.getElementById('faltasTagsContainer');
            const faltasSelecionadasDiv = document.getElementById('faltasSelecionadas');
            
            if (!container) return;
            
            // Limpar sele√ß√µes anteriores ao mudar categoria
            faltasSelecionadas = [];
            atualizarTagsFaltas();
            
            if (window.MEDIDAS_DISCIPLINARES && window.MEDIDAS_DISCIPLINARES[categoria]) {
                const medidas = window.MEDIDAS_DISCIPLINARES[categoria];
                
                container.innerHTML = medidas.map(medida => `
                    <div class="falta-option" onclick="toggleFalta('${medida}')">
                        <input type="checkbox" class="falta-checkbox" id="falta_${medida.replace(/\s+/g, '_')}" />
                        <label for="falta_${medida.replace(/\s+/g, '_')}">${medida}</label>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Faltas n√£o encontradas para esta categoria</div>';
            }
        }
        
        function toggleFalta(falta) {
            // Usar o mesmo padr√£o de ID que √© usado na cria√ß√£o dos checkboxes
            const checkbox = document.getElementById(`falta_${falta.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`);
            
            if (!checkbox) {
                console.warn('Checkbox n√£o encontrado para falta:', falta);
                return;
            }
            
            if (faltasSelecionadas.includes(falta)) {
                // Remover da sele√ß√£o
                faltasSelecionadas = faltasSelecionadas.filter(f => f !== falta);
                checkbox.checked = false;
            } else {
                // Adicionar √† sele√ß√£o
                faltasSelecionadas.push(falta);
                checkbox.checked = true;
            }
            
            atualizarTagsFaltas();
        }
        
        function removerFalta(falta) {
            faltasSelecionadas = faltasSelecionadas.filter(f => f !== falta);
            
            // Desmarcar checkbox se existir - usar mesmo padr√£o de ID
            const checkbox = document.getElementById(`falta_${falta.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            atualizarTagsFaltas();
        }
        
        function atualizarTagsFaltas() {
            const tagsContainer = document.getElementById('faltasTagsContainer');
            const faltasSelecionadasDiv = document.getElementById('faltasSelecionadas');
            const hiddenInput = document.getElementById('faltaEspecifica');
            
            if (faltasSelecionadas.length > 0) {
                tagsContainer.innerHTML = faltasSelecionadas.map(falta => 
                    `<span class="falta-tag" onclick="removerFalta('${falta}')">${falta}</span>`
                ).join('');
                
                faltasSelecionadasDiv.style.display = 'block';
                
                // Atualizar campo hidden para submiss√£o do formul√°rio
                hiddenInput.value = faltasSelecionadas.join('; ');
            } else {
                faltasSelecionadasDiv.style.display = 'none';
                hiddenInput.value = '';
            }
        }
        
        // Fun√ß√£o para calcular dias √∫teis (exclui s√°bados e domingos)
        function adicionarDiasUteis(data, diasUteis) {
            const resultado = new Date(data);
            let diasAdicionados = 0;
            
            while (diasAdicionados < diasUteis) {
                resultado.setDate(resultado.getDate() + 1);
                
                // Verificar se n√£o √© s√°bado (6) nem domingo (0)
                if (resultado.getDay() !== 0 && resultado.getDay() !== 6) {
                    diasAdicionados++;
                }
            }
            
            return resultado;
        }
        
        // MISS√ÉO 1.3: Sistema de controle de prazos
        function inicializarSistemaPrazos() {
            const prazoInput = document.getElementById('prazoAssinatura');
            if (prazoInput) {
                prazoInput.addEventListener('change', calcularStatusPrazo);
                
                // Calcular prazo autom√°tico baseado na data da medida
                const dataOcorrencia = document.getElementById('dataMedida').value;
                if (dataOcorrencia) {
                    calcularPrazoAutomatico(dataOcorrencia);
                } else {
                    // Fallback: usar data de hoje se n√£o houver data definida
                    calcularPrazoAutomatico(new Date().toISOString().split('T')[0]);
                }
            }
            
            // Atualizar prazo quando a data da medida mudar
            const dataMedidaInput = document.getElementById('dataMedida');
            if (dataMedidaInput) {
                dataMedidaInput.addEventListener('change', function() {
                    calcularPrazoAutomatico(this.value);
                });
            }
        }
        
        function calcularPrazoAutomatico(dataOcorrencia) {
            const prazoInput = document.getElementById('prazoAssinatura');
            if (!prazoInput || !dataOcorrencia) return;
            
            // Calcular 3 dias √∫teis a partir da data de ocorr√™ncia
            const dataBase = new Date(dataOcorrencia);
            const prazoCalculado = adicionarDiasUteis(dataBase, 3);
            
            // Definir o prazo calculado
            prazoInput.value = prazoCalculado.toISOString().split('T')[0];
            
            // Definir data m√≠nima como a data da ocorr√™ncia
            prazoInput.min = dataOcorrencia;
            
            // Recalcular status
            calcularStatusPrazo();
            
            console.log(`üìÖ Prazo autom√°tico: ${dataOcorrencia} + 3 dias √∫teis = ${prazoInput.value}`);
        }
        
        function calcularStatusPrazo() {
            const prazoInput = document.getElementById('prazoAssinatura');
            const statusDiv = document.getElementById('statusPrazo');
            const infoDiv = document.getElementById('diasRestantesInfo');
            
            if (!prazoInput.value) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const dataPrazo = new Date(prazoInput.value);
            dataPrazo.setHours(0, 0, 0, 0);
            
            const diffTime = dataPrazo - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let statusClass, statusTexto, statusIcon;
            
            if (diffDays < 0) {
                statusClass = 'vencido';
                statusTexto = `Prazo vencido h√° ${Math.abs(diffDays)} dia(s)`;
                statusIcon = 'üî¥';
            } else if (diffDays === 0) {
                statusClass = 'atencao';
                statusTexto = 'Vence hoje!';
                statusIcon = 'üü°';
            } else if (diffDays <= 2) {
                statusClass = 'atencao';
                statusTexto = `${diffDays} dia(s) restante(s)`;
                statusIcon = 'üü°';
            } else {
                statusClass = 'em-prazo';
                statusTexto = `${diffDays} dia(s) restante(s)`;
                statusIcon = 'üü¢';
            }
            
            statusDiv.className = `status-prazo ${statusClass}`;
            statusDiv.innerHTML = `${statusIcon} ${statusTexto}`;
            infoDiv.style.display = 'block';
        }
        
        // Integra√ß√£o com fun√ß√£o original - sele√ß√£o m√∫ltipla inteligente
        function carregarFaltasCategorizadas(categoria) {
            console.log('üéØ Carregando faltas categorizadas para:', categoria);
            
            if (!categoria) {
                categoria = document.getElementById('categoriaMedida').value;
            }
            
            const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
            const tipoMedida = document.getElementById('tipoMedida').value;
            
            console.log('Tipo de medida:', tipoMedida, 'Categoria:', categoria);
            
            if (categoria && categoria !== '') {
                campoSelecaoFalta.style.display = 'block';
                
                // Verificar se √© medida positiva ou negativa
                if (['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida)) {
                    // Para medidas positivas, usar sistema de op√ß√µes espec√≠ficas
                    carregarOpcoesPositivas(categoria, tipoMedida);
                } else {
                    // Para medidas disciplinares (negativas), usar sele√ß√£o m√∫ltipla
                    carregarFaltasMultiplas(categoria);
                }
            } else {
                campoSelecaoFalta.style.display = 'none';
                faltasSelecionadas = [];
                atualizarTagsFaltas();
            }
        }
        
        function carregarOpcoesPositivas(categoria, tipoMedida) {
            const container = document.getElementById('faltasMultiContainer');
            let opcoes = [];
            
            if (categoria === 'comportamento') {
                opcoes = [
                    'Demonstrou excel√™ncia em disciplina e respeito',
                    'Auxiliou colegas e demonstrou solidariedade',
                    'Apresentou-se impecavelmente uniformizado',
                    'Liderou atividades com responsabilidade',
                    'Manteve postura exemplar em forma√ß√£o'
                ];
            } else if (categoria === 'academico') {
                opcoes = [
                    'Excelente desempenho em avalia√ß√µes',
                    'Participa√ß√£o ativa e construtiva em aula',
                    'Entrega pontual de todas as atividades',
                    'Demonstrou evolu√ß√£o significativa no aprendizado'
                ];
            } else if (categoria === 'cidadania') {
                opcoes = [
                    'Demonstrou valores de cidadania exemplares',
                    'Participou ativamente em projetos comunit√°rios',
                    'Respeitou diversidade e inclus√£o',
                    'Demonstrou responsabilidade social'
                ];
            } else if (categoria === 'lideranca') {
                opcoes = [
                    'Exerceu lideran√ßa positiva e inspiradora',
                    'Mobilizou grupo para objetivos comuns',
                    'Demonstrou iniciativa e proatividade',
                    'Resolveu conflitos de forma madura'
                ];
            }
            
            if (opcoes.length > 0) {
                // Limpar sele√ß√µes anteriores
                faltasSelecionadas = [];
                atualizarTagsFaltas();
                
                container.innerHTML = opcoes.map(opcao => `
                    <div class="falta-option" onclick="toggleFalta('${opcao}')">
                        <input type="checkbox" class="falta-checkbox" id="falta_${opcao.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}" />
                        <label for="falta_${opcao.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}">${opcao}</label>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Op√ß√µes n√£o encontradas para esta categoria</div>';
            }
        }
        
        // Sistema de categorias m√∫ltiplas
        function toggleCategoria(categoria) {
            const checkbox = document.getElementById(`cat_${categoria}`);
            const group = checkbox.parentElement;
            
            if (categoriasSelecionadas.includes(categoria)) {
                // Remover categoria
                categoriasSelecionadas = categoriasSelecionadas.filter(c => c !== categoria);
                checkbox.checked = false;
                group.classList.remove('selected');
            } else {
                // Adicionar categoria
                categoriasSelecionadas.push(categoria);
                checkbox.checked = true;
                group.classList.add('selected');
            }
            
            // Recarregar faltas de todas as categorias selecionadas
            carregarFaltasMultiplasCategorias();
        }
        
        function carregarFaltasMultiplasCategorias() {
            const container = document.getElementById('faltasMultiContainer');
            
            if (categoriasSelecionadas.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Selecione pelo menos uma categoria acima...</div>';
                return;
            }
            
            let htmlContent = '';
            
            categoriasSelecionadas.forEach(categoria => {
                if (window.MEDIDAS_DISCIPLINARES && window.MEDIDAS_DISCIPLINARES[categoria]) {
                    const medidas = window.MEDIDAS_DISCIPLINARES[categoria];
                    const categoriaLabel = categoria === 'leves' ? 'Faltas Leves' : 
                                         categoria === 'medias' ? 'Faltas M√©dias' : 
                                         'Faltas Graves';
                    
                    htmlContent += `
                        <div class="categoria-secao">
                            <div class="categoria-header">
                                ${categoriaLabel} (${medidas.length} op√ß√µes)
                            </div>
                            <div class="categoria-faltas">
                                ${medidas.map(medida => `
                                    <div class="falta-option" onclick="toggleFalta('${medida}')">
                                        <input type="checkbox" class="falta-checkbox" id="falta_${medida.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}" ${faltasSelecionadas.includes(medida) ? 'checked' : ''} />
                                        <label for="falta_${medida.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}">${medida}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (htmlContent) {
                container.innerHTML = htmlContent;
            } else {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Nenhuma falta encontrada para as categorias selecionadas</div>';
            }
        }
        
        // Limpar todas as sele√ß√µes quando mudar o tipo de medida
        function limparSelecoesCategorias() {
            categoriasSelecionadas = [];
            faltasSelecionadas = [];
            
            // Desmarcar checkboxes de categorias
            ['leves', 'medias', 'graves'].forEach(cat => {
                const checkbox = document.getElementById(`cat_${cat}`);
                const group = checkbox?.parentElement;
                if (checkbox) {
                    checkbox.checked = false;
                    group?.classList.remove('selected');
                }
            });
            
            // Limpar container de faltas
            const container = document.getElementById('faltasMultiContainer');
            if (container) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Selecione uma ou mais categorias acima...</div>';
            }
            
            atualizarTagsFaltas();
        }
        
        // NOVAS FUNCIONALIDADES: Sistema de Hist√≥rico de Medidas
        
        // Vari√°veis para controle das tabelas
        let medidasNegativasData = [];
        let medidasPositivasData = [];
        let medidasNegativasFiltradas = [];
        let medidasPositivasFiltradas = [];
        
        // Fun√ß√£o para carregar medidas negativas
        async function carregarMedidasNegativas() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '‚è≥ Carregando...';
            
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Tipos de medidas consideradas negativas
                const tiposNegativos = [
                    'Fato Observado Negativo',
                    'Advert√™ncia Verbal',
                    'Advert√™ncia Escrita',
                    'Suspens√£o',
                    'A√ß√£o Educativa'
                ];
                
                const { data: medidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .in('tipo_medida', tiposNegativos)
                    .order('data', { ascending: false });
                
                if (error) throw error;
                
                medidasNegativasData = medidas || [];
                medidasNegativasFiltradas = [...medidasNegativasData];
                
                // Carregar turmas para filtro
                const turmas = [...new Set(medidasNegativasData.map(m => m.turma))].sort();
                console.log(`üè´ Turmas encontradas para negativas:`, turmas);
                
                // Esperar um pouco para garantir que o DOM esteja pronto
                setTimeout(() => {
                    preencherFiltroTurmas('filtroTurmaNegativas', turmas);
                }, 100);
                
                // Debug do carregamento
                console.log(`üì¶ DADOS CARREGADOS DO BANCO: ${medidasNegativasData.length} medidas negativas`);
                console.log('üì¶ Primeira medida como exemplo:', medidasNegativasData[0]);
                console.log('üì¶ √öltima medida como exemplo:', medidasNegativasData[medidasNegativasData.length - 1]);
                
                // Aplicar filtros (incluindo quantidade)
                aplicarFiltrosNegativas();
                showMessage(`‚úÖ ${medidasNegativasData.length} medidas negativas carregadas`, 'success');
                
            } catch (error) {
                console.error('Erro ao carregar medidas negativas:', error);
                showMessage('‚ùå Erro ao carregar medidas negativas: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // Fun√ß√£o para carregar medidas positivas  
        async function carregarMedidasPositivas() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '‚è≥ Carregando...';
            
            try {
                // Aguardar supabaseClient estar dispon√≠vel
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Tipos de medidas consideradas positivas
                const tiposPositivos = [
                    'Elogio Individual',
                    'Elogio Coletivo',
                    'Fato Observado Positivo'
                ];
                
                const { data: medidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .in('tipo_medida', tiposPositivos)
                    .order('data', { ascending: false });
                
                if (error) throw error;
                
                medidasPositivasData = medidas || [];
                medidasPositivasFiltradas = [...medidasPositivasData];
                
                // Carregar turmas para filtro
                const turmas = [...new Set(medidasPositivasData.map(m => m.turma))].sort();
                console.log(`üè´ Turmas encontradas para positivas:`, turmas);
                
                // Esperar um pouco para garantir que o DOM esteja pronto
                setTimeout(() => {
                    preencherFiltroTurmas('filtroTurmaPositivas', turmas);
                }, 100);
                
                // Aplicar filtros (incluindo quantidade)
                aplicarFiltrosPositivas();
                showMessage(`‚úÖ ${medidasPositivasData.length} medidas positivas carregadas`, 'success');
                
            } catch (error) {
                console.error('Erro ao carregar medidas positivas:', error);
                showMessage('‚ùå Erro ao carregar medidas positivas: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // Fun√ß√£o para preencher filtros de turma
        function preencherFiltroTurmas(selectId, turmas) {
            console.log(`üéØ Preenchendo filtro ${selectId} com turmas:`, turmas);
            const select = document.getElementById(selectId);
            if (!select) {
                console.error(`‚ùå Elemento ${selectId} n√£o encontrado`);
                return;
            }
            
            // Manter primeira op√ß√£o e adicionar turmas
            select.innerHTML = '<option value="todas">Todas as turmas</option>';
            turmas.forEach(turma => {
                select.innerHTML += `<option value="${turma}">${turma}</option>`;
            });
            console.log(`‚úÖ Filtro ${selectId} preenchido com ${turmas.length} turmas`);
        }
        
        // Fun√ß√£o para detectar categoria da falta
        function detectarCategoria(especificacao, observacao) {
            const texto = (especificacao + ' ' + (observacao || '')).toLowerCase();
            
            if (texto.includes('[falta grave]') || texto.includes('grave')) return 'grave';
            if (texto.includes('[falta m√©dia]') || texto.includes('media') || texto.includes('m√©dia')) return 'media';
            if (texto.includes('[falta leve]') || texto.includes('leve')) return 'leve';
            
            return 'geral';
        }
        
        // Fun√ß√£o para renderizar tabela de medidas negativas
        function renderizarTabelaMedidasNegativas() {
            const container = document.getElementById('tableMedidasNegativas');
            
            console.log(`üé® RENDERIZANDO TABELA: ${medidasNegativasFiltradas.length} medidas filtradas`);
            
            if (medidasNegativasFiltradas.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Nenhuma medida negativa encontrada</p>';
                return;
            }
            
            const html = `
                <table class="historico-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAllNegativas" onchange="selecionarTodasMedidasNegativas()">
                            </th>
                            <th class="codigo-cell">C√≥digo</th>
                            <th>Nome</th>
                            <th>Turma</th>
                            <th class="data-cell">Data</th>
                            <th class="tipo-cell">Tipo</th>
                            <th>Categoria</th>
                            <th>Falta/Especifica√ß√£o</th>
                            <th>A√ß√µes Tomadas</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${medidasNegativasFiltradas.map(medida => {
                            const categoria = detectarCategoria(medida.especificacao, medida.observacao);
                            return `
                                <tr>
                                    <td class="checkbox-cell">
                                        <input type="checkbox" class="medida-checkbox-negativa" value="${medida.id}">
                                    </td>
                                    <td class="codigo-cell">${medida.codigo_matricula}</td>
                                    <td>${medida.nome_completo}</td>
                                    <td>${medida.turma}</td>
                                    <td class="data-cell">${new Date(medida.data).toLocaleDateString('pt-BR')}</td>
                                    <td class="tipo-cell">${medida.tipo_medida}</td>
                                    <td><span class="categoria-badge ${categoria}">${categoria.toUpperCase()}</span></td>
                                    <td>${medida.especificacao}</td>
                                    <td>${medida.observacao || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Total:</strong> ${medidasNegativasFiltradas.length} medidas negativas
                </div>
            `;
            
            container.innerHTML = html;
            
            // Verificar se a tabela foi realmente renderizada
            const linhasTabela = container.querySelectorAll('tbody tr');
            console.log(`üîç TABELA RENDERIZADA: ${linhasTabela.length} linhas vis√≠veis no DOM`);
        }
        
        // Fun√ß√£o para renderizar tabela de medidas positivas
        function renderizarTabelaMedidasPositivas() {
            const container = document.getElementById('tableMedidasPositivas');
            
            if (medidasPositivasFiltradas.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Nenhuma medida positiva encontrada</p>';
                return;
            }
            
            const html = `
                <table class="historico-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAllPositivas" onchange="selecionarTodasMedidasPositivas()">
                            </th>
                            <th class="codigo-cell">C√≥digo</th>
                            <th>Nome</th>
                            <th>Turma</th>
                            <th class="data-cell">Data</th>
                            <th class="tipo-cell">Tipo</th>
                            <th>Elogio/Especifica√ß√£o</th>
                            <th>Observa√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${medidasPositivasFiltradas.map(medida => `
                            <tr>
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="medida-checkbox-positiva" value="${medida.id}">
                                </td>
                                <td class="codigo-cell">${medida.codigo_matricula}</td>
                                <td>${medida.nome_completo}</td>
                                <td>${medida.turma}</td>
                                <td class="data-cell">${new Date(medida.data).toLocaleDateString('pt-BR')}</td>
                                <td class="tipo-cell">${medida.tipo_medida}</td>
                                <td>${medida.especificacao}</td>
                                <td>${medida.observacao || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>Total:</strong> ${medidasPositivasFiltradas.length} medidas positivas
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Fun√ß√µes de filtro aprimoradas
        function aplicarFiltrosNegativas() {
            let dados = [...medidasNegativasData];
            console.log(`üîç Iniciando filtros - Total dados originais: ${dados.length}`);
            
            // Filtro por turma
            const turmaSelecionada = document.getElementById('filtroTurmaNegativas').value;
            if (turmaSelecionada !== 'todas') {
                dados = dados.filter(m => m.turma === turmaSelecionada);
                console.log(`üè´ Filtro turma (${turmaSelecionada}): ${dados.length} registros`);
            }
            
            // Filtro por pesquisa
            const pesquisa = document.getElementById('pesquisaNegativas').value.toLowerCase().trim();
            if (pesquisa) {
                dados = dados.filter(m => 
                    m.nome_completo.toLowerCase().includes(pesquisa) ||
                    m.codigo_matricula.toString().includes(pesquisa) ||
                    m.especificacao.toLowerCase().includes(pesquisa)
                );
                console.log(`üîç Filtro pesquisa (${pesquisa}): ${dados.length} registros`);
            }
            
            // Filtro por quantidade
            const quantidade = document.getElementById('quantidadeNegativas').value;
            console.log(`üìä Quantidade selecionada: "${quantidade}"`);
            if (quantidade !== 'todas') {
                const limite = parseInt(quantidade);
                dados = dados.slice(0, limite);
                console.log(`‚úÇÔ∏è Aplicando limite ${limite}: ${dados.length} registros`);
            } else {
                console.log(`‚ôæÔ∏è Sem limite - mantendo todos: ${dados.length} registros`);
            }
            
            medidasNegativasFiltradas = dados;
            console.log(`‚úÖ Filtros aplicados - Total final: ${medidasNegativasFiltradas.length}`);
            renderizarTabelaMedidasNegativas();
        }
        
        function aplicarFiltrosPositivas() {
            let dados = [...medidasPositivasData];
            console.log(`üîç [POSITIVAS] Iniciando filtros - Total dados originais: ${dados.length}`);
            
            // Filtro por turma
            const turmaSelecionada = document.getElementById('filtroTurmaPositivas').value;
            if (turmaSelecionada !== 'todas') {
                dados = dados.filter(m => m.turma === turmaSelecionada);
                console.log(`üè´ [POSITIVAS] Filtro turma (${turmaSelecionada}): ${dados.length} registros`);
            }
            
            // Filtro por pesquisa
            const pesquisa = document.getElementById('pesquisaPositivas').value.toLowerCase().trim();
            if (pesquisa) {
                dados = dados.filter(m => 
                    m.nome_completo.toLowerCase().includes(pesquisa) ||
                    m.codigo_matricula.toString().includes(pesquisa) ||
                    m.especificacao.toLowerCase().includes(pesquisa)
                );
                console.log(`üîç [POSITIVAS] Filtro pesquisa (${pesquisa}): ${dados.length} registros`);
            }
            
            // Filtro por quantidade
            const quantidade = document.getElementById('quantidadePositivas').value;
            console.log(`üìä [POSITIVAS] Quantidade selecionada: "${quantidade}"`);
            if (quantidade !== 'todas') {
                const limite = parseInt(quantidade);
                dados = dados.slice(0, limite);
                console.log(`‚úÇÔ∏è [POSITIVAS] Aplicando limite ${limite}: ${dados.length} registros`);
            } else {
                console.log(`‚ôæÔ∏è [POSITIVAS] Sem limite - mantendo todos: ${dados.length} registros`);
            }
            
            medidasPositivasFiltradas = dados;
            console.log(`‚úÖ [POSITIVAS] Filtros aplicados - Total final: ${medidasPositivasFiltradas.length}`);
            renderizarTabelaMedidasPositivas();
        }
        
        // Fun√ß√µes para limpar pesquisa
        function limparPesquisaNegativas() {
            document.getElementById('pesquisaNegativas').value = '';
            document.getElementById('filtroTurmaNegativas').value = 'todas';
            document.getElementById('quantidadeNegativas').value = '10';
            aplicarFiltrosNegativas();
        }
        
        function limparPesquisaPositivas() {
            document.getElementById('pesquisaPositivas').value = '';
            document.getElementById('filtroTurmaPositivas').value = 'todas';
            document.getElementById('quantidadePositivas').value = '10';
            aplicarFiltrosPositivas();
        }
        
        // Fun√ß√µes de sele√ß√£o
        function selecionarTodasMedidasNegativas() {
            const mainCheckbox = document.getElementById('selectAllNegativas');
            const checkboxes = document.querySelectorAll('.medida-checkbox-negativa');
            
            if (mainCheckbox && mainCheckbox.checked) {
                checkboxes.forEach(cb => cb.checked = true);
            } else {
                checkboxes.forEach(cb => cb.checked = false);
            }
        }
        
        function selecionarTodasMedidasPositivas() {
            const mainCheckbox = document.getElementById('selectAllPositivas');
            const checkboxes = document.querySelectorAll('.medida-checkbox-positiva');
            
            if (mainCheckbox && mainCheckbox.checked) {
                checkboxes.forEach(cb => cb.checked = true);
            } else {
                checkboxes.forEach(cb => cb.checked = false);
            }
        }
        
        // Fun√ß√£o de exporta√ß√£o (placeholder)
        function exportarMedidasSelecionadas(tipo) {
            const checkboxes = document.querySelectorAll(`.medida-checkbox-${tipo}:checked`);
            const selecionados = Array.from(checkboxes).map(cb => cb.value);
            
            if (selecionados.length === 0) {
                showMessage('‚ö†Ô∏è Selecione pelo menos uma medida para exportar', 'warning');
                return;
            }
            
            showMessage(`üìÑ Exportando ${selecionados.length} medidas ${tipo}...`, 'info');
            console.log(`Medidas ${tipo} selecionadas para exporta√ß√£o:`, selecionados);
            
            // TODO: Implementar exporta√ß√£o real (PDF, Excel, etc.)
        }
    </script>

</body>
</html>
