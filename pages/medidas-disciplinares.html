<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidas Disciplinares - Dashboard Disciplinar</title>
    <link rel="icon" type="image/jpeg" href="../assets/images/logo-escola.jpeg">
    <!-- Deploy test -->
    
    <!-- CSS Externos -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/modern-layout.css">
    
    <!-- Script para corrigir cor dos emojis nos títulos -->
    <script src="../assets/js/fix-emoji-titles.js"></script>
    
    <!-- Script para barra superior moderna -->
    <script src="../assets/js/modern-topbar.js"></script>
    
    <!-- APENAS SUPABASE -->
    <script src="../netlify-env.js" onerror="console.log('Variáveis do Netlify não encontradas')"></script>
    <script src="../assets/js/env-config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-only.js"></script>

    <!-- SISTEMA DE SELEÇÃO DE UNIDADE (Sede/Anexa) -->
    <script src="../assets/js/unidade-selector.js"></script>

    <!-- SISTEMA DE TURMAS DINÂMICAS -->
    <script src="../assets/js/turmas-dinamicas.js"></script>

    <!-- jsPDF para exportação em PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    
    <!-- Scripts de categoria de medidas -->
    <script src="../assets/js/medidas-categorias.js"></script>

    <!-- WhatsApp Sender Integration -->
    <script defer src="../assets/js/whatsapp-sender.js?v=20250923"></script>
    
    <!-- Estilos específicos para ficha disciplinar -->
    <style>
        /* ===== LAYOUT PRINCIPAL BASEADO EM RELATÓRIOS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #2c3e50;
            overflow-x: hidden;
        }
        
        /* Layout Principal */
        .main-layout {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar modernizada */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar-section {
            padding: 20px 0;
        }
        
        .sidebar-title {
            padding: 0 20px 15px 20px;
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #495057;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        
        .sidebar-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding-left: 25px;
        }
        
        .sidebar-item.active {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-left: 4px solid #667eea;
            font-weight: 600;
        }
        
        .sidebar-icon {
            margin-right: 12px;
            width: 20px;
            display: inline-block;
            text-align: center;
        }
        
        .sidebar-text {
            flex: 1;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
            overflow-y: auto;
        }
        
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Module title padrão - removido CSS customizado para usar o padrão do framework */
        
        /* Cards de estatísticas */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            font-size: 2.5em;
            opacity: 0.8;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        
        /* Seções principais com design moderno */
        .management-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .management-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .management-header h3 {
            font-size: 1.4em;
            font-weight: 600;
            margin: 0;
        }
        
        .management-content {
            padding: 30px;
        }
        
        /* Mobile responsividade */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .content-area {
                margin-left: 0;
            }
            
            .module-title {
                font-size: 1.8em;
                padding: 20px;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px;
            }
        }

        /* Sistema de expansão/colapso de seções */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            margin: 0;
        }
        
        .section-header:hover {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }
        
        .section-toggle {
            font-size: 1.2em;
            color: #007bff;
            transition: transform 0.3s ease;
            user-select: none;
        }
        
        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 0px;
            opacity: 0;
            transition: all 0.4s ease;
            overflow: hidden;
        }
        
        .section-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        
        .section-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .management-title {
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        /* Sistema de seleção múltipla de faltas */
        .faltas-multi-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }
        
        /* Tabelas de histórico - container com scroll */
        #tableMedidasNegativas, #tableMedidasPositivas {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .historico-table thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }
        
        .historico-table thead th {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            color: #333;
        }
        
        .historico-table tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        .historico-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .historico-table td {
            padding: 8px;
            vertical-align: top;
        }
        
        .falta-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .falta-option:hover {
            background: #f8f9fa;
        }
        
        .falta-option:last-child {
            border-bottom: none;
        }
        
        .falta-checkbox {
            margin-right: 8px;
        }
        
        .faltas-selecionadas {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .faltas-selecionadas-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .falta-tag {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px 4px 2px 0;
            cursor: pointer;
        }
        
        .falta-tag:hover {
            background: #dc3545;
        }
        
        .falta-tag::after {
            content: ' ✕';
            margin-left: 4px;
        }
        
        /* Status do prazo */
        .status-prazo {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        
        .status-prazo.em-prazo {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-prazo.atencao {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-prazo.vencido {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .form-help {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            display: block;
        }
        
        /* Sistema de categorias múltiplas */
        .categorias-container {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .categoria-group {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .categoria-group:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .categoria-group.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .categoria-checkbox {
            margin-right: 8px;
        }
        
        .categoria-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Seções de faltas por categoria */
        .categoria-secao {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .categoria-header {
            background: #f8f9fa;
            padding: 10px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
        }
        
        .categoria-faltas {
            padding: 10px;
        }

        /* Dados pessoais */
        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dado-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .dado-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .dado-valor {
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }
        
        /* Sistema de Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .loading-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            color: #666;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .loading-steps {
            text-align: left;
            margin-top: 20px;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 5px 0;
            font-size: 0.85em;
            color: #666;
        }
        
        .loading-step.active {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .loading-step.completed {
            color: #28a745;
        }
        
        .loading-step-icon {
            margin-right: 8px;
            width: 16px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Top Loading Bar */
        .top-loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            z-index: 9998;
            overflow: hidden;
        }
        
        .top-loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Componentes de Frequência */
        .frequencia-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .frequencia-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .frequencia-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .frequencia-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #17a2b8;
        }
        
        .frequencia-card.presenca-excelente {
            border-left-color: #28a745;
        }
        
        .frequencia-card.presenca-boa {
            border-left-color: #17a2b8;
        }
        
        .frequencia-card.presenca-regular {
            border-left-color: #ffc107;
        }
        
        .frequencia-card.presenca-baixa {
            border-left-color: #dc3545;
        }
        
        .frequencia-card-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .frequencia-card-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .frequencia-card-subtitle {
            font-size: 0.8em;
            color: #888;
        }
        
        .faltas-recentes {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .faltas-recentes-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .falta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #fff5f5;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #dc3545;
        }
        
        .falta-data {
            font-weight: 500;
            color: #dc3545;
        }
        
        .falta-info {
            font-size: 0.85em;
            color: #666;
        }
        
        .sem-faltas {
            text-align: center;
            padding: 20px;
            color: #28a745;
            font-weight: 500;
        }
        
        .ver-todas-faltas {
            display: block;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            color: #007bff;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .ver-todas-faltas:hover {
            background: #e9ecef;
        }
        
        .resumo-mensal {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .resumo-mensal-title {
            font-size: 1em;
            font-weight: bold;
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resumo-mensal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .resumo-mensal-stat {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .resumo-mensal-stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        
        .resumo-mensal-stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }

        /* Resumos */
        .faltas-resumo, .medidas-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .resumo-item {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .resumo-danger { background: linear-gradient(135deg, #dc3545, #e55565); color: white; }
        .resumo-warning { background: linear-gradient(135deg, #ffc107, #ffcd3c); color: #333; }
        .resumo-info { background: linear-gradient(135deg, #17a2b8, #3bc4db); color: white; }
        .resumo-secondary { background: linear-gradient(135deg, #6c757d, #868e96); color: white; }
        .resumo-success { background: linear-gradient(135deg, #28a745, #34ce57); color: white; }
        
        .resumo-numero {
            display: block;
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .resumo-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
            display: block;
        }
        
        /* Timeline de faltas */
        .faltas-timeline {
            margin-top: 20px;
        }
        
        .mes-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .mes-titulo {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            padding: 12px 20px;
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .faltas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .falta-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .falta-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .falta-simples {
            background: linear-gradient(135deg, #dc3545, #e55565);
            color: white;
        }
        
        .falta-controlada {
            background: linear-gradient(135deg, #ffc107, #ffcd3c);
            color: #333;
        }
        
        .atestado {
            background: linear-gradient(135deg, #17a2b8, #3bc4db);
            color: white;
        }
        
        .falta-icon {
            font-size: 1.8em;
            margin-right: 12px;
        }
        
        .falta-info {
            flex-grow: 1;
        }
        
        .falta-data {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 2px;
        }
        
        .falta-dia {
            font-size: 0.85em;
            opacity: 0.8;
            text-transform: capitalize;
        }
        
        .falta-tipo {
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .stat-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .stat-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .stat-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .stat-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
        
        .stat-icon {
            font-size: 2.5em;
            margin-right: 15px;
            opacity: 0.8;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        /* Breakdown */
        .breakdown-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .breakdown-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #495057;
        }
        
        .breakdown-value {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }
        
        /* Info boxes */
        .info-box {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .info-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .info-box h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        /* Medidas timeline */
        .medidas-timeline {
            margin-top: 20px;
        }
        
        .medida-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .medida-data {
            font-weight: bold;
            color: #495057;
            margin-right: 20px;
            min-width: 100px;
            font-size: 0.9em;
        }
        
        .medida-content {
            flex-grow: 1;
        }
        
        .medida-actions {
            margin-left: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .btn-excluir-medida {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .btn-excluir-medida:hover {
            background: #c82333;
            opacity: 1;
            transform: scale(1.1);
        }
        
        .medida-tipo {
            font-weight: bold;
            color: #dc3545;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        /* Medidas positivas - verde */
        .medida-item.positiva {
            border-left: 4px solid #28a745;
        }
        
        .medida-item.positiva .medida-tipo {
            color: #28a745;
        }
        
        /* Pontuação da medida */
        .medida-pontos {
            display: inline-block;
            margin-left: 10px;
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .medida-pontos.positivos {
            background: #d4edda;
            color: #155724;
        }
        
        .medida-pontos.negativos {
            background: #f8d7da;
            color: #721c24;
        }
        
        .medida-descricao {
            color: #495057;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .medida-providencias {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Registros recentes */
        .records-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .record-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .record-student {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }
        
        .record-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-details {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
        }
        
        .record-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .record-turma {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .record-description {
            color: #495057;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        /* Comparações */
        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .comparison-section h5 {
            margin: 0 0 15px 0;
            color: #495057;
            font-weight: 600;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .comparison-good {
            border-left-color: #28a745;
        }
        
        .comparison-alert {
            border-left-color: #dc3545;
        }
        
        .comparison-label {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }
        
        .comparison-value {
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 15px;
        }
        
        /* Nota Disciplinar */
        .disciplinary-score-card {
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .score-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .score-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-emoji {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .score-info .score-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .score-info .score-subtitle {
            font-size: 1.1em;
            font-weight: 600;
            opacity: 0.8;
        }
        
        .score-number {
            font-size: 3.5em;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 20px;
        }
        
        .score-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.95em;
            color: #495057;
            background: rgba(255,255,255,0.7);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid currentColor;
        }
        
        .score-details span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dados-grid, .faltas-grid, .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .disciplinary-score-card {
                padding: 20px;
            }
            
            .score-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .score-number {
                font-size: 2.5em;
                margin-left: 0;
            }
            
            .score-emoji {
                font-size: 2em;
            }
            
            .score-info .score-title {
                font-size: 1.2em;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .faltas-resumo, .medidas-resumo {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .breakdown-grid {
                grid-template-columns: 1fr;
            }
            
            .medida-item {
                flex-direction: column;
            }
            
            .medida-data {
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
        
        /* Estilos para alertas de prazo */
        .alerta-prazo {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .insight-content {
            flex: 1;
            margin-right: 15px;
        }
        
        .insight-detalhes {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .insight-prazo {
            font-size: 0.8em;
            color: #007bff;
            font-weight: bold;
            margin-top: 3px;
        }
        
        .insight-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .btn-marcar-entregue {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        .btn-marcar-entregue:hover {
            background: #218838;
        }
        
        .btn-marcar-entregue:active {
            transform: translateY(1px);
        }
        
        /* Responsividade para alertas */
        @media (max-width: 768px) {
            .alerta-prazo {
                flex-direction: column;
                gap: 10px;
            }
            
            .insight-content {
                margin-right: 0;
            }
            
            .insight-actions {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* Estilos para tabelas de histórico de medidas */
        .historico-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .historico-table th,
        .historico-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .historico-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .historico-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .historico-table .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        
        .historico-table .codigo-cell {
            width: 80px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .historico-table .data-cell {
            width: 90px;
        }
        
        .historico-table .tipo-cell {
            width: 120px;
        }
        
        .historico-table .categoria-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .categoria-badge.leve {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .categoria-badge.media {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .categoria-badge.grave {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .categoria-badge.positiva {
            background-color: #d4edda;
            color: #155724;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 15px;
            cursor: pointer;
        }
        
        .table-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .table-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .checkbox-label {
                margin: 5px 0;
            }
        }

        /* === ESTILOS DAS TABELAS === */
        .table-responsive {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 500px;
        }
        
        .table {
            width: 100%;
            margin-bottom: 0;
            color: #212529;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            vertical-align: middle;
            border-top: 1px solid #dee2e6;
            text-align: left;
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border-top: 0;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,123,255,0.05);
        }
        
        .table tbody tr:hover {
            background-color: rgba(0,123,255,0.1);
            cursor: pointer;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 4px;
        }
        
        .badge-danger {
            color: #fff;
            background-color: #dc3545;
        }
        
        .badge-success {
            color: #fff;
            background-color: #28a745;
        }
        
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .text-center {
            text-align: center !important;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        @media (max-width: 768px) {
            .table th,
            .table td {
                padding: 8px 4px;
                font-size: 14px;
            }
            
            .text-truncate {
                max-width: 150px;
            }
        }

        /* === ESTILOS DO PRAZO AUTOMÁTICO === */
        .prazo-automatico {
            background: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 5px;
        }
        
        .prazo-display {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #007bff;
            margin-bottom: 10px;
        }
        
        .prazo-display strong {
            color: #007bff;
            font-size: 16px;
        }

        /* Estilos para categorias múltiplas */
        .categorias-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .categoria-grupo {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .categoria-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .categoria-checkbox:hover {
            border-color: #007bff;
            background: #f0f7ff;
        }
        
        .categoria-checkbox input[type="checkbox"]:checked + span {
            color: #007bff;
            font-weight: 600;
        }
        
        .falta-checkbox {
            display: block;
            margin: 8px 0;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        
        .falta-checkbox:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .texto-instrucao {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <img src="../assets/images/logo-escola.jpeg" alt="Logo da Escola" class="top-bar-logo" style="height: 40px; margin-right: 15px; border-radius: 4px;">
            <div class="app-launcher">
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
            </div>
            <span class="app-name">Dashboard Disciplinar</span>
        </div>
        <div class="top-bar-center">
            <input type="text" class="search-box" placeholder="Pesquisar registros...">
        </div>
        <div class="top-bar-right">
            <div class="user-profile">A</div>
        </div>
    </div>

    <!-- LAYOUT PRINCIPAL -->
    <div class="main-layout">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Módulos Principais</div>
                
                <a href="../index.html" class="sidebar-item">
                    <span class="sidebar-icon">🏠</span>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                
                <a href="gestao-alunos.html" class="sidebar-item">
                    <span class="sidebar-icon">👥</span>
                    <span class="sidebar-text">Gestão de Alunos</span>
                </a>
                
                <a href="medidas-disciplinares.html" class="sidebar-item active">
                    <span class="sidebar-icon">📋</span>
                    <span class="sidebar-text">Medidas Disciplinares</span>
                </a>
                
                <a href="/pages/consulta-ficha.html" class="sidebar-item">
                    <span class="sidebar-icon">👤</span>
                    <span class="sidebar-text">Ficha Disciplinar</span>
                </a>
                
                <a href="frequencia.html" class="sidebar-item">
                    <span class="sidebar-icon">📅</span>
                    <span class="sidebar-text">Controle de Frequência</span>
                </a>

                <a href="/pages/boletim.html" class="sidebar-item"><span class="sidebar-icon">📚</span><span class="sidebar-text">Boletim Escolar</span></a>

                <a href="relatorios.html" class="sidebar-item">
                    <span class="sidebar-icon">📊</span>
                    <span class="sidebar-text">Relatórios</span>
                </a>
                
                <a href="analises.html" class="sidebar-item">
                    <span class="sidebar-icon">📈</span>
                    <span class="sidebar-text">Análises</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ferramentas</div>
                
                
                <a href="configuracoes.html" class="sidebar-item">
                    <span class="sidebar-icon">⚙️</span>
                    <span class="sidebar-text">Configurações</span>
                </a>
                
                <a href="/pages/comunicacao.html" class="sidebar-item">
                    <span class="sidebar-icon">📱</span>
                    <span class="sidebar-text">Comunicação</span>
                </a>
                
                <a href="login.html" class="sidebar-item">
                    <span class="sidebar-icon">🔐</span>
                    <span class="sidebar-text">Login/Logout</span>
                </a>
            </div>
        </div>

        <!-- ÁREA DE CONTEÚDO -->
        <div class="content-area">
            <div class="main-content">
                
                <!-- TÍTULO -->
                <div class="module-title">
                    📋 Medidas Disciplinares
                </div>

                <!-- SEÇÃO: ESTATÍSTICAS RÁPIDAS -->
                <div class="quick-stats">
                    <div class="stat-card stat-highlight" style="background: linear-gradient(135deg, #28a74520, #17a2b820); border: 2px solid #28a745;">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-content">
                            <div class="stat-number" id="mediaNotaEscola" style="color: #28a745;">0.0</div>
                            <div class="stat-label">Média Disciplinar da Escola</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">⚖️</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalMedidas">0</div>
                            <div class="stat-label">Total de Medidas</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-info">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasMes">0</div>
                            <div class="stat-label">Medidas este Mês</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-success">
                        <div class="stat-icon">📅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="medidasSemana">0</div>
                            <div class="stat-label">Medidas esta Semana</div>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-primary">
                        <div class="stat-icon">👥</div>
                        <div class="stat-content">
                            <div class="stat-number" id="alunosAfetados">0</div>
                            <div class="stat-label">Alunos com Medidas</div>
                        </div>
                    </div>
                </div>

                <!-- PAINEL DE ALERTAS -->
                <div class="management-section" id="painelAlertas">
                    <div class="section-header" onclick="toggleSection('alertas')">
                        <div class="management-title">
                            🚨 Alertas e Prioridades
                        </div>
                        <span class="section-toggle" id="alertas-toggle">🔽</span>
                    </div>
                    <div class="section-content" id="alertas-content">
                        <div id="alertasContainer">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Carregando alertas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO: MEDIDAS DISCIPLINARES -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidas')">
                        <div class="management-title">
                            ⚖️ Registrar Medida Disciplinar
                        </div>
                        <span class="section-toggle" id="medidas-toggle">🔽</span>
                    </div>
                    
                    <div class="section-content" id="medidas-content">
                        <form id="formMedida" onsubmit="salvarMedida(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Turma *</label>
                                <select id="turmaMedida" class="form-select" onchange="carregarAlunosPorTurmaMedida()" required>
                                    <option value="">Selecione a turma...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Turno *</label>
                                <select id="turnoMedida" class="form-select" required>
                                    <option value="">Selecione o turno...</option>
                                    <option value="Matutino">Matutino</option>
                                    <option value="Vespertino">Vespertino</option>
                                    <option value="Integral">Integral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aluno *</label>
                                <select id="alunoMedida" class="form-select" required disabled>
                                    <option value="">Primeiro selecione uma turma...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Data da Ocorrência *</label>
                                <input 
                                    type="date" 
                                    id="dataMedida" 
                                    class="form-input" 
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Medida *</label>
                                <select id="tipoMedida" class="form-select" onchange="configurarCamposMedida()" required>
                                    <option value="">Selecione...</option>
                                    <optgroup label="📈 Medidas Positivas">
                                        <option value="Elogio Individual">Elogio Individual (+0,5)</option>
                                        <option value="Elogio Coletivo">Elogio Coletivo (+0,3)</option>
                                        <option value="Fato Observado Positivo">Fato Observado Positivo (+0,1)</option>
                                    </optgroup>
                                    <optgroup label="📉 Medidas Disciplinares">
                                        <option value="Fato Observado Negativo">Fato Observado Negativo (-0,1)</option>
                                        <option value="Advertência Verbal">Advertência Verbal (-0,3)</option>
                                        <option value="Advertência Escrita">Advertência Escrita (-0,3)</option>
                                        <option value="Suspensão">Suspensão (-0,5 por dia)</option>
                                        <option value="Ação Educativa">Ação Educativa (-1,0)</option>
                                    </optgroup>
                                    <optgroup label="🔄 Medidas Educativas">
                                        <option value="Reunião com Responsáveis">Reunião com Responsáveis</option>
                                        <option value="Encaminhamento Coordenação">Encaminhamento à Coordenação</option>
                                        <option value="Trabalho Educativo">Trabalho Educativo</option>
                                        <option value="Acompanhamento Psicopedagógico">Acompanhamento Psicopedagógico</option>
                                        <option value="Outro">Outro</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <!-- Campos de categoria de faltas - inicialmente ocultos -->
                            
                            <div class="form-group form-group-full" id="campoSelecaoFalta" style="display: none;">
                                <label class="form-label">Selecionar Faltas Específicas *</label>
                                <div id="faltasMultiContainer" class="faltas-multi-container">
                                    <div style="padding: 20px; text-align: center; color: #666;">
                                        Primeiro selecione uma categoria...
                                    </div>
                                </div>
                                <div id="faltasSelecionadas" class="faltas-selecionadas" style="display: none;">
                                    <div class="faltas-selecionadas-title">Faltas selecionadas:</div>
                                    <div id="faltasTagsContainer"></div>
                                </div>
                                <!-- Hidden input para armazenar as faltas selecionadas -->
                                <input type="hidden" id="faltaEspecifica" name="faltasEspecificas" />
                            </div>
                            
                            <div class="form-group" id="campoSuspensao" style="display: none;">
                                <label class="form-label">Dias de Suspensão *</label>
                                <input 
                                    type="number" 
                                    id="diasSuspensao" 
                                    class="form-input" 
                                    min="1" 
                                    max="30"
                                    placeholder="Número de dias"
                                >
                            </div>
                            
                            <div class="form-group form-group-full" id="campoMotivoOriginal">
                                <label class="form-label">Motivo/Descrição *</label>
                                <textarea 
                                    id="motivoMedida" 
                                    class="form-textarea" 
                                    placeholder="Descreva detalhadamente o motivo da medida disciplinar..." 
                                    rows="4"
                                ></textarea>
                            </div>
                            
                            <div class="form-group" id="prazoAssinaturaInfo" style="display: none;">
                                <label class="form-label">📅 Prazo para Assinatura (Automático)</label>
                                <div class="prazo-automatico">
                                    <div class="prazo-display">
                                        <strong id="prazoDataDisplay">📅 Será calculado após selecionar a data</strong>
                                    </div>
                                    <small class="form-help">🤖 <strong>Automático:</strong> Sempre 3 dias úteis após a data de ocorrência</small>
                                </div>
                            </div>
                            
                            <div class="form-group" id="diasRestantesInfo" style="display: none;">
                                <label class="form-label">Status do Prazo</label>
                                <div id="statusPrazo" class="status-prazo">
                                    <!-- Será preenchido automaticamente -->
                                </div>
                            </div>
                            
                            <div class="form-group form-group-full">
                                <label class="form-label">Ações Tomadas</label>
                                <textarea 
                                    id="acoesMedida" 
                                    class="form-textarea" 
                                    placeholder="Descreva as ações tomadas ou que serão tomadas..." 
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        
                        <!-- Opção de envio automático por WhatsApp -->
                        <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500;">
                                <input type="checkbox" id="enviarWhatsAppAuto" style="transform: scale(1.2);">
                                📱 Enviar WhatsApp automaticamente aos responsáveis após salvar
                            </label>
                            <small style="color: #666; margin-left: 28px; display: block; margin-top: 4px;">
                                Notificação será enviada para o número cadastrado do responsável
                            </small>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="limparFormMedida()">
                                🔄 Limpar
                            </button>
                            <button type="submit" class="btn btn-warning" id="btnSalvarMedida">
                                ⚠️ Salvar Medida
                            </button>
                        </div>
                        </form>
                    </div>
                </div>


                <!-- SEÇÃO: REGISTROS RECENTES -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('registros')">
                        <div class="management-title">
                            📋 Registros Recentes
                        </div>
                        <span class="section-toggle" id="registros-toggle">🔼</span>
                    </div>
                    <div class="section-content" id="registros-content">
                        <div class="management-content">
                            <div class="table-actions">
                                <button class="btn btn-info btn-small" onclick="carregarRegistrosRecentes()">
                                    🔄 Atualizar
                                </button>
                                <select class="filter-select" onchange="filtrarRegistrosRecentes(this.value)">
                                    <option value="todos">Todos os tipos</option>
                                    <option value="faltas">Apenas Faltas</option>
                                    <option value="medidas">Apenas Medidas</option>
                                </select>
                                <button class="btn btn-secondary btn-small" onclick="exportarRegistros()">
                                    📊 Exportar
                                </button>
                            </div>
                            
                            <div id="registrosRecentes" class="table-content">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <p>Carregando registros recentes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO: HISTÓRICO DE MEDIDAS NEGATIVAS -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidasNegativas')">
                        <div class="management-title">
                            📊 Histórico de Medidas Disciplinares (Negativas)
                        </div>
                        <span class="section-toggle" id="medidasNegativas-toggle">🔼</span>
                    </div>
                    <div class="section-content" id="medidasNegativas-content">
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="carregarMedidasNegativas()">
                                📋 Carregar Medidas Negativas
                            </button>
                            <input type="text" id="pesquisaNegativas" class="form-input" placeholder="🔍 Pesquisar por nome ou código..." style="max-width: 250px;" oninput="aplicarFiltrosNegativas()">
                            <select class="filter-select" id="filtroTurmaNegativas" onchange="aplicarFiltrosNegativas()">
                                <option value="todas">Todas as turmas</option>
                            </select>
                            <select class="filter-select" id="quantidadeNegativas" onchange="aplicarFiltrosNegativas()">
                                <option value="10" selected>Últimas 10</option>
                                <option value="20">Últimas 20</option>
                                <option value="50">Últimas 50</option>
                                <option value="100">Últimas 100</option>
                                <option value="todas">Todas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="limparPesquisaNegativas()">
                                🧹 Limpar
                            </button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="selecionarTodasNegativas" onchange="selecionarTodasMedidasNegativas()">
                                Selecionar Todas
                            </label>
                            <button class="btn btn-success" onclick="exportarMedidasSelecionadas('negativas')">
                                📄 Exportar Selecionadas
                            </button>
                        </div>
                        <div id="tableMedidasNegativas" class="table-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                Clique em "📋 Carregar Medidas Negativas" para visualizar o histórico completo
                            </p>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO: HISTÓRICO DE MEDIDAS POSITIVAS -->
                <div class="management-section">
                    <div class="section-header" onclick="toggleSection('medidasPositivas')">
                        <div class="management-title">
                            🌟 Histórico de Medidas Disciplinares (Positivas)
                        </div>
                        <span class="section-toggle" id="medidasPositivas-toggle">🔼</span>
                    </div>
                    <div class="section-content" id="medidasPositivas-content">
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="carregarMedidasPositivas()">
                                🌟 Carregar Medidas Positivas
                            </button>
                            <input type="text" id="pesquisaPositivas" class="form-input" placeholder="🔍 Pesquisar por nome ou código..." style="max-width: 250px;" oninput="aplicarFiltrosPositivas()">
                            <select class="filter-select" id="filtroTurmaPositivas" onchange="aplicarFiltrosPositivas()">
                                <option value="todas">Todas as turmas</option>
                            </select>
                            <select class="filter-select" id="quantidadePositivas" onchange="aplicarFiltrosPositivas()">
                                <option value="10" selected>Últimas 10</option>
                                <option value="20">Últimas 20</option>
                                <option value="50">Últimas 50</option>
                                <option value="100">Últimas 100</option>
                                <option value="todas">Todas</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="limparPesquisaPositivas()">
                                🧹 Limpar
                            </button>
                            <label class="checkbox-label">
                                <input type="checkbox" id="selecionarTodasPositivas" onchange="selecionarTodasMedidasPositivas()">
                                Selecionar Todas
                            </label>
                            <button class="btn btn-warning" onclick="exportarMedidasSelecionadas('positivas')">
                                📄 Exportar Selecionadas
                            </button>
                        </div>
                        <div id="tableMedidasPositivas" class="table-content">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                Clique em "🌟 Carregar Medidas Positivas" para visualizar o histórico completo
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Sistema de Loading -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-title">Carregando Sistema</div>
            <div class="loading-subtitle">Preparando dados disciplinares...</div>
            
            <div class="progress-container">
                <div id="loadingProgressBar" class="progress-bar"></div>
            </div>
            <div id="loadingProgressText" class="progress-text">0%</div>
            
            <div class="loading-steps">
                <div id="loadingStep1" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Conectando ao banco de dados...</span>
                </div>
                <div id="loadingStep2" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Carregando lista de alunos...</span>
                </div>
                <div id="loadingStep3" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Calculando estatísticas...</span>
                </div>
                <div id="loadingStep4" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Carregando registros recentes...</span>
                </div>
                <div id="loadingStep5" class="loading-step">
                    <span class="loading-step-icon">⏳</span>
                    <span>Finalizando interface...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Loading Bar -->
    <div id="topLoadingBar" class="top-loading-bar" style="display: none;">
        <div id="topLoadingProgress" class="top-loading-progress"></div>
    </div>

    <!-- JAVASCRIPT -->
    
    <script src="../assets/js/main.js" defer></script>
    <script src="../assets/js/gestao.js" defer></script>
    
    <!-- Serviços de notas disciplinares e frequência -->
    <script type="module">
        import { getNotaDisciplinar, NotasUtils } from '../assets/js/notas-disciplinares.js';
        import { 
            getResumoAcumuladoAluno, 
            getFaltasAluno, 
            getResumoMensalAtualAluno,
            FrequenciaUtils 
        } from '../data/frequencia.js';
        
        // Tornar funções disponíveis globalmente
        window.getNotaDisciplinar = getNotaDisciplinar;
        window.NotasUtils = NotasUtils;
        window.getResumoAcumuladoAluno = getResumoAcumuladoAluno;
        window.getFaltasAluno = getFaltasAluno;
        window.getResumoMensalAtualAluno = getResumoMensalAtualAluno;
        window.FrequenciaUtils = FrequenciaUtils;
    </script>
    
    <script>
        // Sistema de Loading Inteligente
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loadingOverlay');
                this.topBar = document.getElementById('topLoadingBar');
                this.progressBar = document.getElementById('loadingProgressBar');
                this.progressText = document.getElementById('loadingProgressText');
                this.topProgress = document.getElementById('topLoadingProgress');
                this.currentStep = 0;
                this.totalSteps = 5;
                this.isVisible = false;
            }
            
            show(title = 'Carregando Sistema', subtitle = 'Preparando dados disciplinares...') {
                if (this.isVisible) return;
                
                document.querySelector('.loading-title').textContent = title;
                document.querySelector('.loading-subtitle').textContent = subtitle;
                
                this.overlay.style.display = 'flex';
                this.topBar.style.display = 'block';
                this.isVisible = true;
                this.currentStep = 0;
                this.updateProgress(0);
            }
            
            hide() {
                setTimeout(() => {
                    this.overlay.style.display = 'none';
                    this.topBar.style.display = 'none';
                    this.isVisible = false;
                }, 500);
            }
            
            updateProgress(percentage, stepText = null) {
                this.progressBar.style.width = percentage + '%';
                this.progressText.textContent = Math.round(percentage) + '%';
                this.topProgress.style.width = percentage + '%';
                
                if (stepText) {
                    const stepNumber = Math.ceil((percentage / 100) * this.totalSteps);
                    this.setStepActive(stepNumber, stepText);
                }
            }
            
            setStepActive(stepNumber, text = null) {
                // Limpar estados anteriores
                for (let i = 1; i <= this.totalSteps; i++) {
                    const step = document.getElementById(`loadingStep${i}`);
                    if (step) {
                        step.classList.remove('active', 'completed');
                        const icon = step.querySelector('.loading-step-icon');
                        if (i < stepNumber) {
                            step.classList.add('completed');
                            icon.textContent = '✅';
                        } else if (i === stepNumber) {
                            step.classList.add('active');
                            icon.textContent = '🔄';
                            if (text) {
                                step.querySelector('span:last-child').textContent = text;
                            }
                        } else {
                            icon.textContent = '⏳';
                        }
                    }
                }
            }
            
            async simulateProgress(duration = 2000) {
                const steps = [
                    { progress: 20, text: 'Conectando ao banco de dados...' },
                    { progress: 40, text: 'Carregando lista de alunos...' },
                    { progress: 60, text: 'Calculando estatísticas...' },
                    { progress: 80, text: 'Carregando registros recentes...' },
                    { progress: 100, text: 'Finalizando interface...' }
                ];
                
                for (let i = 0; i < steps.length; i++) {
                    await new Promise(resolve => {
                        setTimeout(() => {
                            this.updateProgress(steps[i].progress, steps[i].text);
                            resolve();
                        }, duration / steps.length);
                    });
                }
            }
        }
        
        // Instância global do loading
        window.loadingManager = new LoadingManager();
        
        // Inicialização da página com loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 Página de Medidas Disciplinares carregada');
            
            // Mostrar loading imediatamente
            window.loadingManager.show();
            
            // Inicializar sistema com progresso
            inicializarMedidasDisciplinaresComLoading();
        });

        // Carregar alunos para os selects dos formulários
        async function carregarSelectsAlunos() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`📚 Carregando alunos da unidade: ${unidadeAtual}`);

                // Carregar alunos FILTRADOS pela unidade
                const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma, unidade')
                    .eq('unidade', unidadeAtual)
                    .order('"Nome completo"');

                if (error) throw error;

                const alunos = alunosData.map(item => ({
                    id: item.codigo,
                    codigo: item.codigo,
                    nome: item['Nome completo'],
                    turma: item.turma,
                    foto_url: item.foto_url
                }));

                // Guardar dados para uso posterior
                window.alunosMedidasGlobal = alunos;

                // Preencher select de turmas
                const selectTurmaMedida = document.getElementById('turmaMedida');
                if (selectTurmaMedida) {
                    const turmasUnicas = [...new Set(alunos.map(aluno => aluno.turma))].sort();
                    selectTurmaMedida.innerHTML = '<option value="">Selecione a turma...</option>';
                    turmasUnicas.forEach(turma => {
                        selectTurmaMedida.innerHTML += `<option value="${turma}">${turma}</option>`;
                    });
                }

                // Select de alunos começa desabilitado
                const selectMedida = document.getElementById('alunoMedida');
                if (selectMedida) {
                    selectMedida.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                    selectMedida.disabled = true;
                }

            } catch (error) {
                console.error('❌ Erro ao carregar alunos para os selects:', error);
            }
        }

        // Função para carregar alunos por turma no formulário de medidas
        function carregarAlunosPorTurmaMedida() {
            const selectTurma = document.getElementById('turmaMedida');
            const selectAluno = document.getElementById('alunoMedida');
            
            if (!selectTurma || !selectAluno || !window.alunosMedidasGlobal) return;
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar seleção atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = window.alunosMedidasGlobal.filter(aluno => aluno.turma === turmaSelecionada);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                selectAluno.innerHTML += `<option value="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
        }

        // Controlar exibição do campo de suspensão e calcular prazo
        document.getElementById('tipoMedida').addEventListener('change', function() {
            const campoSuspensao = document.getElementById('campoSuspensao');
            const diasSuspensao = document.getElementById('diasSuspensao');

            if (this.value === 'Suspensão') {
                campoSuspensao.style.display = 'block';
                diasSuspensao.required = true;
            } else {
                campoSuspensao.style.display = 'none';
                diasSuspensao.required = false;
                diasSuspensao.value = '';
            }

            // Recalcular prazo quando tipo de medida muda
            if (typeof calcularPrazoAutomatico === 'function') {
                calcularPrazoAutomatico();
            }
        });

        // Função para salvar medida disciplinar
        async function salvarMedida(event) {
            event.preventDefault();
            
            const form = event.target;
            const btn = form.querySelector('button[type="submit"]');
            const alunoId = document.getElementById('alunoMedida').value;
            const turno = document.getElementById('turnoMedida').value;
            const tipoMedida = document.getElementById('tipoMedida').value;
            const data = document.getElementById('dataMedida').value;
            const motivo = document.getElementById('motivoMedida').value;
            let acoes = document.getElementById('acoesMedida').value;
            const diasSuspensao = document.getElementById('diasSuspensao').value;

            // Só definir prazo para medidas que requerem assinatura
            const medidasComPrazo = ['Advertência Verbal', 'Advertência Escrita', 'Suspensão', 'Ação Educativa'];
            const prazoAssinatura = medidasComPrazo.includes(tipoMedida) ? (window.prazoCalculado || null) : null;

            console.log('🔍 Debug prazo:', {
                tipoMedida,
                requerPrazo: medidasComPrazo.includes(tipoMedida),
                prazoCalculado: window.prazoCalculado,
                prazoFinal: prazoAssinatura
            });
            
            if (!alunoId) {
                alert('Selecione um aluno');
                return;
            }
            
            if (!tipoMedida) {
                alert('Selecione o tipo de medida');
                return;
            }
            
            if (tipoMedida === 'Suspensão' && !diasSuspensao) {
                alert('Informe o número de dias de suspensão');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Buscar dados do aluno do Supabase
                const { data: dadosAluno, error: alunoError } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma')
                    .eq('codigo', parseInt(alunoId))
                    .single();
                    
                if (alunoError || !dadosAluno) {
                    throw new Error('Aluno não encontrado');
                }
                
                // Preparar descrição da medida
                let especificacao = motivo;
                
                // Se faltas foram selecionadas, usar elas como especificação
                if (faltasSelecionadas && faltasSelecionadas.length > 0) {
                    especificacao = faltasSelecionadas.join(' | ');
                    console.log(`✅ Faltas selecionadas: ${especificacao}`);
                } else if (!motivo || motivo.trim() === '') {
                    // Se não há faltas selecionadas nem motivo, usar tipo da medida
                    especificacao = tipoMedida;
                }
                
                // Preparar dados base para salvar
                const dadosBase = {
                    codigo_matricula: dadosAluno.codigo.toString(),
                    nome_completo: dadosAluno['Nome completo'],
                    turma: dadosAluno.turma,
                    turno: turno,
                    data: data,
                    especificacao: especificacao,
                    observacao: acoes,
                    tipo_medida: tipoMedida,
                    criado_em: new Date().toISOString()
                };
                
                // Tentar incluir campos de prazo (se existirem no banco)
                if (prazoAssinatura) {
                    dadosBase.prazo_assinatura = prazoAssinatura;
                    dadosBase.prazo_status = 'pendente';
                }
                
                // Salvar medida diretamente no Supabase
                const { data: result, error: saveError } = await window.supabaseClient
                    .from('medidas')
                    .insert([dadosBase]);
                
                if (saveError) {
                    // Se erro é por causa das colunas de prazo, tentar sem elas
                    if (saveError.code === '42703' && prazoAssinatura) {
                        console.warn('⚠️ Salvando sem campos de prazo (colunas não existem)');
                        delete dadosBase.prazo_assinatura;
                        delete dadosBase.prazo_status;
                        
                        const { data: result2, error: saveError2 } = await window.supabaseClient
                            .from('medidas')
                            .insert([dadosBase]);
                            
                        if (saveError2) throw saveError2;
                        
                        showMessage('⚠️ Medida salva (prazo será registrado após configuração do banco)', 'warning');
                    } else {
                        throw saveError;
                    }
                }
                
                // ARMAZENAR DADOS ANTES DE LIMPAR FORMULÁRIO
                // Armazenar dados do aluno para WhatsApp
                window.ultimoAlunoSalvo = {
                    id: dadosAluno.codigo,
                    nome: dadosAluno['Nome completo'],
                    turma: dadosAluno.turma,
                    telefone1: dadosAluno['Telefone do responsável'] || dadosAluno['Telefone do responsável 2'] || null,
                    telefone2: null
                };

                // Armazenar dados da medida para WhatsApp
                window.ultimaMedidaSalva = {
                    tipo: tipoMedida,
                    especificacao: especificacao, // Usar especificação real que foi salva (faltas selecionadas ou motivo)
                    motivo: motivo,
                    providencias: acoes,
                    data: data || new Date().toISOString().split('T')[0] // Passar sempre no formato YYYY-MM-DD
                };

                console.log('📋 Dados da medida armazenados para WhatsApp:', window.ultimaMedidaSalva);

                // ⚡ VERIFICAR CHECKBOX ANTES DE LIMPAR FORMULÁRIO
                const checkboxElement = document.getElementById('enviarWhatsAppAuto');
                const enviarAuto = checkboxElement?.checked;

                console.log('🔍 Debug checkbox WhatsApp (ANTES do reset):', {
                    elemento: !!checkboxElement,
                    checked: enviarAuto,
                    valor: checkboxElement?.checked
                });

                // Atualizar nota disciplinar do aluno
                if (typeof window.atualizarNotaDisciplinar === 'function') {
                    await window.atualizarNotaDisciplinar(alunoId, dadosAluno);
                }

                // Limpar formulário
                form.reset();
                const campoSuspensao = document.getElementById('campoSuspensao');
                const diasSuspensao = document.getElementById('diasSuspensao');
                const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
                const campoMotivoOriginal = document.getElementById('campoMotivoOriginal');

                if (campoSuspensao) campoSuspensao.style.display = 'none';
                if (diasSuspensao) diasSuspensao.required = false;
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'none';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'block';

                // Mostrar mensagem de sucesso
                showMessage('✅ Medida disciplinar salva com sucesso!', 'success');

                // ✅ PROCESSAR ENVIO WHATSAPP (checkbox já verificado antes do reset)
                if (enviarAuto) {
                    // Enviar WhatsApp automaticamente
                    console.log('📱 ✅ CHECKBOX ESTAVA MARCADO - Enviando WhatsApp automaticamente...');
                    showMessage('📱 Enviando WhatsApp...', 'info');
                    setTimeout(() => {
                        console.log('📱 ⏰ Timeout executado - chamando enviarWhatsAppMedida()');
                        enviarWhatsAppMedida();
                    }, 1000); // Pequeno delay para garantir que dados estão prontos
                } else {
                    console.log('📱 ❌ CHECKBOX NÃO ESTAVA MARCADO - não enviando WhatsApp');
                }

                // Recarregar registros recentes
                await carregarRegistrosRecentes();
                
                // Recarregar estatísticas
                await carregarEstatisticasMedidas();
                
                // Recarregar alertas de prazo
                await carregarAlertasPrazo();
                
                // Se a ficha do aluno estiver aberta, recarregar
                if (window.dadosAlunoAtual && window.dadosAlunoAtual.id === alunoId) {
                    await carregarFichaDisciplinar();
                }
                
                // Mostrar nota disciplinar atualizada
                showMessage(`🎯 Medida registrada! Nota disciplinar atualizada.`, 'info');
                
            } catch (error) {
                console.error('Erro ao salvar medida:', error);
                alert('Erro ao salvar medida: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '⚠️ Salvar Medida';
            }
        }
        
        // Funções para gerenciar seleção de medidas categorizadas
        function configurarCamposMedida() {
            const tipoMedida = document.getElementById('tipoMedida').value;
            const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
            const campoMotivoOriginal = document.getElementById('campoMotivoOriginal');
            const selectCategoria = document.getElementById('categoriaMedida');
            const selectFalta = document.getElementById('faltaEspecifica');
            const textareaMotivo = document.getElementById('motivoMedida');

            // Controlar exibição do campo de prazo
            const campoPrazo = document.getElementById('prazoAssinaturaInfo');
            const campoStatusPrazo = document.getElementById('diasRestantesInfo');
            const medidasComPrazo = [
                'Advertência Verbal',
                'Advertência Escrita',
                'Suspensão',
                'Ação Educativa'
            ];

            // Controlar campo de prazo principal
            if (campoPrazo) {
                if (medidasComPrazo.includes(tipoMedida)) {
                    campoPrazo.style.display = 'block';
                    console.log(`✅ Campo de prazo exibido para: ${tipoMedida}`);
                } else {
                    campoPrazo.style.display = 'none';
                    console.log(`❌ Campo de prazo oculto para: ${tipoMedida}`);
                }
            }

            // Controlar campo de status do prazo
            if (campoStatusPrazo) {
                if (medidasComPrazo.includes(tipoMedida)) {
                    // Manter lógica existente para quando mostrar status
                    // (será controlado por outras funções conforme necessário)
                } else {
                    campoStatusPrazo.style.display = 'none';
                }
            }

            // Medidas que requerem seleção de falta categorizada
            const medidasComCategoria = [
                'Fato Observado Negativo',
                'Advertência Verbal',
                'Advertência Escrita',
                'Suspensão',
                'Ação Educativa'
            ];

            // Medidas positivas que também usam seleção de categoria
            const medidasPositivas = [
                'Elogio Individual',
                'Elogio Coletivo',
                'Fato Observado Positivo'
            ];
            
            if (medidasComCategoria.includes(tipoMedida)) {
                // Mostrar campos de categoria para medidas disciplinares (MÚLTIPLAS CATEGORIAS)
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'block';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'none';
                if (selectCategoria) selectCategoria.required = false; // Não usar o select antigo
                if (selectFalta) selectFalta.required = false; // Usar sistema de múltiplas categorias
                if (textareaMotivo) {
                    textareaMotivo.required = false;
                    textareaMotivo.removeAttribute('required');
                }
                
                // Esconder o select antigo de categoria (mantendo para compatibilidade)
                if (selectCategoria) {
                    selectCategoria.style.display = 'none';
                }
                
                // Limpar seleções múltiplas anteriores
                limparSelecoesCategorias();
                
                // Carregar interface de categorias múltiplas
                carregarFaltasMultiplasCategorias();
                
            } else if (medidasPositivas.includes(tipoMedida)) {
                // Para medidas positivas, mostrar seleção de situações específicas
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'block';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'none';
                if (selectCategoria) selectCategoria.style.display = 'none';
                if (selectFalta) selectFalta.required = false;
                if (textareaMotivo) {
                    textareaMotivo.required = false;
                    textareaMotivo.removeAttribute('required');
                }
                
                // Limpar seleções múltiplas
                limparSelecoesCategorias();
                
                // Carregar opções específicas para medidas positivas
                carregarOpcoesPositivas(tipoMedida);
                
            } else {
                // Para outras medidas, usar campo de texto tradicional
                if (campoSelecaoFalta) campoSelecaoFalta.style.display = 'none';
                if (campoMotivoOriginal) campoMotivoOriginal.style.display = 'block';
                if (selectCategoria) selectCategoria.required = false;
                if (selectFalta) selectFalta.required = false;
                if (textareaMotivo) {
                    textareaMotivo.required = true;
                    textareaMotivo.setAttribute('required', '');
                }
                
                // Mostrar select normal se estiver escondido
                if (selectCategoria) {
                    selectCategoria.style.display = 'block';
                }
                
                // Limpar seleções múltiplas
                limparSelecoesCategorias();
            }
            
            // Gerenciar campo de suspensão
            const campoSuspensao = document.getElementById('campoSuspensao');
            const diasSuspensao = document.getElementById('diasSuspensao');
            
            if (tipoMedida === 'Suspensão') {
                campoSuspensao.style.display = 'block';
                diasSuspensao.required = true;
            } else {
                campoSuspensao.style.display = 'none';
                diasSuspensao.required = false;
            }

            // Recalcular prazo quando campos de medida mudam
            setTimeout(() => {
                if (typeof calcularPrazoAutomatico === 'function') {
                    calcularPrazoAutomatico();
                }
            }, 100);
        }
        
        function carregarFaltasPorCategoria() {
            console.log('🎯 carregarFaltasPorCategoria() chamada');
            const categoria = document.getElementById('categoriaMedida').value;
            const selectFalta = document.getElementById('faltaEspecifica');
            const tipoMedida = document.getElementById('tipoMedida').value;
            const campoSelecaoFalta = document.getElementById('campoSelecaoFalta');
            
            if (!categoria) {
                // Limpar sistema de seleção múltipla
                const container = document.getElementById('faltasMultiContainer');
                if (container) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Primeiro selecione uma categoria...</div>';
                }
                faltasSelecionadas = [];
                atualizarTagsFaltas();
                return;
            }
            
            console.log('Tipo de medida:', tipoMedida, 'Categoria:', categoria);
            
            // Mostrar campo de seleção
            if (campoSelecaoFalta) {
                campoSelecaoFalta.style.display = 'block';
            }
            
            // Para medidas positivas, usar sistema de seleção múltipla
            if (['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida)) {
                carregarOpcoesPositivas(categoria, tipoMedida);
                return; // Sai da função aqui para evitar código duplicado
            }
            
            // Para medidas disciplinares (negativas), usar seleção múltipla de faltas
            if (['Fato Observado Negativo', 'Advertência Verbal', 'Advertência Escrita', 'Suspensão', 'Ação Educativa'].includes(tipoMedida)) {
                carregarFaltasMultiplas(categoria);
                return; // Sai da função aqui
            }
            
            // CÓDIGO ORIGINAL PRESERVADO PARA COMPATIBILIDADE:
            if (['Elogio Individual - ORIGINAL', 'Elogio Coletivo - ORIGINAL', 'Fato Observado Positivo - ORIGINAL'].includes(tipoMedida)) {
                let opcoes = '';
                
                if (categoria === 'comportamento') {
                    opcoes = `
                        <option value="Demonstrou excelência em disciplina e respeito">Demonstrou excelência em disciplina e respeito</option>
                        <option value="Auxiliou colegas e demonstrou solidariedade">Auxiliou colegas e demonstrou solidariedade</option>
                        <option value="Apresentou-se impecavelmente uniformizado">Apresentou-se impecavelmente uniformizado</option>
                        <option value="Liderou atividades com responsabilidade">Liderou atividades com responsabilidade</option>
                        <option value="Manteve postura exemplar em formação">Manteve postura exemplar em formação</option>
                    `;
                } else if (categoria === 'academico') {
                    opcoes = `
                        <option value="Excelente desempenho em avaliações">Excelente desempenho em avaliações</option>
                        <option value="Participação ativa e construtiva em aula">Participação ativa e construtiva em aula</option>
                        <option value="Entrega pontual de todas as atividades">Entrega pontual de todas as atividades</option>
                        <option value="Demonstrou evolução significativa no aprendizado">Demonstrou evolução significativa no aprendizado</option>
                    `;
                } else if (categoria === 'cidadania') {
                    opcoes = `
                        <option value="Participou ativamente de ações cívicas">Participou ativamente de ações cívicas</option>
                        <option value="Demonstrou respeito aos símbolos nacionais">Demonstrou respeito aos símbolos nacionais</option>
                        <option value="Promoveu ações de cidadania na escola">Promoveu ações de cidadania na escola</option>
                        <option value="Colaborou com a manutenção do patrimônio escolar">Colaborou com a manutenção do patrimônio escolar</option>
                    `;
                }
                
                selectFalta.innerHTML = `
                    <option value="">Selecione o motivo do elogio...</option>
                    ${opcoes}
                    <option value="outro">Outro (especificar nas observações)</option>
                `;
                
            } else {
                // Para medidas disciplinares, usar as faltas categorizadas
                if (window.MEDIDAS_DISCIPLINARES && window.MEDIDAS_DISCIPLINARES[categoria]) {
                    const medidas = window.MEDIDAS_DISCIPLINARES[categoria];
                    
                    selectFalta.innerHTML = `
                        <option value="">Selecione a falta específica...</option>
                        ${medidas.map(medida => `<option value="${medida}">${medida}</option>`).join('')}
                    `;
                } else {
                    selectFalta.innerHTML = '<option value="">Erro ao carregar faltas da categoria</option>';
                }
            }
        }

        // Nova função de inicialização com sistema de loading
        async function inicializarMedidasDisciplinaresComLoading() {
            try {
                // ETAPA 1: Conectar ao banco (20%)
                window.loadingManager.updateProgress(10, 'Conectando ao banco de dados...');
                
                // Verificar se sistema Supabase está pronto
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                window.loadingManager.updateProgress(20, 'Conectado ao banco de dados');
                
                // ETAPA 2: Carregar lista de alunos (40%)
                window.loadingManager.updateProgress(25, 'Carregando lista de alunos...');
                
                // Definir data atual no formulário
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) dataMedida.value = hoje;
                
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                window.loadingManager.updateProgress(40, 'Alunos carregados com sucesso');
                
                // ETAPA 3: Calcular estatísticas (60%)
                window.loadingManager.updateProgress(45, 'Calculando estatísticas...');
                await carregarEstatisticasMedidas();
                window.loadingManager.updateProgress(60, 'Estatísticas calculadas');
                
                // ETAPA 4: Carregar registros recentes (80%)
                window.loadingManager.updateProgress(65, 'Carregando registros recentes...');
                await carregarRegistrosRecentes();
                window.loadingManager.updateProgress(80, 'Registros carregados');
                
                // ETAPA 5: Finalizar interface (100%)
                window.loadingManager.updateProgress(85, 'Configurando alertas...');
                
                // Carregar alertas em background
                await carregarAlertasPrazo();
                
                window.loadingManager.updateProgress(95, 'Finalizando interface...');
                
                // Pequena pausa para mostrar conclusão
                await new Promise(resolve => setTimeout(resolve, 500));
                
                window.loadingManager.updateProgress(100, 'Sistema carregado com sucesso!');
                
                // Aguardar um pouco antes de esconder
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Esconder loading
                window.loadingManager.hide();
                
                
            } catch (error) {
                console.error('❌ Erro ao inicializar sistema:', error);
                window.loadingManager.updateProgress(100, 'Erro no carregamento - verifique a conexão');
                
                // Esconder loading após erro
                setTimeout(() => {
                    window.loadingManager.hide();
                    showMessage('Erro ao carregar sistema. Recarregue a página.', 'error');
                }, 2000);
            }
        }

        // Função de inicialização otimizada com carregamento progressivo (ANTIGA - mantida como backup)
        async function inicializarMedidasDisciplinares() {
            try {
                showMessage('Carregando módulo de medidas...', 'success');
                
                // Definir data atual no formulário de medidas (operação rápida)
                const hoje = new Date().toISOString().split('T')[0];
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) {
                    dataMedida.value = hoje;
                }
                
                // Verificar se sistema Supabase está pronto
                if (!window.supabaseClient) {
                    showMessage('⚠️ Supabase não conectado - aguardando...', 'warning');
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 200);
                    });
                }
                
                // ETAPA 1: Carregamento essencial (rápido)
                showMessage('📋 Carregando interface básica...', 'info');
                await Promise.all([
                    carregarSelectsAlunos(),
                    carregarTurmasEAlunos()
                ]);
                
                showMessage('✅ Interface pronta! Carregando dados em background...', 'success');
                
                // ETAPA 2: Carregamento em background (não bloqueia)
                setTimeout(async () => {
                    try {
                        // Carregar estatísticas em background
                        await carregarEstatisticasMedidas();
                        
                        // Carregar registros recentes em background
                        await carregarRegistrosRecentes();
                        
                        // Carregar alertas em background
                        // Carregar alertas de prazo
                        await carregarAlertasPrazo();
                        
                        console.log('✅ Carregamento completo finalizado');
                    } catch (error) {
                        console.warn('Erro no carregamento em background:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro ao inicializar medidas:', error);
                showMessage('Erro ao carregar módulo de medidas', 'error');
            }
        }

        // Carregar alertas
        async function carregarAlertas() {
            const container = document.getElementById('alertasContainer');
            
            try {
                const alertas = [];
                
                // Verificar alunos com muitas medidas
                const limiteMedidas = parseInt(localStorage.getItem('limiteMedidas') || '5');
                
                // Buscar alunos com muitas medidas usando as views
                try {
                    const { data: alunosRisco, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .lt('nota_atual', 7.0); // Alunos com nota baixa
                    
                    if (!error && alunosRisco) {
                        alunosRisco.forEach(aluno => {
                            let tipo = 'warning';
                            let icone = '⚠️';
                            let texto = '';
                            
                            if (aluno.nota_atual < 5.0) {
                                tipo = 'danger';
                                icone = '🚨';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota CRÍTICA: ${aluno.nota_atual.toFixed(2)}`;
                            } else if (aluno.nota_atual < 6.0) {
                                tipo = 'warning';
                                icone = '⚠️';
                                texto = `${aluno.nome_completo} (${aluno.turma}) - Nota BAIXA: ${aluno.nota_atual.toFixed(2)}`;
                            }
                            
                            if (texto) {
                                alertas.push({ tipo, icone, texto, alunoId: aluno.codigo_aluno });
                            }
                        });
                    }
                } catch (error) {
                    console.warn('Erro ao buscar alunos de risco:', error);
                }
                
                // Verificar se há medidas registradas hoje
                const hoje = new Date().toISOString().split('T')[0];
                try {
                    if (window.db) {
                        const medidasHoje = await window.db.collection('medidas_disciplinares')
                            .get();
                        
                        let contadorHoje = 0;
                        medidasHoje.forEach(doc => {
                            const data = doc.data();
                            const dataMedida = data.data ? data.data.split('T')[0] : null;
                            if (dataMedida === hoje) {
                                contadorHoje++;
                            }
                        });
                        
                        if (contadorHoje > 5) {
                            alertas.push({
                                tipo: 'info',
                                icone: '📊',
                                texto: `${contadorHoje} medidas registradas hoje - dia movimentado`
                            });
                        }
                    }
                } catch (error) {
                    console.log('Erro ao verificar medidas de hoje:', error);
                }
                
                // Exibir alertas
                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-text">✅ Nenhum alerta no momento - situação sob controle</div>
                            <span class="trend-indicator trend-down">📉 Positivo</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = alertas.map(alerta => `
                        <div class="insight-item" ${alerta.alunoId ? `style="cursor: pointer;" onclick="destacarAluno('${alerta.alunoId}')"` : ''}>
                            <div class="insight-text">${alerta.icone} ${alerta.texto}</div>
                            <span class="trend-indicator trend-${alerta.tipo === 'danger' ? 'up' : alerta.tipo === 'warning' ? 'stable' : 'down'}">
                                ${alerta.tipo === 'danger' ? '🚨 Crítico' : alerta.tipo === 'warning' ? '⚠️ Atenção' : 'ℹ️ Info'}
                            </span>
                        </div>
                    `).join('');
                }
                
                console.log(`🚨 ${alertas.length} alerta(s) carregado(s)`);
                
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-text">⚠️ Erro ao carregar alertas</div>
                        <span class="trend-indicator trend-up">❌ Erro</span>
                    </div>
                `;
            }
        }

        // Sistema de Nota Disciplinar
        // REMOVIDO: Função calcularNotaDisciplinar
        // Substituída pelas views v_nota_disciplinar_atual e v_nota_disciplinar_contadores
        
        async function obterNotaDisciplinar(codigoAluno) {
            try {
                // Usar o serviço importado se disponível
                if (window.getNotaDisciplinar) {
                    return await window.getNotaDisciplinar(codigoAluno);
                }
                
                // Fallback para implementação direta
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const { data, error } = await window.supabaseClient
                    .from('v_nota_disciplinar_atual')
                    .select('*')
                    .eq('codigo_aluno', codigoAluno)
                    .limit(1);

                if (error) {
                    console.warn('Erro ao obter nota disciplinar:', error);
                    return { data: null, error };
                }

                return { data: data?.[0] || null, error: null };
            } catch (error) {
                console.error('Erro ao consultar nota disciplinar:', error);
                return { data: null, error };
            }
        }
        
        function obterMencaoDisciplinar(nota) {
            if (nota >= 10) return { mencao: 'Excepcional', cor: '#28a745', emoji: '⭐' };
            if (nota >= 9) return { mencao: 'Ótimo', cor: '#17a2b8', emoji: '😊' };
            if (nota >= 7) return { mencao: 'Bom', cor: '#ffc107', emoji: '🙂' };
            if (nota >= 5) return { mencao: 'Regular', cor: '#fd7e14', emoji: '😐' };
            if (nota >= 2) return { mencao: 'Insuficiente', cor: '#dc3545', emoji: '😟' };
            return { mencao: 'Incompatível', cor: '#6c757d', emoji: '😨' };
        }

        // Função para destacar aluno na busca (placeholder)
        function destacarAluno(alunoId) {
            console.log('Destacando aluno:', alunoId);
            showMessage(`Aluno ${alunoId} selecionado`, 'info');
        }

        // Carregar alertas de prazos de assinatura
        async function carregarAlertasPrazo() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);

                // Buscar medidas com prazo de assinatura pendente
                let medidasComPrazo = [];
                
                try {
                    const { data, error } = await window.supabaseClient
                        .from('medidas')
                        .select('id, codigo_matricula, nome_completo, tipo_medida, especificacao, prazo_assinatura, prazo_status, data')
                        .not('prazo_assinatura', 'is', null)
                        .neq('prazo_status', 'entregue')
                        .in('tipo_medida', ['Advertência Verbal', 'Advertência Escrita', 'Suspensão', 'Ação Educativa'])
                        .order('prazo_assinatura', { ascending: true });

                    if (error) {
                        // Se as colunas não existem, mostrar alerta amigável
                        if (error.code === '42703') {
                            console.warn('⚠️ Colunas de prazo não encontradas no banco.');
                            console.log(`
💡 Para ativar os alertas de prazo, execute este SQL no Supabase:

ALTER TABLE medidas
ADD COLUMN IF NOT EXISTS prazo_assinatura date,
ADD COLUMN IF NOT EXISTS prazo_status text default 'pendente',
ADD COLUMN IF NOT EXISTS prazo_entregue_em timestamp;

-- Definir prazo de 3 dias úteis para medidas já existentes
UPDATE medidas
SET prazo_assinatura = (data + interval '3 days')::date
WHERE prazo_assinatura IS NULL
  AND tipo_medida IN ('Advertência Verbal', 'Advertência Escrita', 'Suspensão', 'Ação Educativa');
                            `);
                            await atualizarContainerAlertas([{
                                tipo: 'warning',
                                icone: '⚙️',
                                texto: 'Sistema de alertas de prazo em configuração',
                                detalhes: 'Verifique o console para instruções de ativação'
                            }]);
                            return;
                        }
                        throw error;
                    }
                    
                    medidasComPrazo = data || [];
                    
                } catch (error) {
                    console.warn('Erro ao buscar prazos:', error);
                    // Mostrar mensagem amigável em caso de erro
                    await atualizarContainerAlertas([{
                        tipo: 'info',
                        icone: 'ℹ️',
                        texto: 'Sistema de alertas de prazo em configuração',
                        detalhes: 'As funcionalidades de prazo estarão disponíveis após a configuração do banco'
                    }]);
                    return;
                }

                const alertasPrazo = [];

                // Processar cada medida com prazo
                medidasComPrazo?.forEach(medida => {
                    const dataPrazo = new Date(medida.prazo_assinatura);
                    dataPrazo.setHours(0, 0, 0, 0);
                    
                    const diffTime = dataPrazo - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let statusTexto, statusIcon, prioridade;
                    
                    if (diffDays < 0) {
                        // Vencido
                        statusTexto = `Prazo vencido há ${Math.abs(diffDays)} dia(s)`;
                        statusIcon = '🔴';
                        prioridade = 'danger';
                    } else if (diffDays === 0) {
                        // Vence hoje
                        statusTexto = 'Prazo vence hoje!';
                        statusIcon = '🟡';
                        prioridade = 'warning';
                    } else if (diffDays <= 2) {
                        // Vence em 1-2 dias
                        statusTexto = `Prazo em ${diffDays} dia(s)`;
                        statusIcon = '🟠';
                        prioridade = 'warning';
                    } else {
                        // Em prazo normal
                        statusTexto = `Prazo em ${diffDays} dia(s)`;
                        statusIcon = '🟢';
                        prioridade = 'info';
                    }
                    
                    alertasPrazo.push({
                        id: medida.id,
                        tipo: prioridade,
                        icone: statusIcon,
                        texto: `${medida.nome_completo} - ${medida.tipo_medida}: ${statusTexto}`,
                        detalhes: medida.especificacao,
                        diasRestantes: diffDays,
                        alunoId: medida.codigo_matricula,
                        prazoData: medida.prazo_assinatura
                    });
                });

                // Ordenar por prioridade (vencidos primeiro, depois por proximidade)
                alertasPrazo.sort((a, b) => {
                    if (a.diasRestantes < 0 && b.diasRestantes >= 0) return -1;
                    if (b.diasRestantes < 0 && a.diasRestantes >= 0) return 1;
                    return a.diasRestantes - b.diasRestantes;
                });

                // Atualizar container de alertas com os prazos
                await atualizarContainerAlertas(alertasPrazo);

            } catch (error) {
                console.error('Erro ao carregar alertas de prazo:', error);
            }
        }
        
        // Atualizar container de alertas incluindo prazos e outros alertas
        async function atualizarContainerAlertas(alertasPrazo = []) {
            const container = document.getElementById('alertasContainer');
            
            try {
                // Carregar outros alertas existentes (da função original)
                const outrosAlertas = await obterOutrosAlertas();
                
                // Combinar todos os alertas
                const todosAlertas = [...alertasPrazo, ...outrosAlertas];
                
                if (todosAlertas.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-text">✅ Nenhum alerta no momento - situação sob controle</div>
                            <span class="trend-indicator trend-down">📉 Positivo</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = todosAlertas.map(alerta => {
                        const botaoEntregue = alerta.id ? 
                            `<button class="btn-marcar-entregue" onclick="marcarPrazoEntregue(${alerta.id})" title="Marcar como entregue">
                                ✅ Entregue
                            </button>` : '';
                        
                        return `
                            <div class="insight-item alerta-prazo" ${alerta.alunoId ? `style="cursor: pointer;" onclick="destacarAluno('${alerta.alunoId}')"` : ''}>
                                <div class="insight-content">
                                    <div class="insight-text">${alerta.icone} ${alerta.texto}</div>
                                    ${alerta.detalhes ? `<div class="insight-detalhes">${alerta.detalhes}</div>` : ''}
                                    ${alerta.prazoData ? `<div class="insight-prazo">Prazo: ${new Date(alerta.prazoData).toLocaleDateString('pt-BR')}</div>` : ''}
                                </div>
                                <div class="insight-actions">
                                    <span class="trend-indicator trend-${alerta.tipo === 'danger' ? 'up' : alerta.tipo === 'warning' ? 'stable' : 'down'}">
                                        ${alerta.tipo === 'danger' ? '🚨 Crítico' : alerta.tipo === 'warning' ? '⚠️ Atenção' : 'ℹ️ Info'}
                                    </span>
                                    ${botaoEntregue}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                console.log(`📋 ${todosAlertas.length} alerta(s) carregado(s) (${alertasPrazo.length} de prazos)`);
                
            } catch (error) {
                console.error('Erro ao atualizar container de alertas:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-text">⚠️ Erro ao carregar alertas</div>
                        <span class="trend-indicator trend-up">❌ Erro</span>
                    </div>
                `;
            }
        }
        
        // Obter outros alertas (da função original)
        async function obterOutrosAlertas() {
            const alertas = [];
            
            try {
                // Verificar alunos com nota baixa
                const { data: alunosRisco, error } = await window.supabaseClient
                    .from('v_nota_disciplinar_atual')
                    .select('*')
                    .lt('nota_atual', 7.0)
                    .limit(5);

                if (!error && alunosRisco?.length > 0) {
                    alunosRisco.forEach(aluno => {
                        // Detectar o nome correto (pode variar entre campos)
                        const nomeAluno = aluno.nome_aluno || aluno.nome_completo || aluno['Nome completo'] || 'Nome não encontrado';
                        const turmaAluno = aluno.turma || 'Turma não informada';
                        const codigoAluno = aluno.codigo_aluno || aluno.codigo_matricula || aluno.codigo;
                        
                        alertas.push({
                            tipo: 'warning',
                            icone: '⚠️',
                            texto: `${nomeAluno} (${turmaAluno}) - Nota disciplinar baixa: ${aluno.nota_atual?.toFixed(1)}`,
                            alunoId: codigoAluno
                        });
                    });
                }
            } catch (error) {
                console.warn('Erro ao obter alertas de nota:', error);
            }
            
            return alertas;
        }
        
        // Marcar prazo como entregue
        async function marcarPrazoEntregue(medidaId) {
            try {
                const { error } = await window.supabaseClient
                    .from('medidas')
                    .update({
                        prazo_status: 'entregue',
                        prazo_entregue_em: new Date().toISOString()
                    })
                    .eq('id', medidaId);

                if (error) throw error;

                showMessage('✅ Prazo marcado como entregue!', 'success');
                
                // Recarregar alertas
                await carregarAlertasPrazo();
                
            } catch (error) {
                console.error('Erro ao marcar prazo como entregue:', error);
                alert('Erro ao marcar prazo como entregue: ' + error.message);
            }
        }

        // Carregar estatísticas de medidas disciplinares
        async function carregarEstatisticasMedidas() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`📊 [ESTATÍSTICAS] Carregando estatísticas da unidade: ${unidadeAtual}`);

                // Buscar códigos dos alunos da unidade atual
                const { data: alunosDaUnidade, error: errorAlunos } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo')
                    .eq('unidade', unidadeAtual);

                if (errorAlunos) throw errorAlunos;

                const codigosDaUnidade = alunosDaUnidade?.map(a => a.codigo) || [];

                if (codigosDaUnidade.length === 0) {
                    console.warn('⚠️ Nenhum aluno encontrado na unidade selecionada');
                    // Zerar estatísticas
                    document.getElementById('totalMedidas').textContent = '0';
                    document.getElementById('medidasMes').textContent = '0';
                    document.getElementById('medidasSemana').textContent = '0';
                    document.getElementById('alunosAfetados').textContent = '0';
                    document.getElementById('mediaNotaEscola').textContent = '8.0';
                    return;
                }

                // Carregar medidas APENAS dos alunos da unidade
                const { data: todasMedidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('id, codigo_matricula, criado_em')
                    .in('codigo_matricula', codigosDaUnidade);

                if (error) throw error;
                
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay()); // Início da semana (domingo)
                
                // Calcular estatísticas
                const totalMedidas = todasMedidas.length;
                
                const medidasMes = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioMes;
                }).length;
                
                const medidasSemana = todasMedidas.filter(medida => {
                    const dataMedida = new Date(medida.criado_em);
                    return dataMedida >= inicioSemana;
                }).length;
                
                // Contar alunos únicos com medidas
                const alunosUnicos = new Set(todasMedidas.map(medida => medida.codigo_matricula));
                const alunosAfetados = alunosUnicos.size;
                
                // Calcular média de nota disciplinar da unidade
                let mediaNotaEscola = 8.0;
                try {
                    // Usar alunos da unidade (já carregados acima)
                    const todosAlunos = alunosDaUnidade;

                    if (todosAlunos && todosAlunos.length > 0) {
                        let somaNotas = 0;
                        const totalAlunos = todosAlunos.length;
                        
                        // Agrupar medidas por aluno
                        const medidasPorAluno = {};
                        todasMedidas.forEach(medida => {
                            if (!medidasPorAluno[medida.codigo_matricula]) {
                                medidasPorAluno[medida.codigo_matricula] = [];
                            }
                            medidasPorAluno[medida.codigo_matricula].push(medida);
                        });
                        
                        // Otimização: Buscar notas dos alunos da unidade usando a view
                        try {
                            const { data: todasNotas, error: notasError } = await window.supabaseClient
                                .from('v_nota_disciplinar_atual')
                                .select('codigo_aluno, nota_atual')
                                .in('codigo_aluno', codigosDaUnidade);
                            
                            if (!notasError && todasNotas) {
                                // Criar mapa de notas por aluno
                                const notasPorAluno = {};
                                todasNotas.forEach(nota => {
                                    notasPorAluno[nota.codigo_aluno] = nota.nota_atual;
                                });
                                
                                // Somar notas de todos os alunos
                                todosAlunos.forEach(aluno => {
                                    const notaAluno = notasPorAluno[aluno.codigo] || 8.0;
                                    somaNotas += parseFloat(notaAluno) || 8.0;
                                });
                                
                            } else {
                                console.warn('Usando fallback para cálculo de notas:', notasError);
                                // Fallback: todos com nota 8.0
                                somaNotas = todosAlunos.length * 8.0;
                            }
                        } catch (viewError) {
                            console.warn('Erro ao buscar notas via view, usando fallback:', viewError);
                            // Fallback: todos com nota 8.0
                            somaNotas = todosAlunos.length * 8.0;
                        }
                        
                        mediaNotaEscola = (somaNotas / totalAlunos).toFixed(2);
                    }
                } catch (error) {
                    console.error('Erro ao calcular média da escola:', error);
                }
                
                // Atualizar interface
                document.getElementById('totalMedidas').textContent = totalMedidas;
                document.getElementById('medidasMes').textContent = medidasMes;
                document.getElementById('medidasSemana').textContent = medidasSemana;
                document.getElementById('alunosAfetados').textContent = alunosAfetados;
                document.getElementById('mediaNotaEscola').textContent = mediaNotaEscola;
                
                
            } catch (error) {
                console.error('❌ Erro ao carregar estatísticas:', error);
                // Valores padrão em caso de erro
                document.getElementById('totalMedidas').textContent = '0';
                document.getElementById('medidasMes').textContent = '0';
                document.getElementById('medidasSemana').textContent = '0';
                document.getElementById('alunosAfetados').textContent = '0';
                document.getElementById('mediaNotaEscola').textContent = '8.00';
            }
        }

        // Função auxiliar para formatar datas corretamente (evitar problema de timezone)
        function formatarDataCorreta(dataInput) {
            if (!dataInput) return 'Data não informada';

            if (typeof dataInput === 'string') {
                // Se é string, extrair apenas a parte da data (YYYY-MM-DD)
                const dateStr = dataInput.split('T')[0];
                const [ano, mes, dia] = dateStr.split('-');
                return `${dia}/${mes}/${ano}`;
            } else {
                // Se é objeto Date, usar toLocaleDateString mas forçar UTC
                const utcDate = new Date(dataInput.getTime() + (dataInput.getTimezoneOffset() * 60000));
                return utcDate.toLocaleDateString('pt-BR');
            }
        }

        // Carregar registros recentes de medidas
        async function carregarRegistrosRecentes() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                console.log('📋 Carregando registros recentes...');
                
                // Carregar últimas 5 medidas
                const { data: medidas, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .order('criado_em', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                const container = document.getElementById('registrosRecentes');
                
                if (!medidas || medidas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📋</div>
                            <h3>Nenhuma medida encontrada</h3>
                            <p>As medidas disciplinares registradas aparecerão aqui</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="records-list">';
                medidas.forEach(medida => {
                    // Usar data da ocorrência (não criado_em) e corrigir timezone
                    const dataOcorrencia = medida.data || medida.criado_em;
                    const dataFormatada = formatarDataCorreta(dataOcorrencia);
                    const horaFormatada = new Date(medida.criado_em).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <div class="record-item">
                            <div class="record-header">
                                <span class="record-student">${medida.nome_completo}</span>
                                <span class="record-date">${dataFormatada} às ${horaFormatada}</span>
                            </div>
                            <div class="record-details">
                                <span class="record-type">${medida.tipo_medida}</span>
                                <span class="record-turma">Turma: ${medida.turma}</span>
                            </div>
                            <div class="record-description">${medida.especificacao || 'Sem descrição'}</div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                console.log(`📋 ${medidas.length} registros recentes carregados`);
                
            } catch (error) {
                console.error('❌ Erro ao carregar registros recentes:', error);
                const container = document.getElementById('registrosRecentes');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">❌</div>
                        <h3>Erro ao carregar registros</h3>
                        <p>Tente recarregar a página</p>
                    </div>
                `;
            }
        }
        
        // Tornar função disponível globalmente
        window.carregarRegistrosRecentes = carregarRegistrosRecentes;

        // Carregar dados de demonstração
        function carregarDadosDemoMedidas() {
            document.getElementById('registrosRecentes').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">📋</div>
                    <h3>Nenhum registro encontrado</h3>
                    <p>Sistema configurado para começar a registrar faltas e medidas</p>
                </div>
            `;

            document.getElementById('alertasContainer').innerHTML = `
                <div class="insight-item">
                    <div class="insight-text">📊 Sistema configurado para ver alertas reais</div>
                    <span class="trend-indicator trend-down">ℹ️ Info</span>
                </div>
            `;
        }

        // ======= FUNÇÕES DE FILTROS DINÂMICOS =======
        
        let todosAlunosMedidas = [];
        let todasTurmasMedidas = [];
        
        // Tornar variáveis disponíveis globalmente
        window.todosAlunosMedidas = todosAlunosMedidas;
        window.todasTurmasMedidas = todasTurmasMedidas;
        
        async function carregarTurmasEAlunos() {
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                    
                todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`📚 [CONSULTA] Carregando alunos da unidade: ${unidadeAtual}`);

                // Carregar alunos FILTRADOS pela unidade
                const { data: alunosData, error } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo, "Nome completo", turma, unidade')
                    .eq('unidade', unidadeAtual);

                if (error) throw error;
                
                alunosData.forEach(aluno => {
                    if (aluno['Nome completo'] && aluno.turma) {
                        todosAlunosMedidas.push({
                            id: aluno.codigo,
                            codigo: aluno.codigo,
                            nome: aluno['Nome completo'],
                            turma: aluno.turma,
                            foto_url: aluno.foto_url
                        });
                    }
                });
                
                
                /* CÓDIGO ANTIGO COMENTADO
                try {
                        const response = await fetch('../data/db.json');
                        const dbData = await response.json();
                        if (dbData.alunos) {
                            console.log('FREQ: Carregando alunos do arquivo db.json');
                            todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;
                            
                            // Converter objeto em array
                            Object.keys(dbData.alunos).forEach(alunoId => {
                                const aluno = dbData.alunos[alunoId];
                                if (aluno.nome_completo && aluno.turma) {
                                    todosAlunosMedidas.push({
                                        id: aluno.id || alunoId,
                                        codigo: aluno.codigo || alunoId,
                                        nome: aluno.nome_completo,
                                        turma: aluno.turma
                                    });
                                }
                            });
                            
                            console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos');
                            console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                        }
                    } catch (fileError) {
                        console.error('Erro ao carregar do arquivo:', fileError);
                        return;
                    }
                } else {
                    console.log('FREQ: Carregando alunos do localDb');
                    todosAlunosMedidas = [];
                window.todosAlunosMedidas = todosAlunosMedidas;
                    
                    // Carregar alunos do localDb
                    // USAR SISTEMA HÍBRIDO em vez de localDb diretamente
                    const alunosSnapshot = await window.db.collection('alunos').get();
                    alunosSnapshot.docs.forEach(doc => {
                        const aluno = doc.data();
                        if (aluno.nome_completo && aluno.turma) {
                            todosAlunosMedidas.push({
                                id: aluno.id || doc.id,
                                codigo: aluno.codigo || doc.id,
                                nome: aluno.nome_completo,
                                turma: aluno.turma
                            });
                        }
                    });
                    
                    console.log('FREQ: Array todosAlunosMedidas populado com', todosAlunosMedidas.length, 'alunos do localDb');
                    console.log('FREQ: Exemplo de aluno:', todosAlunosMedidas.find(a => a.id === 'aluno_163'));
                }
                */ // Fim do código antigo comentado
                
                // Extrair turmas únicas
                todasTurmasMedidas = [...new Set(todosAlunosMedidas.map(a => a.turma))].sort();
                window.todasTurmasMedidas = todasTurmasMedidas;
                
                // Carregar turmas no select
                const selectTurma = document.getElementById('turmaConsulta');
                if (selectTurma) {
                    const valorAtual = selectTurma.value; // Preservar seleção atual
                    selectTurma.innerHTML = '<option value="">Selecione uma turma...</option>';
                    todasTurmasMedidas.forEach(turma => {
                        const selected = valorAtual === turma ? 'selected' : '';
                        selectTurma.innerHTML += `<option value="${turma}" ${selected}>Turma ${turma}</option>`;
                    });
                    
                } else {
                    console.log('ℹ️ [TURMAS] Elemento turmaConsulta não encontrado (seção pode ter sido removida)');
                }
                
                console.log(`✅ Carregados: ${todasTurmasMedidas.length} turmas, ${todosAlunosMedidas.length} alunos`);
                
            } catch (error) {
                console.error('Erro ao carregar turmas e alunos:', error);
            }
        }
        
        // Tornar função disponível globalmente
        window.carregarTurmasEAlunos = carregarTurmasEAlunos;
        
        // Função separada para configurar evento de turma (evita conflitos)
        function configurarEventoTurma() {
            console.log('⚙️ [CONFIG] Configurando evento de seleção de turma...');
            const selectTurma = document.getElementById('turmaConsulta');
            if (!selectTurma) {
                console.error('❌ [CONFIG] Select de turma não encontrado');
                return;
            }
            
            // Remover todos os listeners antigos
            const novoSelect = selectTurma.cloneNode(true);
            selectTurma.parentNode.replaceChild(novoSelect, selectTurma);
            
            // Adicionar evento ao novo select
            novoSelect.addEventListener('change', function() {
                console.log('🔥 [CONFIG-EVENT] Turma selecionada:', this.value);
                carregarAlunosPorTurma();
            });
            
            console.log('✅ [CONFIG] Evento configurado com sucesso');
        }
        
        function carregarAlunosPorTurma() {
            console.log('🔍 [CONSULTA] ========== INICIANDO carregarAlunosPorTurma ==========');
            const selectTurma = document.getElementById('turmaConsulta');
            const selectAluno = document.getElementById('alunoConsulta');
            
            if (!selectTurma || !selectAluno) {
                console.log('ℹ️ [CONSULTA] Elementos de consulta não encontrados (seção pode ter sido removida)');
                return;
            }
            
            const turmaSelecionada = selectTurma.value;
            
            // Limpar seleção atual do aluno
            selectAluno.value = '';
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                selectAluno.disabled = true;
                return;
            }
            
            if (!todosAlunosMedidas || todosAlunosMedidas.length === 0) {
                selectAluno.innerHTML = '<option value="">❌ Dados de alunos não carregados</option>';
                selectAluno.disabled = true;
                carregarTurmasEAlunos().then(() => {
                    carregarAlunosPorTurma();
                });
                return;
            }
            
            // Filtrar alunos pela turma selecionada
            const alunosDaTurma = todosAlunosMedidas.filter(aluno => aluno.turma === turmaSelecionada);
            console.log(`🔍 [CONSULTA] Alunos encontrados na turma ${turmaSelecionada}:`, alunosDaTurma.length);
            
            // Atualizar select de alunos
            selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
            alunosDaTurma.forEach(aluno => {
                // Usar o ID interno do aluno (que será convertido para código depois)
                selectAluno.innerHTML += `<option value="${aluno.id}" data-codigo="${aluno.codigo}">${aluno.nome}</option>`;
            });
            
            selectAluno.disabled = false;
            
            console.log(`✅ [CONSULTA] Carregados ${alunosDaTurma.length} alunos da turma ${turmaSelecionada}`);
            console.log('🏁 [CONSULTA] ========== FIM carregarAlunosPorTurma ==========');
        }
        
        // Função simplificada que só carrega alunos (sem recarregar dados)
        function carregarAlunosPorTurmaSimples() {
            const selectTurma = document.getElementById('turmaConsulta');
            const selectAluno = document.getElementById('alunoConsulta');
            
            if (!selectTurma || !selectAluno) {
                console.log('ℹ️ [CONSULTA-SIMPLES] Elementos de consulta não encontrados (seção pode ter sido removida)');
                return;
            }
            
            const turmaSelecionada = selectTurma.value;
            
            if (!turmaSelecionada) {
                selectAluno.innerHTML = '<option value="">Primeiro selecione uma turma...</option>';
                habilitarBotaoPesquisa();
                return;
            }
            
            // Verificar se dados estão disponíveis
            if (!todosAlunosMedidas || todosAlunosMedidas.length === 0) {
                carregarTurmasEAlunos(); // Só se necessário
                return;
            }
            
            // Filtrar alunos da turma selecionada
            const alunosDaTurma = todosAlunosMedidas.filter(aluno => 
                aluno.turma && aluno.turma.toString() === turmaSelecionada.toString()
            );
            
            if (alunosDaTurma.length === 0) {
                selectAluno.innerHTML = '<option value="">Nenhum aluno encontrado nesta turma</option>';
            } else {
                selectAluno.innerHTML = '<option value="">Selecione um aluno...</option>';
                alunosDaTurma
                    .sort((a, b) => a.nome.localeCompare(b.nome))
                    .forEach(aluno => {
                        selectAluno.innerHTML += `<option value="${aluno.id}">${aluno.nome}</option>`;
                    });
            }
            
            habilitarBotaoPesquisa();
        }
        
        
        
        
        
        // Função para excluir medida disciplinar
        async function excluirMedida(medidaId, botao) {
            // Primeira confirmação
            if (!confirm('⚠️ Tem certeza que deseja excluir esta medida disciplinar?\n\nEsta ação não pode ser desfeita.')) {
                return;
            }
            
            // Segunda confirmação mais específica
            if (!confirm('🚨 CONFIRMAÇÃO FINAL:\n\nVocê está prestes a EXCLUIR PERMANENTEMENTE esta medida disciplinar do sistema.\n\nEsta operação:\n• Remove a medida do Supabase\n• Afeta o cálculo da nota disciplinar\n• NÃO pode ser desfeita\n\nDeseja realmente continuar?')) {
                return;
            }
            
            try {
                botao.disabled = true;
                botao.style.opacity = '0.5';
                botao.textContent = '⏳';
                
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                console.log('🗑️ Excluindo medida ID:', medidaId);
                
                // Excluir do Supabase
                const { error } = await window.supabaseClient
                    .from('medidas')
                    .delete()
                    .eq('id', medidaId);
                
                if (error) throw error;
                
                // Remover o item da interface
                const medidaItem = document.querySelector(`[data-medida-id="${medidaId}"]`);
                if (medidaItem) {
                    medidaItem.style.transition = 'all 0.3s ease';
                    medidaItem.style.opacity = '0';
                    medidaItem.style.transform = 'translateX(-100%)';
                    
                    setTimeout(() => {
                        medidaItem.remove();
                        
                        // Verificar se ainda há medidas
                        const medidasRestantes = document.querySelectorAll('.medida-item');
                        if (medidasRestantes.length === 0) {
                            document.getElementById('historicoMedidas').innerHTML = `
                                <div class="info-box info-success">
                                    <h4>✅ Comportamento exemplar!</h4>
                                    <p>Este aluno não possui medidas disciplinares registradas</p>
                                </div>
                            `;
                        }
                    }, 300);
                }
                
                showMessage('✅ Medida disciplinar excluída com sucesso!', 'success');
                
                // Recarregar estatísticas
                await carregarEstatisticasMedidas();
                
                console.log('✅ Medida excluída com sucesso');
                
            } catch (error) {
                console.error('❌ Erro ao excluir medida:', error);
                showMessage('❌ Erro ao excluir medida: ' + error.message, 'error');
                
                // Restaurar botão em caso de erro
                botao.disabled = false;
                botao.style.opacity = '0.7';
                botao.textContent = '🗑️';
            }
        }

        
        // Função para exibir dados de frequência escolar
        async function exibirFrequenciaEscolar(aluno) {
            const container = document.getElementById('frequenciaEscolar');
            const codigoAluno = aluno.codigo || aluno.id || aluno.codigo_matricula;
            
            try {
                // Obter dados de frequência em paralelo
                const [resumoResult, faltasResult, mensalResult] = await Promise.all([
                    window.getResumoAcumuladoAluno(codigoAluno),
                    window.getFaltasAluno(codigoAluno), // TODAS as faltas (sem limite)
                    window.getResumoMensalAtualAluno(codigoAluno)
                ]);
                
                const resumoAcumulado = resumoResult.data;
                const faltas = faltasResult.data || [];
                const resumoMensal = mensalResult.data;
                
                // Determinar classe de presença para estilo
                let classePresenca = 'presenca-regular';
                if (resumoAcumulado?.pct_presenca_operacional) {
                    const pct = resumoAcumulado.pct_presenca_operacional;
                    if (pct >= 95) classePresenca = 'presenca-excelente';
                    else if (pct >= 85) classePresenca = 'presenca-boa';
                    else if (pct >= 75) classePresenca = 'presenca-regular';
                    else classePresenca = 'presenca-baixa';
                }
                
                // Gerar HTML da seção de frequência
                container.innerHTML = `
                    <div class="frequencia-grid">
                        <!-- Card de Presença Acumulada -->
                        <div class="frequencia-card ${classePresenca}">
                            <div class="frequencia-card-title">
                                📊 Presença Acumulada
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoAcumulado.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoAcumulado ? 
                                    window.FrequenciaUtils.getDescricaoPresenca(resumoAcumulado.pct_presenca_operacional) : 
                                    'Dados não disponíveis'
                                }
                            </div>
                            ${resumoAcumulado ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoAcumulado.presencas || 0}P + ${resumoAcumulado.atestados || 0}A + ${resumoAcumulado.faltas || 0}F = ${resumoAcumulado.total_aulas || 0} aulas
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Card do Resumo Mensal -->
                        <div class="frequencia-card">
                            <div class="frequencia-card-title">
                                📅 Mês Atual
                            </div>
                            <div class="frequencia-card-value">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarPercentual(resumoMensal.pct_presenca_operacional) : 
                                    'N/A'
                                }
                            </div>
                            <div class="frequencia-card-subtitle">
                                ${resumoMensal ? 
                                    window.FrequenciaUtils.formatarMesAno(resumoMensal.mes) : 
                                    'Dados não disponíveis'
                                }
                            </div>
                            ${resumoMensal ? `
                                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                    ${resumoMensal.presencas || 0}P + ${resumoMensal.atestados || 0}A + ${resumoMensal.faltas || 0}F
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Faltas Registradas -->
                    <div class="faltas-recentes">
                        <div class="faltas-recentes-title">
                            📋 Faltas Registradas
                        </div>
                        ${faltas.length > 0 ? 
                            `<div class="faltas-datas" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                ${faltas.map(falta => `
                                    <span class="falta-data-chip" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 4px 8px; font-size: 0.85em; color: #495057;">
                                        ${window.FrequenciaUtils.formatarData(falta.data)}
                                    </span>
                                `).join('')}
                            </div>` :
                            `<div class="sem-faltas" style="color: #28a745; font-size: 0.9em; margin-top: 8px;">
                                ✅ Nenhuma falta registrada
                            </div>`
                        }
                    </div>
                `;
                
                
            } catch (error) {
                console.error('❌ Erro ao exibir frequência:', error);
                
                // Fallback em caso de erro
                container.innerHTML = `
                    <div class="frequencia-card">
                        <div class="frequencia-card-title">
                            ⚠️ Erro ao Carregar
                        </div>
                        <div class="frequencia-card-subtitle" style="color: #dc3545;">
                            Não foi possível carregar os dados de frequência.
                            Tente novamente mais tarde.
                        </div>
                    </div>
                `;
            }
        }
        
        // Função para mostrar todas as faltas de um aluno
        async function verTodasFaltas(codigoAluno) {
            try {
                const { data: todasFaltas } = await window.getFaltasAluno(codigoAluno, 50);
                
                if (!todasFaltas || todasFaltas.length === 0) {
                    alert('Nenhuma falta encontrada para este aluno.');
                    return;
                }
                
                // Criar modal ou popup com todas as faltas
                const faltasHTML = todasFaltas.map(falta => 
                    `${window.FrequenciaUtils.formatarData(falta.data)} - ${falta.turma || 'N/A'}`
                ).join('\n');
                
                alert(`Todas as faltas do aluno:\n\n${faltasHTML}`);
                
            } catch (error) {
                console.error('❌ Erro ao carregar todas as faltas:', error);
                alert('Erro ao carregar faltas. Tente novamente.');
            }
        }
        
        
        // Função para calcular pontos de uma medida (apenas para exibição)
        // NOTA: Cálculos oficiais são feitos nas views do Postgres
        function calcularPontosMedidaExibicao(tipoMedida, diasSuspensao = 1) {
            let pontos = 0;
            
            // Medidas positivas
            if (tipoMedida === 'Elogio Individual') pontos = 0.5;
            else if (tipoMedida === 'Elogio Coletivo') pontos = 0.3;
            else if (tipoMedida === 'Fato Observado Positivo') pontos = 0.1;
            
            // Medidas negativas
            else if (tipoMedida === 'Fato Observado Negativo') pontos = -0.1;
            else if (tipoMedida === 'Advertência Verbal' || tipoMedida === 'Advertência Escrita' || tipoMedida === 'Advertência') pontos = -0.3;
            else if (tipoMedida === 'Suspensão') {
                pontos = -0.5 * diasSuspensao;
            }
            else if (tipoMedida === 'Ação Educativa') pontos = -1.0;
            
            return pontos;
        }

        // Função para verificar se é medida positiva
        function isMedidaPositiva(tipoMedida) {
            return ['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'].includes(tipoMedida);
        }

        function exibirHistoricoMedidas(medidas) {
            const container = document.getElementById('historicoMedidas');
            
            if (!medidas || medidas.length === 0) {
                container.innerHTML = `
                    <div class="info-box info-success">
                        <h4>✅ Comportamento exemplar!</h4>
                        <p>Este aluno não possui medidas disciplinares registradas</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar medidas por data (mais recentes primeiro)
            medidas.sort((a, b) => new Date(b.data_registro) - new Date(a.data_registro));
            
            let html = `
                <div class="medidas-resumo">
                    <div class="resumo-item resumo-warning">
                        <span class="resumo-numero">${medidas.length}</span>
                        <span class="resumo-label">Total de Medidas</span>
                    </div>
                </div>
                
                <div class="medidas-timeline">
            `;
            
            medidas.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data_registro || medida.data);
                const tipoMedida = medida.tipo_medida || 'N/A';
                const diasSuspensao = medida.dias_suspensao || 1;
                const pontos = calcularPontosMedidaExibicao(tipoMedida, diasSuspensao);
                const isPositiva = isMedidaPositiva(tipoMedida);
                
                // Debug para verificar pontos
                
                // Formatar exibição dos pontos
                let pontosTexto = '';
                if (pontos > 0) {
                    pontosTexto = `<span class="medida-pontos positivos">+${pontos}</span>`;
                } else if (pontos < 0) {
                    pontosTexto = `<span class="medida-pontos negativos">${pontos}</span>`;
                } else if (pontos === 0) {
                    pontosTexto = `<span class="medida-pontos" style="background:#ffeaa7; color:#d63031;">⚠️ 0</span>`;
                }
                
                html += `
                    <div class="medida-item ${isPositiva ? 'positiva' : ''}" data-medida-id="${medida.id}">
                        <div class="medida-data">${dataFormatada}</div>
                        <div class="medida-content">
                            <div class="medida-tipo">
                                ${tipoMedida}
                                ${pontosTexto}
                            </div>
                            <div class="medida-descricao">
                                <strong>Especificação:</strong> ${medida.especificacao || 'N/A'}
                            </div>
                            ${medida.observacao ? `<div class="medida-providencias"><strong>Observações:</strong> ${medida.observacao}</div>` : ''}
                        </div>
                        <div class="medida-actions">
                            <button class="btn-excluir-medida" onclick="excluirMedida('${medida.id}', this)" title="Excluir medida">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function exibirResumoEstatistico(aluno, medidas) {
            const container = document.getElementById('resumoEstatistico');
            const totalMedidas = medidas.length;
            
            try {
                // Aguardar supabaseClient estar disponível
                if (!window.supabaseClient) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.supabaseClient) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                // Calcular estatísticas avançadas
                let mediasRecentes = 0;
                let tipoMaisComum = 'N/A';
                let mediaGeral = 0;
                let posicaoRanking = 'N/A';
                
                if (medidas.length > 0) {
                    // Medidas nos últimos 30 dias
                    const dataLimite = new Date();
                    dataLimite.setDate(dataLimite.getDate() - 30);
                    mediasRecentes = medidas.filter(m => 
                        new Date(m.data_registro) >= dataLimite
                    ).length;
                    
                    // Tipo mais comum
                    const tiposCount = {};
                    medidas.forEach(m => {
                        tiposCount[m.tipo_medida] = (tiposCount[m.tipo_medida] || 0) + 1;
                    });
                    tipoMaisComum = Object.keys(tiposCount).reduce((a, b) => 
                        tiposCount[a] > tiposCount[b] ? a : b, 'N/A'
                    );
                }
                
                // Buscar dados gerais para comparação
                const { data: todasMedidas } = await window.supabaseClient
                    .from('medidas')
                    .select('codigo_matricula, criado_em');
                
                if (todasMedidas) {
                    // Calcular média geral por aluno
                    const alunosCount = {};
                    todasMedidas.forEach(m => {
                        alunosCount[m.codigo_matricula] = (alunosCount[m.codigo_matricula] || 0) + 1;
                    });
                    
                    const medidasPorAluno = Object.values(alunosCount);
                    mediaGeral = medidasPorAluno.length > 0 ? 
                        (medidasPorAluno.reduce((a, b) => a + b, 0) / medidasPorAluno.length).toFixed(1) : 0;
                    
                    // Calcular posição no ranking (quantos alunos têm mais medidas)
                    const alunosComMais = medidasPorAluno.filter(count => count > totalMedidas).length;
                    posicaoRanking = `${alunosComMais + 1}º de ${medidasPorAluno.length}`;
                }
                
                // Obter nota disciplinar das views (nova implementação)
                let notaDisciplinar = 8.0;
                let dadosNota = null;
                
                try {
                    const codigoAluno = aluno.codigo || aluno.id || selectAluno.value;
                    
                    const { data: notaData, error } = await window.supabaseClient
                        .from('v_nota_disciplinar_atual')
                        .select('*')
                        .eq('codigo_aluno', codigoAluno)
                        .limit(1);
                    
                    if (!error && notaData && notaData.length > 0) {
                        dadosNota = notaData[0];
                        notaDisciplinar = dadosNota.nota_atual || 8.0;
                    } else {
                        console.log(`⚠️ Nota não encontrada para ${codigoAluno}, usando padrão 8.0`);
                    }
                } catch (error) {
                    console.warn('Erro ao obter nota das views:', error);
                }
                
                const mencao = obterMencaoDisciplinar(notaDisciplinar);
                
                container.innerHTML = `
                    <!-- Nota Disciplinar - Destaque Principal -->
                    <div class="disciplinary-score-card" style="background: linear-gradient(135deg, ${mencao.cor}20, ${mencao.cor}10); border: 2px solid ${mencao.cor}; margin-bottom: 20px;">
                        <div class="score-content">
                            <div class="score-header">
                                <span class="score-emoji">${mencao.emoji}</span>
                                <div class="score-info">
                                    <div class="score-title">Nota Disciplinar</div>
                                    <div class="score-subtitle">${mencao.mencao}</div>
                                </div>
                            </div>
                            <div class="score-number" style="color: ${mencao.cor};">${notaDisciplinar.toFixed(2)}</div>
                        </div>
                        
                        ${dadosNota.data_ultima_negativa ? `
                            <div class="score-details">
                                <span>Última ocorrência negativa: ${dadosNota.dias_desde_ultima_negativa || 0} dias atrás</span>
                                ${dadosNota.bonus_ativo ? 
                                    `<span style="color: #28a745;">🎉 Bônus de recuperação ativo!</span>` : 
                                    `<span>Aguardando período de recuperação</span>`
                                }
                            </div>
                        ` : `
                            <div class="score-details">
                                <span style="color: #28a745;">✨ Nenhuma medida negativa registrada!</span>
                            </div>
                        `}
                    </div>
                
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">⚖️</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-info">
                            <div class="stat-icon">📊</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediaGeral}</div>
                                <div class="stat-label">Média Geral (por aluno)</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-danger">
                            <div class="stat-icon">📈</div>
                            <div class="stat-content">
                                <div class="stat-number">${mediasRecentes}</div>
                                <div class="stat-label">Últimos 30 dias</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-primary">
                            <div class="stat-icon">🏆</div>
                            <div class="stat-content">
                                <div class="stat-number">${posicaoRanking}</div>
                                <div class="stat-label">Ranking Disciplinar</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">Código do Aluno</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-secondary">
                            <div class="stat-icon">📋</div>
                            <div class="stat-content">
                                <div class="stat-number" style="font-size: 0.8em;">${tipoMaisComum.length > 15 ? tipoMaisComum.substring(0, 15) + '...' : tipoMaisComum}</div>
                                <div class="stat-label">Tipo Mais Comum</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-section" style="margin-top: 20px;">
                        <h5>📊 Análise Comparativa</h5>
                        <div class="comparison-grid">
                            <div class="comparison-item ${totalMedidas > mediaGeral ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Situação vs Média Geral:</span>
                                <span class="comparison-value">
                                    ${totalMedidas > mediaGeral ? 
                                        `⚠️ Acima da média (+${(totalMedidas - mediaGeral).toFixed(1)})` : 
                                        `✅ Abaixo da média (-${(mediaGeral - totalMedidas).toFixed(1)})`
                                    }
                                </span>
                            </div>
                            
                            <div class="comparison-item ${mediasRecentes > 2 ? 'comparison-alert' : 'comparison-good'}">
                                <span class="comparison-label">Tendência Recente:</span>
                                <span class="comparison-value">
                                    ${mediasRecentes === 0 ? '✅ Sem ocorrências recentes' :
                                      mediasRecentes <= 2 ? '🟡 Situação controlada' :
                                      '🔴 Requer atenção'
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao calcular estatísticas avançadas:', error);
                // Fallback para exibição simples
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon">⚖️</div>
                            <div class="stat-content">
                                <div class="stat-number">${totalMedidas}</div>
                                <div class="stat-label">Total de Medidas</div>
                            </div>
                        </div>
                        
                        <div class="stat-card stat-success">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-content">
                                <div class="stat-number">${aluno.codigo || aluno.id || 'N/A'}</div>
                                <div class="stat-label">Código do Aluno</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        

        // Inicializar filtros quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                await carregarTurmasEAlunos();
            }, 2000);
        });

        // FUNÇÕES DE FREQUÊNCIA SEPARADAS (baseadas no teste que funciona)
        async function verFrequenciaAluno() {
            const selectAluno = document.getElementById('alunoConsulta');
            const areaFrequencia = document.getElementById('areaFrequenciaAluno');
            const resultado = document.getElementById('resultadoFrequenciaAluno');
            
            if (!selectAluno || !selectAluno.value) {
                alert('Primeiro selecione um aluno!');
                return;
            }
            
            // Pegar código do aluno - BUSCAR NOS DADOS CARREGADOS
            let codigo = selectAluno.value;
            const nomeAluno = selectAluno.options[selectAluno.selectedIndex]?.text || '';
            
            console.log('DEBUG: selectAluno.value =', selectAluno.value);
            console.log('DEBUG: nomeAluno =', nomeAluno);
            console.log('DEBUG: todosAlunosMedidas =', todosAlunosMedidas);
            
            // Tentar buscar código real se disponível
            if (todosAlunosMedidas && todosAlunosMedidas.length > 0) {
                const alunoEncontrado = todosAlunosMedidas.find(aluno => aluno.id === selectAluno.value);
                console.log('DEBUG: alunoEncontrado =', alunoEncontrado);
                if (alunoEncontrado && alunoEncontrado.codigo) {
                    codigo = alunoEncontrado.codigo;
                    console.log('DEBUG: Converteu para código =', codigo);
                }
            }
            
            // Se ainda não encontrou código, tentar usar o value do option
            if (codigo === selectAluno.value && selectAluno.options[selectAluno.selectedIndex]) {
                const dataCode = selectAluno.options[selectAluno.selectedIndex].getAttribute('data-codigo');
                if (dataCode) {
                    codigo = dataCode;
                    console.log('DEBUG: Usando data-codigo =', codigo);
                }
            }
            
            console.log('🔍 Buscando frequência para código:', codigo);
            resultado.innerHTML = '🔄 Carregando frequência...';
            areaFrequencia.style.display = 'block';
            
            try {
                console.log('TESTE: Fazendo fetch do arquivo...');
                const response = await fetch('../assets/js/dados-frequencia-agosto.js');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar arquivo: ' + response.status);
                }
                
                const jsContent = await response.text();
                console.log('TESTE: Arquivo carregado, tamanho:', jsContent.length);
                
                // Extrair dados CSV
                const csvMatch = jsContent.match(/const dadosCSV = `([^`]+)`/);
                if (!csvMatch || !csvMatch[1]) {
                    throw new Error('Dados CSV não encontrados no arquivo');
                }
                
                const csvData = csvMatch[1];
                console.log('TESTE: CSV extraído, primeiras 200 chars:', csvData.substring(0, 200));
                
                // Parse CSV
                const linhas = csvData.trim().split('\n');
                console.log('TESTE: Total de linhas CSV:', linhas.length);
                
                // Buscar linha do aluno
                let linhaAluno = null;
                console.log('TESTE: Procurando por linha que começa com:', codigo + ',');
                
                for (let linha of linhas) {
                    if (linha.startsWith(codigo + ',')) {
                        linhaAluno = linha;
                        console.log('TESTE: Linha do aluno encontrada:', linhaAluno);
                        break;
                    }
                }
                
                if (!linhaAluno) {
                    console.log('TESTE: Aluno não encontrado. Primeiras 5 linhas:', linhas.slice(0, 5));
                    console.log('TESTE: Procurando pelo código:', codigo);
                    resultado.innerHTML = `❌ Aluno ${codigo} não encontrado no arquivo de frequência`;
                    return;
                }
                
                const campos = linhaAluno.split(',');
                const nome = campos[1];
                const turma = campos[2];
                const diasAgosto = [1, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15, 18, 19, 20, 21, 22, 25, 26, 27, 28, 29];
                
                const faltas = [];
                for (let i = 3; i < campos.length && i - 3 < diasAgosto.length; i++) {
                    const marcacao = campos[i];
                    if (marcacao === 'F' || marcacao === 'FC' || marcacao === 'A') {
                        const dia = diasAgosto[i - 3];
                        faltas.push({
                            dia: dia,
                            marcacao: marcacao,
                            data: `${dia.toString().padStart(2, '0')}/08`
                        });
                    }
                }
                
                let html = `
                    <h5>✅ ${nome}</h5>
                    <p><strong>Código:</strong> ${codigo}</p>
                    <p><strong>Turma:</strong> ${turma}</p>
                    <p><strong>Total de faltas:</strong> ${faltas.length}</p>
                `;
                
                if (faltas.length > 0) {
                    html += '<p><strong>Faltas encontradas:</strong></p>';
                    faltas.forEach(falta => {
                        let cor = '#dc3545'; // Vermelho para F
                        if (falta.marcacao === 'FC') cor = '#ffc107'; // Amarelo para FC
                        if (falta.marcacao === 'A') cor = '#17a2b8'; // Azul para A
                        
                        html += `<span style="background: ${cor}; color: white; padding: 6px 12px; margin: 3px; border-radius: 5px; display: inline-block;">${falta.data} - ${falta.marcacao}</span> `;
                    });
                    html += '<br><small style="color: #666; margin-top: 10px; display: block;">F = Falta | FC = Falta Controlada | A = Atestado</small>';
                } else {
                    html += '<p style="color: green;">✅ Nenhuma falta registrada</p>';
                }
                
                resultado.innerHTML = html;
                console.log('✅ Frequência carregada com sucesso!');
                
            } catch (error) {
                console.error('❌ Erro ao carregar frequência:', error);
                resultado.innerHTML = `❌ Erro: ${error.message}`;
            }
        }


        // ======= FUNÇÃO DE EXPORTAÇÃO PARA PDF TEMPORARIAMENTE DESABILITADA =======
        async function exportarFichaPDF() {
            alert('Funcionalidade PDF temporariamente desabilitada para correção de erros. Use outras opções de relatório disponíveis.');
            return;
        }
        
        // FUNÇÃO ORIGINAL COMENTADA PARA EVITAR ERROS
        /*
        async function exportarFichaPDF_original() {
            console.log('📄 Iniciando exportação para PDF...');
            const btnExportar = document.getElementById('btnExportarPDF');
            const selectAluno = document.getElementById('alunoConsulta');
            
            // Desabilitar botão durante exportação
            const textoOriginal = btnExportar.innerHTML;
            btnExportar.disabled = true;
            btnExportar.innerHTML = '⏳ Gerando PDF...';
            
            try {
                // Verificar se ficha está carregada
                const fichaContainer = document.getElementById('fichaAluno');
                if (!fichaContainer || fichaContainer.style.display === 'none') {
                    alert('❌ Por favor, primeiro carregue a ficha disciplinar do aluno!');
                    return;
                }
                
                // Obter dados do aluno para nome do arquivo
                const nomeAluno = selectAluno.options[selectAluno.selectedIndex]?.text || 'Aluno';
                const codigoAluno = selectAluno.value;
                
                // ============= NOVA ABORDAGEM: CAPTURAR APARÊNCIA EXATA =============
                
                // Aguardar html2canvas estar disponível
                if (!window.html2canvas) {
                    // Carregar html2canvas dinamicamente se necessário
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }
                
                // Preparar a ficha para captura
                const originalScrollBehavior = fichaContainer.style.overflow;
                const originalMaxHeight = fichaContainer.style.maxHeight;
                
                // Remover scroll temporariamente para capturar tudo
                fichaContainer.style.overflow = 'visible';
                fichaContainer.style.maxHeight = 'none';
                
                // Aguardar um momento para o layout se ajustar
                await new Promise(resolve => setTimeout(resolve, 500));
                
                btnExportar.innerHTML = '📸 Capturando ficha...';
                
                // Capturar a ficha como imagem
                const canvas = await html2canvas(fichaContainer, {
                    scale: 2, // Alta qualidade
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: fichaContainer.scrollWidth,
                    height: fichaContainer.scrollHeight,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // Restaurar estilos originais
                fichaContainer.style.overflow = originalScrollBehavior;
                fichaContainer.style.maxHeight = originalMaxHeight;
                
                btnExportar.innerHTML = '🖨️ Criando PDF...';
                
                // Criar PDF com as dimensões corretas
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                
                // Calcular dimensões para PDF
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgHeight / imgWidth;
                
                // Usar A4 em modo paisagem se necessário, ou retrato
                const pdfWidth = 210; // A4 width in mm
                const pdfHeight = pdfWidth * ratio;
                
                let pdf;
                if (pdfHeight > 297) { // Se for muito alto para A4 retrato
                    pdf = new jsPDF('l', 'mm', 'a4'); // Paisagem
                    const landscapeWidth = 297;
                    const landscapeHeight = landscapeWidth * ratio;
                    pdf.addImage(imgData, 'PNG', 10, 10, landscapeWidth - 20, landscapeHeight);
                } else {
                    pdf = new jsPDF('p', 'mm', 'a4'); // Retrato
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                }
                
                // Se a imagem for muito alta, criar páginas adicionais
                if (pdfHeight > 280) {
                    const pagesNeeded = Math.ceil(pdfHeight / 280);
                    for (let i = 1; i < pagesNeeded; i++) {
                        pdf.addPage();
                        const yOffset = -(280 * i);
                        pdf.addImage(imgData, 'PNG', 10, yOffset + 10, pdfWidth - 20, pdfHeight);
                    }
                }
                
                // Salvar PDF
                const fileName = `Ficha_Disciplinar_${nomeAluno.replace(/[^a-zA-Z0-9]/g, '_')}_${codigoAluno}.pdf`;
                pdf.save(fileName);
                
                console.log('✅ PDF gerado com sucesso:', fileName);
                
            } catch (error) {
                console.error('❌ Erro ao gerar PDF:', error);
                alert('❌ Erro ao gerar PDF: ' + error.message);
            } finally {
                // Restaurar botão
                btnExportar.disabled = false;
                btnExportar.innerHTML = textoOriginal;
            }
        }
        */

        // Função para controle de seções expansíveis
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content) {
                // Usar classes CSS em vez de style.display
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
                    if (toggle) toggle.textContent = '🔽';
                    console.log(`🔽 Seção ${sectionId} recolhida`);
                } else {
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                    if (toggle) toggle.textContent = '🔼';
                    console.log(`✅ Seção ${sectionId} expandida`);
                }
            } else {
                console.warn(`❌ Elemento ${sectionId}-content não encontrado`);
            }
        }

        // === SISTEMA DE CATEGORIAS MÚLTIPLAS ===
        let faltasSelecionadas = [];
        let categoriasSelecionadas = [];

        function limparSelecoesCategorias() {
            categoriasSelecionadas = [];
            faltasSelecionadas = [];
            
            // Desmarcar todos os checkboxes
            document.querySelectorAll('#faltasMultiContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Limpar container
            const container = document.getElementById('faltasMultiContainer');
            if (container) container.innerHTML = '';
            
            const tagsContainer = document.getElementById('faltasTagsContainer');
            if (tagsContainer) tagsContainer.innerHTML = '';
        }

        function toggleCategoria(categoria) {
            const checkbox = document.getElementById(`cat_${categoria}`);
            const index = categoriasSelecionadas.indexOf(categoria);
            
            if (checkbox && checkbox.checked && index === -1) {
                categoriasSelecionadas.push(categoria);
            } else if (checkbox && !checkbox.checked && index > -1) {
                categoriasSelecionadas.splice(index, 1);
            }
            
            // Recarregar faltas baseado nas categorias selecionadas
            const container = document.getElementById('faltasCategoriasContainer');
            if (container) {
                container.innerHTML = '';
                
                if (categoriasSelecionadas.length === 0) {
                    container.innerHTML = '<p class="texto-instrucao">👆 Marque as categorias acima para ver as faltas específicas</p>';
                } else {
                    // Criar seção para cada categoria selecionada
                    categoriasSelecionadas.forEach(cat => {
                        const faltas = carregarFaltasCategorizadas(cat);
                        const categoriaLabel = cat === 'leve' ? '⚡ Faltas Leves' : 
                                              cat === 'media' ? '⚠️ Faltas Médias' : 
                                              '🚨 Faltas Graves';
                        
                        const secaoDiv = document.createElement('div');
                        secaoDiv.className = 'categoria-secao';
                        secaoDiv.innerHTML = `
                            <h5 style="color: #333; margin: 15px 0 10px 0;">${categoriaLabel}</h5>
                            <div class="faltas-categoria">
                                ${faltas.map(falta => `
                                    <label class="falta-checkbox categoria-${cat}">
                                        <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                        <span>${falta}</span>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                        container.appendChild(secaoDiv);
                    });
                }
            }
        }

        function carregarFaltasCategorizadas(categoria) {
            const faltasPorCategoria = {
                'leve': [
                    'Item 1 - Apresentar-se com uniforme diferente do estabelecido pelo regulamento',
                    'Item 2 - Apresentar-se com barba ou bigode sem fazer',
                    'Item 3 - Comparecer à EECM com cabelo em desalinho ou fora do padrão',
                    'Item 4 - Chegar atrasado à EECM para o início das aulas, instrução, treinamento, formatura ou atividade escolar',
                    'Item 5 - Comparecer à EECM sem levar o material necessário',
                    'Item 6 - Adentrar ou permanecer em qualquer dependência da EECM, sem autorização',
                    'Item 7 - Consumir alimentos, balas, doces líquidos ou mascar chicletes durante a aula, instrução, treinamento, formatura, atividade escolar',
                    'Item 8 - Conversar ou se mexer quando estiver em forma',
                    'Item 9 - Deixar de entregar à Monitoria, Secretaria ou a Coordenação, qualquer objeto que não lhe pertença',
                    'Item 10 - Deixar de retribuir cumprimentos ou de prestar sinais de respeito regulamentares',
                    'Item 11 - Deixar material escolar, objetos ou peças de uniforme em locais inapropriados',
                    'Item 12 - Descartar papéis, restos de comida, embalagens ou qualquer objeto no chão ou fora de locais apropriados',
                    'Item 13 - Dobrar qualquer peça de uniforme para diminuir seu tamanho, desfigurando sua originalidade',
                    'Item 14 - Debruçar-se sobre a carteira e dormir durante o horário das aulas ou instruções',
                    'Item 15 - Executar movimentos de ordem unida de forma displicente ou desatenciosa',
                    'Item 16 - Fazer ou provocar excessivo barulho em qualquer dependência da EECM, durante o horário de aula',
                    'Item 17 - Não levar ao conhecimento de autoridade competente falta ou irregularidade que presenciar ou de que tiver ciência',
                    'Item 18 - Perturbar o estudo do(s) colega(s), com ruídos ou brincadeiras',
                    'Item 19 - Utilizar-se, na sala, de qualquer publicação estranha à sua atividade escolar, salvo quando autorizado',
                    'Item 20 - Retardar ou contribuir para o atraso da execução de qualquer atividade sem justo motivo',
                    'Item 21 - Sentar-se no chão, atentando contra a postura e compostura, estando uniformizado',
                    'Item 22 - Utilizar qualquer tipo de jogo, brinquedo, figurinhas, coleções no interior da EECM',
                    'Item 23 - Usar, a aluna, piercings, brinco fora do padrão estabelecido, mais de um brinco em cada orelha, alargador ou similares',
                    'Item 24 - Usar, o aluno, piercings, brinco, alargador ou similares, quando uniformizado',
                    'Item 25 - Usar, quando uniformizado, boné, capuz ou outros adornos, durante a atividade escolar',
                    'Item 26 - Ficar na sala de aula durante os intervalos e as formaturas diárias'
                ],
                'media': [
                    'Item 27 - Atrasar ou deixar de atender ao chamado da Diretoria, coordenação, Oficial de Gestão Educacional-Militar',
                    'Item 28 - Deixar de comparecer a qualquer atividade extraclasse para a qual tenha sido designado',
                    'Item 29 - Deixar de comparecer às atividades escolares, formaturas, ou delas se ausentar, sem autorização',
                    'Item 30 - Deixar de cumprir ou esquivar-se de medidas disciplinares impostas pelo Gestor Educacional-Militar',
                    'Item 31 - Deixar de devolver à EECM, dentro do prazo estipulado, documentos devidamente assinados pelo seu responsável',
                    'Item 32 - Deixar de devolver, no prazo fixado, livros da biblioteca ou outros materiais pertencentes às EECM',
                    'Item 33 - Deixar de entregar ao pai ou responsável, documento que lhe foi encaminhado pela EECM',
                    'Item 34 - Deixar de executar tarefas atribuídas da Diretoria, coordenação, Oficial de Gestão Educacional-Militar',
                    'Item 35 - Deixar de zelar por sua apresentação pessoal',
                    'Item 36 - Dirigir memoriais ou petições a qualquer autoridade, sobre assuntos da alçada da Diretoria',
                    'Item 37 - Entrar ou sair da EECM por locais não permitidos',
                    'Item 38 - Espalhar boatos ou notícias tendenciosas por qualquer meio',
                    'Item 39 - Tocar a sirene, sem ordem para tal',
                    'Item 40 - Fumar dentro ou nas imediações da EECM ou quando uniformizado',
                    'Item 41 - Ingressar ou sair da EECM sem estar com o uniforme regulamentar',
                    'Item 42 - Ler ou distribuir, dentro da EECM, publicações estampas ou jornais que atentem contra a disciplina',
                    'Item 43 - Manter contato físico que denota envolvimento de cunho amoroso (namoro, beijos, etc.)',
                    'Item 44 - Não zelar pelo nome da Instituição que representa, deixando de portar-se adequadamente',
                    'Item 45 - Negar-se a colaborar ou participar nos eventos, formaturas, solenidades e desfiles oficiais',
                    'Item 46 - Ofender a moral de colegas ou de qualquer membro da Comunidade Escolar por atos, gestos ou palavras',
                    'Item 47 - Portar-se de forma inconveniente em sala de aula ou outro local de instrução/recreação',
                    'Item 48 - Portar-se de maneira desrespeitosa ou inconveniente nos eventos sociais ou esportivos',
                    'Item 49 - Proferir palavras de baixo calão, incompatíveis com as normas da boa educação',
                    'Item 50 - Propor ou aceitar transação pecuniária de qualquer natureza, no interior da EECM',
                    'Item 51 - Provocar ou disseminar a discórdia entre colegas',
                    'Item 52 - Publicar ou contribuir para que sejam publicadas mensagens, fotos, vídeos que possam expor a integridade da EECM',
                    'Item 53 - Retirar ou tentar retirar objeto, de qualquer dependência da EECM, sem ordem do responsável',
                    'Item 54 - Sair de forma sem autorização',
                    'Item 55 - Sair, entrar ou permanecer na sala de aula sem permissão',
                    'Item 56 - Ser retirado, por mau comportamento, de sala de aula ou qualquer ambiente',
                    'Item 57 - Simular doenças para esquivar-se ao atendimento de obrigações e de atividades escolares',
                    'Item 58 - Tomar parte em jogos de azar ou em apostas na unidade escolar ou fora dela',
                    'Item 59 - Usar as instalações ou equipamentos esportivos da EECM, sem uniformes adequados, ou sem autorização',
                    'Item 60 - Usar o uniforme ou o nome da EECM em ambiente inapropriado',
                    'Item 61 - Utilizar, sem autorização, telefones celulares ou quaisquer aparelhos eletrônicos durante as atividades escolares',
                    'Item 62 - Usar indevidamente distintivos ou insígnias'
                ],
                'grave': [
                    'Item 63 - Assinar pelo responsável, documento que deve ser entregue à unidade escolar',
                    'Item 64 - Causar danos ao patrimônio da unidade escolar',
                    'Item 65 - Causar ou contribuir para a ocorrência de acidentes de qualquer natureza',
                    'Item 66 - Comunicar-se com outro aluno ou utilizar-se de qualquer meio não permitido durante qualquer instrumento de avaliação',
                    'Item 67 - Denegrir o nome da ECM e/ou de qualquer de seus membros através de procedimentos desrespeitosos',
                    'Item 68 - Desrespeitar, desobedecer ou desafiar a Diretoria, coordenação, Oficial de gestão Educacional-Militar',
                    'Item 69 - Divulgar, ou concorrer para que isso aconteça, qualquer imagem ou matéria que induza a apologia às drogas, à violência e/ou pornografia',
                    'Item 70 - Entrar na unidade escolar, ou dela se ausentar, sem autorização',
                    'Item 71 - Extraviar documentos que estejam sob sua responsabilidade',
                    'Item 72 - Faltar com a verdade e/ou utilizar-se do anonimato para a prática de qualquer falta disciplinar',
                    'Item 73 - Fazer uso, portar, distribuir, estar sob ação ou induzir outrem ao uso de bebida alcoólica, entorpecentes, tóxicos ou produtos alucinógenos',
                    'Item 74 - Hastear ou arriar bandeiras e estandartes, sem autorização',
                    'Item 75 - Instigar colegas a cometer faltas disciplinares e/ou ações delituosas',
                    'Item 76 - Manter contato físico com conotação libidinosa no ambiente da EECM ou fora dela',
                    'Item 77 - Obter ou fazer uso de imagens, vídeos, áudios ou de qualquer tipo de publicação difamatória contra qualquer membro da Comunidade Escolar',
                    'Item 78 - Ofender membros da Comunidade Escolar com a prática de Bullying e Cyberbullying',
                    'Item 79 - Pichar ou causar qualquer poluição visual ou sonora dentro e nas proximidades da EECM',
                    'Item 80 - Portar objetos que ameacem a segurança individual e/ou da coletividade',
                    'Item 81 - Praticar atos contrários ao culto e ao respeito aos símbolos nacionais',
                    'Item 82 - Promover ou tomar parte de qualquer manifestação coletiva que venha a macular o nome da EECM',
                    'Item 83 - Promover trotes de qualquer natureza',
                    'Item 84 - Promover, incitar ou envolver-se em rixa, inclusive luta corporal, dentro ou fora da EECM',
                    'Item 85 - Provocar ou tomar parte, uniformizado ou estando na EECM, em manifestações de natureza política',
                    'Item 86 - Rasurar, violar ou alterar documentos ou o conteúdo dos mesmos',
                    'Item 87 - Representar a EECM e/ou por ela tomar compromisso, sem estar para isso autorizado',
                    'Item 88 - Ter em seu poder, introduzir, ler ou distribuir, dentro da EECM, cartazes, jornais ou publicações que atentem contra a disciplina',
                    'Item 89 - Utilizar ou subtrair indevidamente objetos ou valores alheios',
                    'Item 90 - Utilizar-se de processos fraudulentos na realização de trabalhos pedagógicos',
                    'Item 91 - Utilizar-se indevidamente e/ou causar avaria e/ou destruição do patrimônio pertencente à EECM'
                ]
            };
            
            return faltasPorCategoria[categoria] || [];
        }

        function toggleFalta(falta) {
            const index = faltasSelecionadas.indexOf(falta);
            if (index > -1) {
                faltasSelecionadas.splice(index, 1);
            } else {
                faltasSelecionadas.push(falta);
            }
            atualizarTagsFaltas();
        }

        function atualizarTagsFaltas() {
            const tagsContainer = document.getElementById('faltasTagsContainer');
            if (!tagsContainer) return;
            
            tagsContainer.innerHTML = '';
            
            faltasSelecionadas.forEach(falta => {
                const tag = document.createElement('span');
                tag.className = 'falta-tag';
                tag.innerHTML = `
                    ${falta}
                    <button type="button" onclick="removerFalta('${falta}')" class="remover-tag">×</button>
                `;
                tagsContainer.appendChild(tag);
            });
            
            // Atualizar o campo oculto se necessário
            const hiddenField = document.getElementById('faltasSelecionadasHidden');
            if (hiddenField) {
                hiddenField.value = JSON.stringify(faltasSelecionadas);
            }
        }

        function removerFalta(falta) {
            faltasSelecionadas = faltasSelecionadas.filter(f => f !== falta);
            
            // Desmarcar checkbox correspondente
            const checkbox = document.querySelector(`input[value="${falta}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            atualizarTagsFaltas();
        }

        // === FUNCIONALIDADES DE MEDIDAS NEGATIVAS E POSITIVAS ===
        let medidasNegativasData = [];
        let medidasPositivasData = [];

        async function carregarMedidasNegativas() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '⏳ Carregando...';
                button.disabled = true;

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`📊 [NEGATIVAS] Carregando medidas da unidade: ${unidadeAtual}`);

                // Buscar códigos dos alunos da unidade atual
                const { data: alunosDaUnidade, error: errorAlunos } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo')
                    .eq('unidade', unidadeAtual);

                if (errorAlunos) throw errorAlunos;

                const codigosDaUnidade = alunosDaUnidade?.map(a => a.codigo) || [];

                if (codigosDaUnidade.length === 0) {
                    medidasNegativasData = [];
                    document.getElementById('tableMedidasNegativas').innerHTML = '<p class="text-center text-muted">Nenhum aluno encontrado na unidade selecionada</p>';
                    return;
                }

                // Carregar medidas APENAS dos alunos da unidade
                const { data, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .in('codigo_matricula', codigosDaUnidade)
                    .in('tipo_medida', ['Fato Observado Negativo', 'Advertência Verbal', 'Advertência Escrita', 'Suspensão', 'Ação Educativa'])
                    .order('criado_em', { ascending: false });

                if (error) throw error;
                
                medidasNegativasData = data || [];
                console.log(`✅ ${medidasNegativasData.length} medidas negativas carregadas`);
                
                // Popular filtros de turmas e aplicar filtros iniciais
                popularFiltrosTurmas();
                aplicarFiltrosNegativas();
                
            } catch (error) {
                console.error('❌ Erro ao carregar medidas negativas:', error);
                alert('Erro ao carregar medidas negativas: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function carregarMedidasPositivas() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '⏳ Carregando...';
                button.disabled = true;

                // Obter unidade atual
                const unidadeAtual = window.unidadeSelector ? window.unidadeSelector.getUnidade() : 'Sede';
                console.log(`📊 [POSITIVAS] Carregando medidas da unidade: ${unidadeAtual}`);

                // Buscar códigos dos alunos da unidade atual
                const { data: alunosDaUnidade, error: errorAlunos } = await window.supabaseClient
                    .from('alunos')
                    .select('codigo')
                    .eq('unidade', unidadeAtual);

                if (errorAlunos) throw errorAlunos;

                const codigosDaUnidade = alunosDaUnidade?.map(a => a.codigo) || [];

                if (codigosDaUnidade.length === 0) {
                    medidasPositivasData = [];
                    document.getElementById('tableMedidasPositivas').innerHTML = '<p class="text-center text-muted">Nenhum aluno encontrado na unidade selecionada</p>';
                    return;
                }

                // Carregar medidas APENAS dos alunos da unidade
                const { data, error } = await window.supabaseClient
                    .from('medidas')
                    .select('*')
                    .in('codigo_matricula', codigosDaUnidade)
                    .in('tipo_medida', ['Elogio Individual', 'Elogio Coletivo', 'Fato Observado Positivo'])
                    .order('criado_em', { ascending: false });

                if (error) throw error;
                
                medidasPositivasData = data || [];
                console.log(`✅ ${medidasPositivasData.length} medidas positivas carregadas`);
                
                // Popular filtros de turmas e aplicar filtros iniciais
                popularFiltrosTurmas();
                aplicarFiltrosPositivas();
                
            } catch (error) {
                console.error('❌ Erro ao carregar medidas positivas:', error);
                alert('Erro ao carregar medidas positivas: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function renderizarTabelaMedidasNegativas() {
            const container = document.getElementById('tableMedidasNegativas');
            if (!container) return;
            
            if (medidasNegativasData.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhuma medida negativa encontrada.</p>';
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Aluno</th>
                                <th>Turma</th>
                                <th>Tipo</th>
                                <th>Especificação</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            medidasNegativasData.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data || medida.criado_em);
                
                html += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${medida.nome_completo || 'N/A'}</td>
                        <td>${medida.turma || 'N/A'}</td>
                        <td><span class="badge badge-danger">${medida.tipo_medida}</span></td>
                        <td class="text-truncate" style="max-width: 300px;" title="${medida.especificacao || medida.tipo_medida}">${medida.especificacao || medida.tipo_medida}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderizarTabelaMedidasPositivas() {
            const container = document.getElementById('tableMedidasPositivas');
            if (!container) return;
            
            if (medidasPositivasData.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhuma medida positiva encontrada.</p>';
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Aluno</th>
                                <th>Turma</th>
                                <th>Tipo</th>
                                <th>Especificação</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            medidasPositivasData.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data || medida.criado_em);
                
                html += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${medida.nome_completo || 'N/A'}</td>
                        <td>${medida.turma || 'N/A'}</td>
                        <td><span class="badge badge-success">${medida.tipo_medida}</span></td>
                        <td class="text-truncate" style="max-width: 300px;" title="${medida.especificacao || medida.tipo_medida}">${medida.especificacao || medida.tipo_medida}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // === FUNÇÕES DE FILTROS DAS TABELAS ===
        function aplicarFiltrosNegativas() {
            const pesquisa = document.getElementById('pesquisaNegativas')?.value.toLowerCase() || '';
            const filtroTurma = document.getElementById('filtroTurmaNegativas')?.value || 'todas';
            const quantidade = document.getElementById('quantidadeNegativas')?.value || '10';
            
            let dadosFiltrados = [...medidasNegativasData];
            
            // Primeiro: Limitar quantidade dos dados originais (mais recentes)
            if (quantidade !== 'todas') {
                const limite = parseInt(quantidade);
                dadosFiltrados = dadosFiltrados.slice(0, limite);
            }
            
            // Depois: Filtrar por turma
            if (filtroTurma !== 'todas') {
                dadosFiltrados = dadosFiltrados.filter(medida => medida.turma === filtroTurma);
            }
            
            // Por último: Filtrar por pesquisa (nome ou código)
            if (pesquisa) {
                dadosFiltrados = dadosFiltrados.filter(medida => {
                    const nome = medida.nome_completo?.toLowerCase() || '';
                    const codigo = medida.codigo_matricula?.toString().toLowerCase() || '';
                    return nome.includes(pesquisa) || codigo.includes(pesquisa);
                });
            }
            
            renderizarTabelaFiltrada('tableMedidasNegativas', dadosFiltrados, 'negativa');
        }

        function aplicarFiltrosPositivas() {
            const pesquisa = document.getElementById('pesquisaPositivas')?.value.toLowerCase() || '';
            const filtroTurma = document.getElementById('filtroTurmaPositivas')?.value || 'todas';
            const quantidade = document.getElementById('quantidadePositivas')?.value || '10';
            
            let dadosFiltrados = [...medidasPositivasData];
            
            // Primeiro: Limitar quantidade dos dados originais (mais recentes)
            if (quantidade !== 'todas') {
                const limite = parseInt(quantidade);
                dadosFiltrados = dadosFiltrados.slice(0, limite);
            }
            
            // Depois: Filtrar por turma
            if (filtroTurma !== 'todas') {
                dadosFiltrados = dadosFiltrados.filter(medida => medida.turma === filtroTurma);
            }
            
            // Por último: Filtrar por pesquisa (nome ou código)
            if (pesquisa) {
                dadosFiltrados = dadosFiltrados.filter(medida => {
                    const nome = medida.nome_completo?.toLowerCase() || '';
                    const codigo = medida.codigo_matricula?.toString().toLowerCase() || '';
                    return nome.includes(pesquisa) || codigo.includes(pesquisa);
                });
            }
            
            renderizarTabelaFiltrada('tableMedidasPositivas', dadosFiltrados, 'positiva');
        }

        function renderizarTabelaFiltrada(containerId, dados, tipo) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (dados.length === 0) {
                container.innerHTML = `<p class="text-center text-muted">Nenhuma medida ${tipo} encontrada com os filtros aplicados.</p>`;
                return;
            }
            
            const badgeClass = tipo === 'negativa' ? 'badge-danger' : 'badge-success';
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Aluno</th>
                                <th>Turma</th>
                                <th>Tipo</th>
                                <th>Especificação</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            dados.forEach(medida => {
                const dataFormatada = formatarDataCorreta(medida.data || medida.criado_em);
                
                html += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${medida.nome_completo || 'N/A'}</td>
                        <td>${medida.turma || 'N/A'}</td>
                        <td><span class="badge ${badgeClass}">${medida.tipo_medida}</span></td>
                        <td class="text-truncate" style="max-width: 300px;" title="${medida.especificacao || medida.tipo_medida}">${medida.especificacao || medida.tipo_medida}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Carregar turmas nos filtros quando os dados são carregados
        function popularFiltrosTurmas() {
            const turmasNegativas = [...new Set(medidasNegativasData.map(m => m.turma).filter(Boolean))];
            const turmasPositivas = [...new Set(medidasPositivasData.map(m => m.turma).filter(Boolean))];
            
            const selectNegativas = document.getElementById('filtroTurmaNegativas');
            const selectPositivas = document.getElementById('filtroTurmaPositivas');
            
            if (selectNegativas) {
                selectNegativas.innerHTML = '<option value="todas">Todas as turmas</option>';
                turmasNegativas.sort().forEach(turma => {
                    selectNegativas.innerHTML += `<option value="${turma}">${turma}</option>`;
                });
            }
            
            if (selectPositivas) {
                selectPositivas.innerHTML = '<option value="todas">Todas as turmas</option>';
                turmasPositivas.sort().forEach(turma => {
                    selectPositivas.innerHTML += `<option value="${turma}">${turma}</option>`;
                });
            }
        }

        function carregarFaltasMultiplasCategorias() {
            const container = document.getElementById('faltasMultiContainer');
            if (!container) return;
            
            // Carregar todas as faltas diretamente sem seleção de categoria
            const todasFaltas = [
                ...carregarFaltasCategorizadas('leve'),
                ...carregarFaltasCategorizadas('media'),
                ...carregarFaltasCategorizadas('grave')
            ];
            
            container.innerHTML = `
                <div class="categorias-selector">
                    <h4>📋 Selecione as faltas disciplinares aplicáveis:</h4>
                    <p class="texto-instrucao">Marque todas as faltas que se aplicam ao caso:</p>
                </div>
                <div class="todas-faltas">
                    <div class="categoria-secao">
                        <h5 style="color: #333; margin: 15px 0 10px 0;">⚡ Faltas Leves (Itens 1-26)</h5>
                        <div class="faltas-categoria">
                            ${carregarFaltasCategorizadas('leve').map(falta => `
                                <label class="falta-checkbox categoria-leve">
                                    <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                    <span>${falta}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div class="categoria-secao">
                        <h5 style="color: #333; margin: 15px 0 10px 0;">⚠️ Faltas Médias (Itens 27-62)</h5>
                        <div class="faltas-categoria">
                            ${carregarFaltasCategorizadas('media').map(falta => `
                                <label class="falta-checkbox categoria-media">
                                    <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                    <span>${falta}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div class="categoria-secao">
                        <h5 style="color: #333; margin: 15px 0 10px 0;">🚨 Faltas Graves (Itens 63-91)</h5>
                        <div class="faltas-categoria">
                            ${carregarFaltasCategorizadas('grave').map(falta => `
                                <label class="falta-checkbox categoria-grave">
                                    <input type="checkbox" value="${falta}" onchange="toggleFalta('${falta}')">
                                    <span>${falta}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function carregarOpcoesPositivas(tipoMedida) {
            const container = document.getElementById('faltasMultiContainer');
            if (!container) return;
            
            const opcoesPorTipo = {
                'Elogio Individual': [
                    // 📌 Comportamento e Disciplina
                    'Aluno bem apresentado',
                    'Apresentou postura exemplar',
                    'Demonstrou respeito',
                    'Ajudou espontaneamente na manutenção da ordem da sala',
                    'Apresentou melhoramento de Disciplina',
                    'Elogiado pelo Professor',
                    
                    // 📌 Civismo e Atitude
                    'Cantou o hino nacional com entusiasmo',
                    'Participou ativamente do hasteamento da bandeira',
                    'Apresentou continência correta e bem executada',
                    'Demonstrou espírito de equipe em atividade cívico-militar',
                    'Colaborou na organização de evento escolar',
                    
                    // 📌 Dedicação e Responsabilidade
                    'Realizou todas as tarefas dentro do prazo',
                    'Trouxe materiais extras para auxiliar colegas',
                    'Assumiu responsabilidade voluntária em atividade',
                    'Apresentou melhora significativa na pontualidade',
                    'Cumpriu escala de serviço com excelência',
                    
                    // 📌 Convivência e Respeito
                    'Ajudou colega com dificuldade sem ser solicitado',
                    'Mediou conflito entre colegas de forma positiva',
                    'Tratou todos com cortesia e educação',
                    'Apresentou liderança positiva no grupo',
                    'Demonstrou solidariedade em situação de necessidade',
                    
                    // 📌 Participação e Proatividade
                    'Participou com destaque em atividade esportiva',
                    'Contribuiu ativamente em clube/atividade extracurricular',
                    'Fez perguntas pertinentes durante a aula',
                    'Apresentou sugestões construtivas para a turma',
                    'Engajou-se em atividades de leitura e estudo',
                    
                    // 🎖️ Elogios Individuais
                    'Demonstrou liderança positiva em atividade de grupo',
                    'Exerceu exemplo de disciplina e postura durante toda a semana',
                    'Obteve destaque na participação em evento cívico-militar',
                    'Apresentou melhora significativa no comportamento e rendimento',
                    'Recebeu elogio espontâneo de professor ou servidor',
                    'Manteve uniforme completo e impecável em todas as formações',
                    'Cumpriu com excelência sua função de escala de serviço',
                    'Demonstrou iniciativa e proatividade em situações escolares',
                    'Conduziu colegas com respeito e espírito de equipe',
                    'Realizou apresentação ou tarefa acadêmica de destaque'
                ],
                'Elogio Coletivo': [
                    // 🏅 Elogios Coletivos (Turma / Grupo)
                    'Turma apresentou disciplina exemplar durante a formação',
                    'Executou o hasteamento da bandeira de forma impecável',
                    'Destacou-se pela pontualidade coletiva ao longo da semana',
                    'Demonstrou espírito de equipe em atividade esportiva/cívica',
                    'Participou de evento externo representando a escola com honra',
                    'Realizou atividade de sala com organização e cooperação',
                    'Manteve ambiente de sala limpo e organizado coletivamente',
                    'Demonstrou respeito coletivo aos professores e colegas',
                    'Alcançou melhor média de frequência entre as turmas',
                    'Recebeu elogio público da direção/coordenação pela postura'
                ],
                'Fato Observado Positivo': [
                    // Baseado nas categorias de Elogio Individual para Fatos Observados
                    'Observado comportamento exemplar fora do ambiente escolar',
                    'Observado ajuda espontânea a pessoa necessitada',
                    'Observado cuidado especial com patrimônio público',
                    'Observado mediação pacífica em situação de conflito',
                    'Observado iniciativa em preservação do meio ambiente',
                    'Observado atitude inclusiva com pessoa especial',
                    'Observado demonstração prática de valores éticos',
                    'Observado gesto de bondade com colega/pessoa necessitada',
                    'Observado respeito aos símbolos nacionais em evento público',
                    'Observado atitude de coragem em situação de risco',
                    'Observado solidariedade com a comunidade',
                    'Observado honestidade ao devolver objeto encontrado',
                    'Observado liderança positiva em atividade comunitária'
                ]
            };
            
            const opcoes = opcoesPorTipo[tipoMedida] || [];
            container.innerHTML = `
                <div class="categorias-selector">
                    <h4>✨ Situações específicas para ${tipoMedida}:</h4>
                    <p class="texto-instrucao">Selecione uma ou mais situações que se aplicam:</p>
                </div>
                <div class="opcoes-positivas">
                    ${opcoes.map(opcao => `
                        <label class="falta-checkbox opcao-positiva">
                            <input type="checkbox" value="${opcao}" onchange="toggleFalta('${opcao}')">
                            <span>✅ ${opcao}</span>
                        </label>
                    `).join('')}
                </div>
            `;
        }

        // === SISTEMA DE CÁLCULO DE PRAZO ===
        function adicionarDiasUteis(data, diasUteis) {
            const resultado = new Date(data);
            let diasAdicionados = 0;
            
            while (diasAdicionados < diasUteis) {
                resultado.setDate(resultado.getDate() + 1);
                // Se não for sábado (6) nem domingo (0)
                if (resultado.getDay() !== 0 && resultado.getDay() !== 6) {
                    diasAdicionados++;
                }
            }
            
            return resultado;
        }

        function calcularPrazoAutomatico() {
            // Verificar se o campo de prazo deve estar visível
            const campoPrazo = document.getElementById('prazoAssinaturaInfo');
            const tipoMedida = document.getElementById('tipoMedida').value;

            const medidasComPrazo = [
                'Advertência Verbal',
                'Advertência Escrita',
                'Suspensão',
                'Ação Educativa'
            ];

            // Só calcular se o tipo de medida requer prazo
            if (!medidasComPrazo.includes(tipoMedida)) {
                console.log(`❌ Tipo de medida "${tipoMedida}" não requer prazo - não calculando`);
                return;
            }

            const dataOcorrencia = document.getElementById('dataMedida').value;
            const prazoDisplay = document.getElementById('prazoDataDisplay');

            if (!dataOcorrencia || !prazoDisplay) return;

            try {
                const dataOcorr = new Date(dataOcorrencia);
                // 3 dias úteis após a ocorrência
                const dataPrazo = adicionarDiasUteis(dataOcorr, 3);

                // Formatar para exibição brasileira
                const prazoFormatado = dataPrazo.toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                prazoDisplay.innerHTML = `📅 ${prazoFormatado}`;
                console.log(`✅ Prazo calculado: ${prazoFormatado}`);

                // Salvar data formatada para ISO para uso no salvamento
                window.prazoCalculado = dataPrazo.toISOString().split('T')[0];

            } catch (error) {
                console.error('Erro ao calcular prazo:', error);
                prazoDisplay.innerHTML = '❌ Erro ao calcular prazo';
            }
        }

        // Adicionar evento ao campo de data quando carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const dataMedida = document.getElementById('dataMedida');
                if (dataMedida) {
                    dataMedida.addEventListener('change', calcularPrazoAutomatico);
                    // Calcular prazo inicial se data já estiver preenchida
                    if (dataMedida.value) {
                        calcularPrazoAutomatico();
                    }
                }
            }, 1000);
        });

        // ========================================
        // 📱 WHATSAPP INTEGRATION FUNCTIONS
        // ========================================

        // FUNÇÃO REMOVIDA: mostrarBotaoWhatsApp()
        // Agora usamos apenas envio automático via checkbox

        // Enviar notificação WhatsApp
        async function enviarWhatsAppMedida() {
            console.log('🚀 FUNÇÃO enviarWhatsAppMedida() CHAMADA!');
            try {
                // Verificar se WhatsApp Sender está disponível
                if (!window.whatsappSender) {
                    showMessage('❌ Sistema WhatsApp não carregado', 'error');
                    return;
                }

                // Obter dados do aluno da última medida salva
                const dadosAluno = window.ultimoAlunoSalvo;
                if (!dadosAluno) {
                    showMessage('❌ Dados do aluno não encontrados', 'error');
                    return;
                }

                // Obter dados da medida armazenados
                const medida = window.ultimaMedidaSalva;
                if (!medida) {
                    showMessage('❌ Dados da medida não encontrados. Salve uma medida primeiro.', 'error');
                    return;
                }

                console.log('📱 Enviando WhatsApp:', { dadosAluno, medida });

                // Enviar via WhatsApp Sender
                const resultado = await window.whatsappSender.notificarMedidaDisciplinar(dadosAluno, medida);

                if (resultado.success) {
                    showMessage('✅ WhatsApp enviado com sucesso!', 'success');
                } else {
                    showMessage(`❌ Erro ao enviar WhatsApp: ${resultado.error}`, 'error');
                }

            } catch (error) {
                console.error('❌ Erro ao enviar WhatsApp:', error);
                showMessage('❌ Erro ao enviar WhatsApp: ' + error.message, 'error');
            }
        }

        // FUNÇÃO REMOVIDA: obterDadosMedidaFormulario()
        // Agora usamos os dados que foram armazenados em window.ultimaMedidaSalva

        // FUNÇÃO REMOVIDA: obterEspecificacaoMedida()
        // Agora usamos a especificação real que foi salva no banco (faltas selecionadas ou motivo)

        // Atualizar função limparFormMedida para esconder botão WhatsApp
        const limparFormMedidaOriginal = window.limparFormMedida;
        window.limparFormMedida = function() {
            // Chamar função original de limpar
            if (limparFormMedidaOriginal) {
                limparFormMedidaOriginal();
            } else {
                // Implementação básica se não existir
                const form = document.getElementById('medidaForm');
                if (form) form.reset();
            }

            // Resetar botão de salvar para estado padrão
            const btnSalvar = document.getElementById('btnSalvarMedida');
            if (btnSalvar) {
                btnSalvar.innerHTML = '⚠️ Salvar Medida';
                btnSalvar.className = 'btn btn-warning';
            }

            // Limpar checkbox WhatsApp
            const checkboxWhatsApp = document.getElementById('enviarWhatsAppAuto');
            if (checkboxWhatsApp) {
                checkboxWhatsApp.checked = false;
            }

            // Limpar dados armazenados
            window.ultimoAlunoSalvo = null;
            window.ultimaMedidaSalva = null;

            console.log('🔄 Formulário limpo e botão WhatsApp escondido');
        };

        // Variables para armazenar dados da última medida salva
        window.ultimoAlunoSalvo = null;
        window.ultimaMedidaSalva = null;

        // FUNÇÃO REMOVIDA: resetarBotaoWhatsApp()
        // Não precisamos mais resetar botão separado

        // Função para atualizar texto do botão salvar baseado no checkbox
        function atualizarTextoBotaoSalvar() {
            const checkbox = document.getElementById('enviarWhatsAppAuto');
            const btnSalvar = document.getElementById('btnSalvarMedida');

            if (checkbox && btnSalvar) {
                if (checkbox.checked) {
                    btnSalvar.innerHTML = '⚠️📱 Salvar e Enviar WhatsApp';
                    btnSalvar.className = 'btn btn-success';
                } else {
                    btnSalvar.innerHTML = '⚠️ Salvar Medida';
                    btnSalvar.className = 'btn btn-warning';
                }
            }
        }

        // Adicionar listener para atualizar texto do botão
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Listener para atualizar texto do botão ao marcar/desmarcar checkbox
                const checkboxWhatsApp = document.getElementById('enviarWhatsAppAuto');
                if (checkboxWhatsApp) {
                    checkboxWhatsApp.addEventListener('change', atualizarTextoBotaoSalvar);
                }

                console.log('👂 Listener do checkbox WhatsApp adicionado');
            }, 1500);
        });

        console.log('📱 Funções WhatsApp carregadas com sucesso');

    </script>

</body>
</html>
