# Render Configuration - Database Connection Testing
# Teste múltiplas configurações de conexão com Supabase
# Use este arquivo para testar diferentes connection strings

services:
  - type: web
    name: evolution-api-escola-jupiara
    env: node
    region: oregon
    plan: free
    buildCommand: npm install && npm run build
    startCommand: npm start
    healthCheckPath: /
    envVars:
      - key: AUTHENTICATION_API_KEY
        value: escola_jupiara_2025_secure_key
      - key: SERVER_TYPE
        value: http
      - key: SERVER_PORT
        value: 10000
      - key: CORS_ORIGIN
        value: "*"
      - key: DEL_INSTANCE
        value: "false"
      - key: DATABASE_ENABLED
        value: "true"
      - key: CONFIG_SESSION_PHONE_CLIENT
        value: "Escola Jupiara"
      - key: CONFIG_SESSION_PHONE_NAME
        value: "Sistema Disciplinar"
      - key: LOG_LEVEL
        value: "ERROR"
      - key: WEBHOOK_GLOBAL_ENABLED
        value: "false"
      - key: AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES
        value: "false"

      # OPÇÃO 1: Connection Pooler (RECOMENDADO)
      # Use esta primeira para evitar problemas de IPv6
      - key: DATABASE_URL
        value: "postgresql://postgres.rvppxdhrahcwiwrrwwaz:Jupiara2025@pooler.supabase.com:5432/postgres?sslmode=require&pgbouncer=true"
      - key: DIRECT_URL
        value: "postgresql://postgres.rvppxdhrahcwiwrrwwaz:Jupiara2025@pooler.supabase.com:5432/postgres?sslmode=require&pgbouncer=true"

      # OPÇÃO 2: Forçar IPv4 com parâmetros específicos
      # Se a OPÇÃO 1 falhar, substitua pelas linhas abaixo:
      # - key: DATABASE_URL
      #   value: "postgresql://postgres.rvppxdhrahcwiwrrwwaz:Jupiara2025@db.rvppxdhrahcwiwrrwwaz.supabase.co:5432/postgres?sslmode=require&connect_timeout=10&application_name=evolution_api"
      # - key: DIRECT_URL
      #   value: "postgresql://postgres.rvppxdhrahcwiwrrwwaz:Jupiara2025@db.rvppxdhrahcwiwrrwwaz.supabase.co:5432/postgres?sslmode=require&connect_timeout=10&application_name=evolution_api"

      # OPÇÃO 3: Session Mode (se pooler não funcionar)
      # - key: DATABASE_URL
      #   value: "postgresql://postgres.rvppxdhrahcwiwrrwwaz:Jupiara2025@db.rvppxdhrahcwiwrrwwaz.supabase.co:6543/postgres?sslmode=require"
      # - key: DIRECT_URL
      #   value: "postgresql://postgres.rvppxdhrahcwiwrrwwaz:Jupiara2025@db.rvppxdhrahcwiwrrwwaz.supabase.co:6543/postgres?sslmode=require"

      - key: DATABASE_CONNECTION_CLIENT_NAME
        value: "evolution_escola_jupiara"

    # Configurações específicas do Render
    autoDeploy: true
    branch: main
    dockerfilePath: ./Dockerfile

# INSTRUÇÕES DE TESTE:
# 1. Primeiro teste com OPÇÃO 1 (pooler.supabase.com)
# 2. Se falhar, comente as linhas da OPÇÃO 1 e descomente OPÇÃO 2
# 3. Se ainda falhar, teste OPÇÃO 3 (porta 6543 - session mode)
# 4. Verifique os logs no Render para cada tentativa