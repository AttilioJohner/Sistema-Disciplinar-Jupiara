<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Sincroniza√ß√£o - Sistema Disciplinar</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            color: #333; 
            margin-bottom: 10px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .description {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .output {
            background: #fff;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: #22c55e; }
        .status-offline { background: #ef4444; }
        .instructions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            color: #92400e;
            margin-bottom: 10px;
        }
        .instructions ol {
            margin-left: 20px;
            color: #92400e;
        }
        .instructions li {
            margin-bottom: 5px;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fed7aa; color: #92400e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Sincroniza√ß√£o - Sistema Disciplinar Jupiara</h1>
        <p class="description">
            Ferramenta para testar a sincroniza√ß√£o em tempo real entre Gest√£o de Alunos, 
            Medidas Disciplinares e Frequ√™ncia usando Supabase Realtime com Foreign Keys CASCADE.
        </p>

        <div class="instructions">
            <h3>üìã Como testar:</h3>
            <ol>
                <li>Abra esta p√°gina em <strong>duas abas/janelas</strong> diferentes</li>
                <li>Execute a√ß√µes em uma aba e observe as atualiza√ß√µes autom√°ticas na outra</li>
                <li>Teste criar, atualizar e excluir alunos</li>
                <li>Verifique que medidas e frequ√™ncia s√£o exclu√≠das em cascata</li>
                <li>Observe os logs de sincroniza√ß√£o em tempo real</li>
            </ol>
        </div>

        <!-- Se√ß√£o 1: Gest√£o de Alunos -->
        <div class="test-section">
            <h2>
                üë• Gest√£o de Alunos 
                <span class="status-indicator status-offline" id="status-alunos"></span>
                <span class="badge badge-warning" id="count-alunos">0 alunos</span>
            </h2>
            
            <div class="test-grid">
                <button class="btn-success" onclick="tests.criarAlunoTeste()">
                    ‚ûï Criar Aluno Teste
                </button>
                <button class="btn-primary" onclick="tests.listarAlunos()">
                    üìã Listar Alunos
                </button>
                <button class="btn-warning" onclick="tests.atualizarAlunoTeste()">
                    ‚úèÔ∏è Atualizar Aluno Teste
                </button>
                <button class="btn-danger" onclick="tests.excluirAlunoTeste()">
                    üóëÔ∏è Excluir Aluno Teste
                </button>
            </div>
            
            <div class="output" id="output-alunos">
                <div class="log-entry log-info">Aguardando comandos...</div>
            </div>
        </div>

        <!-- Se√ß√£o 2: Verifica√ß√£o de Cascata -->
        <div class="test-section">
            <h2>
                üîó Teste de Cascata (FK ON DELETE CASCADE)
                <span class="badge badge-warning" id="cascade-status">N√£o testado</span>
            </h2>
            
            <div class="test-grid">
                <button class="btn-success" onclick="tests.criarAlunoComDados()">
                    1Ô∏è‚É£ Criar Aluno + Dados
                </button>
                <button class="btn-primary" onclick="tests.verificarRelacoes()">
                    2Ô∏è‚É£ Verificar Rela√ß√µes
                </button>
                <button class="btn-danger" onclick="tests.excluirEVerificarCascata()">
                    3Ô∏è‚É£ Excluir e Verificar Cascata
                </button>
                <button class="btn-warning" onclick="tests.executarMigration()">
                    üîß Executar Migration SQL
                </button>
            </div>
            
            <div class="output" id="output-cascade">
                <div class="log-entry log-info">Teste de cascata n√£o iniciado</div>
            </div>
        </div>

        <!-- Se√ß√£o 3: Monitoramento Realtime -->
        <div class="test-section">
            <h2>
                üì° Monitoramento Realtime
                <span class="status-indicator status-offline" id="status-realtime"></span>
                <span class="badge badge-warning" id="realtime-events">0 eventos</span>
            </h2>
            
            <div class="test-grid">
                <button class="btn-success" onclick="tests.iniciarRealtime()">
                    ‚ñ∂Ô∏è Iniciar Monitoramento
                </button>
                <button class="btn-danger" onclick="tests.pararRealtime()">
                    ‚è∏Ô∏è Parar Monitoramento
                </button>
                <button class="btn-primary" onclick="tests.limparLogs()">
                    üßπ Limpar Logs
                </button>
            </div>
            
            <div class="output" id="output-realtime">
                <div class="log-entry log-info">Monitoramento n√£o iniciado</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../netlify-env.js"></script>
    <script src="../assets/js/env-config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script type="module">
        import { supabase } from '../assets/js/supabase-client.js';
        import alunosAPI from '../assets/js/data/alunos.js';
        
        // Estado global
        let realtimeSubscription = null;
        let eventCount = 0;
        const TEST_ALUNO_ID = 9999999; // ID de teste
        
        // Fun√ß√µes de log
        function log(section, message, type = 'info') {
            const output = document.getElementById(`output-${section}`);
            if (!output) return;
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLog(section) {
            const output = document.getElementById(`output-${section}`);
            if (output) {
                output.innerHTML = '<div class="log-entry log-info">Log limpo</div>';
            }
        }
        
        // Testes de Alunos
        window.tests = {
            async criarAlunoTeste() {
                try {
                    log('alunos', 'Criando aluno de teste...', 'info');
                    
                    const resultado = await alunosAPI.createAluno({
                        codigo: TEST_ALUNO_ID,
                        nome_completo: `Aluno Teste ${Date.now()}`,
                        turma: '9Z',
                        status: 'ativo',
                        responsavel: 'Respons√°vel Teste',
                        telefone: '(66) 99999-0000'
                    });
                    
                    if (resultado.error) {
                        throw resultado.error;
                    }
                    
                    log('alunos', `‚úÖ Aluno criado: ID ${TEST_ALUNO_ID}`, 'success');
                    await this.listarAlunos();
                    
                } catch (error) {
                    log('alunos', `‚ùå Erro: ${error.message}`, 'error');
                }
            },
            
            async listarAlunos() {
                try {
                    const { data, error } = await alunosAPI.getAlunos();
                    
                    if (error) throw error;
                    
                    const count = data.length;
                    document.getElementById('count-alunos').textContent = `${count} alunos`;
                    
                    log('alunos', `üìã Total: ${count} alunos cadastrados`, 'success');
                    
                    // Mostrar √∫ltimos 5
                    const ultimos = data.slice(-5);
                    ultimos.forEach(aluno => {
                        log('alunos', `  ‚Ä¢ ${aluno.codigo} - ${aluno["Nome completo"]} (${aluno.turma})`, 'info');
                    });
                    
                } catch (error) {
                    log('alunos', `‚ùå Erro ao listar: ${error.message}`, 'error');
                }
            },
            
            async atualizarAlunoTeste() {
                try {
                    log('alunos', 'Atualizando aluno de teste...', 'info');
                    
                    const resultado = await alunosAPI.updateAluno(TEST_ALUNO_ID, {
                        nome_completo: `Aluno Atualizado ${Date.now()}`,
                        turma: '9Y'
                    });
                    
                    if (resultado.error) {
                        throw resultado.error;
                    }
                    
                    log('alunos', `‚úÖ Aluno ${TEST_ALUNO_ID} atualizado`, 'success');
                    
                } catch (error) {
                    log('alunos', `‚ùå Erro: ${error.message}`, 'error');
                }
            },
            
            async excluirAlunoTeste() {
                try {
                    log('alunos', 'Excluindo aluno de teste...', 'warning');
                    
                    const resultado = await alunosAPI.deleteAluno(TEST_ALUNO_ID);
                    
                    if (resultado.error) {
                        throw resultado.error;
                    }
                    
                    log('alunos', `‚úÖ Aluno ${TEST_ALUNO_ID} exclu√≠do`, 'success');
                    await this.listarAlunos();
                    
                } catch (error) {
                    log('alunos', `‚ùå Erro: ${error.message}`, 'error');
                }
            },
            
            // Testes de Cascata
            async criarAlunoComDados() {
                try {
                    log('cascade', '1Ô∏è‚É£ Criando aluno com dados relacionados...', 'info');
                    
                    // Criar aluno
                    await alunosAPI.createAluno({
                        codigo: TEST_ALUNO_ID,
                        nome_completo: 'Aluno Para Cascata',
                        turma: '9X',
                        status: 'ativo'
                    });
                    
                    log('cascade', '‚úÖ Aluno criado', 'success');
                    
                    // Criar medida disciplinar
                    const { error: errorMedida } = await supabase
                        .from('medidas')
                        .insert({
                            codigo_aluno: TEST_ALUNO_ID,
                            codigo_matricula: TEST_ALUNO_ID.toString(),
                            tipo: 'advertencia',
                            data_ocorrencia: new Date().toISOString(),
                            descricao: 'Teste de cascata'
                        });
                    
                    if (errorMedida) throw errorMedida;
                    log('cascade', '‚úÖ Medida disciplinar criada', 'success');
                    
                    // Criar registro de frequ√™ncia
                    const { error: errorFreq } = await supabase
                        .from('frequencia')
                        .insert({
                            codigo_aluno: TEST_ALUNO_ID,
                            codigo_matricula: TEST_ALUNO_ID.toString(),
                            data: new Date().toISOString(),
                            status: 'P'
                        });
                    
                    if (errorFreq) throw errorFreq;
                    log('cascade', '‚úÖ Registro de frequ√™ncia criado', 'success');
                    
                    document.getElementById('cascade-status').className = 'badge badge-success';
                    document.getElementById('cascade-status').textContent = 'Dados criados';
                    
                } catch (error) {
                    log('cascade', `‚ùå Erro: ${error.message}`, 'error');
                }
            },
            
            async verificarRelacoes() {
                try {
                    log('cascade', '2Ô∏è‚É£ Verificando rela√ß√µes...', 'info');
                    
                    const relacoes = await alunosAPI.checkAlunoRelations(TEST_ALUNO_ID);
                    
                    log('cascade', `Medidas encontradas: ${relacoes.hasMedidas ? 'SIM' : 'N√ÉO'}`, 
                        relacoes.hasMedidas ? 'success' : 'warning');
                    log('cascade', `Frequ√™ncia encontrada: ${relacoes.hasFrequencia ? 'SIM' : 'N√ÉO'}`, 
                        relacoes.hasFrequencia ? 'success' : 'warning');
                    
                    if (relacoes.hasAnyRelation) {
                        document.getElementById('cascade-status').className = 'badge badge-success';
                        document.getElementById('cascade-status').textContent = 'Rela√ß√µes confirmadas';
                    }
                    
                } catch (error) {
                    log('cascade', `‚ùå Erro: ${error.message}`, 'error');
                }
            },
            
            async excluirEVerificarCascata() {
                try {
                    log('cascade', '3Ô∏è‚É£ Excluindo aluno e verificando cascata...', 'warning');
                    
                    // Excluir aluno
                    const { error } = await alunosAPI.deleteAluno(TEST_ALUNO_ID);
                    if (error) throw error;
                    
                    log('cascade', '‚úÖ Aluno exclu√≠do', 'success');
                    
                    // Aguardar um momento para cascata propagar
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Verificar se medidas foram exclu√≠das
                    const { data: medidas } = await supabase
                        .from('medidas')
                        .select('id')
                        .eq('codigo_aluno', TEST_ALUNO_ID);
                    
                    log('cascade', `Medidas restantes: ${medidas?.length || 0}`, 
                        medidas?.length === 0 ? 'success' : 'error');
                    
                    // Verificar se frequ√™ncia foi exclu√≠da
                    const { data: frequencia } = await supabase
                        .from('frequencia')
                        .select('id')
                        .eq('codigo_aluno', TEST_ALUNO_ID);
                    
                    log('cascade', `Frequ√™ncia restante: ${frequencia?.length || 0}`, 
                        frequencia?.length === 0 ? 'success' : 'error');
                    
                    if ((!medidas || medidas.length === 0) && (!frequencia || frequencia.length === 0)) {
                        log('cascade', 'üéâ CASCATA FUNCIONOU! Todos os registros foram exclu√≠dos', 'success');
                        document.getElementById('cascade-status').className = 'badge badge-success';
                        document.getElementById('cascade-status').textContent = 'Cascata OK';
                    } else {
                        log('cascade', '‚ö†Ô∏è Cascata pode n√£o ter funcionado completamente', 'warning');
                        document.getElementById('cascade-status').className = 'badge badge-error';
                        document.getElementById('cascade-status').textContent = 'Cascata falhou';
                    }
                    
                } catch (error) {
                    log('cascade', `‚ùå Erro: ${error.message}`, 'error');
                }
            },
            
            async executarMigration() {
                log('cascade', 'üîß Para executar a migration, rode o SQL no Supabase Dashboard', 'warning');
                log('cascade', 'Arquivo: migrations/001_normalize_fks.sql', 'info');
                log('cascade', 'Acesse: Dashboard > SQL Editor > New Query', 'info');
            },
            
            // Monitoramento Realtime
            iniciarRealtime() {
                if (realtimeSubscription) {
                    log('realtime', '‚ö†Ô∏è Monitoramento j√° est√° ativo', 'warning');
                    return;
                }
                
                log('realtime', '‚ñ∂Ô∏è Iniciando monitoramento realtime...', 'info');
                
                realtimeSubscription = alunosAPI.subscribeAlunosChanges((payload) => {
                    eventCount++;
                    document.getElementById('realtime-events').textContent = `${eventCount} eventos`;
                    
                    const { eventType, new: newRecord, old: oldRecord } = payload;
                    
                    if (eventType === 'INSERT') {
                        log('realtime', `‚ûï NOVO ALUNO: ${newRecord["Nome completo"]} (${newRecord.codigo})`, 'success');
                    } else if (eventType === 'UPDATE') {
                        log('realtime', `‚úèÔ∏è ATUALIZADO: ${newRecord["Nome completo"]} (${newRecord.codigo})`, 'warning');
                    } else if (eventType === 'DELETE') {
                        log('realtime', `üóëÔ∏è EXCLU√çDO: ${oldRecord["Nome completo"]} (${oldRecord.codigo})`, 'error');
                    }
                });
                
                document.getElementById('status-realtime').className = 'status-indicator status-online';
                log('realtime', '‚úÖ Monitoramento ativo', 'success');
                log('realtime', 'Execute a√ß√µes em outra aba e observe aqui!', 'info');
            },
            
            pararRealtime() {
                if (!realtimeSubscription) {
                    log('realtime', '‚ö†Ô∏è Monitoramento n√£o est√° ativo', 'warning');
                    return;
                }
                
                realtimeSubscription.unsubscribe();
                realtimeSubscription = null;
                
                document.getElementById('status-realtime').className = 'status-indicator status-offline';
                log('realtime', '‚è∏Ô∏è Monitoramento parado', 'warning');
            },
            
            limparLogs() {
                clearLog('alunos');
                clearLog('cascade');
                clearLog('realtime');
                eventCount = 0;
                document.getElementById('realtime-events').textContent = '0 eventos';
            }
        };
        
        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', async () => {
            log('alunos', 'üöÄ Sistema de testes iniciado', 'success');
            
            // Verificar conex√£o com Supabase
            try {
                const { data, error } = await supabase.from('alunos').select('count').limit(1);
                if (!error) {
                    document.getElementById('status-alunos').className = 'status-indicator status-online';
                    log('alunos', '‚úÖ Conectado ao Supabase', 'success');
                } else {
                    throw error;
                }
            } catch (error) {
                document.getElementById('status-alunos').className = 'status-indicator status-offline';
                log('alunos', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
            }
            
            // Listar alunos inicialmente
            await tests.listarAlunos();
        });
        
        // Cleanup ao fechar
        window.addEventListener('beforeunload', () => {
            if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
            }
        });
    </script>
</body>
</html>